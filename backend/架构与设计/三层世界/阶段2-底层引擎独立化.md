# é˜¶æ®µ 2ï¼šåº•å±‚å¼•æ“ç‹¬ç«‹åŒ–

> çŠ¶æ€ï¼šâœ… é˜¶æ®µ 2 å®Œæˆï¼ˆP1+2.1+2.2+2.3+2.4ï¼‰
> ç›®æ ‡ï¼šç¡®ç«‹ `app/world/` çš„çº¯æœºæ¢°è¾¹ç•Œï¼Œå‰¥ç¦»æ‰€æœ‰ LLM ä¾èµ–ã€‚
> å‰ç½®ï¼šé˜¶æ®µ 1 å®Œæˆ + Preflight é€šè¿‡

---

## æŠ¤æ ï¼ˆå¼€å·¥å‰å¿…é¡»å°±ä½ï¼‰

### G1. æµ‹è¯•åŸºçº¿å›ºå®š

å½“å‰åŸºçº¿ï¼ˆ2026-02-20 é˜¶æ®µ 1 å®Œæˆæ—¶ï¼‰ï¼š

```
62 failed / 559 passed / 11 errors (collection)
```

**62 failures ç»†åˆ†**ï¼š
- **47 ä¸ª**ï¼š`pytest-asyncio` æœªå®‰è£… â†’ `async def functions are not natively supported`
- **15 ä¸ª**ï¼šçœŸå®å¤±è´¥
  - 10 ä¸ª AttributeErrorï¼šå¼•ç”¨å·²åˆ é™¤/é‡æ„çš„ APIï¼ˆ`navigate` å·¥å…·ç§»é™¤ã€`_update_hosts_edges` æ”¹ä½ç½®ã€`_determine_teammate_perspective` ä¸å­˜åœ¨ï¼‰
  - 5 ä¸ª AssertionErrorï¼šå·¥å…·æ³¨å†Œè¡¨å˜æ›´åæµ‹è¯•æ–­è¨€è¿‡æ—¶

**11 collection errors**ï¼š
- 5 ä¸ªï¼š`ModuleNotFoundError: mcp`ï¼ˆmcp åŒ…æœªå®‰è£…ï¼‰
- 3 ä¸ªï¼š`ModuleNotFoundError: pytest_asyncio`
- 3 ä¸ªï¼š`ModuleNotFoundError: fastapi`ï¼ˆfastapi æœªå®‰è£…åˆ°æµ‹è¯•ç¯å¢ƒï¼‰

**è§„åˆ™**ï¼šæ¯ä¸ªå­ä»»åŠ¡å®Œæˆåè·‘ `PYTHONPATH=. pytest tests/ -v --continue-on-collection-errors`ï¼Œç»“æœå¿…é¡» â‰¤ 62 failed / 11 errorsï¼Œpassed â‰¥ 559ã€‚æ–°å¢å¤±è´¥ â†’ ç«‹å³ä¿®å¤ã€‚

### G2. å›å½’é˜»æ–­ï¼ˆPreflight éªŒè¯ç»“æœï¼‰

#### G2a. FlashOperation æ­»åˆ†æ”¯ï¼ˆâš ï¸ å·²ç¡®è®¤ï¼‰

`FlashOperation` æšä¸¾ 16 ä¸ªå€¼ï¼Œ`execute_request()` åªå¤„ç† 9 ä¸ªï¼Œ**7 ä¸ªè½åˆ° unsupported é»˜è®¤åˆ†æ”¯**ï¼š

| æ­»åˆ†æ”¯ | å®šä¹‰ä½ç½® | ç”Ÿäº§è°ƒç”¨æ–¹ | æµ‹è¯•å¼•ç”¨ |
|--------|---------|-----------|---------|
| `GET_PROGRESS` | `admin_protocol.py:116` | æ—  | `test_admin_agentic_intent_inference.py`ï¼ˆä»…ä½œæ ‡å¿—ï¼‰ |
| `GET_STATUS` | `admin_protocol.py:117` | æ—  | `test_navigation_fallback_and_sublocation.py:405`ï¼ˆæœŸæœ› success=Trueï¼‰ |
| `HEAL_PLAYER` | `admin_protocol.py:119` | æ—  | `test_navigation_fallback_and_sublocation.py:376`ï¼ˆæœŸæœ› success=Trueï¼‰ |
| `DAMAGE_PLAYER` | `admin_protocol.py:120` | æ—  | æ—  |
| `ADD_XP` | `admin_protocol.py:121` | æ—  | `test_navigation_fallback_and_sublocation.py:389`ï¼ˆæœŸæœ› success=Trueï¼‰ |
| `ADD_ITEM` | `admin_protocol.py:122` | æ—  | `test_navigation_fallback_and_sublocation.py:364`ï¼ˆæœŸæœ› success=Trueï¼‰ |
| `REMOVE_ITEM` | `admin_protocol.py:123` | æ—  | æ—  |

**ç°çŠ¶**ï¼šè¿™äº›æ“ä½œå·²ç”± V4 Agentic Tools ç›´æ¥å¤„ç†ï¼ˆä¸ç» FlashRequest/execute_requestï¼‰ï¼ŒFlashOperation æšä¸¾å€¼æ˜¯**æ­»ä»£ç **ã€‚æµ‹è¯•å¼•ç”¨è¿™äº›æ“ä½œä½†å¿…å®šè¿”å› `success=False`ï¼Œå±äºå·²çŸ¥çš„ 15 ä¸ªçœŸå®å¤±è´¥ä¸­çš„ä¸€éƒ¨åˆ†ã€‚

**å¤„ç†æ–¹æ¡ˆ**ï¼š
- [ ] ç¡®è®¤è¿™ 7 ä¸ªæšä¸¾å€¼åœ¨ç”Ÿäº§è·¯å¾„ä¸­é›¶è°ƒç”¨ï¼ˆâœ… å·²ç¡®è®¤ï¼‰
- [ ] æ ‡è®°ä¸ºæ­»ä»£ç ï¼Œé˜¶æ®µ 2 ä¸­**ä¸å®ç°**ã€**ä¸åˆ é™¤**ï¼ˆé¿å…æ— å…³æ”¹åŠ¨ï¼‰
- [ ] ç›¸å…³å¤±è´¥æµ‹è¯•ä¿æŒåœ¨åŸºçº¿ä¸­

#### G2b. talk_pending å·¥å…·è¿‡æ»¤æ¼æ´ï¼ˆğŸ”´ å¿…é¡»ä¿®å¤ï¼‰

**é—®é¢˜**ï¼š`_ENGINE_TOOL_EXCLUSIONS` åªæœ‰ `"talk"` â†’ `{"npc_dialogue"}`ï¼Œä½†ç¼ºå°‘ `"talk_pending"`ã€‚

```python
# v4_agentic_tools.py:26-31
_ENGINE_TOOL_EXCLUSIONS = {
    "move_area": {"update_time"},
    "rest": {"update_time"},
    "talk": {"npc_dialogue"},           # â† æœ‰
    # "talk_pending": {"npc_dialogue"},  # â† ç¼ºï¼
    "use_item": {"add_item", "remove_item", "heal_player"},
}
```

**é£é™©**ï¼šå½“ IntentExecutor çš„ flash_cpu ä¸å¯ç”¨æ—¶è¿”å› `talk_pending`ï¼Œä½† LLM ä»èƒ½çœ‹åˆ° `npc_dialogue` å·¥å…· â†’ **é‡å¤å¯¹è¯è°ƒç”¨**ã€‚å½“å‰ä»…é  LLM æ™ºèƒ½é¿å…ï¼Œæ— å¼ºä¿è¯ã€‚

**ä¿®å¤**ï¼šPreflight å•è¡Œä¿®å¤ + è¡¥æµ‹è¯•ã€‚

#### G2c. è¢«åˆ æ—§æ¥å£å…¼å®¹ï¼ˆâœ… å·²ç¡®è®¤ï¼‰

é˜¶æ®µ 1 åˆ é™¤çš„æ—§æ–¹æ³• grep ç¡®è®¤é›¶æ®‹ç•™å¼•ç”¨ï¼š
- `init_state` / `list_deltas`ï¼šStateManager å·²åˆ 
- `persist_state` / `refresh_state` / `get_game_time`ï¼šAdminWorldRuntime å·²åˆ 
- æ— éœ€å…¼å®¹ shim

#### G2d. pytest æ”¶é›†è¾¹ç•Œï¼ˆâœ… å·²ç¡®è®¤ï¼‰

11 ä¸ª collection errors å…¨éƒ¨æ˜¯åŒ…ç¼ºå¤±ï¼ˆmcp/pytest-asyncio/fastapiï¼‰ï¼Œéè·¯å¾„é—®é¢˜ã€‚æ—  `scripts/test_*.py` æ±¡æŸ“ã€‚

### G3. ä¸»è·¯å¾„èšç„¦

é˜¶æ®µ 2 åªéªŒæ”¶ **V4 Pipeline ä¸»è·¯å¾„**ï¼ˆ`AdminCoordinator.process_player_input_v3()` â†’ `PipelineOrchestrator.process()`ï¼‰ã€‚

å…¶ä½™æ—§è·¯å¾„æ ‡è®°çŠ¶æ€ï¼š
- MCP Game Toolsï¼ˆ43 å·¥å…·ï¼‰â†’ **å…¼å®¹ä¸­ / ä¸éªŒæ”¶**
- REST ç›´å†™ç«¯ç‚¹ï¼ˆ`POST /party/add` ç­‰ç»•è¿‡ Pipeline çš„ï¼‰â†’ **å…¼å®¹ä¸­ / ä¸éªŒæ”¶**
- ç§èŠæµï¼ˆ`process_private_chat_stream`ï¼‰â†’ **å…¼å®¹ä¸­ / ä¸éªŒæ”¶**ï¼ˆé˜¶æ®µ 4 ç»Ÿä¸€ï¼‰

---

## Preflightï¼ˆå¼€å·¥å‰å¿…é¡»å®Œæˆï¼‰

### P1. talk_pending å·¥å…·è¿‡æ»¤ä¿®å¤

**æ”¹åŠ¨**ï¼š`v4_agentic_tools.py` ä¸€è¡Œ

```python
_ENGINE_TOOL_EXCLUSIONS = {
    "move_area": {"update_time"},
    "rest": {"update_time"},
    "talk": {"npc_dialogue"},
    "talk_pending": {"npc_dialogue"},  # â† æ–°å¢
    "use_item": {"add_item", "remove_item", "heal_player"},
}
```

**è¡¥æµ‹è¯•**ï¼š`tests/test_tool_filtering.py` æ–°å¢ `test_talk_pending_also_removes_npc_dialogue`

### P2. NpcReactor è¿ç§»ç•™å…¼å®¹å¯¼å‡º

NpcReactor ä»…æœ‰ **2 ä¸ªå¯¼å…¥ç«™ç‚¹**ï¼š
1. `pipeline_orchestrator.py:251`ï¼ˆåŠ¨æ€ importï¼Œç”Ÿäº§ä»£ç ï¼‰
2. `tests/test_npc_reactor.py:6`ï¼ˆé™æ€ importï¼Œæµ‹è¯•ä»£ç ï¼‰

**è¿ç§»ç­–ç•¥**ï¼šç§»åŠ¨æ–‡ä»¶åˆ° `app/services/npc_reactor.py`ï¼Œåœ¨åŸä½ç½®ç•™å…¼å®¹å¯¼å‡ºï¼š

```python
# app/world/npc_reactor.pyï¼ˆå…¼å®¹ shimï¼‰
"""NPCReactor å·²è¿ç§»è‡³ app.services.npc_reactor"""
from app.services.npc_reactor import NPCReactor, MAX_REACTIONS_PER_ROUND
__all__ = ["NPCReactor", "MAX_REACTIONS_PER_ROUND"]
```

è¿™æ · 0 ä¸ªå¯¼å…¥ç«™ç‚¹éœ€è¦ä¿®æ”¹ï¼ŒåŸºçº¿ä¸ä¼šæ¶åŒ–ã€‚

### P3. AdminWorldRuntime æ®‹ç•™æ¢³ç†

**è°ƒæŸ¥ç»“æœ**ï¼šAdminCoordinator ä»æœ‰ 7 å¤„ `_world_runtime` è°ƒç”¨ï¼š

| è°ƒç”¨ | æ–¹æ³• | æ´»è·ƒåº¦ | æ¥æº |
|------|------|--------|------|
| L1090 | `start_session()` | **æ´»è·ƒ**ï¼š`game_v2.py:159` | REST è·¯ç”± |
| L1152 | `get_current_location()` | **æ´»è·ƒ**ï¼š`game_v2.py` 5 å¤„ | REST è·¯ç”± |
| L560 | `get_current_location()` | **æ´»è·ƒ**ï¼š`resume_session()` å†…éƒ¨ | å†…éƒ¨ |
| L693 | `get_current_location()` | **æ´»è·ƒ**ï¼š`generate_opening_narration()` å†…éƒ¨ | å†…éƒ¨ |
| L1161 | `advance_time()` | **ä¼‘çœ **ï¼šæ—  REST è·¯ç”±è°ƒç”¨ | SessionRuntime å·²æ¥ç®¡ |
| L1164 | `enter_sub_location()` | **ä¼‘çœ **ï¼šæ—  REST è·¯ç”±è°ƒç”¨ | IntentExecutor å·²æ¥ç®¡ |
| L1167 | `leave_sub_location()` | **ä¼‘çœ **ï¼šæ—  REST è·¯ç”±è°ƒç”¨ | IntentExecutor å·²æ¥ç®¡ |

**ç»“è®º**ï¼š`start_session()` å’Œ `get_current_location()` ä»è¢« REST API è·¯ç”±æ´»è·ƒè°ƒç”¨ã€‚AdminWorldRuntime **ä¸èƒ½åœ¨é˜¶æ®µ 2 åˆ é™¤**ã€‚3 ä¸ªä¼‘çœ æ–¹æ³•å¯æ ‡è®° deprecated ä½†ä¸æ€¥åˆ ã€‚

---

## è°ƒæŸ¥å‘ç°

### F1. `app/world/` LLM ä¾èµ–å…¨æ™¯

**11 ä¸ªçº¯æœºæ¢°æ–‡ä»¶ï¼ˆé›¶ LLM ä¾èµ–ï¼‰** âœ…

| æ–‡ä»¶ | èŒè´£ |
|------|------|
| `snapshot.py` | åºåˆ—åŒ–/ååºåˆ—åŒ– |
| `models.py` | WorldNode/Behavior/WorldEvent ç±»å‹å®šä¹‰ |
| `constants.py` | D&D 5e å‚è€ƒè¡¨ |
| `stats_manager.py` | XP/Gold/HP çº¯å‡½æ•°æ“ä½œ |
| `scene_bus.py` | å›åˆæ¶ˆæ¯æ€»çº¿å®¹å™¨ |
| `world_graph.py` | å›¾å®¹å™¨ + ç´¢å¼• + è„è¿½è¸ª |
| `event_propagation.py` | BFS äº‹ä»¶æ‰©æ•£ + è¡°å‡ |
| `behavior_engine.py` | æ¡ä»¶è¯„ä¼° + åŠ¨ä½œæ‰§è¡Œï¼ˆ`_eval_flash_evaluate` ä»…æ¶ˆè´¹ç¼“å­˜ï¼Œä¸è°ƒç”¨ LLMï¼‰ |
| `graph_builder.py` | 7 æ­¥æ„å›¾ç®¡çº¿ |
| `player_node.py` | ç©å®¶å›¾èŠ‚ç‚¹é€‚é…å™¨ |
| `intent_resolver.py` | çº¯å›¾ç»“æ„æ„å›¾åŒ¹é… |

**2 ä¸ªæ··åˆæ–‡ä»¶ï¼ˆéœ€æ‹†åˆ†ï¼‰** âš ï¸

| æ–‡ä»¶ | æœºæ¢°æ¯”ä¾‹ | LLM å…¥ä¾µç‚¹ | åˆ‡å‰²çº¿ |
|------|---------|-----------|-------|
| `intent_executor.py` | ~80% | `execute_talk()` â†’ `flash_cpu.execute_request()` (L460-489) | execute_talk è¿”å› `talk_pending`ï¼Œç”± Pipeline å±‚è¡¥å…… NPC å¯¹è¯ |
| | | `execute_sublocation_enter()` â†’ `recall_orchestrator.recall()` (L320) | recall å·² fail-openï¼Œå¯å‰¥ç¦» |
| `npc_reactor.py` | ~60% | `_llm_reaction()` â†’ `LLMService.generate_simple()` (L247-279) | æå– _llm_reaction åˆ° Agent å±‚ï¼Œä¿ç•™æ¨¡æ¿ fallback |

### F2. IntentExecutor æ–¹æ³•åˆ†ç±»

| æ–¹æ³• | ç±»å‹ | è¡Œæ•° | ä¿®æ”¹çŠ¶æ€ | LLM ä¾èµ– |
|------|------|------|---------|---------|
| `dispatch()` | çº¯æœºæ¢° | â€” | æ—  | æ—  |
| `execute_move()` | æ··åˆ | 97-260 | ä½ç½®/æ—¶é—´/å›¾èŠ‚ç‚¹ | BehaviorEngine ON_EXIT/ON_ENTERï¼ˆé LLMï¼Œä½†å¯èƒ½å« flash_evaluate æ¡ä»¶ï¼‰ |
| `execute_sublocation_enter()` | æ··åˆ | 293-337 | sub_location | recall_orchestrator.recall()ï¼ˆå¯é€‰ï¼‰ |
| `execute_sublocation_leave()` | çº¯æœºæ¢° | 503-539 | sub_location | æ—  |
| `execute_talk()` | **Agent å±‚** | 427-501 | narrative.npc_interactions | flash_cpu.execute_request() |
| `execute_rest()` | çº¯æœºæ¢° | 541-586 | æ—¶é—´/HP | æ—  |
| `execute_examine()` | çº¯æœºæ¢° | 629-714 | æ— ï¼ˆåªè¯»ï¼‰ | æ—  |
| `execute_use_item()` | çº¯æœºæ¢° | 716-824 | HP/èƒŒåŒ… | æ—  |

**æ‹†åˆ†æ–¹æ¡ˆ**ï¼šexecute_talk ä¸­çš„ NPC å¯¹è¯ç”Ÿæˆä¸Šç§»åˆ° Pipeline å±‚ã€‚IntentExecutor åªåšéªŒè¯+è®¡æ•°+å†™å…¥ ACTION æ€»çº¿æ¡ç›®ï¼Œè¿”å› `talk_pending` æ ‡å¿—ã€‚Pipeline å±‚æ£€æµ‹åˆ°è¯¥æ ‡å¿—åè°ƒç”¨ FlashCPUã€‚

**æ³¨æ„**ï¼šæ‹†åˆ†å execute_talk **å§‹ç»ˆ**è¿”å› `talk_pending`ï¼ˆä¸å†æœ‰æˆåŠŸè·¯å¾„ï¼‰ã€‚`_ENGINE_TOOL_EXCLUSIONS` ä¸­åº”å°† `"talk"` åˆ é™¤ã€ä»…ä¿ç•™ `"talk_pending"` â†’ ä¸å¯¹ï¼ŒPipeline å±‚è¡¥å……å®Œå¯¹è¯ååº”è®¾ `engine_executed.type = "talk"`ï¼ˆå¯¹è¯å·²å®Œæˆï¼‰ï¼Œè®©å·¥å…·è¿‡æ»¤æŒ‰åŸé€»è¾‘æ’é™¤ `npc_dialogue`ã€‚æ‰€ä»¥ `"talk"` å’Œ `"talk_pending"` æ’é™¤è§„åˆ™éƒ½éœ€ä¿ç•™ã€‚

### F3. V4AgenticTools 26 ä¸ªå·¥å…·åˆ†ç±»

**çº¯åº•å±‚çŠ¶æ€æ“ä½œï¼ˆ9 ä¸ªï¼‰**ï¼š
heal_player, damage_player, add_xp, add_item, remove_item, update_time, advance_chapter, complete_objective, report_flash_evaluation

**çº¯ Agent å±‚ï¼ˆ3 ä¸ªï¼‰**ï¼š
npc_dialogue, recall_memory, generate_scene_image

**æ··åˆå±‚ï¼ˆ14 ä¸ªï¼‰**ï¼š
- åº•å±‚+äº‹ä»¶å¼•æ“ï¼ˆ5 ä¸ªï¼‰ï¼šactivate_event, complete_event, fail_event, advance_stage, complete_event_objective
- åº•å±‚+MCP è°ƒç”¨ï¼ˆ5 ä¸ªï¼‰ï¼šstart_combat, choose_combat_action, add_teammate, remove_teammate, disband_party
- çº¯å›¾æ“ä½œï¼ˆ3 ä¸ªï¼‰ï¼šcreate_memory, update_disposition, ability_check

**å…³é”®å‘ç°**ï¼šSessionRuntime å¯¹ v4_agentic_tools çš„æ‰€æœ‰æš´éœ²éƒ½æ˜¯**çº¯çŠ¶æ€æ“ä½œ**ï¼ˆ.player, .world_graph, .narrative, mark_*_dirty()ï¼‰ï¼Œé›¶ LLM ä¾èµ–ã€‚

### F4. SessionRuntime æ—  LLMï¼ˆç¡®è®¤ï¼‰

SessionRuntime çš„æ‰€æœ‰æ–¹æ³•ï¼ˆrestore/persist/run_behavior_tick/advance_time/enter_area ç­‰ï¼‰**é›¶ LLM è°ƒç”¨**ã€‚run_behavior_tick() é©±åŠ¨çš„ BehaviorEngine.tick() ä¹Ÿæ˜¯çº¯æœºæ¢°â€”â€”`_eval_flash_evaluate()` ä»…è¯»å–ç¼“å­˜ï¼ˆç”± B é˜¶æ®µçš„ `report_flash_evaluation` å·¥å…·å†™å…¥ï¼‰ï¼Œä¸è°ƒç”¨ LLMã€‚

### F5. BehaviorEngine åŒ Tick æœºåˆ¶

**è®¾è®¡æ„å›¾**ï¼š
- **pre-tick (A4)**ï¼šè¯„ä¼°ç¡®å®šæ€§æ¡ä»¶ â†’ è§¦å‘è¡Œä¸º â†’ æ ‡è®° FLASH_EVALUATE pending â†’ narrative hints æ³¨å…¥ä¸Šä¸‹æ–‡
- **post-tick (C1)**ï¼šB é˜¶æ®µ LLM æä¾›äº† flash_results â†’ ä¹‹å‰è¢«é˜»å¡çš„ FLASH_EVALUATE æ¡ä»¶ç°åœ¨å¯ä»¥æ±‚å€¼ â†’ å¯èƒ½è§¦å‘æ–°è¡Œä¸º

**å»é‡æœºåˆ¶**ï¼š`_applied_side_effect_events: Set[str]` åœ¨å•è½®å†…æœ‰æ•ˆï¼ˆåŒå±‚ï¼ševent_id + blanket keyï¼‰ã€‚SessionRuntime **æ¯è½®æ–°å»º**ï¼ˆåœ¨ PipelineOrchestrator.process ä¸­ï¼‰ï¼Œæ‰€ä»¥è·¨è½®æ±¡æŸ“ä¸å­˜åœ¨ã€‚

**é£é™©è¯„ä¼°**ï¼š
- â˜…â˜† ä½ï¼šçº¯å™äº‹ behaviors å¯èƒ½åŒå‘ï¼ˆé‡å¤ hintï¼Œè¢«å¿½ç•¥ï¼‰
- â˜…â˜… ä¸­ï¼šçŠ¶æ€ä¾èµ– behaviors å¯èƒ½åœ¨ post-tick è§¦å‘æ–°çš„çº§è”
- â˜…â˜…â˜…â˜…â˜… ä¸å¯åŠ¨ï¼šFLASH_EVALUATE é—­ç¯ä¾èµ– pre+post åŒ tickï¼Œ**ä¸èƒ½åˆå¹¶ä¸ºå•æ¬¡**

**ç»“è®º**ï¼šåŒ tick æ˜¯**æœ‰æ„è®¾è®¡**è€Œé bugã€‚ä¿®å¤æ–¹å‘æ˜¯å¢å¼ºå»é‡ï¼Œä¸æ˜¯åˆå¹¶ã€‚

### F6. å‰¯ä½œç”¨å»é‡ç”Ÿå‘½å‘¨æœŸ

```
åˆ›å»º: SessionRuntime.__init__() â†’ ç©º set
å†™å…¥: _sync_tick_to_narrative() + _apply_tick_side_effects() + å·¥å…·è°ƒç”¨
è¯»å–: æ¯æ¬¡å‰¯ä½œç”¨åº”ç”¨å‰æ£€æŸ¥ dedup_key
æ¸…é™¤: SessionRuntime æ¯è½®æ–°å»º â†’ è‡ªåŠ¨æ¸…é™¤ï¼ˆä½†å•è½®å†…ä¸æ¸…é™¤ï¼‰
æŒä¹…åŒ–: ä¸å­˜åœ¨ï¼ˆçº¯å†…å­˜ï¼‰
```

**çœŸæ­£çš„é£é™©**ï¼šä¸æ˜¯åŒ tick å†…é‡å¤ï¼ˆå»é‡æœºåˆ¶å·¥ä½œï¼‰ï¼Œè€Œæ˜¯ **crash æ¢å¤**â€”â€”å¿«ç…§å·²ä¿å­˜ XP+100ï¼Œcrash åæ¢å¤ï¼Œå»é‡é›†ä¸ºç©ºï¼ŒåŒä¸€äº‹ä»¶å†æ¬¡è§¦å‘ â†’ XP å†å‘ä¸€éã€‚ä¿®å¤éœ€è¦æŒä¹…åŒ–å»é‡é›†ã€‚

---

## æ‰§è¡Œè®¡åˆ’

### åˆ†æ¬¡ç­–ç•¥

æŒ‰**è®¤çŸ¥ä¸»é¢˜**åˆ†ä¸¤æ¬¡æ‰§è¡Œï¼Œä¸æŒ‰å­ä»»åŠ¡ç¼–å·åˆ‡ï¼š

| æ¬¡æ•° | ä¸»é¢˜ | åŒ…å«ä»»åŠ¡ | é‡Œç¨‹ç¢‘ | é¢„ä¼°æ”¹åŠ¨é‡ |
|------|------|---------|--------|----------|
| **ç¬¬ä¸€æ¬¡** | LLM è¾¹ç•Œæ¸…ç† | P1 + 2.1 + 2.2 | `app/world/` é›¶ LLM import | ~70 è¡Œæ”¹ + æ–‡ä»¶è¿ç§» |
| **ç¬¬äºŒæ¬¡** | æ•°æ®ä¸€è‡´æ€§ | 2.3 + 2.4 | crash æ¢å¤å®‰å…¨ + tick å»é‡ | ~60 è¡Œæ”¹ + Firestore è·¯å¾„ |

**ä¸ºä»€ä¹ˆè¿™æ ·åˆ‡**ï¼š
- ç¬¬ä¸€æ¬¡çš„ä¸‰ä¸ªä»»åŠ¡æ˜¯åŒä¸€ä»¶äº‹çš„ä¸‰ä¸ªé¢ï¼ˆP1 æ˜¯ 2.1 çš„å‰ç½®ï¼Œ2.2 å’Œ 2.1 å…±äº«éªŒè¯æ ‡å‡†ï¼‰ï¼Œæ”¹å®Œè·‘ä¸€æ¬¡å›å½’å°±èƒ½éªŒè¯"app/world/ çº¯æœºæ¢°åŒ–"é‡Œç¨‹ç¢‘
- ç¬¬äºŒæ¬¡æ¶‰åŠ Firestore è·¯å¾„è®¾è®¡å’Œ BehaviorEngine å»é‡ç­–ç•¥ï¼Œæ˜¯ç‹¬ç«‹çš„è®¤çŸ¥åŸŸï¼Œéœ€è¦å¹²å‡€çš„ä¸Šä¸‹æ–‡æ¥æ€è€ƒ
- æ··åœ¨ä¸€èµ·å®¹æ˜“é¡¾æ­¤å¤±å½¼

---

### ç¬¬ä¸€æ¬¡ï¼šLLM è¾¹ç•Œæ¸…ç†ï¼ˆP1 + 2.1 + 2.2ï¼‰

```
P1. talk_pending å·¥å…·è¿‡æ»¤ä¿®å¤           â† 1 è¡Œä»£ç  + 1 ä¸ªæµ‹è¯•ï¼ˆ2.1 å‰ç½®ï¼‰
  â†“
2.1 IntentExecutor æ‹†åˆ†
    â”œâ”€ execute_talk() flash_cpu è°ƒç”¨ä¸Šç§»åˆ° Pipeline
    â”œâ”€ execute_sublocation_enter() recall è°ƒç”¨æ ‡è®°å¯é€‰ / ä¸Šç§»
    â”œâ”€ ç§»é™¤æ„é€ å‚æ•° flash_cpu
    â””â”€ è¡¥é½ engine_executed è¯­ä¹‰ï¼ˆtalk vs talk_pendingï¼‰
  â†“ï¼ˆå¯ä¸ 2.1 å¹¶è¡Œï¼‰
2.2 NpcReactor ç§»å‡º app/world/
    â”œâ”€ ç§»åŠ¨åˆ° app/services/npc_reactor.py
    â”œâ”€ åŸä½ç½®ç•™å…¼å®¹å¯¼å‡ºï¼ˆé›¶å¯¼å…¥ç«™ç‚¹æ”¹åŠ¨ï¼‰
    â””â”€ éªŒè¯ app/world/ é›¶ LLM import
  â†“
å›å½’éªŒè¯ + æ–‡æ¡£æ›´æ–°
```

**éªŒè¯é‡Œç¨‹ç¢‘**ï¼š
```bash
# app/world/ é›¶ LLM import
grep -rn "flash_cpu\|FlashCPU\|LLMService\|llm_service\|generate_simple" app/world/ --include="*.py"
# é¢„æœŸï¼š0 åŒ¹é…ï¼ˆnpc_reactor.py ä»…å‰©å…¼å®¹å¯¼å‡º shimï¼‰

# åŸºçº¿ä¸å˜
PYTHONPATH=. pytest tests/ -v --continue-on-collection-errors
# é¢„æœŸï¼šâ‰¤ 62 failed / â‰¥ 559 passed / 11 errors
```

---

### ç¬¬äºŒæ¬¡ï¼šæ•°æ®ä¸€è‡´æ€§ï¼ˆ2.3 + 2.4ï¼‰

```
2.3 å‰¯ä½œç”¨å»é‡æŒä¹…åŒ–
    â”œâ”€ å®šä¹‰å…è®¸æŒä¹…åŒ–çš„ dedup key æ¨¡å¼
    â”œâ”€ persist() å†™å…¥ _applied_side_effect_events åˆ° Firestore
    â”œâ”€ restore() è¯»å–å¹¶åˆå¹¶
    â””â”€ TTL ç­–ç•¥ï¼ˆé˜²æ­¢å»é‡é›†æ— é™è†¨èƒ€ï¼‰
  â†“
2.4 åŒ Tick å¢å¼º
    â”œâ”€ BehaviorEngine è¡Œä¸ºçº§ _fired_this_round æ ‡è®°
    â”œâ”€ post-tick å‰æ¸…ç©ºï¼ˆå…è®¸ FLASH_EVALUATE æ–°è§£é”ï¼‰
    â””â”€ æµ‹è¯•ï¼šXP ä¸åŒå‘
  â†“
å›å½’éªŒè¯ + æ–‡æ¡£æ›´æ–°
```

**éªŒè¯é‡Œç¨‹ç¢‘**ï¼š
```bash
# crash æ¢å¤å»é‡
PYTHONPATH=. pytest tests/test_side_effect_dedup.py -v  # æ–°æµ‹è¯•
# é¢„æœŸï¼šæ¨¡æ‹Ÿ crash æ¢å¤åå‰¯ä½œç”¨ä¸é‡å¤

# åŸºçº¿ä¸å˜
PYTHONPATH=. pytest tests/ -v --continue-on-collection-errors
# é¢„æœŸï¼šâ‰¤ 62 failed / â‰¥ 559 passed / 11 errors
```

---

## éªŒè¯æ ‡å‡†

- [x] `app/world/` ç›®å½•æ—  LLM/AI importï¼ˆ`intent_executor.py` æ—  flash_cpu / FlashCPU / LLMService å¯¼å…¥ï¼‰âœ…
- [x] IntentExecutor æ—  FlashCPU ä¾èµ–ï¼ˆæ„é€ å‚æ•°æ—  `flash_cpu`ï¼‰âœ…
- [x] NpcReactor ä¸»ä½“ä¸åœ¨ `app/world/` ç›®å½•ï¼ˆä»…å‰©å…¼å®¹å¯¼å‡º shimï¼‰âœ…
- [x] P1 talk_pendingï¼šæ·±å…¥åˆ†æåå†³å®šä¸æ·»åŠ æ’é™¤ï¼ˆPipeline å¤±è´¥æ—¶ GM éœ€è¦ npc_dialogue å…œåº•ï¼‰âœ…
- [x] å‰¯ä½œç”¨å»é‡æŒä¹…åŒ–ï¼špersist() å†™å…¥ GameState.metadataï¼Œrestore() æ¢å¤ï¼›crash recovery æµ‹è¯• 8/8 é€šè¿‡ âœ…
- [x] åŒ tick å¢å¼ºï¼šBehaviorEngine._fired_behaviors å›åˆå†…å»é‡ï¼›FLASH_EVALUATE è‡ªç„¶è±å…ï¼›TestRoundDedup 4/4 é€šè¿‡ âœ…
- [ ] AdminWorldRuntimeï¼šstart_session + get_current_location æ­£å¸¸å·¥ä½œï¼ˆé˜¶æ®µ 2 ä¸åŠ¨ï¼‰
- [x] æµ‹è¯•åŸºçº¿ï¼š62 failed / 570 passed / 11 errors âœ…ï¼ˆ+12 æ–°æµ‹è¯•ï¼‰

---

## å˜æ›´æ—¥å¿—

| æ—¥æœŸ | æ“ä½œ |
|------|------|
| 2026-02-20 | åˆ›å»ºéª¨æ¶ |
| 2026-02-20 | **å…¨é¢è°ƒæŸ¥å®Œæˆ**ï¼š5 è·¯å¹¶è¡Œå®¡è®¡ï¼ˆLLM ä¾èµ–å…¨æ™¯ã€IntentExecutor è°ƒç”¨é“¾ã€æµ‹è¯•åŸºçº¿åˆ†ç±»ã€V4Tools+SessionRuntime æ··åˆå±‚ã€BehaviorEngine åŒ tickï¼‰ã€‚æŠ¤æ  G1-G3 å°±ä½ã€‚å­ä»»åŠ¡ä» 4 ä¸ªç»†åŒ–ä¸ºå…·ä½“æ–¹æ¡ˆã€‚å…³é”®å‘ç°ï¼šåŒ tick æ˜¯æœ‰æ„è®¾è®¡ä¸å¯åˆå¹¶ï¼›SessionRuntime æ—  LLMï¼›app/world/ ä»… 2 æ–‡ä»¶éœ€æ‹†åˆ† |
| 2026-02-20 | **Preflight éªŒè¯å®Œæˆ**ï¼š4 è·¯å¹¶è¡ŒéªŒè¯ï¼ˆFlashOperation æ­»åˆ†æ”¯ã€talk_pending åè®®æ¼æ´ã€NpcReactor å¯¼å…¥ç«™ç‚¹ã€AdminWorldRuntime æ®‹ç•™è°ƒç”¨ï¼‰ã€‚å‘ç°ï¼šFlashOperation 7 ä¸ªæ­»æšä¸¾å€¼ï¼ˆç”Ÿäº§é›¶è°ƒç”¨ï¼Œæ ‡è®°æ­»ä»£ç ä¸å¤„ç†ï¼‰ï¼›talk_pending ç¼ºå·¥å…·è¿‡æ»¤ï¼ˆå¿…é¡» preflight ä¿®å¤ï¼‰ï¼›NpcReactor ä»… 2 ä¸ªå¯¼å…¥ç«™ç‚¹ï¼ˆå…¼å®¹å¯¼å‡ºé›¶ç ´åï¼‰ï¼›AdminWorldRuntime start_session/get_current_location ä»è¢« REST æ´»è·ƒè°ƒç”¨ï¼ˆä¸åˆ é™¤ï¼‰ |
| 2026-02-20 | **ç¬¬ä¸€æ¬¡æ‰§è¡Œå®Œæˆï¼ˆP1+2.1+2.2ï¼‰**ï¼šP1 æ·±å…¥åˆ†æåè·³è¿‡ï¼ˆtalk_pending æ’é™¤ä¼šé˜»æ–­ GM å…œåº•è·¯å¾„ï¼Œä¸åº”æ·»åŠ ï¼‰ã€‚2.1 IntentExecutor.execute_talk() å‰¥ç¦» flash_cpuï¼ŒNPC å¯¹è¯ç”Ÿæˆä¸Šç§»åˆ° PipelineOrchestrator._pipeline_npc_dialogue()ï¼Œflash_cpu æ„é€ å‚æ•°ç§»é™¤ã€‚2.2 NpcReactor è¿ç§»åˆ° app/services/npc_reactor.pyï¼ŒåŸä½ç•™å…¼å®¹ shimã€‚éªŒè¯ï¼šapp/world/ é›¶ LLM import âœ…ï¼ŒåŸºçº¿ 62 failed/558 passed/11 errors âœ… |
| 2026-02-20 | **ç¬¬äºŒæ¬¡æ‰§è¡Œå®Œæˆï¼ˆ2.3+2.4ï¼‰**ï¼š2.3 å‰¯ä½œç”¨å»é‡æŒä¹…åŒ– â€” `_applied_side_effect_events` å†™å…¥ `GameState.metadata["_applied_side_effects"]`ï¼ˆpersist å†™ + restore è¯»ï¼Œcap 200ï¼‰ã€‚2.4 åŒ tick è¡Œä¸ºçº§å»é‡ â€” BehaviorEngine æ–°å¢ `_fired_behaviors: Set[Tuple[str, str]]`ï¼Œ`_evaluate_and_execute()` å¤´éƒ¨æ£€æŸ¥é˜»æ­¢åŒå›åˆé‡å¤æ‰§è¡Œï¼ŒFLASH_EVALUATE è‡ªç„¶è±å…ï¼ˆpre-tick ä¸æ‰§è¡Œ â†’ ä¸å…¥é›†åˆ â†’ post-tick æ­£å¸¸æ‰§è¡Œï¼‰ã€‚ä¿®å¤ TestTickCooldown ä¸ºæ¯è½®æ–°å»º engineï¼ˆç¬¦åˆç”Ÿäº§å®é™…ï¼‰ã€‚éªŒè¯ï¼š62 failed/570 passed/11 errors âœ…ï¼ˆ+12 æ–°æµ‹è¯•ï¼‰ |
