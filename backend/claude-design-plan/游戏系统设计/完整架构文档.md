
> **修订说明**：本文档已根据实际代码验证修正，标注了当前线上入口与Pro-First v2的区别。

## 一、系统全景图

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              玩家输入层                                          │
│                        (自然语言 / 按钮操作)                                     │
└──────────────────────────────────┬──────────────────────────────────────────────┘
                                   │
                                   ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                           FastAPI 路由层                                         │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐ │
│  │ /graphs  │ │ /flash   │ │  /pro    │ │   /gm    │ │  /game   │ │/gm(master)│ │
│  │(图谱CRUD)│ │(记忆层)  │ │(对话层)  │ │(事件层)  │ │(循环层)  │ │(编排层)  │ │
│  └──────────┘ └──────────┘ └──────────┘ └──────────┘ └──────────┘ └──────────┘ │
└──────────────────────────────────┬──────────────────────────────────────────────┘
                                   │
                                   ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                      AdminCoordinator (单例编排器)                               │
│                                                                                  │
│  ⚠️ 当前线上入口 (Legacy):                                                       │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │  process_player_input()                                                  │   │
│  │  └─ 实际调用 FlashCPUService.process_player_input()                     │   │
│  │  └─ 规则驱动的简单路由（/go、/talk、/time等命令）                        │   │
│  │  └─ 默认返回空 narration，由 ProDM 填充（main_model 默认是 Flash）       │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                  │
│  ✅ Pro-First v2 (已上线 /api/gm/{world_id}/sessions/{session_id}/input_v2):                                                   │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │  process_player_input_v2() - 七步流程                                    │   │
│  │                                                                          │   │
│  │  1. _build_context()      ←── 收集上下文（位置、时间、场景）             │   │
│  │         ↓                                                                │   │
│  │  2. pro_dm.parse_intent() ←── Pro解析玩家意图（Flash LLM）              │   │
│  │         ↓                                                                │   │
│  │  3. _execute_flash_requests() ←── Flash执行操作（导航、对话等）         │   │
│  │         ↓                                                                │   │
│  │  4. party_service.sync()  ←── 同步队友位置                              │   │
│  │         ↓                                                                │   │
│  │  5. pro_dm.narrate_v2()   ←── 生成叙述（默认 main_model=Flash，可配置）│   │
│  │         ↓                                                                │   │
│  │  6. teammate_response()   ←── 队友响应（可见性管理）                    │   │
│  │         ↓                                                                │   │
│  │  7. _distribute_event()   ←── [TODO] 事件分发给队友图谱                 │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
└──────────────────────────────────┬──────────────────────────────────────────────┘
                                   │
         ┌─────────────────────────┼─────────────────────────┐
         │                         │                         │
         ▼                         ▼                         ▼
┌─────────────────┐   ┌─────────────────────┐   ┌─────────────────────┐
│   ProDMService  │   │  FlashCPUService    │   │  AdminWorldRuntime  │
│                 │   │                     │   │                     │
│ • parse_intent()│   │ • execute_request() │   │ • navigate()        │
│ • narrate_v2()  │   │ • 10类Flash操作     │   │ • advance_time()    │
│ • LLM意图解析   │   │ • 默认fallback直连  │   │ • get_location()    │
│                 │   │                     │   │ • enter_sublocation │
└────────┬────────┘   └──────────┬──────────┘   └──────────┬──────────┘
         │                       │                         │
         │     ┌─────────────────┴─────────────────┐       │
         │     │                                   │       │
         ▼     ▼                                   ▼       ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              MCP 工具层                                          │
│                                                                                  │
│  ⚠️ 重要：FlashCPUService 默认直连服务，绕过 MCP 子进程                          │
│  代码注释："MCP 客户端库有 bug，且 MCP 工具本质上只是调用同样的方法"             │
│  → MCP 为可选/备用路径，实际执行通过 fallback 直接调用服务方法                   │
│                                                                                  │
│   ┌─────────────────────────────────────────────────────────────────────────┐   │
│   │                    Game Tools MCP Server                                 │   │
│   │  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌───────┐ │   │
│   │  │NPC工具  │ │路人工具 │ │叙述工具 │ │导航工具 │ │时间工具 │ │图谱   │ │   │
│   │  │         │ │         │ │         │ │         │ │         │ │工具   │ │   │
│   │  │get_inst │ │spawn    │ │progress │ │navigate │ │get_time │ │query  │ │   │
│   │  │respond  │ │respond  │ │maps     │ │enter    │ │advance  │ │upsert │ │   │
│   │  │persist  │ │despawn  │ │trigger  │ │leave    │ │         │ │recall │ │   │
│   │  └─────────┘ └─────────┘ └─────────┘ └─────────┘ └─────────┘ └───────┘ │   │
│   └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                  │
│   ┌─────────────────────────────────────────────────────────────────────────┐   │
│   │                    Combat MCP Server (14个工具)                          │   │
│   │  start_combat | start_combat_session | get_available_actions |          │   │
│   │  get_available_actions_for_actor | execute_action |                     │   │
│   │  execute_action_for_actor | get_combat_state | get_combat_events |      │   │
│   │  get_pending_turn_requests | get_combat_result | resolve_combat_session │   │
│   │  register_enemy_template | register_enemy_archetype | list_enemy_templates│   │
│   └─────────────────────────────────────────────────────────────────────────┘   │
└──────────────────────────────────┬──────────────────────────────────────────────┘
                                   │
         ┌─────────────────────────┼─────────────────────────┐
         │                         │                         │
         ▼                         ▼                         ▼
┌─────────────────┐   ┌─────────────────────┐   ┌─────────────────────┐
│ 记忆系统        │   │   战斗引擎          │   │   Gemini API        │
│                 │   │                     │   │                     │
│ MemoryGraph     │   │ CombatEngine        │   │ Flash (快速)        │
│ (NetworkX)      │   │ (D&D规则)           │   │ gemini-3-flash-preview │
│                 │   │                     │   │                     │
│ Spreading       │   │ OpponentAI          │   │ Pro (深度)          │
│ Activation      │   │ (4种性格)           │   │ gemini-3-pro-preview │
│                 │   │                     │   │                     │
│ FlashService    │   │ 12类行动            │   │ Thinking:           │
│ (摄入/检索)     │   │ 5级距离             │   │ lowest/low/medium/high │
│                 │   │ 9种状态             │   │                     │
└────────┬────────┘   └──────────┬──────────┘   └──────────┬──────────┘
         │                       │                         │
         └───────────────────────┴─────────────────────────┘
                                 │
                                 ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                           Firestore 持久化层 (已修正)                            │
│                                                                                  │
│   worlds/{world_id}/                                                            │
│   ├── graphs/{graph_type}/                   ← 世界级知识图谱                   │
│   │   ├── nodes/{node_id}                                                       │
│   │   └── edges/{edge_id}                                                       │
│   ├── characters/{char_id}/                  ← 角色级记忆图谱                   │
│   │   ├── nodes/{node_id}                                                       │
│   │   └── edges/{edge_id}                                                       │
│   ├── maps/{map_id}/                         ← 地图数据                         │
│   │   ├── info/data                          ← 地图元数据                       │
│   │   ├── graphs/shared_memory/              ← 地点级共享记忆图谱               │
│   │   ├── sub_locations/{sub_location_id}/   ← 子地点                           │
│   │   │   └── graphs/shared_memory/          ← 子地点共享记忆图谱               │
│   │   └── npcs/                              ← NPC分配与路人模板                │
│   │       ├── assignments                    ← 地图NPC分配                      │
│   │       └── passerby_templates             ← 路人模板                         │
│   └── sessions/{session_id}                  ← 会话数据（文档，非子集合）       │
│       └── metadata.admin_state               ← 游戏状态存储位置                 │
│                                                                                  │
│   ⚠️ Legacy MCP 使用不同路径:                                                    │
│   users/{user_id}/sessions/{session_id}/messages ← 消息流                       │
└─────────────────────────────────────────────────────────────────────────────────┘
```

---

## 二、核心服务详解

### 2.1 Admin 编排层（4个核心服务）

| 服务 | 文件 | 职责 |
|------|------|------|
| **AdminCoordinator** | `admin_coordinator.py` | 单例编排器，协调所有子系统，包含Legacy流程与Pro-First v2 |
| **ProDMService** | `pro_dm_service.py` | 意图解析(Flash) + 叙述生成(main_model可配置) |
| **FlashCPUService** | `flash_cpu_service.py` | 快速操作执行引擎，处理10类Flash操作（含未实现项） |
| **AdminWorldRuntime** | `world_runtime.py` | 世界状态运行时：导航、时间、子地点管理 |

### 2.2 Flash 操作类型（完整 10 个）

```python
FlashOperation (app/models/admin_protocol.py):
├── # 实例管理
├── SPAWN_PASSERBY         # 生成路人NPC
├── NPC_DIALOGUE           # NPC对话
├── # 事件系统
├── BROADCAST_EVENT        # 广播事件
├── GRAPHIZE_EVENT         # 事件图谱化 [未实现]
├── RECALL_MEMORY          # 回忆记忆
├── # 导航/时间
├── NAVIGATE               # 导航到新地点
├── UPDATE_TIME            # 推进游戏时间
├── ENTER_SUBLOCATION      # 进入子地点
├── # 战斗
├── START_COMBAT           # 开始战斗
└── # 章节
└── TRIGGER_NARRATIVE_EVENT # 触发叙事事件
```

### 2.3 意图类型（完整 14 个）

```python
IntentType (app/models/admin_protocol.py):
# 导航类 (4个)
NAVIGATION              # 移动到某地点
ENTER_SUB_LOCATION      # 进入子地点
LEAVE_SUB_LOCATION      # 离开子地点 [新增]
LOOK_AROUND             # 观察环境

# 对话类 (3个)
NPC_INTERACTION         # 与NPC交互
TEAM_INTERACTION        # 与队友交互
END_DIALOGUE            # 结束对话

# 战斗类 (2个)
START_COMBAT            # 发起战斗
COMBAT_ACTION           # 战斗中的行动

# 时间类 (2个)
WAIT                    # 等待/消磨时间
REST                    # 休息

# 特殊类 (3个)
SYSTEM_COMMAND          # 系统命令
ROLEPLAY                # 纯角色扮演
UNKNOWN                 # 无法解析
```

---

## 三、记忆系统架构

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              三层记忆架构                                        │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│   ┌─────────────────┐        ┌─────────────────┐        ┌─────────────────┐    │
│   │    热记忆       │   ──>  │    温记忆       │   ──>  │    冷记忆       │    │
│   │  (会话内)       │        │  (归档话题)     │        │  (向量索引)     │    │
│   │                 │        │                 │        │  [占位未实现]   │    │
│   │ 最近消息        │        │ 提炼的话题      │        │ 语义检索        │    │
│   │ 实时对话        │        │ 线程和洞见      │        │                 │    │
│   └─────────────────┘        └─────────────────┘        └─────────────────┘    │
│                                                                                  │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│   ┌─────────────────────────────────────────────────────────────────────────┐   │
│   │                    MemoryGraph (NetworkX MultiDiGraph)                   │   │
│   │                                                                          │   │
│   │    节点类型: identity | person | location | event | rumor | knowledge    │   │
│   │              | item | organization | goal | emotion | location_ref |     │   │
│   │              person_ref | item_ref                                      │   │
│   │    边关系: located_in | part_of | owns | works_at | family | friend      │   │
│   │            | enemy | colleague | knows | participated | witnessed        │   │
│   │            | heard_about | caused | believes | suspects | knows_that     │   │
│   │            | likes | fears | trusts | hates | refers_to                 │   │
│   │    内存索引 (仅2个): _type_index | _name_index                          │   │
│   │    ⚠️ 注：无 _day_index，时间索引在 Firestore timeline 子集合            │   │
│   │                                                                          │   │
│   │    核心操作:                                                             │   │
│   │    • add_node() / remove_node()                                         │   │
│   │    • add_edge() / remove_edge()                                         │   │
│   │    • expand_nodes() - 多跳邻居展开                                      │   │
│   │    • subgraph() - 子图提取                                              │   │
│   └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                  │
│   ┌─────────────────────────────────────────────────────────────────────────┐   │
│   │                    SpreadingActivation (扩散激活算法)                    │   │
│   │                                                                          │   │
│   │    参数:                                                                 │   │
│   │    • max_iterations: 3       # 最大迭代次数                             │   │
│   │    • decay: 0.6              # 衰减因子                                 │   │
│   │    • fire_threshold: 0.1     # 激发阈值                                 │   │
│   │    • output_threshold: 0.15  # 输出阈值                                 │   │
│   │    • hub_threshold: 20       # 枢纽阈值                                 │   │
│   │    • hub_penalty: 0.5        # 枢纽惩罚                                 │   │
│   │    • max_activation: 1.0     # 最大激活值                               │   │
│   │    • convergence_threshold:0.01 # 收敛阈值                             │   │
│   │    • lateral_inhibition: false # 侧向抑制默认关闭                       │   │
│   │    • inhibition_factor: 0.1  # 抑制因子                                 │   │
│   │                                                                          │   │
│   │    流程: 种子节点 → 传播 → 衰减 →（可选抑制）→ 收敛 → 输出激活节点     │   │
│   └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘
```

---

## 四、战斗系统架构

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              战斗引擎 (D&D风格)                                  │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│   ┌─────────────────────────────────────────────────────────────────────────┐   │
│   │  战斗状态流转                                                            │   │
│   │  IDLE → INITIALIZED → IN_PROGRESS → WAITING_PLAYER_INPUT → ENDED       │   │
│   └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                  │
│   ┌──────────────────────────┐    ┌──────────────────────────┐                 │
│   │  12类行动                │    │  5级距离系统             │                 │
│   │                          │    │                          │                 │
│   │  ATTACK      (action)    │    │  ENGAGED   (近战接触)    │                 │
│   │  OFFHAND     (bonus)     │    │  CLOSE     (1步)         │                 │
│   │  THROW       (action)    │    │  NEAR      (2步)         │                 │
│   │  SHOVE       (bonus)     │    │  FAR       (3步)         │                 │
│   │  SPELL       (varies)    │    │  DISTANT   (4步+)        │                 │
│   │  DEFEND      (action)    │    │                          │                 │
│   │  MOVE        (movement)  │    └──────────────────────────┘                 │
│   │  DASH        (action)    │                                                  │
│   │  DISENGAGE   (action)    │    ┌──────────────────────────┐                 │
│   │  USE_ITEM    (bonus)     │    │  9种状态效果             │                 │
│   │  FLEE        (action)    │    │                          │                 │
│   │  END_TURN    (free)      │    │  POISONED   STUNNED      │                 │
│   │                          │    │  DEFENDING  BURNING      │                 │
│   └──────────────────────────┘    │  PRONE      FRIGHTENED   │                 │
│                                    │  BLINDED    RESTRAINED   │                 │
│   ┌──────────────────────────┐    │  DISENGAGED HIDDEN       │                 │
│   │  AI性格系统              │    │                          │                 │
│   │                          │    └──────────────────────────┘                 │
│   │  cowardly   - HP<30%逃跑 │                                                  │
│   │  aggressive - 永不逃跑   │    ┌──────────────────────────┐                 │
│   │  pack_hunter- 集火受伤   │    │  骰子系统                │                 │
│   │  defensive  - HP<50%防御 │    │                          │                 │
│   │                          │    │  d20() → 1-20           │                 │
│   └──────────────────────────┘    │  roll("2d8+3")          │                 │
│                                    │  advantage/disadvantage │                 │
│                                    │  CRITICAL: 20 / MISS: 1 │                 │
│                                    └──────────────────────────┘                 │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘
```

---

## 五、数据模型体系

### 5.1 状态管理模型

```python
GameState                          # 游戏主状态
├── session_id: str
├── world_id: str
├── player_location: str           # 当前地点ID
├── sub_location: str              # 子地点ID
├── game_time: GameTimeState       # 游戏时间
│   ├── day: int
│   ├── hour: int
│   ├── minute: int
│   └── period: "dawn"|"day"|"dusk"|"night"
├── chat_mode: "think"|"say"       # 内心独白/出声说
├── active_dialogue_npc: str       # 当前对话NPC
├── combat_id: str                 # 当前战斗ID
├── party_id: str                  # 队伍ID
└── metadata: Dict
```

### 5.2 图谱数据模型

```python
MemoryNode                         # 记忆节点
├── id: str
├── type: str                      # identity|person|location|event|rumor|knowledge|item|organization|goal|emotion|location_ref|person_ref|item_ref
├── name: str
├── importance: float              # 0-1权重
├── properties: Dict               # 扩展属性
└── created_at/updated_at

MemoryEdge                         # 记忆边
├── id: str
├── source: str → target: str
├── relation: str                  # located_in|part_of|owns|works_at|family|friend|enemy|colleague|knows|participated|witnessed|heard_about|caused|believes|suspects|knows_that|likes|fears|trusts|hates|refers_to
├── weight: float
└── properties: Dict
```

### 5.3 事件模型

```python
Event
├── type: EventType                # SCENE_CHANGE|DIALOGUE|ACTION|COMBAT|SYSTEM|CUSTOM
├── timestamp: datetime
├── game_day: int
├── location: str
├── participants: List[str]        # 参与者
├── witnesses: List[str]           # 见证人
├── content: EventContent
├── visibility: EventVisibility    # public + known_to列表
├── nodes: List[MemoryNode]
└── edges: List[MemoryEdge]
```

---

## 六、LLM模型策略 (已修正)

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              模型配置 (app/config.py)                            │
├───────────────┬──────────────────────────┬──────────────────────────────────────┤
│    配置项      │        默认值             │              说明                    │
├───────────────┼──────────────────────────┼──────────────────────────────────────┤
│ gemini_flash  │ gemini-3-flash-preview   │  快速推理                            │
│ gemini_main   │ gemini-3-flash-preview   │  ⚠️ 默认是flash，不是pro             │
│ gemini_pro    │ gemini-3-pro-preview     │  深度推理                            │
├───────────────┼──────────────────────────┼──────────────────────────────────────┤
│ thinking_level│ lowest|low|medium|high   │  ⚠️ 包含 lowest                      │
└───────────────┴──────────────────────────┴──────────────────────────────────────┘

补充说明:
- ProDMService.narrate_v2() 走 LLMService.main_model（默认是 Flash，可通过配置切 Pro）

NPC三层AI策略 (app/services/tiered_ai_service.py):
┌─────────────────┬────────────────┬─────────────────┬────────────────────────────┐
│  NPCTier        │    AITier      │    模型         │    说明                    │
├─────────────────┼────────────────┼─────────────────┼────────────────────────────┤
│  PASSERBY       │    FAST        │  Flash          │  最简回复，无工具          │
│  (路人)         │                │  (无thinking)   │                            │
├─────────────────┼────────────────┼─────────────────┼────────────────────────────┤
│  SECONDARY      │  SUBCONSCIOUS  │  Flash          │  较详细回复                │
│  (次要NPC)      │                │  +thinking:med  │                            │
├─────────────────┼────────────────┼─────────────────┼────────────────────────────┤
│  MAIN           │    DEEP        │  Pro            │  完整对话，支持记忆工具    │
│  (主要NPC)      │                │  +thinking:low  │                            │
└─────────────────┴────────────────┴─────────────────┴────────────────────────────┘

关键映射 (TIER_BY_NPC):
  NPCTier.PASSERBY → AITier.FAST
  NPCTier.SECONDARY → AITier.SUBCONSCIOUS
  NPCTier.MAIN → AITier.DEEP
```

---

## 七、API端点总览

### 7.1 六大路由模块

| 路由 | 前缀 | 核心功能 |
|------|------|----------|
| graphs | `/api/graphs/` | 图谱CRUD、激活扩散、索引查询 |
| flash | `/api/flash/` | 记忆摄入/检索（结构化+自然语言） |
| pro | `/api/pro/` | 角色档案、上下文组装、对话 |
| gm | `/api/gm/` | 事件摄入、智能视角分发 |
| game | `/api/game/` | 会话、导航、战斗、路人、叙事 |
| game_master | `/api/gm/` | 完整游戏循环编排 |

### 7.2 核心端点

```
# 游戏循环（最重要）
POST /api/gm/{world_id}/sessions/{session_id}/input      ← 旧版（兼容）
POST /api/gm/{world_id}/sessions/{session_id}/input_v2   ← Pro-First v2（推荐）

# 导航系统
POST /api/game/{world_id}/sessions/{session_id}/navigate
POST /api/game/{world_id}/sessions/{session_id}/sub-location/enter

# 对话系统
POST /api/pro/{world_id}/characters/{character_id}/chat

# 战斗系统
POST /api/game/{world_id}/sessions/{session_id}/combat/start
POST /api/game/{world_id}/sessions/{session_id}/combat/resolve

# 记忆系统
POST /api/flash/{world_id}/characters/{character_id}/recall-natural
POST /api/gm/{world_id}/events/ingest-natural
```

---

## 八、队伍系统

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              队伍系统架构                                        │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│   Party                              TeammateResponseService                    │
│   ├── party_id                       ├── decide_response()    # 判断是否回应   │
│   ├── leader_id ("player")           ├── generate_response()  # 生成回应内容   │
│   ├── members: [PartyMember]         └── process_round()      # 处理整轮回应   │
│   ├── current_location                                                          │
│   └── share_events: bool             TeammateVisibilityManager                  │
│                                       ├── 队友只知道自己见证的事件               │
│   PartyMember                         ├── 后生成的队友可见前者回应               │
│   ├── character_id                    └── 上下文过滤（隐藏不相关信息）           │
│   ├── name                                                                       │
│   ├── role                                                                       │
│   └── joined_at                                                                  │
│                                                                                  │
│   队友响应流程:                                                                  │
│   ┌─────────────────────────────────────────────────────────────────────────┐   │
│   │  1. 遍历每个队友                                                        │   │
│   │  2. decide_response() - Flash判断是否回应（基于性格、情绪、话题相关性） │   │
│   │  3. generate_response() - Pro/Flash生成回应                             │   │
│   │  4. 累积可见上下文（后者可见前者回应）                                   │   │
│   │  5. 返回 TeammateRoundResult                                            │   │
│   └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘
```

---

## 九、关键文件路径

```
app/
├── main.py                         # FastAPI入口
├── config.py                       # 配置系统（模型、窗口、池化）
│
├── routers/                        # API路由层
│   ├── graphs.py                   # 图谱CRUD
│   ├── flash.py                    # 记忆层
│   ├── pro.py                      # 对话层
│   ├── gm.py                       # 事件层
│   ├── game.py                     # 游戏循环
│   └── game_master.py              # 编排层
│
├── services/                       # 业务服务层
│   ├── admin/                      # Admin编排层
│   │   ├── admin_coordinator.py    # 核心编排器
│   │   ├── pro_dm_service.py       # 意图解析+叙述
│   │   ├── flash_cpu_service.py    # Flash执行引擎
│   │   └── world_runtime.py        # 世界状态运行时
│   │
│   ├── memory_graph.py             # 记忆图谱（NetworkX）
│   ├── spreading_activation.py     # 扩散激活算法
│   ├── flash_service.py            # 角色记忆操作
│   ├── party_service.py            # 队伍管理
│   ├── teammate_response_service.py # 队友响应
│   └── state_manager.py            # 状态管理
│
├── mcp/                            # MCP工具层
│   ├── game_tools_server.py        # 游戏MCP服务器
│   └── tools/
│       ├── npc_tools.py            # NPC工具
│       ├── passerby_tools.py       # 路人工具
│       ├── narrative_tools.py      # 叙事工具
│       ├── navigation_tools.py     # 导航工具
│       ├── time_tools.py           # 时间工具
│       └── graph_tools.py          # 图谱工具
│
├── combat/                         # 战斗系统
│   ├── combat_engine.py            # 战斗引擎核心
│   ├── combat_mcp_server.py        # 战斗MCP接口
│   ├── ai_opponent.py              # 敌人AI
│   ├── enemy_registry.py           # 敌人模板
│   ├── rules.py                    # 规则常量
│   ├── dice.py                     # 骰子系统
│   └── models/                     # 战斗数据模型
│
├── models/                         # Pydantic数据模型
│   ├── state_delta.py              # 状态增量
│   ├── admin_protocol.py           # Admin协议
│   ├── game_action.py              # 游戏行动
│   └── party.py                    # 队伍模型
│
└── prompts/                        # 提示词模板
    ├── pro_dm_system.md            # DM系统提示
    ├── flash_cpu_system.md         # Flash系统提示
    ├── intent_parse.md             # 意图解析提示
    ├── teammate_decision.md        # 队友决策提示
    └── teammate_response.md        # 队友响应提示
```

---

## 十、核心数据流图

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                           完整请求处理流程                                       │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│  玩家: "我要去森林找那个神秘的老人"                                              │
│         │                                                                        │
│         ▼                                                                        │
│  ┌─────────────────────────────────────────────────────────────────────────┐    │
│  │  AdminCoordinator.process_player_input_v2()                             │    │
│  └─────────────────────────────────────────────────────────────────────────┘    │
│         │                                                                        │
│         ▼                                                                        │
│  ┌─────────────────────────────────────────────────────────────────────────┐    │
│  │  Step 1: _build_context()                                               │    │
│  │  收集: GameState + Location + Time + ActiveNPC                          │    │
│  └─────────────────────────────────────────────────────────────────────────┘    │
│         │                                                                        │
│         ▼                                                                        │
│  ┌─────────────────────────────────────────────────────────────────────────┐    │
│  │  Step 2: ProDMService.parse_intent()     [Flash LLM]                    │    │
│  │  输出: IntentParseResult                                                │    │
│  │    - intent_type: NAVIGATION                                            │    │
│  │    - target: "forest"                                                   │    │
│  │    - flash_requests: [                                                  │    │
│  │        FlashRequest(op=NAVIGATE, target="forest"),                      │    │
│  │        FlashRequest(op=NPC_DIALOGUE, target="mysterious_elder")         │    │
│  │      ]                                                                  │    │
│  └─────────────────────────────────────────────────────────────────────────┘    │
│         │                                                                        │
│         ▼                                                                        │
│  ┌─────────────────────────────────────────────────────────────────────────┐    │
│  │  Step 3: FlashCPUService._execute_flash_requests()                      │    │
│  │                                                                         │    │
│  │  for FlashRequest(NAVIGATE, "forest"):                                  │    │
│  │    → AdminWorldRuntime.navigate("forest")                               │    │
│  │      → calculate_path() → advance_time() → generate_travel_narration()  │    │
│  │    → StateDelta: {player_location: "forest", time: +30min}              │    │
│  │                                                                         │    │
│  │  for FlashRequest(NPC_DIALOGUE, "mysterious_elder"):                    │    │
│  │    → fallback直连: ProService.chat_simple(...)                          │    │
│  │      → （MCP可选路径，默认不走子进程）                                   │    │
│  │    → NPC回应: "年轻人，你终于来了..."                                   │    │
│  └─────────────────────────────────────────────────────────────────────────┘    │
│         │                                                                        │
│         ▼                                                                        │
│  ┌─────────────────────────────────────────────────────────────────────────┐    │
│  │  Step 4: PartyService.sync_locations()  [如有队友]                      │    │
│  │  同步所有队友位置到 "forest"                                            │    │
│  └─────────────────────────────────────────────────────────────────────────┘    │
│         │                                                                        │
│         ▼                                                                        │
│  ┌─────────────────────────────────────────────────────────────────────────┐    │
│  │  Step 5: ProDMService.narrate_v2()       [main_model 默认 Flash]        │    │
│  │  输入: 玩家输入 + 意图结果 + Flash执行结果 + 上下文                     │    │
│  │  输出: 沉浸式叙述                                                       │    │
│  │    "你穿过蜿蜒的小径，古老的森林在你面前展开。阳光透过树冠洒落，         │    │
│  │     在那棵最古老的橡树下，一位白发苍苍的老者正静静等待着你..."          │    │
│  └─────────────────────────────────────────────────────────────────────────┘    │
│         │                                                                        │
│         ▼                                                                        │
│  ┌─────────────────────────────────────────────────────────────────────────┐    │
│  │  Step 6: TeammateResponseService.process_round()  [如有队友]            │    │
│  │                                                                         │    │
│  │  for teammate in party.members:                                         │    │
│  │    1. decide_response() [Flash] → 判断是否回应                          │    │
│  │    2. if should_respond:                                                │    │
│  │         generate_response() [Pro/Flash] → 生成回应内容                  │    │
│  │    3. 累积可见上下文（后者可见前者回应）                                 │    │
│  │                                                                         │    │
│  │  输出: TeammateRoundResult                                              │    │
│  │    - responses: [{character_id: "knight", response: "这地方不太对劲"}]  │    │
│  └─────────────────────────────────────────────────────────────────────────┘    │
│         │                                                                        │
│         ▼                                                                        │
│  ┌─────────────────────────────────────────────────────────────────────────┐    │
│  │  Step 7: _distribute_event_to_party()  [TODO]                            │    │
│  │  计划：将本次交互事件注入各队友的记忆图谱（基于可见性规则）             │    │
│  └─────────────────────────────────────────────────────────────────────────┘    │
│         │                                                                        │
│         ▼                                                                        │
│  ┌─────────────────────────────────────────────────────────────────────────┐    │
│  │  返回: CoordinatorResponse                                              │    │
│  │  {                                                                      │    │
│  │    "narration": "你穿过蜿蜒的小径...",                                  │    │
│  │    "speaker": "GM",                                                     │    │
│  │    "teammate_responses": [{"character_id": "knight", ...}],             │    │
│  │    "available_actions": ["与老者交谈", "四处查看", "返回村庄"],          │    │
│  │    "state_delta": {"player_location": "forest", "time": {...}},         │    │
│  │    "npc_response": "年轻人，你终于来了..."                              │    │
│  │  }                                                                      │    │
│  └─────────────────────────────────────────────────────────────────────────┘    │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘
```

---

## 十一、设计亮点总结（区分已实现/待实现）

| 特性 | 实现方式 | 状态 | 效果 |
|------|----------|------|------|
| **Legacy游戏循环** | FlashCPU规则路由 | ✅ 已实现 | 当前线上入口 |
| **Pro-First架构** | 先解析再执行再叙述 | 🚧 v2未挂路由 | 精确意图理解 |
| **双层记忆** | MemoryGraph + SpreadingActivation | ✅ 已实现 | 上下文感知的智能回忆 |
| **三层NPC** | AITier: FAST/SUBCONSCIOUS/DEEP | ✅ 已实现 | 成本与质量平衡 |
| **队伍可见性** | TeammateVisibilityManager | ✅ 框架 | 真实的角色视角差异 |
| **队友事件分发** | _distribute_event_to_party | 🚧 TODO | 队友图谱记忆 |
| **D&D战斗** | 12行动+5距离+9状态 | ✅ 已实现 | 策略深度的战斗体验 |
| **MCP工具化** | 游戏+战斗MCP Server | ⚠️ 备用路径 | 默认直连fallback |
| **增量状态** | StateDelta追踪 | ✅ 已实现 | 精确的状态变更审计 |

---

## 十二、开发者工具生态（犄角旮旯）

### 12.1 三层CLI架构（多工具）

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                         高级交互CLI（用户友好）                                   │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐              │
│  │ play_cli.py │ │game_master  │ │flash_natural│ │ pro_chat    │              │
│  │ (主游戏循环)│ │ _cli.py     │ │ _cli.py     │ │ _cli.py     │              │
│  │             │ │(GM交互测试) │ │(记忆自然语言)│ │(Pro对话)    │              │
│  │ ~1521行     │ │ ~568行      │ │ ~254行      │ │ ~169行      │              │
│  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘              │
│                                                                                  │
│  play_cli.py 核心命令:                                                          │
│  • go <地点> | enter/leave <子地点>  ← 导航系统                                 │
│  • talk <NPC> | bye/end              ← 对话系统                                 │
│  • party add/remove | teammates      ← 队伍系统                                 │
│  • time | wait [分钟]                ← 时间系统                                 │
│  • combat | attack/defend            ← 战斗系统                                 │
│  • debug | graph | recall | ingest   ← 调试命令                                 │
├─────────────────────────────────────────────────────────────────────────────────┤
│                         中级JSON接口（测试用）                                   │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐              │
│  │ flash_cli   │ │ pro_cli     │ │ gm_cli      │ │ game_cli    │              │
│  │ (记忆JSON)  │ │(对话JSON)   │ │(事件JSON)   │ │(循环JSON)   │              │
│  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘              │
├─────────────────────────────────────────────────────────────────────────────────┤
│                         低级服务层（核心逻辑）                                   │
│  AdminCoordinator → FlashService → ProService → GraphStore                     │
└─────────────────────────────────────────────────────────────────────────────────┘
```

### 12.2 六阶段世界初始化流程

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                        Worldbook → Firestore 流水线                              │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│  Phase 1: 预处理                    lorebook_prep.py                            │
│  ┌─────────────────────────────────────────────────────────────────┐           │
│  │  worldbook_full.md (1.76MB) ──→ 条目分割 ──→ entries.jsonl     │           │
│  └─────────────────────────────────────────────────────────────────┘           │
│                                   ↓                                             │
│  Phase 2: 全局摘要生成              global_summary.py                           │
│  ┌─────────────────────────────────────────────────────────────────┐           │
│  │  entries.jsonl ──→ LLM分析 ──→ global_summary.json             │           │
│  │                               (实体ID标准化)                     │           │
│  └─────────────────────────────────────────────────────────────────┘           │
│                                   ↓                                             │
│  Phase 3: 批请求生成                request_generator.py                        │
│  ┌─────────────────────────────────────────────────────────────────┐           │
│  │  entries + summary ──→ Batch请求 ──→ batch_requests.jsonl      │           │
│  └─────────────────────────────────────────────────────────────────┘           │
│                                   ↓                                             │
│  Phase 4-5: Gemini Batch API        job_manager.py                              │
│  ┌─────────────────────────────────────────────────────────────────┐           │
│  │  batch_requests.jsonl ──→ Gemini API ──→ batch_results.jsonl   │           │
│  │                          (离线大规模处理)                        │           │
│  └─────────────────────────────────────────────────────────────────┘           │
│                                   ↓                                             │
│  Phase 6: 结果处理                  result_processor.py                         │
│  ┌─────────────────────────────────────────────────────────────────┐           │
│  │  batch_results.jsonl ──→ 解析+验证 ──→ structured/ (8个JSON)   │           │
│  │                                        ├── maps.json            │           │
│  │                                        ├── characters.json      │           │
│  │                                        ├── world_graph.json     │           │
│  │                                        ├── mainlines.json       │           │
│  │                                        └── ...                  │           │
│  └─────────────────────────────────────────────────────────────────┘           │
│                                   ↓                                             │
│  加载到Firestore                    init_world_cli.py load                      │
│  ┌─────────────────────────────────────────────────────────────────┐           │
│  │  structured/ ──→ WorldInitializer ──→ Firestore                │           │
│  │                  ├── map_loader.py                              │           │
│  │                  └── character_loader.py                        │           │
│  └─────────────────────────────────────────────────────────────────┘           │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘

命令示例:
$ python -m app.tools.init_world_cli graphize --worldbook data/goblin_slayer/worldbook_full.md
$ python -m app.tools.init_world_cli load --world goblin_slayer --data-dir data/goblin_slayer/structured/
$ python -m app.tools.init_world_cli verify --world goblin_slayer
```

### 12.3 NPC三层分类系统

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                           NPC Tier 分类体系                                      │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐                 │
│  │      MAIN       │  │    SECONDARY    │  │    PASSERBY     │                 │
│  │    (主要角色)   │  │   (次要角色)    │  │    (路人)       │                 │
│  ├─────────────────┤  ├─────────────────┤  ├─────────────────┤                 │
│  │ 例: goblin_slayer│  │ 例: guild_girl  │  │ 例: 市场小贩    │                 │
│  │     priestess   │  │     cow_girl    │  │     旅店客人    │                 │
│  ├─────────────────┤  ├─────────────────┤  ├─────────────────┤                 │
│  │ LLM: Pro        │  │ LLM: Flash      │  │ LLM: Flash      │                 │
│  │ 记忆: 完整图谱  │  │ 记忆: 基础图谱  │  │ 记忆: 地点共享图谱│                 │
│  │ 持久: 永久      │  │ 持久: 永久      │  │ 持久: 实例不持久  │                 │
│  │ 对话: 深度理解  │  │ 对话: 较详细    │  │ 对话: 简短回复  │                 │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘                 │
│                                                                                  │
│  路人生成系统:                                                                   │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │  PasserbyTemplate                     PasserbyInstance                   │   │
│  │  ├── name_pool: ["张三", "李四"]      ├── instance_id (唯一)             │   │
│  │  ├── personality_pool                 ├── template_id (来源模板)         │   │
│  │  ├── appearance_pool                  ├── map_id + sub_location_id       │   │
│  │  ├── speech_pattern                   ├── mood: "neutral"|"happy"|...    │   │
│  │  └── default_map                      ├── spawn_time                     │   │
│  │                                       └── interaction_count               │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                  │
│  生成率配置 (per sub_location, 示例，实际由 maps.json 提供):                    │
│  • market (市场): 0.8 passerby_rate                                             │
│  • tavern (酒馆): 0.7                                                           │
│  • guild_hall: 0.6                                                              │
│  • temple: 0.3                                                                  │
│  • blacksmith: 0.2                                                              │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘
```

### 12.4 事件生成器（随机事件系统）

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                        EventGenerator 随机事件体系                               │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│  事件类型分布:                                                                   │
│  ┌───────────────┬────────┬───────────────────────────────────────────────┐    │
│  │ 类型          │ 权重   │ 描述                                           │    │
│  ├───────────────┼────────┼───────────────────────────────────────────────┤    │
│  │ ENCOUNTER     │  50%   │ 战斗/社交遭遇                                  │    │
│  │ DISCOVERY     │  20%   │ 物品/地点发现                                  │    │
│  │ AMBIANCE      │  15%   │ 氛围描写（无交互）                             │    │
│  │ WEATHER       │  15%   │ 天气环境变化                                   │    │
│  └───────────────┴────────┴───────────────────────────────────────────────┘    │
│                                                                                  │
│  危险等级 → 遭遇表:                                                             │
│  ┌───────────────┬───────────────────────────────────────────────────────┐     │
│  │ low           │ 旅行商人, 巡逻卫兵, 流浪者, 野兔                       │     │
│  │ medium        │ 野狼, 哥布林斥候, 受伤冒险者, 神秘商人                 │     │
│  │ high          │ 哥布林小队, 强盗, 受困旅队, 狼群                       │     │
│  │ extreme       │ 哥布林战群+首领, 食人魔, 巨魔                          │     │
│  └───────────────┴───────────────────────────────────────────────────────┘     │
│                                                                                  │
│  时间修正:                                                                       │
│  ┌───────────────┬───────────────┬───────────────────────────────────────┐     │
│  │ TimePeriod    │ 概率修正      │ 特殊效果                               │     │
│  ├───────────────┼───────────────┼───────────────────────────────────────┤     │
│  │ DAWN          │ ×1.2          │ -                                      │     │
│  │ DAY           │ ×1.0          │ 基准                                   │     │
│  │ DUSK          │ ×1.2          │ -                                      │     │
│  │ NIGHT         │ ×1.5          │ -                                      │     │
│  └───────────────┴───────────────┴───────────────────────────────────────┘     │
│                                                                                  │
│  战斗模板 (与Combat Engine集成):                                                 │
│  ┌───────────────┬────────┬────────┬───────────┬──────────┬──────────┐        │
│  │ 敌人          │ HP     │ AC     │ 攻击加值  │ 伤害     │ XP       │        │
│  ├───────────────┼────────┼────────┼───────────┼──────────┼──────────┤        │
│  │ 哥布林        │ 15     │ 13     │ +3        │ 1d6+1    │ 50       │        │
│  │ 兽人战士      │ 30     │ 15     │ +5        │ 1d8+3    │ 100      │        │
│  │ 野狼          │ 20     │ 14     │ +4        │ 1d6+2    │ 75       │        │
│  └───────────────┴────────┴────────┴───────────┴──────────┴──────────┘        │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘
```

### 12.5 地图导航系统深层架构

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                           AreaNavigator 导航架构                                 │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│  双层导航:                                                                       │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │  Map-to-Map (地图间)                 Within-Map (地图内)                 │   │
│  │  ┌───────────┐                       ┌───────────────────────────────┐  │   │
│  │  │ frontier  │ ←─ A* 寻路 ─→        │ frontier_town                 │  │   │
│  │  │  _town    │   (30min+)            │ ├── guild_hall (子地点)       │  │   │
│  │  └─────┬─────┘                       │ ├── blacksmith                │  │   │
│  │        │                             │ ├── tavern                    │  │   │
│  │  ┌─────┴─────┐                       │ ├── temple                    │  │   │
│  │  │ dark      │                       │ ├── market                    │  │   │
│  │  │  _forest  │                       │ └── ...                       │  │   │
│  │  └───────────┘                       └───────────────────────────────┘  │   │
│  │                                       (即时切换，无时间消耗)             │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                  │
│  MapArea 数据结构:                                                               │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │  MapArea:                                                                │   │
│  │  ├── id: "frontier_town"                                                │   │
│  │  ├── name: "边境小镇"                                                   │   │
│  │  ├── description: "..."                                                 │   │
│  │  ├── atmosphere: "bustling"                                             │   │
│  │  ├── danger_level: "low"|"medium"|"high"|"extreme"                      │   │
│  │  ├── region: "frontier"                                                 │   │
│  │  ├── connections: [MapConnection]  ← 有向图边                           │   │
│  │  │   ├── target_map_id                                                   │   │
│  │  │   ├── travel_time: "30分钟"/"1小时"/"半天" 等                         │   │
│  │  │   ├── connection_type: "travel"|"gate"|"teleport"|"secret"           │   │
│  │  │   └── requirements: Dict                                             │   │
│  │  ├── available_actions: ["探索", "休息", ...]                           │   │
│  │  ├── key_features: ["喷泉广场", ...]                                    │   │
│  │  ├── resident_npcs: ["guild_girl", ...]                                 │   │
│  │  └── sub_locations: Dict[str, SubLocation]                              │   │
│  │      └── SubLocation:                                                   │   │
│  │          ├── id, name, description                                      │   │
│  │          ├── interaction_type: "visit"|"shop"|"quest"|"rest"|"craft"|"worship"│   │
│  │          ├── resident_npcs: []                                          │   │
│  │          ├── passerby_spawn_rate: 0.0-1.0                               │   │
│  │          ├── travel_time_minutes: int                                  │   │
│  │          └── available_actions: []                                      │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                  │
│  寻路算法: A* (支持多跳路径)                                                     │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │  navigate(from="town", to="dungeon")                                    │   │
│  │  → find_path() [A*]                                                     │   │
│  │  → segments: [                                                          │   │
│  │      {from: "town", to: "forest", time: 45min, danger: "medium"},       │   │
│  │      {from: "forest", to: "dungeon", time: 30min, danger: "high"}       │   │
│  │    ]                                                                    │   │
│  │  → check_travel_event() per segment                                     │   │
│  │  → advance_time(total_minutes)                                          │   │
│  │  → generate_travel_narration()                                          │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘
```

### 12.6 遗留代码（Legacy MCP系统）

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                     app/legacy_mcp/ - 第一代记忆系统（已隔离）                   │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│  完整的三层记忆实现（热/温/冷）:                                                 │
│                                                                                  │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │  legacy_mcp/                                                             │   │
│  │  ├── memory_gateway.py      # 主记忆网关 (25KB)                         │   │
│  │  │   └── 工具: session_snapshot, memory_request, memory_commit          │   │
│  │  ├── firestore_service.py   # Firestore读写 (28KB)                      │   │
│  │  ├── message_stream.py      # 消息流管理                                │   │
│  │  ├── truncate_archiver.py   # 截断归档（热→温记忆）                     │   │
│  │  ├── message_assembler.py   # 上下文组装                                │   │
│  │  ├── topic_state.py         # 话题状态管理                              │   │
│  │  ├── embedding_service.py   # 向量嵌入服务                              │   │
│  │  ├── embedding.py           # 嵌入算法                                  │   │
│  │  ├── server.py              # 内部MCP服务器                             │   │
│  │  ├── mcp_standard_server.py # 标准MCP协议服务器                         │   │
│  │  └── models.py              # 数据模型（APIMessage, Topic, Thread等）   │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                  │
│  设计意图:                                                                       │
│  • 保留作为参考实现和回退方案                                                    │
│  • 已被新的 Pro-Flash 架构逐步替代                                               │
│  • 支持多种embedding提供商（Gemini/Cloudflare）                                  │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘
```

### 12.7 设计文档体系

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                           项目设计文档结构                                       │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│  顶层哲学文档:                                                                   │
│  ├── /设计概念.md (~1000行)                                                     │
│  │   ├── 系统哲学：模拟独立意识体共存                                           │
│  │   ├── 数据模型：三类图谱（世界观/GM/角色）                                   │
│  │   ├── 激活扩散算法伪代码 + 参数表                                            │
│  │   └── Flash三大任务的Prompt模板                                              │
│  │                                                                               │
│  └── /MEMORY_GATEWAY_INTEGRATION.md                                             │
│      └── MCP记忆网关接入文档（Legacy系统）                                       │
│                                                                                  │
│  阶段设计文档 (design2/):                                                        │
│  ├── phase3_flash_foundation.md    # Flash服务基础                              │
│  ├── phase4_pro_foundation.md      # Pro对话服务                                │
│  ├── phase5_gm_foundation.md       # GM Flash + 事件总线                        │
│  ├── phase6_game_loop_foundation.md # 完整游戏循环                              │
│  └── phase6_完成报告.md            # 验收标准与交付物                           │
│                                                                                  │
│  系统架构规划 (claude-design-plan/游戏系统设计/):                                │
│  ├── 完整架构文档.md               # 全景架构蓝图                               │
│  ├── 中心化架构重构计划.md         # 关键设计决策                               │
│  │   └── 从分散式→中心化: System Admin Layer 替换 GameMasterService             │
│  ├── NPC实例池架构设计.md          # 实例管理策略                               │
│  └── 箱庭驱动世界初始化系统设计.md # 世界初始化流程                             │
│                                                                                  │
│  Prompt模板 (app/prompts/):                                                      │
│  ├── intent_parse.md               # 13种意图类型规范                           │
│  ├── pro_dm_system.md              # DM角色定义                                 │
│  ├── flash_cpu_system.md           # Flash规则引擎提示                          │
│  ├── teammate_decision.md          # 队友决策逻辑                               │
│  ├── teammate_response.md          # 队友响应生成                               │
│  └── travel_narration.md           # 旅行场景叙述                               │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘
```

---

## 十三、项目演进与成熟度

### 13.1 Phase演进路线

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│  Phase 1: 图谱基础设施       ✅ 完成                                             │
│  ├── MemoryGraph (NetworkX)                                                     │
│  └── GraphStore (Firestore)                                                     │
├─────────────────────────────────────────────────────────────────────────────────┤
│  Phase 2: 世界观图谱         ✅ 完成                                             │
│  ├── Worldbook解析器                                                            │
│  └── 批处理系统                                                                  │
├─────────────────────────────────────────────────────────────────────────────────┤
│  Phase 3: Flash记忆服务      ✅ 完成                                             │
│  ├── FlashService                                                               │
│  └── 扩散激活算法                                                                │
├─────────────────────────────────────────────────────────────────────────────────┤
│  Phase 4: Pro+Flash联动      ✅ 完成                                             │
│  ├── ProService                                                                 │
│  └── 记忆工具调用                                                                │
├─────────────────────────────────────────────────────────────────────────────────┤
│  Phase 5: GM Flash+事件总线  ✅ 完成                                             │
│  ├── GMService                                                                  │
│  └── 多视角事件分发                                                              │
├─────────────────────────────────────────────────────────────────────────────────┤
│  Phase 6: 完整游戏循环       ✅ 完成（v2已上线）                                 │
│  ├── AdminCoordinator                                                           │
│  ├── Pro-First七步流程                                                          │
│  └── 战斗系统集成                                                                │
└─────────────────────────────────────────────────────────────────────────────────┘
```

### 13.2 待完成功能（从TODO注释）

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│  发现的TODO (关键):                                                              │
│                                                                                  │
│  admin_coordinator.py:                                                          │
│  └── # TODO: 实际写入队友图谱 (teammate memory persistence)                     │
│      ⚠️ _distribute_event_to_party() 尚未实现，队友图谱记忆仍为框架             │
│                                                                                  │
│  combat_engine.py:                                                              │
│  ├── # TODO: 从玩家状态读取金币 (dynamic currency system)                       │
│  ├── # TODO: 跟踪使用的物品 (item tracking)                                     │
│  └── # TODO: 物品掉落逻辑 (loot generation system)                              │
│                                                                                  │
│  flash_cpu_service.py:                                                          │
│  └── GRAPHIZE_EVENT 返回 "not implemented yet"                                  │
│                                                                                  │
│  状态说明:                                                                       │
│  • process_player_input_v2() 存在但未挂路由                                      │
│  • 队友事件分发仍为TODO，文档标注"七步流程"会误导读者认为已上线                  │
│  • 核心Legacy循环可用，Pro-First新架构待完成                                    │
└─────────────────────────────────────────────────────────────────────────────────┘
```

### 13.3 新增关键模块（需补充到记忆系统）

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│  当前NPC工作记忆/图谱化关键链路:                                                 │
│                                                                                  │
│  ActionOptionsService (app/services/action_options_service.py)                  │
│  └── 选项生成服务（当前未接入主流程，旧版仍用 _get_available_actions）           │
│                                                                                  │
│  ContextWindow (app/services/context_window.py)                                 │
│  └── NPC工作记忆窗口管理                                                        │
│                                                                                  │
│  InstanceManager (app/services/instance_manager.py)                             │
│  └── NPC实例池化与上下文缓存                                                    │
│                                                                                  │
│  MemoryGraphizer (app/services/memory_graphizer.py)                             │
│  └── 事件→图谱节点/边的自动转换                                                 │
│                                                                                  │
│  ⚠️ 这些是当前系统实际工作的核心链路，应标注为"新链路"                          │
└─────────────────────────────────────────────────────────────────────────────────┘
```

---

## 十四、隐藏的设计洞察

| 设计点 | 实现细节 | 设计意图 |
|--------|----------|----------|
| **分阶段演进** | Phase 1-6独立验收 | 增量开发，每阶段可独立测试 |
| **双模式处理** | 自然语言CLI + JSON接口 | 快速原型 + 自动化测试兼顾 |
| **三层CLI** | 高级交互→中级JSON→低级服务 | 不同用户群体的入口 |
| **遗留隔离** | legacy_mcp/独立目录 | 保留参考实现，不影响主线 |
| **调试友好** | 每层输出tier_used/model/latency | 快速定位LLM决策问题 |
| **离线处理** | Gemini Batch API | 大规模Worldbook处理解耦 |
| **图谱中心** | 所有信息流向知识图谱 | 事件→节点边双向转换 |
| **Prompt配置化** | prompts/目录MD文件 | 提示词版本管理 |

---

## 十五、完整文件路径速查

```
核心运行时:
├── play_cli.py                              # 主游戏入口 (推荐)
├── app/services/admin/admin_coordinator.py  # 核心编排器
├── app/services/admin/pro_dm_service.py     # Pro DM服务
├── app/services/admin/flash_cpu_service.py  # Flash CPU服务
└── app/services/admin/world_runtime.py      # 世界运行时

记忆系统:
├── app/services/memory_graph.py             # 图谱基础
├── app/services/spreading_activation.py     # 扩散激活
├── app/services/flash_service.py            # Flash服务
└── app/legacy_mcp/                          # 遗留记忆系统

世界初始化:
├── app/tools/init_world_cli.py              # 初始化入口
├── app/tools/worldbook_graphizer/           # Worldbook解析
├── app/tools/world_initializer/             # Firestore加载
└── app/tools/batch/                         # 批处理系统

游戏数据:
├── data/goblin_slayer/structured/           # 结构化数据
│   ├── maps.json                            # 地图定义
│   ├── characters.json                      # 角色数据
│   ├── world_graph.json                     # 知识图谱 (600KB+)
│   └── mainlines.json                       # 主线故事

设计文档:
├── /设计概念.md                             # 系统哲学
├── /design2/                                # 阶段设计
└── /claude-design-plan/游戏系统设计/        # 架构规划

MCP工具:
├── app/mcp/game_tools_server.py             # 游戏MCP
├── app/mcp/tools/                           # 工具实现
└── app/combat/combat_mcp_server.py          # 战斗MCP

配置与提示:
├── app/config.py                            # 全局配置
├── .env                                     # 环境变量
└── app/prompts/                             # Prompt模板
```

---

*此架构文档基于对整个后端代码库的深度分析生成，包含主路径和犄角旮旯的完整覆盖*
