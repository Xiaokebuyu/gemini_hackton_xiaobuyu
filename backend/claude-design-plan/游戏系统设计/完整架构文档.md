# AI驱动RPG游戏后端 - 完整架构文档

## 一、项目总览

**技术栈**: FastAPI + Firestore + Google Gemini（默认 Gemini 3 系列） + NetworkX + MCP

**核心能力**:
- 三层记忆系统（热/温/冷）
- 双层认知架构（Flash潜意识 + Pro意识）
- 三层NPC AI响应
- 知识图谱与扩散激活
- D&D风格战斗系统
- MCP工具协议集成

---

## 二、项目目录结构

```
backend/
├── app/                              # 主应用代码
│   ├── main.py                       # FastAPI 入口
│   ├── config.py                     # 全局配置 (Pydantic)
│   ├── routers/                      # API 路由层
│   ├── services/                     # 业务逻辑层
│   ├── models/                       # 数据模型层
│   ├── mcp/                          # MCP 工具服务器
│   ├── combat/                       # 战斗系统
│   ├── tools/                        # CLI 工具集
│   ├── legacy_mcp/                   # 旧版 MCP/记忆网关（保留）
│   ├── utils/                        # 通用工具函数
│   ├── rules.py                      # 旧版战斗规则常量
│   └── prompts/                      # 系统提示词
├── data/                             # 世界数据 (goblin_slayer)
├── tests/                            # 测试代码
├── requirements.txt                  # Python 依赖
├── .env                              # 环境变量
└── CLAUDE.md                         # 项目规范
```

---

## 三、整体架构图

```
┌──────────────────────────────────────────────────────────────────────────────┐
│                              客户端 (CLI / Web)                               │
└───────────────────────────────────┬──────────────────────────────────────────┘
                                    │
                                    ▼
┌──────────────────────────────────────────────────────────────────────────────┐
│                           FastAPI 应用层 (main.py)                            │
│  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐    │
│  │ /game   │ │ /gm     │ │ /graphs │ │ /flash  │ │ /pro    │ │/game_   │    │
│  │ 游戏循环│ │GM事件   │ │图谱管理 │ │角色记忆 │ │角色对话 │ │master   │    │
│  └────┬────┘ └────┬────┘ └────┬────┘ └────┬────┘ └────┬────┘ └────┬────┘    │
└───────┼──────────┼──────────┼──────────┼──────────┼──────────┼──────────────┘
        │          │          │          │          │          │
        └──────────┴──────────┴──────────┴──────────┴──────────┘
                                    │
                                    ▼
┌──────────────────────────────────────────────────────────────────────────────┐
│                        Admin 协调层 (AdminCoordinator)                        │
│  ┌────────────────┐  ┌────────────────┐  ┌────────────────┐                  │
│  │ FlashCPUService│  │ ProDMService   │  │ StateManager   │                  │
│  │ 规则引擎/MCP   │  │ 叙述生成       │  │ 状态管理       │                  │
│  └───────┬────────┘  └───────┬────────┘  └───────┬────────┘                  │
│          │                   │                   │                            │
│  ┌───────┴───────────────────┴───────────────────┴───────┐                   │
│  │              AdminWorldRuntime (世界运行时)            │                   │
│  │         导航 | 时间 | 会话 | 事件 | 状态持久化         │                   │
│  └───────────────────────────────────────────────────────┘                   │
└──────────────────────────────────┬───────────────────────────────────────────┘
                                   │
        ┌──────────────────────────┼──────────────────────────┐
        │                          │                          │
        ▼                          ▼                          ▼
┌───────────────┐        ┌─────────────────┐        ┌─────────────────┐
│  MCP 工具层    │        │   服务层         │        │  战斗 MCP       │
│ Game Tools    │        │  Services       │        │ Combat Server   │
│ ┌───────────┐ │        │ ┌─────────────┐ │        │ ┌─────────────┐ │
│ │ NPC工具   │ │        │ │FlashService │ │        │ │CombatEngine │ │
│ │ 路人工具  │ │        │ │ProService   │ │        │ │AIOpponent   │ │
│ │ 章节工具  │ │        │ │GraphStore   │ │        │ │DiceSystem   │ │
│ │ 导航工具  │ │        │ │MemoryGraph  │ │        │ │Rules/Effects│ │
│ │ 时间工具  │ │        │ │NarrativeServ│ │        │ │EnemyRegistry│ │
│ │ 图谱工具  │ │        │ │PasserbyServ │ │        │ └─────────────┘ │
│ └───────────┘ │        │ │InstanceMgr  │ │        └────────┬────────┘
└───────┬───────┘        │ │TieredAIServ │ │                 │
        │                │ └─────────────┘ │                 │
        │                └────────┬────────┘                 │
        │                         │                          │
        └─────────────────────────┼──────────────────────────┘
                                  │
                                  ▼
┌──────────────────────────────────────────────────────────────────────────────┐
│                              外部服务层                                       │
│  ┌─────────────────┐   ┌─────────────────┐   ┌─────────────────┐            │
│  │ Google Gemini   │   │ Google Firestore│   │ NetworkX        │            │
│  │ ├─flash-preview │   │ ├─worlds/       │   │ (内存图谱)      │            │
│  │ ├─pro-preview   │   │ │ ├─characters/ │   │ ├─激活扩散      │            │
│  │ └─embedding-004 │   │ │ ├─graphs/     │   │ ├─子图提取      │            │
│  └─────────────────┘   │ │ ├─maps/       │   │ └─路径查找      │            │
│                        │ │ └─sessions/   │   └─────────────────┘            │
│                        │ └───────────────┘                                   │
└──────────────────────────────────────────────────────────────────────────────┘
```

---

## 四、路由层详解 (app/routers/)

| 路由模块 | 前缀 | 核心端点（均带 `/api` 前缀） | 职责 |
|---------|------|----------------------------|------|
| **game.py** | /game | /{world_id}/sessions, /sessions/start, /combat/start, /combat/resolve, /navigate, /location, /time, /time/advance, /sub-location/enter|leave, /sub-locations, /narrative/*, /passersby/* | 游戏会话、战斗、导航、叙事与路人 |
| **game_master.py** | /gm | /{world_id}/sessions, /context, /scene, /input, /dialogue/start|end, /combat/trigger|action, /advance-day | GM主控完整循环 |
| **gm.py** | /gm | /{world_id}/events/ingest, /events/ingest-natural | GM事件管理 |
| **graphs.py** | /graphs | /{world_id}/{graph_type}, /subgraph, /index/*, /nodes, /edges, /activation | 知识图谱 CRUD（graph_type: gm / ontology / character） |
| **flash.py** | /flash | /{world_id}/characters/{character_id}/ingest|recall|ingest-natural|recall-natural | 角色记忆系统 |
| **pro.py** | /pro | /{world_id}/characters/{character_id}/profile|context|chat | 角色对话系统 |

---

## 五、服务层详解 (app/services/)

### 5.1 Admin 层服务

```
app/services/admin/
├── admin_coordinator.py      # 单例协调器入口
├── flash_cpu_service.py      # 规则引擎 + MCP客户端
├── pro_dm_service.py         # 叙述生成
├── state_manager.py          # GameState + StateDelta（内存态）
├── world_runtime.py          # 导航/时间/会话
├── event_llm_service.py      # 自然语言事件解析/编码
└── event_service.py          # 事件系统（结构化/自然语言）
```

### 5.2 双层认知服务

#### Flash 层（潜意识/长期记忆）
| 服务 | 职责 |
|-----|------|
| flash_service.py | 单角色记忆操作（ingest/recall）|
| flash_llm_service.py | 自然语言→结构化编码 |
| flash_pro_bridge.py | Flash与Pro通信桥接 |

#### Pro 层（意识/工作记忆）
| 服务 | 职责 |
|-----|------|
| pro_service.py | 角色意识核心（profile/context/chat）|
| pro_llm_service.py | 对话LLM + 工具调用 |
| pro_context_builder.py | 组装完整上下文Prompt |

### 5.3 游戏运行时服务

| 服务 | 职责 |
|-----|------|
| game_session_store.py | 会话状态持久化 |
| narrative_service.py | 四层叙事（主线→章节→地图→地点）|
| passerby_service.py | 路人NPC生成与管理 |
| instance_manager.py | NPC实例池（LRU淘汰）|
| context_window.py | 单NPC工作记忆（200K tokens）|
| area_navigator.py | 区域导航和地点管理 |
| time_manager.py | 游戏时间管理 |
| event_generator.py | 事件生成与渲染 |

### 5.4 基础设施服务

| 服务 | 职责 |
|-----|------|
| graph_store.py | Firestore图谱持久化（含 LocationGraphStore 与索引） |
| graph_schema.py | 图谱类型/关系校验 |
| memory_graph.py | NetworkX 内存图操作 |
| memory_graphizer.py | 对话/事件图谱化 |
| spreading_activation.py | 激活扩散算法 |
| llm_service.py | Gemini调用封装 |
| reference_resolver.py | 引用解析 |
| tiered_ai_service.py | 三层NPC AI路由 |
| event_bus.py | 事件总线（内存） |

---

## 六、数据模型层 (app/models/)

### 6.1 核心模型

```
app/models/
├── activation.py             # SpreadingActivationConfig
├── admin_protocol.py         # FlashOperation, FlashRequest, FlashResponse
├── context_window.py         # ContextWindowState, GraphizeRequest, WindowMessage
├── event.py                  # Event, GMEventIngestRequest
├── flash.py                  # EventIngestRequest, RecallRequest
├── game.py                   # GameSessionState, CombatContext
├── graph.py                  # MemoryNode, MemoryEdge, GraphData
├── graph_elements.py         # EventGroupNode, EventNode, GraphEdgeSpec
├── graph_schema.py           # 图谱类型/关系常量
├── message.py                # Message, MessageRole
├── narrative.py              # Mainline, Chapter, NarrativeProgress
├── npc_instance.py           # NPCConfig, NPCInstanceState
├── passerby.py               # PasserbyInstance, PasserbyConfig
├── pro.py                    # CharacterProfile, ChatRequest, SceneContext
├── session.py                # Session
├── state_delta.py            # GameState, StateDelta, GameTimeState
└── topic.py                  # TopicThread, ArtifactVersion
```

### 6.2 关键数据结构

**GameState**（Flash管理的游戏状态）:
```python
session_id, world_id
player_location, sub_location
game_time: GameTimeState
chat_mode: "think" | "say"
active_dialogue_npc
combat_id
narrative_progress, metadata
```

**MemoryNode**（知识图谱节点）:
```python
id, type, name
importance, properties
created_at, updated_at
```

**CharacterProfile**（角色档案）:
```python
name
occupation, age
personality, speech_pattern
example_dialogue, system_prompt
metadata
```

---

## 七、MCP 工具层 (app/mcp/)

### 7.1 Game Tools MCP Server

```
app/mcp/
├── game_tools_server.py      # FastMCP服务器入口
└── tools/
    ├── npc_tools.py          # get_instance, npc_respond, persist_instance
    ├── passerby_tools.py     # spawn_passerby, passerby_respond, despawn
    ├── narrative_tools.py    # get_progress, get_available_maps, trigger_event
    ├── navigation_tools.py   # get_location, navigate, enter_sublocation, leave_sublocation
    ├── time_tools.py         # get_time, advance_time
    └── graph_tools.py        # query_graph, upsert_node, recall_memory
```

### 7.2 Combat MCP Server

```
app/combat/
├── combat_mcp_server.py      # 战斗MCP服务器（14个工具）
├── combat_engine.py          # 核心战斗逻辑
├── ai_opponent.py            # 敌人AI
├── dice.py                   # D20骰子系统
├── rules.py                  # D&D规则
├── effects.py                # 状态效果
├── spells.py                 # 法术系统
├── spatial.py                # 距离计算
├── enemy_registry.py         # 敌人模板库
└── models/                   # 战斗数据模型
```

**Combat MCP 工具列表**:
- start_combat
- start_combat_session
- resolve_combat_session
- get_available_actions / get_available_actions_for_actor
- execute_action / execute_action_for_actor
- get_combat_state / get_combat_events / get_pending_turn_requests
- get_combat_result
- register_enemy_template / register_enemy_archetype
- list_enemy_templates

---

## 八、三层记忆架构

```
┌─────────────────────────────────────────────────────────────┐
│                    热记忆 (会话级)                           │
│  ContextWindow - Pro的工作记忆                              │
│  容量: 200K tokens（instance_pool_context_window_size 默认） │
│  实时对话 | 会话内有效                                       │
└─────────────────────────────┬───────────────────────────────┘
                              │ 溢出时
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                    温记忆 (图谱级)                           │
│  MemoryGraph - Flash的长期记忆                              │
│  每角色独立图谱 + GM世界图谱 | 激活扩散检索                  │
└─────────────────────────────┬───────────────────────────────┘
                              │ 时间衰减
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                    冷记忆 (向量级) [占位]                    │
│  Embedding + 向量搜索 | 暂未启用                            │
└─────────────────────────────────────────────────────────────┘
```

> 注：`memory_window_tokens` 等配置仍保留在 config 中，主要用于 legacy/记忆网关路径，与 NPC 的 `ContextWindow` 配置相互独立。

---

## 九、三层NPC AI架构

```
┌─────────────────────────────────────────────────────────────┐
│                   NPC 响应层级决策树                         │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│   PASSERBY (路人)      SECONDARY (次要)      MAIN (主要)    │
│        ↓                    ↓                    ↓          │
│     [FAST]            [SUBCONSCIOUS]          [DEEP]        │
│        ↓                    ↓                    ↓          │
│  gemini-3-             gemini-3-flash        gemini-3-pro   │
│   flash-preview        (medium thinking)     (low thinking)  │
│   (无思考)               (中等思考)             (低思考)       │
│   (无工具)              (MCP记忆工具)        (完整记忆)      │
│   (<100ms)              (~500ms)             (~2s)          │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

> 注：具体模型与 thinking_level 可通过 `npc_tier_config` 环境变量覆盖。

---

## 十、数据流图

### 10.1 玩家输入处理流

```
玩家输入
    │
    ▼
AdminCoordinator.process_player_input()
    │
    ├──► FlashCPUService.process_player_input()
    │    ├── 系统命令识别 (/think, /say, /mode think|say, /time, /where|/location, /go|/navigate, /talk, /end|/leave)
    │    ├── 对话上下文处理 → _npc_respond()
    │    ├── SAY模式多NPC广播
    │    ├── 战斗输入路由 → call_combat_tool()
    │    └── 默认路径 → 返回给Pro处理
    │
    └──► [如果Flash无响应]
         ProDMService.narrate()
         ├── 加载 pro_dm_system.md
         ├── 补充上下文（地点、时间、氛围）
         └── LLMService.generate_response()
    │
    ▼
返回响应给客户端
```

### 10.2 记忆检索流

```
Pro.chat() 对话请求
    │
    ├──► LLM分析是否需要记忆
    │
    ├─[需要]─► Flash.recall_memory()
    │          ├── LLM理解查询意图
    │          ├── 图谱中找种子节点
    │          ├── spread_activation() 扩散激活
    │          └── extract_subgraph() 提取子图
    │
    └──► LLM最终生成回复（含thinking）
         │
         ▼
    ChatResponse (回复 + 记忆信息)
```

### 10.3 GM事件分发流

```
GM自然语言事件描述
    │
    ▼
AdminEventService.ingest_event_natural()
    │
    ├──► EventLLMService.parse_event()
    │    └── 提取参与者、目击者、地点
    │
    ├──► EventLLMService.encode_gm_event()
    │    └── 生成GM图谱节点和边
    │
    ├──► GraphStore.upsert_node/edge("gm")
    │    └── 写入GM客观图谱
    │
    └──► dispatch_to_characters()
         for character_id in recipients:
             _dispatch_to_character()
             ├── 参与者 → 第一人称视角
             ├── 目击者 → 第三人称视角
             └── 其他角色 → 传闻/间接
             │
             ▼
         FlashService.ingest_event(character_id)
         └── 写入角色私有图谱
```

---

## 十一、CLI 工具集 (app/tools/)

### 11.1 世界初始化

```bash
# 阶段1：世界书图谱化
python -m app.tools.init_world_cli graphize \
    --worldbook data/goblin_slayer/worldbook_full.md \
    --output data/goblin_slayer/structured/

# 阶段2：加载到Firestore
python -m app.tools.init_world_cli load \
    --world goblin_slayer \
    --data-dir data/goblin_slayer/structured/

# 验证模式
python -m app.tools.init_world_cli load --world goblin_slayer --dry-run
```

### 11.2 游戏测试

```bash
# 交互式GM工具
python -m app.tools.game_master_cli

# LLM对话测试
python -m app.tools.flash_natural_cli
python -m app.tools.pro_chat_cli
```

### 11.3 批处理流水线

```
worldbook.json → lorebook_prep.py → entries.jsonl
                          ↓
              global_summary.py → summary.json
                          ↓
           request_generator.py → batch_requests.jsonl
                          ↓
                job_manager.py → [Gemini Batch API]
                          ↓
           result_processor.py → world_graph.json
```

### 11.4 其它常用工具（节选）

```bash
# 本地交互/调试
python -m app.tools.game_cli
python -m app.tools.gm_cli
python -m app.tools.pro_cli
python -m app.tools.flash_cli

# 图谱/数据操作
python -m app.tools.graph_importer --input data.json --world demo_world --graph ontology
python -m app.tools.graph_indexer --world demo_world --graph ontology
python -m app.tools.graph_review
```

---

## 十二、配置系统 (app/config.py)

### 12.1 外部服务/模型配置

| 配置项 | 默认值 | 说明 |
|-------|-------|------|
| google_application_credentials | ./firebase-credentials.json | Firebase 凭证路径 |
| firestore_database | (default) | Firestore数据库 |
| gemini_api_key | (必需) | Gemini API密钥 |
| gemini_flash_model | gemini-3-flash-preview | Flash模型 |
| gemini_main_model | gemini-3-flash-preview | 通用模型 |
| gemini_pro_model | gemini-3-pro-preview | Pro模型 |
| gemini_embedding_model | text-embedding-004 | 向量模型 |

### 12.2 Admin / MCP 配置

| 配置项 | 默认值 | 说明 |
|-------|-------|------|
| admin_flash_model | gemini-3-flash-preview | Admin Flash 模型 |
| admin_pro_model | gemini-3-pro-preview | Admin Pro 模型 |
| admin_flash_thinking_level | low | Admin Flash 思考层级 |
| admin_pro_thinking_level | low | Admin Pro 思考层级 |
| mcp_tools_transport | stdio | Game Tools 传输方式 |
| mcp_tools_command | python | Game Tools 启动命令 |
| mcp_tools_args | -m app.mcp.game_tools_server | Game Tools 启动参数 |
| mcp_combat_command | python | Combat MCP 启动命令 |
| mcp_combat_args | -m app.combat.combat_mcp_server | Combat MCP 启动参数 |

### 12.3 记忆系统/实例池配置

| 配置项 | 默认值 | 说明 |
|-------|-------|------|
| memory_window_tokens | 120,000 | memory gateway 窗口（legacy） |
| memory_insert_budget_tokens | 20,000 | 插入预算 |
| instance_pool_max_instances | 20 | NPC实例池上限 |
| instance_pool_context_window_size | 200,000 | ContextWindow 大小 |
| instance_pool_graphize_threshold | 0.9 | 图谱化阈值 |
| instance_pool_keep_recent_tokens | 50,000 | 图谱化后保留 token |
| instance_pool_evict_after_minutes | 30 | 实例淘汰阈值 |

### 12.4 三层AI配置

| 配置项 | 默认值 | 说明 |
|-------|-------|------|
| npc_tier_config.passerby_model | gemini-3-flash-preview | 路人模型 |
| npc_tier_config.secondary_model | gemini-3-flash-preview | 次要角色模型 |
| npc_tier_config.main_model | gemini-3-pro-preview | 主要角色模型 |
| npc_tier_config.secondary_thinking | medium | 次要角色思考层级 |
| npc_tier_config.main_thinking | low | 主要角色思考层级 |

> 注：`GEMINI_FAST_MODEL` / `GEMINI_SUBCONSCIOUS_MODEL` / `GEMINI_DEEP_MODEL` 仍保留配置，但当前三层 NPC 主要使用 `npc_tier_config`。

---

## 十三、Firestore 数据结构

```
firestore://
├── worlds/{world_id}/
│   ├── meta/info                      # 世界元数据（world map）
│   ├── characters/{character_id}/
│   │   ├── profile                    # CharacterProfile（字段）
│   │   ├── state                      # NPCInstanceState/instance_state（字段）
│   │   ├── nodes/                     # 角色私有记忆节点
│   │   └── edges/                     # 角色私有记忆边
│   │
│   ├── graphs/{graph_type}/           # gm / ontology
│   │   ├── nodes/
│   │   ├── edges/
│   │   ├── type_index/nodes           # 按类型索引
│   │   ├── name_index/nodes           # 按名称索引
│   │   └── timeline/events            # 时间线索引
│   │
│   ├── maps/{map_id}/
│   │   ├── info/data                  # MapInfo
│   │   ├── npcs/passerby_templates    # 路人模板
│   │   ├── graphs/shared_memory/      # 地点共享记忆（Map级）
│   │   └── sub_locations/{id}/graphs/shared_memory/  # 子地点共享记忆（可选）
│   │
│   └── sessions/{session_id}          # GameSessionState 文档
│       ├── metadata.narrative         # 叙事进度
│       └── metadata.admin_state       # GameState (Admin层)
```

---

## 十四、提示词系统 (app/prompts/)

| 文件 | 角色 | 输出格式 |
|-----|------|---------|
| flash_cpu_system.md | 系统执行层(CPU) | 严格JSON |
| pro_dm_system.md | 游戏主持人(DM) | 自然文本 |
| travel_narration.md | 旅途叙述 | 沉浸式第二人称 |

---

## 十五、技术指标（运行时/数据相关）

| 指标 | 值 |
|------|-----|
| 世界书大小 | 取决于 data/{world_id}/worldbook_* |
| 知识图谱节点/边 | 取决于导入与运行时生成 |
| 地图/角色数量 | 取决于 maps.json / characters.json |
| MCP工具数 | 32（Game Tools 18 + Combat 14） |
| CLI工具数 | 多项（见 app/tools） |
| API路由数 | 以 app/routers 实际定义为准 |

---

## 十六、核心设计特点

1. **三层记忆系统** - 热(工作记忆) + 温(图谱) + 冷(向量)
2. **双层认知架构** - Flash(潜意识/长期) + Pro(意识/对话)
3. **激活扩散检索** - 基于NetworkX的关联记忆
4. **智能视角分发** - GM事件自动转化为多角色视角
5. **NPC实例池** - 200K tokens工作记忆 + LRU淘汰
6. **三层NPC AI** - PASSERBY(快) → SECONDARY(中) → MAIN(深)
7. **MCP工具协议** - 标准化游戏系统接口
8. **D&D战斗系统** - 完整TTRPG战斗规则
9. **中心化Admin层** - 统一协调所有子系统
10. **StateDelta追踪** - 状态变更可审计（回滚未实现）
