<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åšå¾·ä¹‹é—¨ - å¯¼æ¼”æ¼”å‘˜æµ‹è¯•å°</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+JP:wght@400;700&family=Noto+Sans+JP:wght@300;400;500&display=swap" rel="stylesheet">
    <style>
        /* ==================== å…¨å±€æ ·å¼ ==================== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            /* æ—¥å¼è‰²å½© */
            --gold: #D4A574;
            --wood-dark: #3E2723;
            --wood-medium: #5D4037;
            --wood-light: #8D6E63;
            --paper: #FFF8E7;
            --ink: #2C2416;
            --red-seal: #C62828;
            --green-tea: #7CB342;
            
            /* é˜´å½± */
            --shadow-subtle: 0 2px 8px rgba(0,0,0,0.1);
            --shadow-medium: 0 4px 16px rgba(0,0,0,0.2);
            --shadow-strong: 0 8px 24px rgba(0,0,0,0.3);
        }

        body {
            font-family: 'Noto Sans JP', sans-serif;
            background: linear-gradient(135deg, var(--wood-dark) 0%, var(--wood-medium) 100%);
            color: var(--ink);
            min-height: 100vh;
            padding: 20px;
            background-image: 
                repeating-linear-gradient(90deg, transparent, transparent 2px, rgba(0,0,0,.05) 2px, rgba(0,0,0,.05) 4px),
                repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(0,0,0,.05) 2px, rgba(0,0,0,.05) 4px);
        }

        /* ==================== ä¸»å®¹å™¨ ==================== */
        .main-container {
            max-width: 1800px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 300px 1fr 320px;
            grid-template-rows: auto 1fr auto;
            gap: 20px;
            height: calc(100vh - 40px);
        }

        /* ==================== é¡¶éƒ¨åŒºåŸŸ ==================== */
        .header {
            grid-column: 1 / -1;
            background: var(--paper);
            border: 4px solid var(--wood-dark);
            border-radius: 8px;
            padding: 20px 30px;
            box-shadow: var(--shadow-medium);
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: -10px;
            left: -10px;
            right: -10px;
            bottom: -10px;
            background: 
                linear-gradient(45deg, transparent 48%, var(--gold) 48%, var(--gold) 52%, transparent 52%),
                linear-gradient(-45deg, transparent 48%, var(--gold) 48%, var(--gold) 52%, transparent 52%);
            background-size: 20px 20px;
            opacity: 0.1;
            z-index: 0;
        }

        .header-content {
            position: relative;
            z-index: 1;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .title {
            font-family: 'Noto Serif JP', serif;
            font-size: 32px;
            font-weight: 700;
            color: var(--wood-dark);
            text-shadow: 2px 2px 0 var(--gold);
            letter-spacing: 4px;
        }

        .session-info {
            display: flex;
            gap: 30px;
            font-size: 14px;
        }

        .info-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .info-label {
            color: var(--wood-medium);
            font-weight: 500;
        }

        .info-value {
            background: var(--wood-dark);
            color: var(--gold);
            padding: 4px 12px;
            border-radius: 4px;
            font-weight: 500;
            font-family: monospace;
        }

        .seal {
            width: 60px;
            height: 60px;
            background: var(--red-seal);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-family: 'Noto Serif JP', serif;
            font-weight: 700;
            font-size: 20px;
            box-shadow: var(--shadow-medium);
            transform: rotate(-15deg);
        }

        /* ==================== å·¦ä¾§æ  ==================== */
        .left-panel {
            grid-row: 2;
            background: var(--paper);
            border: 3px solid var(--wood-dark);
            border-radius: 8px;
            padding: 20px;
            box-shadow: var(--shadow-medium);
            overflow-y: auto;
        }

        .panel-title {
            font-family: 'Noto Serif JP', serif;
            font-size: 18px;
            font-weight: 700;
            color: var(--wood-dark);
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--gold);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .scene-card {
            background: white;
            border: 2px solid var(--wood-light);
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: var(--shadow-subtle);
        }

        .scene-name {
            font-weight: 700;
            color: var(--wood-dark);
            font-size: 16px;
            margin-bottom: 8px;
        }

        .scene-detail {
            font-size: 13px;
            color: var(--wood-medium);
            margin: 4px 0;
        }

        .npc-list {
            margin-top: 12px;
        }

        .npc-item {
            background: linear-gradient(135deg, var(--paper) 0%, white 100%);
            border-left: 3px solid var(--green-tea);
            padding: 8px 12px;
            margin: 6px 0;
            border-radius: 4px;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .npc-icon {
            width: 24px;
            height: 24px;
            background: var(--green-tea);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
            font-weight: 700;
        }

        /* ==================== ä¸­å¤®å¯¹è¯åŒº ==================== */
        .main-content {
            grid-row: 2;
            background: var(--paper);
            border: 3px solid var(--wood-dark);
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            box-shadow: var(--shadow-medium);
            overflow: hidden;
        }

        .scroll-container {
            flex: 1;
            overflow-y: auto;
            padding: 30px;
            background: 
                repeating-linear-gradient(
                    0deg,
                    transparent,
                    transparent 35px,
                    rgba(212, 165, 116, 0.1) 35px,
                    rgba(212, 165, 116, 0.1) 36px
                );
        }

        /* è‡ªå®šä¹‰æ»šåŠ¨æ¡ */
        .scroll-container::-webkit-scrollbar {
            width: 12px;
        }

        .scroll-container::-webkit-scrollbar-track {
            background: var(--wood-light);
        }

        .scroll-container::-webkit-scrollbar-thumb {
            background: var(--wood-dark);
            border-radius: 6px;
        }

        .scroll-container::-webkit-scrollbar-thumb:hover {
            background: var(--wood-medium);
        }

        /* æ¶ˆæ¯æ ·å¼ */
        .message {
            margin-bottom: 24px;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 8px;
        }

        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 16px;
            border: 2px solid;
            box-shadow: var(--shadow-subtle);
        }

        .avatar-gm {
            background: linear-gradient(135deg, var(--gold) 0%, #E6C68A 100%);
            border-color: var(--wood-dark);
            color: var(--wood-dark);
        }

        .avatar-npc {
            background: linear-gradient(135deg, var(--green-tea) 0%, #9CCC65 100%);
            border-color: var(--wood-medium);
            color: white;
        }

        .avatar-player {
            background: linear-gradient(135deg, #1976D2 0%, #42A5F5 100%);
            border-color: var(--wood-medium);
            color: white;
        }

        .avatar-system {
            background: linear-gradient(135deg, var(--wood-medium) 0%, var(--wood-light) 100%);
            border-color: var(--wood-dark);
            color: white;
        }

        .message-meta {
            flex: 1;
        }

        .message-speaker {
            font-weight: 700;
            font-size: 15px;
            color: var(--wood-dark);
        }

        .message-time {
            font-size: 11px;
            color: var(--wood-medium);
        }

        .message-content {
            background: white;
            padding: 16px 20px;
            border-radius: 8px;
            border-left: 4px solid;
            box-shadow: var(--shadow-subtle);
            line-height: 1.7;
            font-size: 15px;
        }

        .content-gm { border-left-color: var(--gold); }
        .content-npc { border-left-color: var(--green-tea); }
        .content-player { border-left-color: #42A5F5; }
        .content-system { border-left-color: var(--wood-medium); }

        .message-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 500;
            margin-left: 8px;
        }

        .badge-memory {
            background: #FFE082;
            color: var(--wood-dark);
        }

        .badge-combat {
            background: #EF5350;
            color: white;
        }

        /* ==================== å³ä¾§æ  ==================== */
        .right-panel {
            grid-row: 2;
            background: var(--paper);
            border: 3px solid var(--wood-dark);
            border-radius: 8px;
            padding: 20px;
            box-shadow: var(--shadow-medium);
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .control-section {
            background: white;
            border: 2px solid var(--wood-light);
            border-radius: 6px;
            padding: 15px;
            box-shadow: var(--shadow-subtle);
        }

        .section-title {
            font-weight: 700;
            color: var(--wood-dark);
            margin-bottom: 12px;
            font-size: 14px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--gold);
        }

        .quick-action-btn {
            width: 100%;
            padding: 10px 15px;
            margin: 6px 0;
            background: linear-gradient(135deg, var(--paper) 0%, white 100%);
            border: 2px solid var(--wood-light);
            border-radius: 6px;
            color: var(--wood-dark);
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .quick-action-btn:hover {
            background: var(--gold);
            border-color: var(--wood-dark);
            transform: translateX(4px);
            box-shadow: var(--shadow-medium);
        }

        .debug-toggle {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 0;
            font-size: 13px;
        }

        .toggle-switch {
            width: 44px;
            height: 24px;
            background: var(--wood-light);
            border-radius: 12px;
            position: relative;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .toggle-switch.active {
            background: var(--green-tea);
        }

        .toggle-switch::after {
            content: '';
            position: absolute;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            top: 2px;
            left: 2px;
            transition: left 0.3s ease;
            box-shadow: var(--shadow-subtle);
        }

        .toggle-switch.active::after {
            left: 22px;
        }

        /* ==================== åº•éƒ¨è¾“å…¥åŒº ==================== */
        .input-area {
            grid-column: 1 / -1;
            background: var(--paper);
            border: 3px solid var(--wood-dark);
            border-radius: 8px;
            padding: 20px;
            box-shadow: var(--shadow-medium);
        }

        .input-wrapper {
            display: flex;
            gap: 12px;
            align-items: flex-end;
        }

        .input-box {
            flex: 1;
            background: white;
            border: 2px solid var(--wood-light);
            border-radius: 8px;
            padding: 12px 16px;
            font-size: 15px;
            font-family: 'Noto Sans JP', sans-serif;
            resize: vertical;
            min-height: 60px;
            max-height: 200px;
            transition: border-color 0.3s ease;
        }

        .input-box:focus {
            outline: none;
            border-color: var(--gold);
            box-shadow: 0 0 0 3px rgba(212, 165, 116, 0.2);
        }

        .send-btn {
            padding: 12px 32px;
            background: linear-gradient(135deg, var(--gold) 0%, #E6C68A 100%);
            border: 2px solid var(--wood-dark);
            border-radius: 8px;
            color: var(--wood-dark);
            font-size: 15px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: var(--shadow-subtle);
            font-family: 'Noto Serif JP', serif;
        }

        .send-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
        }

        .send-btn:active {
            transform: translateY(0);
        }

        .send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* ==================== åˆå§‹åŒ–å¯¹è¯æ¡† ==================== */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            backdrop-filter: blur(4px);
        }

        .modal {
            background: var(--paper);
            border: 4px solid var(--wood-dark);
            border-radius: 12px;
            padding: 40px;
            max-width: 500px;
            width: 90%;
            box-shadow: var(--shadow-strong);
            position: relative;
        }

        .modal::before {
            content: '';
            position: absolute;
            top: 10px;
            left: 10px;
            right: 10px;
            bottom: 10px;
            border: 2px solid var(--gold);
            border-radius: 8px;
            pointer-events: none;
        }

        .modal-content {
            position: relative;
            z-index: 1;
        }

        .modal-title {
            font-family: 'Noto Serif JP', serif;
            font-size: 28px;
            font-weight: 700;
            color: var(--wood-dark);
            text-align: center;
            margin-bottom: 30px;
            text-shadow: 1px 1px 0 var(--gold);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            font-weight: 500;
            color: var(--wood-dark);
            margin-bottom: 8px;
            font-size: 14px;
        }

        .form-input {
            width: 100%;
            padding: 12px 16px;
            background: white;
            border: 2px solid var(--wood-light);
            border-radius: 6px;
            font-size: 15px;
            font-family: 'Noto Sans JP', sans-serif;
            transition: border-color 0.3s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--gold);
            box-shadow: 0 0 0 3px rgba(212, 165, 116, 0.2);
        }

        .start-btn {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, var(--gold) 0%, #E6C68A 100%);
            border: 3px solid var(--wood-dark);
            border-radius: 8px;
            color: var(--wood-dark);
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: var(--shadow-medium);
            font-family: 'Noto Serif JP', serif;
            margin-top: 10px;
        }

        .start-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-strong);
        }

        .hidden {
            display: none;
        }

        /* ==================== åŠ è½½åŠ¨ç”» ==================== */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid var(--wood-light);
            border-top-color: var(--gold);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* ==================== å“åº”å¼ ==================== */
        @media (max-width: 1400px) {
            .main-container {
                grid-template-columns: 260px 1fr 280px;
            }
        }

        @media (max-width: 1200px) {
            .main-container {
                grid-template-columns: 1fr;
                grid-template-rows: auto auto 1fr auto;
            }

            .left-panel, .right-panel {
                grid-row: auto;
            }

            .main-content {
                min-height: 400px;
            }
        }
    </style>
</head>
<body>
    <!-- åˆå§‹åŒ–æ¨¡æ€æ¡† -->
    <div id="initModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-content">
                <div class="modal-title">ğŸ® å¯åŠ¨æ¸¸æˆä¸–ç•Œ</div>
                <div class="form-group">
                    <label class="form-label">ä¸–ç•Œæ ‡è¯†ç¬¦</label>
                    <input type="text" class="form-input" id="worldInput" value="demo_world" placeholder="è¾“å…¥ä¸–ç•ŒID...">
                </div>
                <div class="form-group">
                    <label class="form-label">APIåœ°å€</label>
                    <input type="text" class="form-input" id="apiInput" value="http://localhost:8000" placeholder="åç«¯APIåœ°å€...">
                </div>
                <button class="start-btn" onclick="startGame()">
                    â›©ï¸ å¼€å¯å†’é™©
                </button>
            </div>
        </div>
    </div>

    <!-- ä¸»ç•Œé¢ -->
    <div class="main-container">
        <!-- é¡¶éƒ¨ -->
        <div class="header">
            <div class="header-content">
                <div class="title">ğŸ“œ åšå¾·ä¹‹é–€Â·è¨˜æ†¶ç·¨ç¹”</div>
                <div class="session-info">
                    <div class="info-item">
                        <span class="info-label">ä¸–ç•Œ</span>
                        <span class="info-value" id="worldId">---</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">ä¼šè¯</span>
                        <span class="info-value" id="sessionId">---</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">é˜¶æ®µ</span>
                        <span class="info-value" id="gamePhase">IDLE</span>
                    </div>
                </div>
                <div class="seal">é¨“</div>
            </div>
        </div>

        <!-- å·¦ä¾§æ  -->
        <div class="left-panel">
            <div class="panel-title">ğŸ—ºï¸ å½“å‰åœºæ™¯</div>
            <div class="scene-card" id="sceneCard">
                <div class="scene-name">æœªè¿›å…¥åœºæ™¯</div>
                <div class="scene-detail">ç­‰å¾…å¼€å§‹æ¸¸æˆ...</div>
            </div>

            <div class="panel-title" style="margin-top: 20px;">ğŸ‘¥ åœ¨åœºè§’è‰²</div>
            <div id="npcList">
                <div class="npc-item" style="opacity: 0.5;">
                    <div class="npc-icon">?</div>
                    <span>æ— </span>
                </div>
            </div>
        </div>

        <!-- ä¸­å¤®å¯¹è¯åŒº -->
        <div class="main-content">
            <div class="scroll-container" id="messageContainer">
                <div class="message">
                    <div class="message-header">
                        <div class="message-avatar avatar-system">âš™ï¸</div>
                        <div class="message-meta">
                            <div class="message-speaker">ç³»ç»Ÿ</div>
                            <div class="message-time">ç­‰å¾…å¯åŠ¨</div>
                        </div>
                    </div>
                    <div class="message-content content-system">
                        æ¬¢è¿æ¥åˆ°åšå¾·ä¹‹é—¨è®°å¿†ç¼–ç»‡ç³»ç»Ÿã€‚è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•ç•Œé¢ï¼Œç”¨äºéªŒè¯Flash+ProåŒå±‚è®¤çŸ¥æ¶æ„ã€‚
                        <br><br>
                        è¯·è¾“å…¥ä¸–ç•ŒIDå¼€å§‹æ¸¸æˆã€‚
                    </div>
                </div>
            </div>
        </div>

        <!-- å³ä¾§æ  -->
        <div class="right-panel">
            <!-- å¿«é€Ÿåœºæ™¯åˆ‡æ¢ -->
            <div class="control-section">
                <div class="section-title">ğŸ¯ åœºæ™¯ä¼ é€</div>
                <button class="quick-action-btn" onclick="enterScene('blacksmith', 'é“åŒ é“º', 'ä¸€é—´çƒ­æ°”è…¾è…¾çš„æ‰“é“ä½œåŠ')">
                    ğŸ”¨ é“åŒ é“º
                </button>
                <button class="quick-action-btn" onclick="enterScene('tavern', 'é‡‘éº¦æ—…åº—', 'å……æ»¡é…’é¦™å’Œæ¬¢å£°ç¬‘è¯­çš„æ—…åº—')">
                    ğŸº é‡‘éº¦æ—…åº—
                </button>
                <button class="quick-action-btn" onclick="enterScene('forest_edge', 'æ£®æ—è¾¹ç¼˜', 'å¹½æš—æ£®æ—çš„è¾¹ç•Œï¼Œè¿œå¤„ä¼ æ¥é‡å…½çš„åšå«')">
                    ğŸŒ² æ£®æ—è¾¹ç¼˜
                </button>
                <button class="quick-action-btn" onclick="enterScene('market', 'é›†å¸‚', 'ç†™ç†™æ”˜æ”˜çš„å¸‚åœºå¹¿åœº')">
                    ğŸª é›†å¸‚
                </button>
            </div>

            <!-- æµ‹è¯•åŠŸèƒ½ -->
            <div class="control-section">
                <div class="section-title">ğŸ”¬ æµ‹è¯•å·¥å…·</div>
                <button class="quick-action-btn" onclick="testFlash()">
                    ğŸ’­ æµ‹è¯•è®°å¿†ç¼–ç 
                </button>
                <button class="quick-action-btn" onclick="testRecall()">
                    ğŸ” æµ‹è¯•è®°å¿†æ£€ç´¢
                </button>
                <button class="quick-action-btn" onclick="viewGraph()">
                    ğŸ•¸ï¸ æŸ¥çœ‹å›¾è°±
                </button>
                <button class="quick-action-btn" onclick="triggerTestCombat()">
                    âš”ï¸ è§¦å‘æµ‹è¯•æˆ˜æ–—
                </button>
            </div>

            <!-- è°ƒè¯•å¼€å…³ -->
            <div class="control-section">
                <div class="section-title">âš™ï¸ è°ƒè¯•é€‰é¡¹</div>
                <div class="debug-toggle">
                    <span>æ˜¾ç¤ºAPIè°ƒç”¨</span>
                    <div class="toggle-switch" id="apiLogToggle" onclick="toggleDebug('apiLog')"></div>
                </div>
                <div class="debug-toggle">
                    <span>æ˜¾ç¤ºè®°å¿†è°ƒç”¨</span>
                    <div class="toggle-switch active" id="memoryLogToggle" onclick="toggleDebug('memoryLog')"></div>
                </div>
                <div class="debug-toggle">
                    <span>æ˜¾ç¤ºäº‹ä»¶åˆ†å‘</span>
                    <div class="toggle-switch active" id="eventLogToggle" onclick="toggleDebug('eventLog')"></div>
                </div>
            </div>

            <!-- å¿«æ·å¯¹è¯ -->
            <div class="control-section">
                <div class="section-title">ğŸ’¬ å¿«æ·å¯¹è¯</div>
                <button class="quick-action-btn" onclick="setInput('ä½ å¥½ï¼Œè¿™é‡Œæ˜¯å“ªé‡Œï¼Ÿ')">
                    æ‰“æ‹›å‘¼
                </button>
                <button class="quick-action-btn" onclick="setInput('æœ€è¿‘æœ‰ä»€ä¹ˆæ–°é²œäº‹å—ï¼Ÿ')">
                    æ‰“å¬æ¶ˆæ¯
                </button>
                <button class="quick-action-btn" onclick="setInput('æˆ‘èƒ½å¸®ä»€ä¹ˆå¿™å—ï¼Ÿ')">
                    æä¾›å¸®åŠ©
                </button>
                <button class="quick-action-btn" onclick="setInput('ä½ è¿˜è®°å¾—æˆ‘ä¹‹å‰åšçš„äº‹å—ï¼Ÿ')">
                    è¯¢é—®è®°å¿†
                </button>
            </div>
        </div>

        <!-- åº•éƒ¨è¾“å…¥ -->
        <div class="input-area">
            <div class="input-wrapper">
                <textarea 
                    class="input-box" 
                    id="playerInput" 
                    placeholder="è¾“å…¥ä½ çš„è¡ŒåŠ¨æˆ–å¯¹è¯..."
                    onkeydown="if(event.key === 'Enter' && !event.shiftKey) { event.preventDefault(); sendMessage(); }"
                ></textarea>
                <button class="send-btn" id="sendBtn" onclick="sendMessage()">
                    å‘é€ ğŸ“¨
                </button>
            </div>
        </div>
    </div>

    <script>
        // ==================== å…¨å±€çŠ¶æ€ ====================
        const state = {
            apiBase: 'http://localhost:8000',
            worldId: null,
            sessionId: null,
            phase: 'idle',
            currentScene: null,
            debug: {
                apiLog: false,
                memoryLog: true,
                eventLog: true,
            }
        };

        // ==================== APIå®¢æˆ·ç«¯ ====================
        class GameAPI {
            constructor(baseURL) {
                this.baseURL = baseURL;
            }

            async call(method, endpoint, body = null) {
                // ç¡®ä¿endpointä»¥/apiå¼€å¤´
                if (!endpoint.startsWith('/api')) {
                    endpoint = '/api' + endpoint;
                }
                
                const url = `${this.baseURL}${endpoint}`;
                const options = {
                    method,
                    headers: {'Content-Type': 'application/json'},
                };
                if (body) {
                    options.body = JSON.stringify(body);
                }

                try {
                    if (state.debug.apiLog) {
                        addMessage('system', `APIè°ƒç”¨: ${method} ${endpoint}`);
                    }

                    const response = await fetch(url, options);
                    if (!response.ok) {
                        const error = await response.json();
                        throw new Error(error.detail || `HTTP ${response.status}`);
                    }
                    const data = await response.json();
                    
                    if (state.debug.apiLog) {
                        console.log('APIå“åº”:', data);
                    }
                    
                    return data;
                } catch (error) {
                    addMessage('system', `âŒ APIé”™è¯¯: ${error.message}`, 'error');
                    throw error;
                }
            }

            // æ¸¸æˆä¸»æ¥å£
            async createSession(worldId, participants = ['player']) {
                return this.call('POST', `/gm/${worldId}/sessions`, {
                    payload: {
                        session_id: null,
                        participants
                    }
                });
            }

            async getContext(worldId, sessionId) {
                return this.call('GET', `/gm/${worldId}/sessions/${sessionId}/context`);
            }

            async enterScene(worldId, sessionId, scene) {
                return this.call('POST', `/gm/${worldId}/sessions/${sessionId}/scene`, {
                    payload: {
                        scene,
                        generate_description: true
                    }
                });
            }

            async sendInput(worldId, sessionId, input) {
                return this.call('POST', `/gm/${worldId}/sessions/${sessionId}/input`, {
                    payload: {
                        input,
                        input_type: null
                    }
                });
            }

            // Flashæ¥å£
            async ingestEvent(worldId, characterId, eventDesc, gameDay = 1) {
                return this.call('POST', `/flash/${worldId}/characters/${characterId}/ingest/natural`, {
                    event_description: eventDesc,
                    game_day: gameDay
                });
            }

            async recallMemory(worldId, characterId, query) {
                return this.call('POST', `/flash/${worldId}/characters/${characterId}/recall/natural`, {
                    query,
                    translate: true
                });
            }

            // Proæ¥å£
            async setProfile(worldId, characterId, profile) {
                return this.call('PUT', `/pro/${worldId}/characters/${characterId}/profile`, profile);
            }

            // å›¾è°±æ¥å£
            async getGraph(worldId, graphType, characterId = null) {
                let endpoint = `/graphs/${worldId}/${graphType}`;
                if (characterId) {
                    endpoint += `?character_id=${characterId}`;
                }
                return this.call('GET', endpoint);
            }
        }

        const api = new GameAPI(state.apiBase);

        // ==================== UIæ›´æ–°å‡½æ•° ====================
        function updateUI() {
            document.getElementById('worldId').textContent = state.worldId || '---';
            document.getElementById('sessionId').textContent = state.sessionId ? state.sessionId.substring(0, 8) : '---';
            document.getElementById('gamePhase').textContent = state.phase.toUpperCase();
        }

        function updateSceneCard(scene) {
            if (!scene) return;
            
            const card = document.getElementById('sceneCard');
            card.innerHTML = `
                <div class="scene-name">ğŸ“ ${scene.location || 'æœªçŸ¥åœ°ç‚¹'}</div>
                <div class="scene-detail">ğŸŒ¤ï¸ æ°›å›´: ${scene.atmosphere || 'æ™®é€š'}</div>
                <div class="scene-detail">ğŸ“ ${scene.description || 'æ— æè¿°'}</div>
            `;

            // æ›´æ–°NPCåˆ—è¡¨
            const npcList = document.getElementById('npcList');
            if (scene.participants && scene.participants.length > 0) {
                npcList.innerHTML = scene.participants
                    .filter(p => p !== 'player')
                    .map(npc => `
                        <div class="npc-item">
                            <div class="npc-icon">${npc[0].toUpperCase()}</div>
                            <span>${npc}</span>
                        </div>
                    `).join('');
            } else {
                npcList.innerHTML = '<div class="npc-item" style="opacity: 0.5;"><div class="npc-icon">?</div><span>æ— </span></div>';
            }
        }

        function addMessage(type, content, speaker = null) {
            const container = document.getElementById('messageContainer');
            const time = new Date().toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
            
            let avatarClass, avatarIcon, contentClass, displaySpeaker;
            
            switch(type) {
                case 'gm':
                    avatarClass = 'avatar-gm';
                    avatarIcon = 'ğŸ­';
                    contentClass = 'content-gm';
                    displaySpeaker = speaker || 'GM';
                    break;
                case 'npc':
                    avatarClass = 'avatar-npc';
                    avatarIcon = 'ğŸ‘¤';
                    contentClass = 'content-npc';
                    displaySpeaker = speaker || 'NPC';
                    break;
                case 'player':
                    avatarClass = 'avatar-player';
                    avatarIcon = 'ğŸ—£ï¸';
                    contentClass = 'content-player';
                    displaySpeaker = 'ä½ ';
                    break;
                default:
                    avatarClass = 'avatar-system';
                    avatarIcon = 'âš™ï¸';
                    contentClass = 'content-system';
                    displaySpeaker = 'ç³»ç»Ÿ';
            }

            const message = document.createElement('div');
            message.className = 'message';
            message.innerHTML = `
                <div class="message-header">
                    <div class="message-avatar ${avatarClass}">${avatarIcon}</div>
                    <div class="message-meta">
                        <div class="message-speaker">${displaySpeaker}</div>
                        <div class="message-time">${time}</div>
                    </div>
                </div>
                <div class="message-content ${contentClass}">
                    ${content}
                </div>
            `;

            container.appendChild(message);
            container.scrollTop = container.scrollHeight;
        }

        function setInput(text) {
            document.getElementById('playerInput').value = text;
        }

        function toggleDebug(key) {
            state.debug[key] = !state.debug[key];
            const toggle = document.getElementById(key + 'Toggle');
            toggle.classList.toggle('active');
        }

        // ==================== æ¸¸æˆé€»è¾‘ ====================
        async function startGame() {
            const worldId = document.getElementById('worldInput').value.trim();
            const apiBase = document.getElementById('apiInput').value.trim();
            
            if (!worldId) {
                alert('è¯·è¾“å…¥ä¸–ç•ŒID');
                return;
            }

            state.apiBase = apiBase;
            api.baseURL = apiBase;
            state.worldId = worldId;

            try {
                addMessage('system', 'ğŸ® æ­£åœ¨åˆ›å»ºæ¸¸æˆä¼šè¯...');
                
                const result = await api.createSession(worldId);
                state.sessionId = result.session.session_id;
                state.phase = 'scene';

                updateUI();
                document.getElementById('initModal').classList.add('hidden');

                addMessage('system', `âœ… æ¸¸æˆä¼šè¯å·²åˆ›å»º\nä¼šè¯ID: ${state.sessionId}`);
                addMessage('gm', 'å†’é™©è€…ï¼Œæ¬¢è¿æ¥åˆ°åšå¾·ä¹‹é—¨çš„ä¸–ç•Œã€‚ä½ ç«™åœ¨å‘½è¿çš„åå­—è·¯å£ï¼Œå‰æ–¹çš„é“è·¯ç”±ä½ è‡ªå·±é€‰æ‹©...');
                addMessage('system', 'ğŸ’¡ æç¤º: ä½¿ç”¨å³ä¾§çš„åœºæ™¯ä¼ é€æŒ‰é’®é€‰æ‹©ä¸€ä¸ªåœ°ç‚¹å¼€å§‹æ¸¸æˆ');

            } catch (error) {
                addMessage('system', `âŒ åˆ›å»ºä¼šè¯å¤±è´¥: ${error.message}`);
            }
        }

        async function enterScene(sceneId, sceneName, description) {
            if (!state.sessionId) {
                addMessage('system', 'âŒ è¯·å…ˆå¼€å§‹æ¸¸æˆ');
                return;
            }

            try {
                addMessage('system', `ğŸš¶ æ­£åœ¨å‰å¾€: ${sceneName}...`);

                const scene = {
                    scene_id: sceneId,
                    description: description,
                    location: sceneName,
                    participants: ['player'],
                    atmosphere: 'normal'
                };

                const result = await api.enterScene(state.worldId, state.sessionId, scene);
                
                state.currentScene = result.scene;
                updateSceneCard(result.scene);

                if (result.description) {
                    addMessage('gm', result.description);
                }

                if (state.debug.memoryLog && result.npc_memories) {
                    for (const [npcId, memory] of Object.entries(result.npc_memories)) {
                        if (memory && !memory.includes('å¤±è´¥')) {
                            addMessage('system', `ğŸ’­ ${npcId}çš„è®°å¿†è¢«é¢„åŠ è½½: ${memory.substring(0, 100)}...`);
                        }
                    }
                }

            } catch (error) {
                addMessage('system', `âŒ åœºæ™¯åˆ‡æ¢å¤±è´¥: ${error.message}`);
            }
        }

        async function sendMessage() {
            const input = document.getElementById('playerInput').value.trim();
            if (!input) return;

            if (!state.sessionId) {
                addMessage('system', 'âŒ è¯·å…ˆå¼€å§‹æ¸¸æˆ');
                return;
            }

            try {
                // æ˜¾ç¤ºç©å®¶è¾“å…¥
                addMessage('player', input);
                document.getElementById('playerInput').value = '';
                
                // ç¦ç”¨å‘é€æŒ‰é’®
                const sendBtn = document.getElementById('sendBtn');
                sendBtn.disabled = true;
                sendBtn.innerHTML = '<span class="loading"></span>';

                // å‘é€åˆ°åç«¯
                const result = await api.sendInput(state.worldId, state.sessionId, input);

                // æ˜¾ç¤ºå“åº”
                const speaker = result.speaker || 'GM';
                const messageType = result.type === 'dialogue' ? 'npc' : 'gm';
                addMessage(messageType, result.response, speaker);

                // æ˜¾ç¤ºè®°å¿†è°ƒç”¨
                if (state.debug.memoryLog && result.recalled_memory) {
                    addMessage('system', `ğŸ’­ è®°å¿†è°ƒç”¨: ${result.recalled_memory.substring(0, 150)}...`);
                }

                // æ˜¾ç¤ºå·¥å…·è°ƒç”¨
                if (state.debug.memoryLog && result.tool_called) {
                    addMessage('system', `ğŸ”§ ${speaker}è°ƒç”¨äº†recall_memoryå·¥å…·`);
                }

                // æ›´æ–°é˜¶æ®µ
                state.phase = result.type;
                updateUI();

            } catch (error) {
                addMessage('system', `âŒ å‘é€å¤±è´¥: ${error.message}`);
            } finally {
                const sendBtn = document.getElementById('sendBtn');
                sendBtn.disabled = false;
                sendBtn.innerHTML = 'å‘é€ ğŸ“¨';
            }
        }

        // ==================== æµ‹è¯•åŠŸèƒ½ ====================
        async function testFlash() {
            if (!state.worldId) {
                addMessage('system', 'âŒ è¯·å…ˆå¼€å§‹æ¸¸æˆ');
                return;
            }

            addMessage('system', 'ğŸ§ª æµ‹è¯•Flashè®°å¿†ç¼–ç ...');
            
            try {
                const result = await api.ingestEvent(
                    state.worldId,
                    'gorn',
                    'ç©å®¶å¸®åŠ©Gornä¿®å¥½äº†é“åŒ é“ºçš„ç‚‰å­ï¼ŒGornéå¸¸æ„Ÿæ¿€',
                    1
                );

                addMessage('system', `âœ… äº‹ä»¶å·²ç¼–ç \n- æ–°å¢èŠ‚ç‚¹: ${result.node_count}\n- æ–°å¢è¾¹: ${result.edge_count}`);
            } catch (error) {
                addMessage('system', `âŒ æµ‹è¯•å¤±è´¥: ${error.message}`);
            }
        }

        async function testRecall() {
            if (!state.worldId) {
                addMessage('system', 'âŒ è¯·å…ˆå¼€å§‹æ¸¸æˆ');
                return;
            }

            addMessage('system', 'ğŸ” æµ‹è¯•è®°å¿†æ£€ç´¢...');
            
            try {
                const result = await api.recallMemory(
                    state.worldId,
                    'gorn',
                    'ç©å®¶åšäº†ä»€ä¹ˆï¼Ÿ'
                );

                addMessage('system', `âœ… è®°å¿†æ£€ç´¢ç»“æœ:\n${result.translated_memory || '(æ— ç›¸å…³è®°å¿†)'}`);
            } catch (error) {
                addMessage('system', `âŒ æµ‹è¯•å¤±è´¥: ${error.message}`);
            }
        }

        async function viewGraph() {
            if (!state.worldId) {
                addMessage('system', 'âŒ è¯·å…ˆå¼€å§‹æ¸¸æˆ');
                return;
            }

            addMessage('system', 'ğŸ•¸ï¸ æ­£åœ¨åŠ è½½å›¾è°±...');
            
            try {
                const graph = await api.getGraph(state.worldId, 'character', 'gorn');
                addMessage('system', `âœ… å›¾è°±åŠ è½½æˆåŠŸ\n- èŠ‚ç‚¹æ•°: ${graph.nodes.length}\n- è¾¹æ•°: ${graph.edges.length}`);
                console.log('å®Œæ•´å›¾è°±æ•°æ®:', graph);
            } catch (error) {
                addMessage('system', `âŒ åŠ è½½å¤±è´¥: ${error.message}`);
            }
        }

        async function triggerTestCombat() {
            addMessage('system', 'âš”ï¸ æˆ˜æ–—åŠŸèƒ½å¼€å‘ä¸­...');
            addMessage('gm', 'çªç„¶ï¼Œä¸¤åªå“¥å¸ƒæ—ä»é˜´å½±ä¸­è·³å‡ºï¼å®ƒä»¬æŒ¥èˆç€ç”Ÿé”ˆçš„çŸ­åˆ€ï¼Œå‘å‡ºåˆºè€³çš„å°–å«...');
        }

        // ==================== åˆå§‹åŒ– ====================
        window.addEventListener('load', () => {
            console.log('ğŸ® åšå¾·ä¹‹é—¨è®°å¿†ç¼–ç»‡ç³»ç»Ÿå·²åŠ è½½');
            console.log('ğŸ“Š å½“å‰çŠ¶æ€:', state);
        });
    </script>
</body>
</html>