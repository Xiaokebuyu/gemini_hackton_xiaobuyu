概览

  - 位置：backend/app/combat/
  - 功能：回合制战斗、抽象距离、行动经济、状态/效果、法术、敌人模板注册、多 LLM 回合调度、结构化
    日志

  ———

  快速体验（本地脚本）

  - 基础战斗：

    python -m app.combat.test_combat_cli
  - 多 LLM 调度示例（伪 LLM，演示 turn queue）：

    python -m app.combat.llm_orchestrator_example

  ———

  MCP 服务启动

  - 运行：

    python -m app.combat.combat_mcp_server stdio
  - 核心工具（按战斗流程）：
      1. start_combat
      2. get_pending_turn_requests
      3. get_available_actions_for_actor
      4. execute_action_for_actor
      5. get_combat_events（前端/日志）
      6. get_combat_result（结束后）

  ———

  敌人模板注册（两种入口）

  1. 完整属性模板

  {
    "enemy_type": "cave_wisp",
    "name": "洞穴幽火",
    "max_hp": 18,
    "ac": 13,
    "attack_bonus": 4,
    "damage_dice": "1d6",
    "damage_bonus": 2,
    "damage_type": "fire",
    "initiative_bonus": 3,
    "ai_personality": "skirmisher",
    "xp_reward": 70,
    "gold_reward": 4,
    "tags": ["cave","undead"],
    "resistances": ["cold"],
    "vulnerabilities": [],
    "immunities": []
  }

  2. 范式生成（role/tier）

  {
    "enemy_type": "cave_wisp",
    "name": "洞穴幽火",
    "role": "skirmisher",
    "tier": 2,
    "tags": ["cave","undead"]
  }

  工具：

  - register_enemy_template
  - register_enemy_archetype
  - list_enemy_templates

  ———

  战斗启动（含同伴）

  {
    "enemies": [
      {"type": "goblin", "level": 1}
    ],
    "player_state": {
      "name": "主角",
      "hp": 40,
      "max_hp": 40,
      "ac": 14,
      "attack_bonus": 3,
      "damage_dice": "1d6",
      "damage_bonus": 2,
      "damage_type": "slashing",
      "initiative_bonus": 2,
      "abilities": {"strength": 14, "dexterity": 12},
      "spells_known": ["fire_bolt"],
      "spell_slots": { "1": 2 },
      "spell_attack_bonus": 5,
      "spell_save_dc": 13,
      "resistances": [],
      "vulnerabilities": [],
      "immunities": [],
      "speed": 1
    },
    "allies": [
      {
        "id": "ally_mage",
        "name": "法师同伴",
        "hp": 26,
        "max_hp": 26,
        "ac": 12,
        "attack_bonus": 4,
        "damage_dice": "1d6",
        "damage_bonus": 1,
        "initiative_bonus": 3
      }
    ]
  }

  ———

  多 LLM 回合调度流程

  - 轮到谁会在 turn_requests 出现（通过 get_pending_turn_requests 拉取）
  - 调度器按 actor_id 分配给对应 LLM
  - LLM 调用：
      - get_available_actions_for_actor(combat_id, actor_id)
      - 选择 action_id
      - execute_action_for_actor(combat_id, actor_id, action_id)

  ———

  可用行动类型（当前实现）

  - 近战攻击 attack_*
  - 副手攻击 offhand_*
  - 投掷 throw_*
  - 推撞 shove_*
  - 脱离 disengage
  - 疾跑 dash
  - 移动 move_closer / move_away
  - 防御 defend
  - 使用物品 use_*
  - 施法 spell_*_*
  - 逃跑 flee
  - 结束回合 end_turn

  ———

  抽象距离（可扩展接口）

  - 距离段位：engaged / close / near / far / distant
  - 行动会自动检查距离
  - move_closer / move_away 会调整段位
  - 离开 engaged 会触发借机攻击（除非先 disengage）

  ———

  结构化日志与前端推送

  - get_combat_events(combat_id, since_seq, limit)
  - 每条事件包含 seq / round / actor / event_type / message / payload

  ———

  小结

  - 你已经有完整战斗骨架 + MCP 接入 + 多 LLM 回合调度
  - 后续世界观/职业/装备/法术扩展，只需要继续填数据与规则，不需重构架构