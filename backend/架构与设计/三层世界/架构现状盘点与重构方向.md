# ä¸‰å±‚ä¸–ç•Œæ¶æ„ â€” ç°çŠ¶ç›˜ç‚¹ä¸é‡æ„æ–¹å‘

> åˆ›å»ºæ—¶é—´ï¼š2026-02-20
> çŠ¶æ€ï¼šç›˜ç‚¹å®Œæˆï¼Œå¾…è®¨è®ºç¡®è®¤æ–¹å‘åå¯åŠ¨é‡æ„
> å‰ç½®ï¼šDirection A æ€»çº¿é©±åŠ¨æ¶æ„å®Œæˆï¼ŒPart A å¼•æ“å µç‚¹ä¿®å¤å®Œæˆ
> è§¦å‘åŸå› ï¼šå‡†å¤‡å»ºè®¾ç»æµ/å‡çº§/å•†åº—ç³»ç»Ÿæ—¶å‘ç°å½“å‰æ¶æ„æ— æ³•å¹²å‡€åœ°å®¹çº³æ–°ç³»ç»Ÿâ€”â€”Agent å±‚å’Œä¸–ç•Œæœºæ¢°å±‚æ··åœ¨ä¸€èµ·ï¼ŒåŒä¸€ä»¶äº‹æœ‰ä¸‰æ¡è·¯å¾„ï¼ŒçŠ¶æ€æ•£è½åœ¨å¤šå¤„

---

## ä¸€ã€ç›®æ ‡æ¶æ„

> **æ ¸å¿ƒç†å¿µ**ï¼šæŠŠç©å®¶å’Œ Agent æ”¾å…¥ä¸€ä¸ªçœŸæ­£çš„æ¸¸æˆä¸–ç•Œã€‚æŠ½è±¡å±‚éš”å¼€ä¸Šå±‚ä¸åº•å±‚ï¼Œåº•å±‚å¯¹æ‰€æœ‰ä¸Šå±‚å®ä½“é€æ˜ï¼Œæ— éæƒé™é«˜ä½ã€‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ä¸Šå±‚ï¼šå±…æ°‘ï¼ˆPlayers / Agentsï¼‰          â”‚
â”‚  GM Agent / NPC Agent / é˜Ÿå‹ Agent / ç©å®¶ â”‚
â”‚  åªçœ‹åˆ°"æˆ‘èƒ½åšä»€ä¹ˆ"ï¼Œé€šè¿‡ç»Ÿä¸€æ¥å£è¡ŒåŠ¨      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ä¸­å±‚ï¼šä¸–ç•Œè§„åˆ™æ¥å£ï¼ˆWorld APIï¼‰          â”‚
â”‚  æƒé™æ§åˆ¶ / åŠ¨ä½œéªŒè¯ / ç»“æœåŒ…è£…           â”‚
â”‚  å¯¹ä¸Šå±‚æš´éœ²ç»Ÿä¸€å·¥å…·ï¼Œå¯¹ä¸‹å±‚è½¬å‘æ“ä½œ         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  åº•å±‚ï¼šæ¸¸æˆä¸–ç•Œå¼•æ“ï¼ˆWorld Engine MCPï¼‰    â”‚
â”‚  WorldGraph + BehaviorEngine + å¯¼èˆª +     â”‚
â”‚  ç»æµ + æ—¶é—´ + äº‹ä»¶ + æˆ˜æ–— + ç‰©å“ + ...  â”‚
â”‚  æœºæ¢°çœŸç†æºï¼Œé›¶ AIï¼Œçº¯è§„åˆ™/çŠ¶æ€/è®¡ç®—       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**åŸåˆ™**ï¼š
- åº•å±‚ = Strandbeest çš„æœºæ¢°ç»“æ„ï¼ˆçº¯è§„åˆ™ï¼Œé›¶ AIï¼‰
- ä¸­å±‚ = æœºæ¢°ç»“æ„æš´éœ²ç»™å¤–ç•Œçš„æ“ä½œé¢æ¿ï¼ˆç»Ÿä¸€æ¥å£ + æƒé™ï¼‰
- ä¸Šå±‚ = é£ï¼ˆç©å®¶æ“ä½œ + Agent AI å†³ç­–ï¼‰

---

## äºŒã€ç°çŠ¶ç›˜ç‚¹ï¼šæ¯ä¸ªæ¨¡å—çš„å½’å±

### 2.1 å·²ç»æ˜¯åº•å±‚ï¼ˆä¸–ç•Œæœºæ¢°ï¼Œå¯ç›´æ¥æ”¶å…¥ World Engineï¼‰

è¿™äº›æ¨¡å—**ä¸æ¶‰åŠ LLM/AI**ï¼Œçº¯ç²¹æ˜¯è§„åˆ™ã€çŠ¶æ€ã€è®¡ç®—ï¼š

| æ¨¡å— | æ–‡ä»¶ | èŒè´£ |
|------|------|------|
| **WorldGraph** | `app/world/world_graph.py` | å›¾å®¹å™¨ + ç´¢å¼• + è„è¿½è¸ª |
| **BehaviorEngine** | `app/world/behavior_engine.py` | æ¡ä»¶è¯„ä¼° + åŠ¨ä½œæ‰§è¡Œ + çº§è”ä¼ æ’­ |
| **EventPropagation** | `app/world/event_propagation.py` | BFS äº‹ä»¶æ‰©æ•£ + è¡°å‡ |
| **GraphBuilder** | `app/world/graph_builder.py` | 7 æ­¥æ„å›¾ç®¡çº¿ |
| **Snapshot** | `app/world/snapshot.py` | å¢é‡å¿«ç…§æŒä¹…åŒ– |
| **PlayerNodeView** | `app/world/player_node.py` | ç©å®¶å›¾èŠ‚ç‚¹é€‚é…å™¨ |
| **IntentResolver** | `app/world/intent_resolver.py` | çº¯æ¨¡å¼åŒ¹é…æ„å›¾è¯†åˆ«ï¼ˆæ—  LLMï¼‰ |
| **SceneBus** | `app/world/scene_bus.py` | å›åˆæ¶ˆæ¯æ€»çº¿å®¹å™¨ |
| **Constants** | `app/world/constants.py` | D&D 5e å‚è€ƒæ•°æ®è¡¨ |
| **Models** | `app/world/models.py` | WorldNode/Edge/Behavior/Event ç±»å‹å®šä¹‰ |
| **GameRuntime** | `app/runtime/game_runtime.py` | WorldInstance ç”Ÿå‘½å‘¨æœŸ + ç¼“å­˜ |
| **WorldInstance** | `app/runtime/world_instance.py` | ä¸–ç•Œé™æ€æ•°æ®æ³¨å†Œè¡¨ |
| **AreaRuntime** | `app/runtime/area_runtime.py` | åŒºåŸŸçŠ¶æ€ + è®¿é—®è®°å½• |
| **ContextAssembler** | `app/runtime/context_assembler.py` | 6 å±‚ä¸Šä¸‹æ–‡ç»„è£…ï¼ˆçº¯æ˜ å°„ï¼‰ |
| **StateManager** | `app/services/admin/state_manager.py` | å†…å­˜çŠ¶æ€ç¼“å­˜ + Delta |
| **TimeManager** | `app/services/time_manager.py` | æ—¶é—´æ¨è¿› + æ—¶æ®µåˆ¤å®š |
| **AreaNavigator** | `app/services/area_navigator.py` | A* å¯»è·¯ + æ—…è¡Œæ—¶é—´ |
| **NarrativeService** | `app/services/narrative_service.py` | ç« èŠ‚/ä¸»çº¿è§„åˆ™æ£€æŸ¥ |
| **PartyService** | `app/services/party_service.py` | é˜Ÿä¼å¢åˆ  + ä½ç½®åŒæ­¥ |
| **CharacterService** | `app/services/character_service.py` | è§’è‰²åˆ›å»º + D&D è§„åˆ™è®¡ç®— |
| **ItemRegistry** | `app/services/item_registry.py` | ç‰©å“æŸ¥è¯¢ï¼ˆé™æ€æ•°æ®ï¼‰ |
| **AbilityCheckService** | `app/services/ability_check_service.py` | d20 æ£€å®š |
| **GraphStore** | `app/services/graph_store.py` | å›¾æŒä¹…åŒ– I/O |
| **MemoryGraph** | `app/services/memory_graph.py` | NetworkX å›¾å®¹å™¨ |
| **SpreadingActivation** | `app/services/spreading_activation.py` | æ‰©æ•£æ¿€æ´»ç®—æ³• |
| **ContextWindow** | `app/services/context_window.py` | Token çª—å£ç®¡ç† |
| **EventBus** | `app/services/event_bus.py` | äº‹ä»¶å‘å¸ƒ/è®¢é˜… |
| **MCPClientPool** | `app/services/mcp_client_pool.py` | MCP è¿æ¥æ±  |
| **CombatEngine** | `app/combat/combat_engine.py` | æˆ˜æ–—å¼•æ“ |
| **DiceRoller** | `app/combat/dice.py` | éª°å­ç³»ç»Ÿ |
| **CombatRules** | `app/combat/rules.py` | æˆ˜æ–—å…¬å¼ |
| **CombatEffects** | `app/combat/effects.py` | çŠ¶æ€æ•ˆæœ |
| **æ‰€æœ‰ Store** | `character_store.py`, `party_store.py` ç­‰ | Firestore I/O |
| **æ‰€æœ‰ Models** | `app/models/*`, `app/runtime/models/*` | æ•°æ®ç»“æ„å®šä¹‰ |

### 2.2 å·²ç»æ˜¯ä¸Šå±‚ï¼ˆAgent å±‚ï¼Œåº”ç•™åœ¨ä¸Šå±‚æˆ–ç‹¬ç«‹ï¼‰

è¿™äº›æ¨¡å—**æ ¸å¿ƒä¾èµ– LLM/AI**ï¼š

| æ¨¡å— | æ–‡ä»¶ | èŒè´£ |
|------|------|------|
| **FlashCPUService** | `app/services/admin/flash_cpu_service.py` | Agentic ä¼šè¯é©±åŠ¨ï¼ˆLLM + å·¥å…·è°ƒç”¨ï¼‰ |
| **TeammateResponseService** | `app/services/teammate_response_service.py` | é˜Ÿå‹ AI å†³ç­– + å“åº”ç”Ÿæˆ |
| **MemoryGraphizer** | `app/services/memory_graphizer.py` | å¯¹è¯ â†’ å›¾è°±èŠ‚ç‚¹ï¼ˆLLM è½¬åŒ–ï¼‰ |
| **EventLLMService** | `app/services/admin/event_llm_service.py` | è‡ªç„¶è¯­è¨€äº‹ä»¶è§£æï¼ˆLLM 3 æ­¥ç®¡çº¿ï¼‰ |
| **TieredAIService** | `app/services/tiered_ai_service.py` | NPC ä¸‰å±‚æ¨¡å‹åˆ†å‘ï¼ˆPasserby/Secondary/Mainï¼‰ |
| **NpcReactor** | `app/world/npc_reactor.py` | NPC è‡ªä¸»ååº”ï¼ˆâš ï¸ å« LLM è°ƒç”¨ï¼Œæ”¾åœ¨ `app/world/` æ˜¯é”™ä½ï¼‰ |
| **AI Opponent** | `app/combat/ai_opponent.py` | æ•Œäºº AIï¼ˆå« LLMï¼‰ |
| **LLMService** | `app/services/llm_service.py` | é€šç”¨ Gemini API åŒ…è£… |
| **FlashLLMService** | `app/services/flash_llm_service.py` | Flash çº§ LLM è°ƒç”¨ |
| **ImageGenerationService** | `app/services/image_generation_service.py` | AI å›¾ç‰‡æœåŠ¡ |
| **SessionHistory** | `app/services/session_history.py` | ç©å®¶å†å²ç®¡ç† + è‡ªåŠ¨å›¾è°±åŒ–ï¼ˆè·¨å±‚ï¼šå­˜å‚¨æ˜¯åº•å±‚ï¼Œå›¾è°±åŒ–æ˜¯ä¸Šå±‚ï¼‰ |
| **SceneBusGraphizer** | `app/services/scene_bus_graphizer.py` | SceneBus è‡ªåŠ¨å…¥å›¾ï¼ˆLLM è½¬åŒ–ï¼‰ |
| **RecallOrchestrator** | `app/services/admin/recall_orchestrator.py` | è®°å¿†å¬å›ç¼–æ’ |
| **TeammateAgenticTools** | `app/services/admin/teammate_agentic_tools.py` | é˜Ÿå‹å·¥å…·å®šä¹‰ï¼ˆä¸ V4AgenticTools å¹³è¡Œï¼‰ |
| **æ‰€æœ‰ Prompt æ–‡ä»¶** | `app/prompts/*` | Agent äººæ ¼/æŒ‡ä»¤å®šä¹‰ |

> **æ³¨æ„**ï¼šé¡¹ç›®ä¸­æœ‰ **7 ä¸ªç‹¬ç«‹çš„ LLM è°ƒç”¨ç‚¹**ï¼ˆLLMService / FlashLLMService / EventLLMService / FlashCPUService / TieredAIService / TeammateResponseService / NpcReactorï¼‰ï¼Œæ— ç»Ÿä¸€çš„ token è®¡æ•°ã€æˆæœ¬è¿½è¸ªæˆ–é€Ÿç‡é™åˆ¶ã€‚

### 2.3 æ··åˆå±‚ï¼ˆå½“å‰æ¨ªè·¨ä¸¤å±‚ï¼Œéœ€è¦æ‹†åˆ†ï¼‰

| æ¨¡å— | æ–‡ä»¶ | åº•å±‚éƒ¨åˆ† | ä¸Šå±‚éƒ¨åˆ† |
|------|------|---------|---------|
| **IntentExecutor** | `app/world/intent_executor.py` | æœºæ¢°æ‰§è¡Œï¼ˆå¯¼èˆª/æ—¶é—´/ç‰©å“/ä¼‘æ¯ï¼‰ | å¯¹è¯æ„å›¾è½¬å‘ç»™ FlashCPU |
| **V4AgenticToolRegistry** | `app/services/admin/v4_agentic_tools.py` | çŠ¶æ€ä¿®æ”¹æ“ä½œï¼ˆé‡‘å¸/XP/ç‰©å“/äº‹ä»¶ï¼‰ | å·¥å…·å®šä¹‰æ ¼å¼ï¼ˆä¸º LLM æ¶ˆè´¹ï¼‰ + NPC MCP è°ƒç”¨ |
| **SessionRuntime** | `app/runtime/session_runtime.py` | restore/persist/æ—¶é—´/çŠ¶æ€ç®¡ç† | WorldGraph tick æ•´åˆ + å‰¯ä½œç”¨åˆ†å‘ |
| **PipelineOrchestrator** | `app/services/admin/pipeline_orchestrator.py` | ä¸‰é˜¶æ®µè°ƒåº¦éª¨æ¶ | ä¾èµ– FlashCPU é©±åŠ¨ B é˜¶æ®µ |
| **AdminCoordinator** | `app/services/admin/admin_coordinator.py` | æœåŠ¡æ³¨å†Œå·¥å‚ | è·¯ç”±åˆ° Agent å¤„ç†æµ + ç§èŠæµç»•è¿‡ Pipeline |
| **InstanceManager** | `app/services/instance_manager.py` | å®ä¾‹æ± ç®¡ç†/LRU/æ·˜æ±° | å›¾è°±åŒ–è§¦å‘ï¼ˆè°ƒç”¨ MemoryGraphizerï¼‰ |
| **FlashService** | `app/services/flash_service.py` | å›¾æŸ¥è¯¢/æ‰©æ•£æ¿€æ´» | è‡ªç„¶è¯­è¨€äº‹ä»¶æ‘„å…¥ï¼ˆè°ƒç”¨ LLMï¼‰ |
| **PasserbyService** | `app/services/passerby_service.py` | ç”Ÿæˆæ± ç®¡ç†/æ¨¡æ¿ | å¯¹è¯ç”Ÿæˆï¼ˆè°ƒç”¨ TieredAIï¼‰ |
| **CompanionInstance** | `app/runtime/companion_instance.py` | äº‹ä»¶æ—¥å¿—/çŠ¶æ€å­˜å‚¨ | æƒ…æ„ŸçŠ¶æ€ï¼ˆä¸º Agent å†³ç­–å‡†å¤‡ï¼‰ |
| **EventService** | `app/services/admin/event_service.py` | ç»“æ„åŒ–äº‹ä»¶å…¥å›¾ | ä¸ EventLLMService èŒè´£è¾¹ç•Œæ¨¡ç³Š |
| **ReferenceResolver** | `app/services/reference_resolver.py` | NPC/ç‰©å“/åœ°ç‚¹ ID è§£æï¼ˆåº•å±‚ï¼‰ | â€” |
| **EventGenerator** | `app/services/event_generator.py` | äº‹ä»¶ç”Ÿæˆæ¨¡æ¿ | â€” |

### 2.5 é¦–æ¬¡ç›˜ç‚¹é—æ¼çš„åº•å±‚æ¨¡å—

| æ¨¡å— | æ–‡ä»¶ | èŒè´£ | å½’å± |
|------|------|------|------|
| **Rules** | `app/rules.py` | æ¸¸æˆè§„åˆ™å¸¸æ•° | åº•å±‚ |
| **GraphSchema** | `app/services/graph_schema.py` | å›¾æ¨¡å¼æ ¡éªŒ | åº•å±‚ |
| **CombatConstants** | `app/combat/constants.py` | æˆ˜æ–—å¸¸æ•° | åº•å±‚ |
| **DataRepository** | `app/combat/data_repository.py` | æˆ˜æ–—æ•°æ®ä»“åº“ | åº•å±‚ |
| **EnemyRegistry** | `app/combat/enemy_registry.py` | æ•Œäººæ³¨å†Œè¡¨ | åº•å±‚ |
| **Spatial** | `app/combat/spatial.py` | ç©ºé—´è®¡ç®— | åº•å±‚ |
| **Spells** | `app/combat/spells.py` | æ³•æœ¯å®šä¹‰ | åº•å±‚ |
| **TemplateMapper** | `app/combat/template_mapper.py` | æ¨¡æ¿æ˜ å°„ | åº•å±‚ |
| **TeammateVisibilityManager** | `app/services/teammate_visibility_manager.py` | é˜Ÿå‹å¯è§æ€§è§„åˆ™ | åº•å±‚ |
| **Config** | `app/config.py` | å…¨å±€é…ç½®å•ä¾‹ï¼ˆ142 é¡¹ï¼‰ | åŸºç¡€è®¾æ–½ |
| **Main** | `app/main.py` | FastAPI å…¥å£ + MCP æ¢é’ˆ | åŸºç¡€è®¾æ–½ |
| **Dependencies** | `app/dependencies.py` | @lru_cache ä¾èµ–æ³¨å…¥ | åŸºç¡€è®¾æ–½ |

### 2.4 æ¥å£å±‚ï¼ˆå½“å‰çš„ API æš´éœ²ï¼Œéœ€è¦ç»Ÿä¸€æ”¶ç¼–ï¼‰

| æ¥å£ | æ–‡ä»¶ | å½“å‰æœåŠ¡å¯¹è±¡ |
|------|------|------------|
| **REST API** | `app/routers/game_v2.py` | å‰ç«¯ï¼ˆç©å®¶ï¼‰ |
| **Game MCP Tools** | `app/mcp/tools/*.py` | GM Agentï¼ˆé€šè¿‡ MCPClientPoolï¼‰ |
| **V4 Agentic Tools** | `app/services/admin/v4_agentic_tools.py` | GM Agentï¼ˆç›´æ¥å†…å­˜è°ƒç”¨ï¼‰ |
| **Combat MCP** | `app/combat/combat_mcp_server.py` | GM Agent |

**é—®é¢˜**ï¼šåŒä¸€ä¸ªæ“ä½œï¼ˆå¦‚"ç»™ç©å®¶åŠ ç‰©å“"ï¼‰æœ‰ä¸‰æ¡è·¯å¾„ï¼š
1. REST API â†’ `AdminCoordinator` â†’ `CharacterService`
2. MCP Tool â†’ `game_tools_server` â†’ `AdminCoordinator`
3. V4 Agentic â†’ `v4_agentic_tools.add_item()` â†’ `session.player.add_item()`

ä¸‰æ¡è·¯å¾„å„è‡ªæ ¡éªŒã€å„è‡ªå†™å…¥ã€å¯èƒ½ä¸ä¸€è‡´ã€‚

---

## ä¸‰ã€å‘ç°çš„æ ¸å¿ƒé—®é¢˜

### 3.1 çŠ¶æ€æ•£è½ï¼ˆåŒä¸€æ•°æ®å¤šå¤„è¯»å†™ï¼‰

**ç©å®¶é‡‘å¸/XP/HP**ï¼š
```
å†™å…¥è·¯å¾„ 1: v4_agentic_tools.add_xp()         â†’ session.player.xp += N
å†™å…¥è·¯å¾„ 2: _sync_combat_to_graph()            â†’ session.player.xp = ... + N
å†™å…¥è·¯å¾„ 3: _apply_on_complete_from_graph()    â†’ session.player.xp = ... + N
å†™å…¥è·¯å¾„ 4: flash_cpu._sync_combat_results()   â†’ session.player.xp = ... + N
å†™å…¥è·¯å¾„ 5: session._apply_tick_side_effects() â†’ session.player.xp = ... + N
```

5 æ¡å†™å…¥è·¯å¾„ï¼Œæ¯æ¡éƒ½ç›´æ¥æ“ä½œ `player.xp`ï¼Œæ²¡æœ‰ç»Ÿä¸€æ ¡éªŒï¼Œæ²¡æœ‰å‡çº§æ£€æŸ¥ã€‚Gold åŒç†æœ‰ 4 æ¡ã€‚

**NPC ä½ç½®**ï¼šIntentExecutor ç›´æ¥æ”¹ WorldGraph HOSTS è¾¹
**äº‹ä»¶çŠ¶æ€**ï¼šBehaviorEngine + V4AgenticTools + SessionRuntime ä¸‰å¤„å¯æ”¹

### 3.2 Agent å±‚å’Œä¸–ç•Œå±‚æ··åˆ

- `V4AgenticToolRegistry`ï¼šæ—¢æ˜¯ LLM å·¥å…·å®šä¹‰ï¼Œåˆæ˜¯çŠ¶æ€ä¿®æ”¹å…¥å£
- `IntentExecutor`ï¼šä¸»è¦æ˜¯æœºæ¢°æ‰§è¡Œï¼Œä½† TALK æ„å›¾ä¼šè§¦å‘ FlashCPU çš„ NPC å¯¹è¯
- `SessionRuntime`ï¼šä¸»è¦æ˜¯çŠ¶æ€ç®¡ç†ï¼Œä½†å†…åµŒäº† BehaviorEngine tick å’Œå‰¯ä½œç”¨åˆ†å‘é€»è¾‘
- `NpcReactor`ï¼šæ”¾åœ¨ `app/world/` ä½†å« LLM è°ƒç”¨ï¼Œå±‚çº§é”™ä½

### 3.3 ä¸‰å¥—æ¥å£ä¸ç»Ÿä¸€

**å®Œæ•´äº¤å‰å¯¹æ¯”**ï¼ˆâš ï¸ = å®ç°ä¸ä¸€è‡´ï¼ŒâŒ = è¯¥è·¯å¾„æ— æ­¤åŠŸèƒ½ï¼‰ï¼š

| æ“ä½œ | REST | MCP (43 å·¥å…·) | V4 Agentic (26 å·¥å…·) | ä¸€è‡´æ€§ |
|------|------|--------------|---------------------|--------|
| NPC å¯¹è¯ | `POST /dialogue/start` | `npc_respond` | `npc_dialogue` | âš ï¸ ä¸‰å¥—è·¯ç”±ï¼Œå„è‡ªç®¡ç† |
| æˆ˜æ–— | 4 ä¸ªç«¯ç‚¹ | âŒ æ—  | 3 ä¸ªå·¥å…· | âš ï¸ **ä¸¤å¥—ç‹¬ç«‹æˆ˜æ–—çŠ¶æ€æœº** |
| äº‹ä»¶ç®¡ç† | ä»… `trigger_event` | ä»… `trigger_event` | 7 ä¸ªå·¥å…·ï¼ˆå®Œæ•´ç”Ÿå‘½å‘¨æœŸï¼‰ | âš ï¸ åŠŸèƒ½ä¸¥é‡å‰²è£‚ |
| ç‰©å“ç®¡ç† | âŒ æ—  | 8 ä¸ªå·¥å…· â†’ CharacterStore | 2 ä¸ªå·¥å…· â†’ SessionRuntime | âš ï¸ **å­˜å‚¨è·¯å¾„åˆ†å‰** |
| é˜Ÿå‹ç®¡ç† | 5 ä¸ªç«¯ç‚¹ | ä»… `get_party_info` | 3 ä¸ªå·¥å…· | âš ï¸ REST ç›´å†™ï¼ŒAgentic èµ° Session |
| èƒ½åŠ›æ£€å®š | `POST /dice-roll` | âŒ æ—  | `ability_check` | âš ï¸ **ä¸¤ä¸ªç‹¬ç«‹å®ç°** |
| åŠ  XP | âŒ æ—  | `add_player_xp` | `add_xp` | âœ“ éƒ½å†™ player.xp |
| æ²»ç–—/ä¼¤å®³ | âŒ æ—  | `heal/damage_player` | `heal/damage_player` | âœ“ |
| å¥½æ„Ÿåº¦ | âŒ æ—  | `update_disposition` | `update_disposition` | âœ“ éƒ½èµ° GraphStore |
| å¯¼èˆª | âŒ ç§»é™¤ | 3 ä¸ªå·¥å…· | âŒ ç§»é™¤ï¼ˆIntentExecutorï¼‰ | âœ“ |
| æ—¶é—´ | âŒ æ— å†™ç«¯ç‚¹ | `advance_time` | `update_time` | âœ“ éƒ½èµ° SessionRuntime |
| å›¾è°±æ“ä½œ | âŒ æ—  | 4 ä¸ªå·¥å…· | âŒ æ—  | âœ“ ä»… MCP |
| é€‰æ‹©è®°å½• | âŒ æ—  | 2 ä¸ªå·¥å…· | âŒ æ—  | âœ“ ä»… MCP |
| è·¯äºº NPC | 3 ä¸ªç«¯ç‚¹ | 3 ä¸ªå·¥å…· | âŒ æ—  | âœ“ éƒ½èµ° PasserbyService |
| å›¾ç‰‡ç”Ÿæˆ | âŒ æ—  | âŒ æ—  | `generate_scene_image` | âœ“ ä»… Agentic |

### 3.4 ç¼ºå¤±çš„ç³»ç»Ÿ

| ç³»ç»Ÿ | ç°çŠ¶ |
|------|------|
| ç»æµç³»ç»Ÿï¼ˆStatsManagerï¼‰ | ä¸å­˜åœ¨ï¼Œé‡‘å¸/XP/ç‰©å“æ“ä½œæ•£è½åœ¨ 5+ ä¸ªæ–‡ä»¶ |
| å•†åº—ç³»ç»Ÿï¼ˆShopServiceï¼‰ | ä¸å­˜åœ¨ï¼Œå­åœ°ç‚¹æ•°æ®æœ‰ä½†æ— äº¤æ˜“æœºæ¢° |
| å‡çº§ç³»ç»Ÿ | ä¸å­˜åœ¨äºè¿è¡Œæ—¶è·¯å¾„ï¼ˆCharacterService.add_xp æ˜¯æ—§è·¯å¾„ï¼‰ |
| æƒé™ç³»ç»Ÿ | ä¸å­˜åœ¨ï¼Œæ‰€æœ‰ Agent èƒ½è°ƒæ‰€æœ‰å·¥å…· |

### 3.5 ä¾èµ–æ³¨å…¥ä¸å•ä¾‹é—®é¢˜ï¼ˆè¡¥å……å®¡è®¡å‘ç°ï¼‰

**StateManager ä¸‰å®ä¾‹åˆ†å‰**ï¼š
```
AdminCoordinator._state_manager     â†’ StateManager Aï¼ˆå‡ ä¹ä¸ä½¿ç”¨ï¼‰
AdminWorldRuntime._state_manager    â†’ StateManager Bï¼ˆå®é™…ä½¿ç”¨ï¼Œstart_session & persistï¼‰
FlashCPUService._state_manager      â†’ StateManager Cï¼ˆå·²å¼ƒç”¨ä½†ä»å­˜åœ¨ï¼‰
```
ä¸‰ä»½ç‹¬ç«‹çš„ `_states` å­—å…¸ï¼ŒåŒä¸€ä¼šè¯çŠ¶æ€åœ¨ä¸‰å¤„å¯èƒ½ä¸åŒæ­¥ã€‚

**åæœŸæ³¨å…¥ç©ºæŒ‡é’ˆé£é™©**ï¼ˆ`admin_coordinator.py:121-137`ï¼‰ï¼š
```python
self.flash_cpu.party_service = self.party_service        # åæœŸæ³¨å…¥
self.flash_cpu.character_service = None                  # placeholder â†’ ç«æ€é£é™©
```

**åŒé‡å•ä¾‹å†—ä½™**ï¼š`AdminCoordinator.get_instance()` è¿”å›ç±»å•ä¾‹ + `@lru_cache()` åŒ…è£¹ï¼Œé‡ç½®æ—¶å¯èƒ½ä¸åŒæ­¥ã€‚

### 3.6 æŒä¹…åŒ–é“¾è·¯è„†å¼±æ€§ï¼ˆè¡¥å……å®¡è®¡å‘ç°ï¼‰

**Player å”¯ä¸€æŒä¹…åŒ–è·¯å¾„æ˜¯ WorldGraph å¿«ç…§**ï¼š
```python
# session_runtime.py persist() æ­¥éª¤ 3:
if self._dirty_player:
    self._dirty_player = False        # æ ‡è®°æ¸…é™¤
    persisted.append("player")        # â† å®é™…ä¸å†™ä»»ä½•ä¸œè¥¿ï¼
# çœŸæ­£å†™å…¥åœ¨æ­¥éª¤ 7:
await self._persist_world_graph_snapshot()  # â† è‹¥å¤±è´¥ï¼Œplayer æ•°æ®æ°¸ä¹…ä¸¢å¤±
```

- `_world_graph_failed=True` æ—¶**é™é»˜é™çº§**ï¼šäº‹ä»¶å·¥å…·è¢«ç¦ã€BehaviorEngine ä¸è·‘ã€Player æ›´æ”¹ä¸ä¿å­˜ï¼Œä½†ä¼šè¯ç»§ç»­è¿è¡Œæ— æŠ¥é”™
- `metadata.player_character` å·²åœç”¨å†™å…¥ï¼Œä½†æ¢å¤æ—¶ä»ä½œä¸ºå›é€€è¯»å–ï¼ˆå¹½çµè·¯å¾„ï¼‰

**å‰¯ä½œç”¨å»é‡ä¸æŒä¹…åŒ–**ï¼š
```python
self._applied_side_effect_events: Set[str] = set()  # çº¯å†…å­˜ï¼Œcrash æ¢å¤åæ¸…ç©º
```
åœºæ™¯ï¼šXP +100 â†’ å¿«ç…§ä¿å­˜ â†’ å´©æºƒ â†’ æ¢å¤ â†’ å»é‡é›†ä¸ºç©º â†’ XP å†å‘ä¸€éã€‚

**åŒå€ BehaviorEngine tick**ï¼š
- pre-tickï¼ˆA é˜¶æ®µï¼‰+ post-tickï¼ˆC é˜¶æ®µï¼‰å„è·‘ä¸€æ¬¡
- å»é‡ä»…é™æœ¬è½®å†…å­˜ï¼Œå·¥å…·è·¯å¾„äº§ç”Ÿçš„åŒä¸€äº‹ä»¶å¯èƒ½é‡å¤

**persist() 7 æ­¥æ— äº‹åŠ¡ä¿è¯**ï¼š
```
æ­¥éª¤ 1: GameState    â†’ æˆåŠŸ
æ­¥éª¤ 2: Narrative    â†’ æˆåŠŸ
æ­¥éª¤ 3: Player       â†’ ä»…æ ‡è®°ï¼ˆä¾èµ–æ­¥éª¤ 7ï¼‰
æ­¥éª¤ 4: Party        â†’ å·²å®æ—¶å†™å…¥
æ­¥éª¤ 5: Companions   â†’ âš ï¸ æœªå®ç°
æ­¥éª¤ 6: AreaRuntime  â†’ æˆåŠŸ
æ­¥éª¤ 7: WorldGraph   â†’ è‹¥å¤±è´¥ â†’ Player æ•°æ®ä¸¢å¤±ï¼Œå…¶ä»–æ­¥éª¤å·²æäº¤æ— æ³•å›æ»š
```

### 3.7 ç§èŠç³»ç»Ÿè„±ç¦»ä¸»ç®¡çº¿ï¼ˆè¡¥å……å®¡è®¡å‘ç°ï¼‰

`process_private_chat_stream()`ï¼ˆ`admin_coordinator.py`ï¼‰å®Œå…¨ç»•è¿‡ PipelineOrchestratorï¼š
- ä¸è®°å½• SessionHistory
- ä¸æ‰§è¡Œ BehaviorEngine
- ä¸è§¦å‘äº‹ä»¶å‰¯ä½œç”¨
- NPC è®°å¿†ä¸ä¸»çº¿å‰§æƒ…è„±ç¦»

### 3.8 Firestore æ•°æ®æ¨¡å‹é—®é¢˜ï¼ˆè¡¥å……å®¡è®¡å‘ç°ï¼‰

**GameState å¤šå‰¯æœ¬æ— åŒæ­¥**ï¼š
```
å‰¯æœ¬ 1: StateManager._statesï¼ˆå†…å­˜ç¼“å­˜ï¼‰
å‰¯æœ¬ 2: sessions/{sid} â†’ metadata.admin_stateï¼ˆFirestoreï¼‰
å‰¯æœ¬ 3: game_state.narrative_progressï¼ˆåµŒå…¥å¼ï¼Œä¸ metadata.narrative å¯èƒ½åˆ†å‰ï¼‰
```

**å®Œæ•´ Firestore è·¯å¾„ç»“æ„**ï¼ˆæ–‡æ¡£åŸç¼ºï¼‰ï¼š
```
worlds/{world_id}/
  sessions/{session_id}/
    (document)                    â† ä¸»ä¼šè¯æ–‡æ¡£ï¼ˆmetadata.admin_state / narrative / player_characterï¼‰
    world_snapshot/current        â† WorldGraph å¿«ç…§ï¼ˆPlayer å”¯ä¸€æŒä¹…åŒ–è·¯å¾„ï¼‰
    messages/{message_id}         â† ä¼šè¯å†å²
    companions/{char_id}/
      data/state                  â† åŒä¼´çŠ¶æ€
      shared_events/{event_id}    â† å…±äº«äº‹ä»¶ï¼ˆä¸Šé™ 100 æ¡ï¼‰
      area_summaries/{area_id}    â† åŒºåŸŸæ‘˜è¦
    areas/{area_id}/
      state/current               â† åŒºåŸŸçŠ¶æ€
      npc_contexts/{npc_id}       â† NPC å¿«ç…§
      visits/{visit_id}           â† è®¿é—®è®°å½•
  parties/{session_id}/
    (document)                    â† Party å…ƒæ•°æ®
    members/{char_id}             â† é˜Ÿä¼æˆå‘˜ï¼ˆå®æ—¶å†™å…¥ï¼Œéäº‹åŠ¡ï¼‰
  characters/{char_id}/
    nodes/, edges/                â† è§’è‰²çŸ¥è¯†å›¾
    dispositions/{target_id}      â† å¥½æ„Ÿåº¦ï¼ˆå« history æœ€è¿‘ 50 æ¡ï¼‰
  graphs/world/nodes/, edges/     â† ä¸–ç•Œçº§çŸ¥è¯†å›¾
  chapters/{cid}/graph/data/...   â† ç« èŠ‚çº§
  chapters/{cid}/areas/{aid}/graph/data/...  â† åŒºåŸŸçº§
  camp/graph/...                  â† è¥åœ°çº§
  choices/{choice_id}             â† ç©å®¶é€‰æ‹©è®°å½•
```

**æ—  schema ç‰ˆæœ¬ç®¡ç†**ï¼šGameStateã€NarrativeProgress ç­‰æ¨¡å‹æ—  `schema_version` å­—æ®µï¼Œè·¨ç‰ˆæœ¬å‡çº§é è¿æ°”ã€‚

---

## å››ã€é‡æ„æ–¹å‘

### 4.1 åº•å±‚ï¼šWorld Engine MCP

å°†æ‰€æœ‰"ä¸–ç•Œæœºæ¢°"æ”¶ç¼–ä¸ºä¸€ä¸ªç»Ÿä¸€çš„æœåŠ¡ï¼ˆå†…éƒ¨æ¨¡å—åŒ–ï¼Œå¯¹å¤–ç»Ÿä¸€ MCP æ¥å£ï¼‰ï¼š

```
World Engine MCP
â”œâ”€â”€ graph/          WorldGraph + GraphBuilder + Snapshot
â”œâ”€â”€ behavior/       BehaviorEngine + EventPropagation + SceneBus
â”œâ”€â”€ navigation/     AreaNavigator + ä½ç½®ç®¡ç† + å­åœ°ç‚¹
â”œâ”€â”€ economy/        StatsManagerï¼ˆé‡‘å¸/XP/ç‰©å“ç»Ÿä¸€å…¥å£ï¼‰+ ShopService
â”œâ”€â”€ combat/         CombatEngine + Dice + Effects + Rules
â”œâ”€â”€ time/           TimeManager + æ—¶æ®µ + è¥ä¸šæ—¶é—´
â”œâ”€â”€ character/      CharacterService + D&D è§„åˆ™ + å‡çº§
â”œâ”€â”€ narrative/      NarrativeService + ç« èŠ‚ + äº‹ä»¶çŠ¶æ€æœº
â”œâ”€â”€ party/          PartyService + ä½ç½®åŒæ­¥
â”œâ”€â”€ persistence/    GraphStore + StateManager + Snapshot + CharacterStore
â””â”€â”€ query/          ContextAssembler + IntentResolver + SpreadingActivation
```

**å…³é”®å˜åŒ–**ï¼š
- `StatsManager` æˆä¸ºé‡‘å¸/XP/ç‰©å“çš„**å”¯ä¸€å†™å…¥å…¥å£**ï¼Œä»»ä½•è·¯å¾„æƒ³æ”¹ç©å®¶æ•°å€¼éƒ½å¿…é¡»ç»è¿‡å®ƒ
- å‡çº§æ£€æŸ¥å†…åµŒåœ¨ `StatsManager.add_xp()` ä¸­ï¼ˆä¸å†éœ€è¦å¤–éƒ¨è°ƒç”¨æ–¹è®°ä½æ£€æŸ¥ï¼‰
- å•†åº—æ˜¯å­åœ°ç‚¹ä¸Šçš„æœºæ¢°å®ä½“ï¼ŒShopService ç®¡ç†è´§æ¶/ä»·æ ¼/åº“å­˜

### 4.2 ä¸­å±‚ï¼šWorld APIï¼ˆæŠ½è±¡æœåŠ¡å±‚ï¼‰

ç»Ÿä¸€æ¥å£å±‚ï¼Œå¯¹ä¸Šå±‚æš´éœ²æ“ä½œï¼Œå¯¹ä¸‹å±‚è½¬å‘ï¼š

```
World API
â”œâ”€â”€ åŠ¨ä½œæ¥å£       move(target) / talk(npc_id, message) / examine(target) / use_item(item_id) / rest()
â”œâ”€â”€ äº¤æ˜“æ¥å£       buy(item_id, shop_location) / sell(item_id) / haggle(item_id, offer_price)
â”œâ”€â”€ æŸ¥è¯¢æ¥å£       get_location() / get_inventory() / get_stats() / get_shop_stock(location)
â”œâ”€â”€ æˆ˜æ–—æ¥å£       trigger_combat() / combat_action() / resolve_combat()
â”œâ”€â”€ ç¤¾äº¤æ¥å£       update_disposition() / start_dialogue() / end_dialogue()
â””â”€â”€ æƒé™å±‚         æ ¹æ®è°ƒç”¨è€…èº«ä»½ï¼ˆplayer/gm/npc/teammateï¼‰è¿‡æ»¤å¯ç”¨æ“ä½œå’Œå¯è§ä¿¡æ¯
```

**æƒé™ç¤ºä¾‹**ï¼š
- **ç©å®¶**ï¼šèƒ½ move/talk/examine/buy/sell/use_itemï¼Œä¸èƒ½ç›´æ¥ activate_event
- **GM Agent**ï¼šèƒ½ activate_event/complete_event/advance_chapterï¼Œä¸èƒ½ç›´æ¥æ”¹é‡‘å¸ï¼ˆç”±ç³»ç»Ÿç»“ç®—ï¼‰
- **NPC Agentï¼ˆå•†äººï¼‰**ï¼šèƒ½ adjust_price/show_inventoryï¼Œä¸èƒ½æ”¹ç©å®¶ä½ç½®
- **NPC Agentï¼ˆæ™®é€šï¼‰**ï¼šèƒ½ update_disposition/recall_memoryï¼Œä¸èƒ½äº¤æ˜“

### 4.3 ä¸Šå±‚ï¼šå±…æ°‘ï¼ˆAgent å±‚ï¼‰

æ¯ä¸ª Agent é€šè¿‡ World API ä¸ä¸–ç•Œäº¤äº’ï¼Œçœ‹åˆ°çš„æ˜¯"æˆ‘èƒ½åšä»€ä¹ˆ"ï¼š

```
ä¸Šå±‚å±…æ°‘
â”œâ”€â”€ ç©å®¶          é€šè¿‡å‰ç«¯ UI â†’ REST â†’ World API ä¸ä¸–ç•Œäº¤äº’
â”œâ”€â”€ GM Agent      æ¶ˆè´¹ SceneBus â†’ å™è¿° + åˆ›æ„è£å†³ï¼ˆä¸æ“ä½œä¸–ç•Œæ•°å€¼ï¼‰
â”œâ”€â”€ NPC Agent     è¢«å”¤é†’æ—¶è¯» SceneBus â†’ ç”¨è‡ªå·±çš„äººæ ¼äº¤äº’ â†’ é€šè¿‡ World API æ‰§è¡Œ
â”œâ”€â”€ é˜Ÿå‹ Agent    å§‹ç»ˆè¯» SceneBus â†’ è‡ªä¸»å†³ç­– â†’ é€šè¿‡ World API è¡¨è¾¾
â””â”€â”€ ç³»ç»Ÿç»“ç®—      æˆ˜æ–—/äº‹ä»¶å®Œæˆåè‡ªåŠ¨é€šè¿‡ World API å‘æ”¾å¥–åŠ±ï¼ˆé Agentï¼‰
```

---

## äº”ã€å½“å‰ä»£ç åˆ°ç›®æ ‡æ¶æ„çš„æ˜ å°„

### å¯ç›´æ¥æ”¶å…¥åº•å±‚çš„ï¼ˆæ”¹åŠ¨å°ï¼‰

| å½“å‰æ¨¡å— | å½’å…¥ World Engine çš„å“ªä¸ªå­ç³»ç»Ÿ | éœ€è¦çš„æ”¹åŠ¨ |
|---------|--------------------------|----------|
| `app/world/` å…¨éƒ¨ | `graph/` + `behavior/` | å‡ ä¹æ— éœ€æ”¹åŠ¨ |
| `TimeManager` | `time/` | æ— éœ€æ”¹åŠ¨ |
| `AreaNavigator` | `navigation/` | æ— éœ€æ”¹åŠ¨ |
| `CombatEngine` + dice/rules/effects | `combat/` | æ— éœ€æ”¹åŠ¨ |
| `CharacterService` | `character/` | è¡¥å……å‡çº§é€»è¾‘ |
| `PartyService` | `party/` | æ— éœ€æ”¹åŠ¨ |
| `NarrativeService` | `narrative/` | æ— éœ€æ”¹åŠ¨ |
| `GraphStore` + stores | `persistence/` | æ— éœ€æ”¹åŠ¨ |
| `ContextAssembler` | `query/` | æ— éœ€æ”¹åŠ¨ |
| `SpreadingActivation` | `query/` | æ— éœ€æ”¹åŠ¨ |

### éœ€è¦æ–°å»ºçš„

| æ–°æ¨¡å— | èŒè´£ |
|--------|------|
| **StatsManager** | é‡‘å¸/XP/ç‰©å“çš„å”¯ä¸€å†™å…¥å…¥å£ + å‡çº§è‡ªåŠ¨è§¦å‘ |
| **ShopService** | å•†åº—æ•°æ® + äº¤æ˜“æœºæ¢° + åº“å­˜ç®¡ç† |
| **World API å±‚** | ç»Ÿä¸€æ“ä½œæ¥å£ + æƒé™æ§åˆ¶ |
| **æƒé™å®šä¹‰** | å„ Agent è§’è‰²çš„å¯ç”¨æ“ä½œç™½åå• |

### éœ€è¦æ‹†åˆ†çš„

| å½“å‰æ¨¡å— | åº•å±‚éƒ¨åˆ†ï¼ˆæ”¶å…¥ Engineï¼‰ | ä¸Šå±‚éƒ¨åˆ†ï¼ˆç•™åœ¨ Agent å±‚ï¼‰ |
|---------|---------------------|----------------------|
| `IntentExecutor` | æœºæ¢°æ‰§è¡Œå‡½æ•°ï¼ˆmove/rest/examine/use_itemï¼‰ | TALK æ„å›¾çš„ NPC è°ƒç”¨é€»è¾‘ |
| `V4AgenticToolRegistry` | çŠ¶æ€ä¿®æ”¹æ“ä½œ â†’ æ”¹ä¸ºè°ƒç”¨ StatsManager/World API | å·¥å…·å®šä¹‰/æ ¼å¼åŒ– â†’ ç”± World API ç»Ÿä¸€æš´éœ² |
| `SessionRuntime` | restore/persist/çŠ¶æ€ç®¡ç† | tick ç¼–æ’/å‰¯ä½œç”¨ â†’ ç§»å…¥ Engine è°ƒåº¦å±‚ |
| `PipelineOrchestrator` | A/C é˜¶æ®µçš„æœºæ¢°éƒ¨åˆ† | B é˜¶æ®µçš„ Agent é©±åŠ¨ |
| `InstanceManager` | å®ä¾‹æ± /LRU | å›¾è°±åŒ–è§¦å‘ï¼ˆè°ƒ MemoryGraphizerï¼‰ |
| `SessionHistory` | æ¶ˆæ¯å­˜å‚¨/è¯»å–ï¼ˆåº•å±‚ï¼‰ | è‡ªåŠ¨å›¾è°±åŒ–ï¼ˆä¸Šå±‚ LLMï¼‰ |
| `AdminCoordinator` | æœåŠ¡æ³¨å†Œå·¥å‚ | Agent å¤„ç†æµ + ç§èŠæµï¼ˆåº”èµ° Pipelineï¼‰ |

### å¯ä»¥åºŸå¼ƒ/åˆå¹¶çš„

| å½“å‰ | åŸå›  |
|------|------|
| `AdminWorldRuntime` | ä¸ SessionRuntime èŒè´£é‡å ï¼ˆå¯¼èˆª/æ—¶é—´/çŠ¶æ€ï¼‰ï¼Œåº”åˆå¹¶ |
| MCP `game_tools_server` å¤§éƒ¨åˆ†å·¥å…· | å°†è¢« World API ç»Ÿä¸€æ›¿ä»£ |
| V4 Agentic Tools ä¸­çš„çŠ¶æ€ä¿®æ”¹éƒ¨åˆ† | ç»Ÿä¸€åˆ° StatsManager |
| `flash_cpu._sync_combat_results_to_character()` | ç»Ÿä¸€åˆ° StatsManager |
| StateManager B/C å®ä¾‹ | åˆå¹¶ä¸ºå•ä¸€å®ä¾‹ï¼Œæ¶ˆé™¤ä¸‰å®ä¾‹åˆ†å‰ |
| `CharacterService.add_xp()` æ—§è·¯å¾„ | æ“ä½œ CharacterStore è€Œé WorldGraphï¼Œå·²åºŸå¼ƒ |

---

## å…­ã€éœ€è¦åœ¨é‡æ„ä¸­ä¸€å¹¶è§£å†³çš„å±å±±é—®é¢˜

| é—®é¢˜ | ä¸¥é‡ç¨‹åº¦ | æ¶‰åŠæ–‡ä»¶ | è§£å†³æ–¹å‘ | é˜¶æ®µ 1 çŠ¶æ€ |
|------|---------|---------|---------|-----------|
| StateManager ä¸‰å®ä¾‹åˆ†å‰ | ğŸ”´ é«˜ | `admin_coordinator.py` | åˆå¹¶ä¸ºå•ä¸€å®ä¾‹ | âœ… å·²ä¿®å¤ï¼ˆ1.1ï¼šæ¶ˆé™¤åæœŸæ³¨å…¥ï¼Œå•å®ä¾‹å…±äº« + æ–­è¨€ï¼‰ |
| Player æŒä¹…åŒ–ä»…ä¾èµ–å¿«ç…§ | ğŸ”´ é«˜ | `session_runtime.py` | å¢åŠ ç‹¬ç«‹æŒä¹…åŒ–è·¯å¾„ | âœ… å·²ä¿®å¤ï¼ˆ1.3ï¼šCharacterStore å…œåº• + è„æ ‡è®°å»¶è¿Ÿæ¸…é™¤ï¼‰ |
| XP/Gold/HP æ•£å†™ï¼ˆ5+æ¡è·¯å¾„ï¼‰ | ğŸ”´ é«˜ | å¤šæ–‡ä»¶ | æ”¶å£åˆ° StatsManager | âœ… å·²ä¿®å¤ï¼ˆ1.2+1.6ï¼šstats_manager çº¯å‡½æ•° + sync_combat_rewardsï¼‰ |
| AdminWorldRuntime æ®‹ç•™ | ğŸŸ¡ ä¸­ | `world_runtime.py` | åˆå¹¶å…¥ SessionRuntime | âœ… å·²ä¿®å¤ï¼ˆ1.4ï¼šSR/FlashCPU/Pipeline é›¶ä¾èµ–ï¼ŒAWR ä»…ä¿ç•™ MCP passthroughï¼‰ |
| æ­»ä»£ç ç§¯ç´¯ | ğŸŸ¡ ä¸­ | å¤šæ–‡ä»¶ | æ¸…ç† | âœ… å·²ä¿®å¤ï¼ˆ1.5ï¼š-873 è¡Œï¼‰ |
| except:pass é™é»˜å¼‚å¸¸ | ğŸŸ¡ ä¸­ | å¤šæ–‡ä»¶ | åŠ æ—¥å¿—/æå‡çº§åˆ« | âœ… å·²ä¿®å¤ï¼ˆ1.7ï¼š6 å¤„æ¶ˆé™¤ï¼Œ12 å¤„çº§åˆ«ä¿®æ­£ï¼‰ |
| å‰¯ä½œç”¨å»é‡ä¸æŒä¹…åŒ– | ğŸŸ¡ ä¸­ | `session_runtime.py:82` | æŒä¹…åŒ–åˆ° Firestore | âœ… å·²ä¿®å¤ï¼ˆ2.3ï¼šmetadata æŒä¹…åŒ– + crash recoveryï¼‰ |
| ç§èŠç»•è¿‡ Pipeline | ğŸŸ¡ ä¸­ | `admin_coordinator.py` | ç»Ÿä¸€èµ° Pipeline | â¸ï¸ æœªä¿®ï¼ˆé˜¶æ®µ 4ï¼‰ |
| persist() æ— äº‹åŠ¡ä¿è¯ | ğŸŸ¡ ä¸­ | `session_runtime.py` | å¢åŠ åŸå­æ€§æˆ–è¡¥å¿æœºåˆ¶ | â¸ï¸ æœªä¿®ï¼ˆé˜¶æ®µ 2+ï¼‰ |
| åŒå€ BehaviorEngine tick | ğŸŸ¡ ä¸­ | `pipeline_orchestrator.py` | åˆå¹¶ä¸ºå•æ¬¡æˆ–ä¸¥æ ¼å»é‡ | âœ… å·²ä¿®å¤ï¼ˆ2.4ï¼š_fired_behaviors å›åˆçº§å»é‡ï¼‰ |
| ä¸‰å¥—æ¥å£ä¸ç»Ÿä¸€ | ğŸŸ¡ ä¸­ | REST/MCP/V4 | World API ç»Ÿä¸€æ”¶ç¼– | â¸ï¸ æœªä¿®ï¼ˆé˜¶æ®µ 3ï¼‰ |
| ç¼ºå¤±ç³»ç»Ÿï¼ˆå•†åº—/æƒé™ï¼‰ | ğŸŸ¡ ä¸­ | â€” | æ–°å»º | â¸ï¸ æœªä¿®ï¼ˆé˜¶æ®µ 2-4ï¼‰ |
| Firestore æ—  schema_version | ğŸŸ¢ ä½ | æ¨¡å‹å±‚ | æ·»åŠ ç‰ˆæœ¬å­—æ®µ | â¸ï¸ æœªä¿®ï¼ˆé˜¶æ®µ 2ï¼‰ |

## ä¸ƒã€ä¸åœ¨æœ¬æ¬¡é‡æ„èŒƒå›´

| é¡¹ç›® | åŸå›  |
|------|------|
| æˆ˜æ–—ç³»ç»Ÿé‡æ„ | ç‹¬ç«‹æ–‡æ¡£ï¼ˆ`æˆ˜æ–—ç³»ç»Ÿé‡æ„è®¡åˆ’.md`ï¼‰ï¼Œæˆ˜æ–—å¼•æ“æœ¬èº«å·²ç»å¤Ÿç‹¬ç«‹ |
| å‰ç«¯é€‚é… | ç­‰ World API ç¨³å®šåå†æ¥ |
| ä»»åŠ¡æ± ç³»ç»Ÿ | éœ€è¦åœ¨æ–°æ¶æ„ä¸Šè®¾è®¡ï¼Œä¸æ€¥ |
| æ³•æœ¯ç³»ç»Ÿå®Œå–„ | åç»­åœ¨ character/ å­ç³»ç»Ÿä¸­é€æ­¥æ‰©å±• |

---

## å…«ã€å…³é”®ä»£ç ä½ç½®é€ŸæŸ¥

| å…³æ³¨ç‚¹ | æ–‡ä»¶ | è¡Œå·/æ–¹æ³• |
|--------|------|----------|
| ç©å®¶ XP å†™å…¥ï¼ˆ5 å¤„ï¼‰ | `v4_agentic_tools.py:626`, `:924`, `:1329`, `flash_cpu_service.py:551`, `session_runtime.py:589` | æ¯å¤„éƒ½æ˜¯ `player.xp = ... + N` |
| ç©å®¶ Gold å†™å…¥ï¼ˆ4 å¤„ï¼‰ | `v4_agentic_tools.py:929`, `:1348`, `flash_cpu_service.py:555`, `session_runtime.py:604` | æ¯å¤„éƒ½æ˜¯ `player.gold = ... + N` |
| IntentExecutor æœºæ¢°æ‰§è¡Œ | `intent_executor.py` | `execute_move()`, `execute_rest()`, `execute_examine()`, `execute_use_item()` |
| V4 å·¥å…·æ³¨å†Œï¼ˆ26 ä¸ªï¼‰ | `v4_agentic_tools.py:121-160` | `get_tools()` è¿”å›å…¨éƒ¨å·¥å…·åˆ—è¡¨ |
| é˜Ÿå‹å·¥å…· | `teammate_agentic_tools.py` | ä¸ V4 å¹³è¡Œçš„é˜Ÿå‹å·¥å…·å®šä¹‰ |
| SessionRuntime persist | `session_runtime.py:949-1012` | 7 æ­¥ç»Ÿä¸€æŒä¹…åŒ–ï¼ˆæ­¥éª¤ 5 æœªå®ç°ï¼‰ |
| SessionRuntime restore | `session_runtime.py:164-253` | Wave1 å¹¶è¡Œ + Wave2 ä¸²è¡Œ |
| StateManager ä¸‰å®ä¾‹ | `admin_coordinator.py:85,91-96,108` | A/B/C ä¸‰ä¸ªç‹¬ç«‹å®ä¾‹ |
| åæœŸæ³¨å…¥ | `admin_coordinator.py:121-137` | FlashCPU çš„ service æ³¨å…¥ |
| ç§èŠç»•è¿‡ Pipeline | `admin_coordinator.py` | `process_private_chat_stream()` |
| å‰¯ä½œç”¨å»é‡ï¼ˆå†…å­˜ï¼‰ | `session_runtime.py:82` | `_applied_side_effect_events: Set[str]` |
| WorldGraph é™çº§ | `session_runtime.py:412-427,454-478` | `_world_graph_failed` é™é»˜é™çº§ |
| åŒå€ tick | `pipeline_orchestrator.py:105,345` | pre-tick + post-tick |
| ä¸‰å¥—æ¥å£ | `game_v2.py`(39ç«¯ç‚¹), `app/mcp/tools/*`(43å·¥å…·), `v4_agentic_tools.py`(26å·¥å…·) | è§ 3.3 å®Œæ•´å¯¹æ¯”è¡¨ |
| MCP å…¨å±€å•ä¾‹ | `app/mcp/tools/navigation_tools.py:7-12` | HTTP æ¨¡å¼ä¸‹çŠ¶æ€åˆ†å‰é£é™© |

---

## ä¹ã€æ•°æ®æµå…¨æ™¯ï¼ˆè¡¥å……å®¡è®¡ï¼‰

### PipelineOrchestrator.process() å®Œæ•´è°ƒç”¨é“¾

```
ç©å®¶è¾“å…¥
  â†“
A é˜¶æ®µ: ä¸Šä¸‹æ–‡ç»„è£…
  â”œâ”€â”€ SessionRuntime.restore()
  â”‚     â””â”€â”€ Wave1 å¹¶è¡Œ: GameState, Player, Party, Narrative
  â”‚     â””â”€â”€ Wave2 ä¸²è¡Œ: History, Area, Companions, WorldGraph, Snapshot
  â”œâ”€â”€ session.run_behavior_tick("pre")        â† ç¬¬ä¸€æ¬¡ BehaviorEngine tick
  â”‚     â””â”€â”€ äº§ç”Ÿå‰¯ä½œç”¨äº‹ä»¶ â†’ _applied_side_effect_events å»é‡
  â”œâ”€â”€ IntentResolver.resolve(input)           â† æœºæ¢°æ„å›¾è¯†åˆ«
  â”‚     â””â”€â”€ IntentExecutor.dispatch(intent)   â† å¯ç›´æ¥ä¿®æ”¹ä½ç½®/æ—¶é—´/ç‰©å“
  â”‚           â””â”€â”€ è®¾ç½® context["engine_executed"]
  â””â”€â”€ NPCReactor.collect_reactions()          â† âš ï¸ å« LLMï¼ŒåŸºäºæ—§çŠ¶æ€å¿«ç…§
  â†“
B é˜¶æ®µ: Agentic ä¼šè¯
  â””â”€â”€ FlashCPUService.agentic_process_v4()
        â””â”€â”€ V4AgenticToolRegistry.get_tools()
              â””â”€â”€ å·¥å…·è¿‡æ»¤: è‹¥ engine_executed â†’ æ’é™¤å¯¹åº”å·¥å…·
              â””â”€â”€ LLM å·¥å…·è°ƒç”¨å¯ä¿®æ”¹ WorldGraph/Player/Party/Events
  â†“
C é˜¶æ®µ: åå¤„ç†
  â”œâ”€â”€ session.run_behavior_tick("post")       â† ç¬¬äºŒæ¬¡ BehaviorEngine tick
  â”‚     â””â”€â”€ åŒä¸€äº‹ä»¶å¯èƒ½å†è¯„ä¼°ä¸€éï¼ˆå»é‡ä»…é™æœ¬è½®å†…å­˜ï¼‰
  â”œâ”€â”€ CompanionInstance äº‹ä»¶åˆ†å‘
  â”œâ”€â”€ TeammateResponseService.process_round() â† LLM å†³ç­–
  â””â”€â”€ SessionRuntime.persist()                â† 7 æ­¥ï¼ˆè§ 3.6ï¼‰
```

### ä¸‰ä¸ªå¹¶å‘çš„çŠ¶æ€å­˜å‚¨

```
Firestoreï¼ˆæŒä¹…å±‚ï¼‰
  â”œâ”€â”€ metadata.admin_state  â†’ GameState
  â”œâ”€â”€ metadata.narrative    â†’ NarrativeProgress
  â”œâ”€â”€ world_snapshot/current â†’ WorldGraph å¿«ç…§ï¼ˆå« Player èŠ‚ç‚¹ï¼‰
  â””â”€â”€ parties/{sid}/members â†’ Party æˆå‘˜ï¼ˆå®æ—¶å†™å…¥ï¼‰

StateManager._statesï¼ˆå†…å­˜å±‚ï¼‰
  â”œâ”€â”€ A: AdminCoordinator._state_manager   [å‡ ä¹ä¸ç”¨]
  â”œâ”€â”€ B: AdminWorldRuntime._state_manager  [å®é™…ä½¿ç”¨]
  â””â”€â”€ C: FlashCPUService._state_manager    [å·²å¼ƒç”¨]

WorldGraphï¼ˆä¼šè¯æœŸé—´ï¼‰
  â”œâ”€â”€ èŠ‚ç‚¹ stateï¼ˆXP, HP, ä½ç½®, ç‰©å“ï¼‰
  â”œâ”€â”€ å¿«ç…§ä¿å­˜åˆ° Firestore â†’ æ¢å¤æ—¶åŠ è½½
  â””â”€â”€ _world_graph_failed æ—¶å…¨éƒ¨é™çº§
```

---

## åã€æ¨èçš„è®¡åˆ’å‘½å

| åç§° | é£æ ¼ |
|------|------|
| **ä¸‰å±‚ä¸–ç•Œ** | ç›´ç™½ï¼Œæè¿°æ¶æ„å½¢æ€ |
| **å¤©åœ°äºº** | å¤©=Agentï¼ˆé£ï¼‰ï¼Œåœ°=Engineï¼ˆéª¨æ¶ï¼‰ï¼Œäºº=APIï¼ˆè§„åˆ™ï¼‰ |
| **Strandbeest 2.0** | å»¶ç»­æ–¹å‘æ‰‹å†Œçš„æ ¸å¿ƒæ¯”å–» |
| **ä¸–ç•Œå¼•æ“åŒ–** | å¼ºè°ƒ"æŠŠä¸–ç•Œåšæˆå¼•æ“" |
| **éª¨æ¶å‡æ ¼** | å¼ºè°ƒä»æ··åˆæ¶æ„å‡çº§ä¸ºåˆ†å±‚æ¶æ„ |

---

## åä¸€ã€å˜æ›´æ—¥å¿—

| æ—¥æœŸ | æ“ä½œ |
|------|------|
| 2026-02-20 | åˆ›å»ºã€‚ä¸‰ä»£ç†å…¨é¢ç›˜ç‚¹ä»£ç åº“ï¼Œåˆ†ç±»æ‰€æœ‰æ¨¡å—ï¼Œè¯†åˆ«æ ¸å¿ƒé—®é¢˜ï¼Œç¡®ç«‹ä¸‰å±‚æ¶æ„æ–¹å‘ |
| 2026-02-20 | è¡¥å……å®¡è®¡ã€‚å››ä»£ç†ä¸“é¡¹æ·±æŒ–ï¼šâ‘ æ•°æ®æµä¸ä¾èµ–å…³ç³» â‘¡ä¸‰å¥—æ¥å£å®Œæ•´äº¤å‰å¯¹æ¯” â‘¢é—æ¼æ¨¡å—ä¸éšè—è€¦åˆ â‘£Firestore æ•°æ®æ¨¡å‹ã€‚æ–°å¢ 3.3 å®Œæ•´å¯¹æ¯”è¡¨ã€3.5-3.8 å››ä¸ªæ–°é—®é¢˜ç« èŠ‚ã€2.5 é—æ¼æ¨¡å—ã€ç¬¬å…­ç« å±å±±é—®é¢˜ã€ç¬¬ä¹ç« æ•°æ®æµå…¨æ™¯ |
| 2026-02-20 | **é˜¶æ®µ 1 å®Œæˆåæ›´æ–°**ï¼šç¬¬å…­ç« å±å±±é—®é¢˜è¡¨å¢åŠ é˜¶æ®µ 1 ä¿®å¤çŠ¶æ€åˆ—ï¼ˆ7 é¡¹ âœ… + 6 é¡¹ â¸ï¸ï¼‰ã€‚Codex å®¡è®¡ç¡®è®¤å±å±±è¯„åˆ†ä»åˆå§‹ ~8/10 é™è‡³ 6/10 |
