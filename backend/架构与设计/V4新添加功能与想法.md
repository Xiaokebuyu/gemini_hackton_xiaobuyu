# V4 待办功能与设计想法

## 待办事项

### [ ] 时间系统与 LLM 解耦

**优先级**: 高 | **类型**: 架构重构

当前时间推进依赖 agentic 工具调用（`update_time`），由 LLM 决定是否/何时推进时间。问题在于：

- LLM 可能遗忘推进时间，导致时间停滞
- 时间推进粒度不一致（有时跳太多，有时不动）
- 时间本质上是世界机械层的一部分，不应由叙述层控制

**目标设计**: 时间作为世界底层运行时的一部分，随玩家操作自动流逝：

- 地点移动 → 根据距离自动消耗旅行时间
- 环境操作（探索/搜索/休息）→ 消耗对应时长
- NPC 对话 → 每轮对话消耗少量时间
- 战斗 → 根据回合数消耗时间
- LLM 仅保留"等待/休息"等显式时间跳跃的控制权

**实现思路**: 在 `SessionRuntime` / `AreaRuntime` 层注入时间消耗规则，各工具执行后自动调用 `session.advance_time(minutes)` 而非由 LLM 主动调用 `update_time` 工具。

---

### [ ] 完整商店系统

**优先级**: 中 | **类型**: 新功能

实现可交互的商店/交易系统，支持买卖物品、讨价还价、NPC 好感影响价格等。

---


### 环境掷骰检定，这个真得做做吧！


### 逐个工具排查
V4 工具注册表就是整个 runtime                            
  的操作面，逐个排查等于对核心链路做端到端验证。                     
  
  当前注册了 22 个工具，按功能分 9 组：                              
  组: 导航        
  工具: navigate, enter_sublocation, leave_sublocation               
  后端依赖: SessionRuntime.enter_area/sublocation                    
  ────────────────────────────────────────
  组: NPC
  工具: npc_dialogue
  后端依赖: FlashCPU → MCP game_tools
  ────────────────────────────────────────
  组: 记忆
  工具: recall_memory, create_memory
  后端依赖: RecallOrchestrator / GraphStore
  ────────────────────────────────────────
  组: 时间
  工具: update_time
  后端依赖: FlashCPU → MCP game_tools
  ────────────────────────────────────────
  组: 玩家状态
  工具: heal_player, damage_player, add_xp, add_item, remove_item
  后端依赖: SessionRuntime.player 直改
  ────────────────────────────────────────
  组: 战斗
  工具: start_combat, get_combat_options, choose_combat_action
  后端依赖: FlashCPU → MCP combat
  ────────────────────────────────────────
  组: 队伍
  工具: add_teammate, remove_teammate, disband_party
  后端依赖: FlashCPU → MCP game_tools
  ────────────────────────────────────────
  组: 检定/好感
  工具: ability_check, update_disposition
  后端依赖: FlashCPU / GraphStore
  ────────────────────────────────────────
  组: 事件/章节
  工具: activate_event, complete_event, advance_chapter,
    complete_objective
  后端依赖: AreaRuntime / SessionRuntime
  ────────────────────────────────────────
  组: 图片
  工具: generate_scene_image
  后端依赖: ImageGenerationService
  要逐个排查的话，建议的优先级是：

  1. 事件/章节组 — 刚改完的核心，验证 activate → complete → advance
  链路、回合计数器递增、completion_hint 生成
  2. 导航组 — 涉及区域切换 + 事件重评估
  3. NPC 对话 — 依赖 MCP 连通性
  4. 其他 — 玩家状态/队伍/战斗/记忆

---

## 章节-地图数据调研（2026-02-12）

### 现有 10 张地图

| ID | 名称 | 危险度 | 区域 | 子地点数 | 被章节开放数 |
|----|------|--------|------|---------|------------|
| `frontier_town` | 边境小镇 | low | 边境地区 | 7 | **40** |
| `cow_girl_farm` | 牧场 | low | 边境地区 | 2 | 13 |
| `water_town` | 水之都 | low | 西方未知境 | 2 | 14 |
| `underground_waterway` | 地下水道 | high | 水之都(地下) | 0 | 9 |
| `whispering_woods` | 轻语森林 | medium | 西方未知境 | 1 | 7 |
| `mirror_lake` | 镜子湖 | high | 轻语森林深处 | 0 | 6 |
| `sol_tower` | 索尔之塔 | extreme | 兰德索尔 | 0 | **0** |
| `landosol_city` | 兰德索尔 | low | 大陆南部 | 1 | **0** |
| `narukami_island` | 鸣神本岛 | medium | 鸣神群岛 | 2 | **0** |
| `velen` | 威伦 | high | 大陆南部 | 1 | **0** |

**4 张孤岛地图**: `sol_tower`、`landosol_city`、`narukami_island`、`velen` 没有任何章节在 `available_areas` 里引用，当前永远无法到达。

### 地图门禁机制（已确认有效）

三层执行，全部基于章节的 `available_areas` 字段：

1. **NarrativeService** (`narrative_service.py:697-720`) — 权威判定 `is_map_available()`
2. **AdminWorldRuntime** (`world_runtime.py:275-283`) — API 路由级拦截，返回 "该地区尚未解锁"
3. **V4AgenticToolRegistry** (`v4_agentic_tools.py:298-315`) — LLM 工具级拦截

特殊逻辑：`available_maps=["*"]` 全部解锁；`available_maps=[]` 全部锁定；章节不存在 fallback 为 `["*"]`。

`maps.json` 中所有连接的 `requirements` 均为 `null`，门控完全靠章节。

### 18 个 `available_areas` 为空的章节

| 分类 | 章节 | 实际故事场景 | 现有地图能覆盖？ |
|------|------|-------------|----------------|
| **矿人堡垒/地牢** (5章) | ch_5_3_2, ch_5_5, ch_5_6, ch_5_7, ch_5_8 | 矿人堡垒（地牢→城墙→雪山） | **不能** — 需新地图 |
| **古墓** (2章) | ch_6_4, ch_6_6 | 古代陵墓 | **不能** — 需新地图 |
| **古代遗迹** (1章) | ch_1_7 | 哥布林遗迹 | **不能** |
| **沉没巨林** (1章) | ch_5_2_3 | 利维坦巢穴 | **不能** |
| **frontier_town** (1章) | ch_5_1_2 | 边境小镇日常 | **能** |
| **地下+部落** (1章) | ch_5_4_4 | 隧道+蜥蜴人营地 | 勉强 `underground_waterway` |
| **抽象/Meta** (4章) | ch_2_6, ch_5_2, ch_5_4, ch_6_5 | 无物理地点（记忆/总纲/任务管理器） | N/A — 需 fallback |
| **对话/不定** (3章) | ch_5_4_3, ch_5_5_2, ch_6_81 | 地点随剧情变化 | 用 `frontier_town` 兜底 |

### 需要新增的地图

按现有 `maps.json` 格式手搓即可，结构为：`id / name / description / atmosphere / danger_level / region / connections / available_actions / key_features / sub_locations`

**明确需要**:
1. **矿人堡垒** (`dwarf_fortress`) — vol_5 战争弧 5 章的连续场景
2. **古墓** (`ancient_tomb`) — vol_6 探墓弧 2 章

**可能需要**:
3. **沉没巨林** (`sunken_forest`) — 古神弧利维坦巢穴
4. **古代遗迹** (`ancient_ruins`) — vol_1 ch_1_7 的哥布林遗迹

### 代码侧待办：空 `available_areas` 的 fallback

当章节 `available_areas` 为空列表 `[]` 时，所有地图被锁，玩家卡死。需要 fallback 逻辑（如保持当前地图可用）。

### 故事线结构

全局主链: vol_1 → vol_2 → vol_3 → vol_4 → vol_5 → vol_6（82 章，chapter_graph 串联）

Vol 1-2 纯线性，Vol 3 开始出现平行线：

**Vol 3**: 7 主线 + 6 平行线 (ch_3_X_2)
**Vol 4**: 基本线性 (7章)
**Vol 5**: 最复杂 — 24 章，4 条交织故事弧：

```
               ┌─ ch_5_2 ("古神卷总纲") ──→ ch_6_1 (跳到卷6)
ch_5_1("预演") ┤
               └─ ???

ch_5_3("总纲") → ch_5_4("总纲") → ch_5_5 → ch_5_6 → ch_5_7 → ch_5_8("新的黎明")
                                      ↑                              │
          ch_5_2_2 → ch_5_3_2 → ch_5_4_2 ┘(合流)                     ↓
                                                                  ch_5_1_2("古神·眼眸")
                                                                     │
          ch_5_2_3 → ch_5_3_3 → ch_5_4_3 → ch_5_5_2 ──┐             │
                                                        ↓             ↓
                                                     ch_5_1_3 ← (合流)
                                                        │
          ch_5_3_4 → ch_5_4_4 → ch_5_5_3 ──┐           │
                                            ↓           ↓
                                         ch_5_1_4 ← (合流)
                                            │
                          ch_5_2_4 → ch_5_2_5 ← (合流)
                                        │
                                     ch_5_3_5
```

| 弧 | 章节 | 内容 | 来源 |
|---|---|---|---|
| 矿人堡垒战 | ch_5_3→ch_5_4→ch_5_5~ch_5_8 | 突袭→攻城→地牢→城墙→雪山 | 主线 |
| 前传/准备 | ch_5_2_2→ch_5_3_2→ch_5_4_2 | 合流到 ch_5_5 | — |
| 古神·利维坦 | ch_5_1_2→...→ch_5_5_2→... | 眼眸→追寻→威压→终曲 | 作者 sulfurzero |
| 边境魔物饭 | ch_5_3_4→ch_5_4_4→ch_5_5_3 | 蜥蜴人救援+部落结盟 | — |

**Vol 6**: 主链 ch_6_1→...→ch_6_11 + 支线 ch_6_81→ch_6_82（魅魔角色线）

### 主链断裂与开局章节 BUG（2026-02-12 续）

**BUG**: 开局实际使用 Vol 2 Ch 1 而非 Vol 1 Ch 1
**根因**: `narrative_service.py` 从 Firestore 加载 mainlines 时 `.stream()` 不保证顺序，
`_resolve_default_progress()` 取 `next(iter(mainlines.keys()))` 恰好拿到 vol_2。
**修复**: `load_narrative_data()` 存入缓存前按 key 排序。

**全局主链骨干** (44 章, Vol 1→4):
ch_1_1 → ... → ch_1_13 → ch_2_1 → ... → ch_2_11 → ch_3_1 → ... → ch_3_7 → ch_4_1 → ... → ch_4_6

**断裂点**:
- ch_4_6 → ch_5_1: chapter_graph 中**缺失此边**，Vol 4→5 无法自动衔接
- Vol 5 "主链"仅 2 步: ch_5_1 → ch_5_2 → ch_6_1（跳到卷6），24 章实际内容全在侧链

**待修复的数据问题** (后续):
- ch_4_6 → ch_5_1 缺失链接
- Vol 5 侧链（矿人堡垒/古神/魔物饭/抉择弧）缺少从主链接入的入口
- 18 个章节 available_areas 为空（需新增地图或 fallback）