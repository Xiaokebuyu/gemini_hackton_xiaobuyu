# 世界观图谱导入流程（Phase 2）

本流程面向“大文本世界观资料”导入（2–3MB 或更大），默认采用 LLM 批量抽取生成图谱。

> 目标：将纯文本世界观资料导入到 `ontology` 图谱中，形成可查询的基础知识图谱。

---

## 1. 预处理与切分

建议按 800–1500 字符切分，保留段落边界，减少跨块信息丢失。

工具：`app/tools/ontology_batch_prep.py`

示例：
```
python -m app.tools.ontology_batch_prep \
  --input data/world.txt \
  --output data/ontology_chunks.jsonl \
  --chunk-size 1200 \
  --overlap 0 \
  --source bg3_world
```

如果需要生成 LLM Prompt，可指定模板：
```
python -m app.tools.ontology_batch_prep \
  --input data/world.txt \
  --output data/ontology_prompts.jsonl \
  --template app/tools/templates/ontology_extract_prompt.txt
```

---

## 2. LLM 批量抽取

每个 JSONL 行应包含：
```
{
  "chunk_id": "chunk_0001",
  "source": "bg3_world",
  "text": "...",
  "prompt": "...可选..."
}
```

LLM 返回格式必须为：
```
{
  "nodes": [...],
  "edges": [...]
}
```

### ID 规则（强烈建议）
- 人物：`person_<slug>`
- 地点：`location_<slug>`
- 组织：`org_<slug>`
- 物品：`item_<slug>`
- 事件：`event_<slug>`

### 避免重复
为同一实体保持一致 ID；如不确定，可先统一用占位 ID，后续用脚本修正。

---

## 3. 导入到 Firestore

导入工具：`app/tools/graph_importer.py`

示例：
```
python -m app.tools.graph_importer \
  --input data/llm_outputs.jsonl \
  --world demo_world \
  --graph ontology \
  --build-indexes
```

建议流程：
1) 批量导入（不写索引）
2) 导入完成后运行索引重建（更快更稳）
```
python -m app.tools.graph_indexer --world demo_world --graph ontology
```

---

## 4. 数据抽样检查与去重

导入前建议先审查 LLM 输出：
```
python -m app.tools.graph_review --input data/llm_outputs.jsonl --report data/review_report.json
```

如果存在明显重复（同名不同 ID），可使用合并工具：
```
python -m app.tools.graph_merge --input data/llm_outputs.jsonl --merge-by-name --report data/merge_report.json
```

建议抽样检查：
- 关键实体是否被识别
- 关系方向是否合理
- 节点类型是否符合 `NodeType`

---

## 5. 可选：Schema 校验

导入时可启用校验：
```
python -m app.tools.graph_importer \
  --input data/llm_outputs.jsonl \
  --world demo_world \
  --graph ontology \
  --validate --strict
```

---

## 参考文件

- Schema 枚举：`app/models/graph_schema.py`
- 基础校验：`app/services/graph_schema.py`
- 导入工具：`app/tools/graph_importer.py`
- 切分工具：`app/tools/ontology_batch_prep.py`
- Prompt 模板：`app/tools/templates/ontology_extract_prompt.txt`
- 输出规范：`design2/世界观图谱输出规范.md`
- 评审工具：`app/tools/graph_review.py`
- 合并工具：`app/tools/graph_merge.py`
