# 图世界活物化 — 方向手册

> 创建时间：2026-02-18
> 状态：方向确立，持续落地中（A.1 第五批 F18/F19 已实现）
> 前置：世界底层重构（C1-C8 + C9 引擎完善）全部完成

---

## 一、设计哲学

### 1.1 Strandbeest 模型

Theo Jansen 的风力动物没有大脑，但通过精密的机械联动，遇风就走、遇水就退、被困就挣脱。它的"智能"完全来自结构设计。

**图世界 = Strandbeest，LLM = 风。**

图不需要"理解"世界——它通过节点拓扑、条件评估、行为触发、状态转移这些纯机械操作，产出丰富的信号。LLM 消费这些信号，将机械反馈变成活的叙事。

### 1.2 骨架与蒙版

```
图世界 = 骨架
  │  节点拓扑（世界→章节→区域→地点→NPC/事件）
  │  行为引擎（BehaviorEngine: tick → 条件评估 → 动作执行 → 级联传播）
  │  事件状态机（LOCKED → AVAILABLE → ACTIVE → COMPLETED/FAILED → COOLDOWN）
  │  约束与门控（章节 gate、area_lock、blocked 边）
  │
世界书内容 = 蒙版
  │  narrative_directive: 不是台词脚本，是 NPC 动机和世界状态描述
  │  事件不是"剧情节点"，是"世界中存在的压力或机会"
  │  玩家可以选择响应或暂时无视
  │  GM 的职责是呈现这些存在，不是强迫推进
```

骨架决定世界**能做什么**，蒙版决定世界**为什么这样做**。

### 1.3 三条底层原则

1. **引擎驱动 + 状态回报**：BehaviorEngine 是主循环，LLM 工具调用是手动覆盖手段
2. **系统是真理源，LLM 是叙述者**：地图/条件/时间/状态由引擎决定，LLM 只负责把骨架变成活的叙事
3. **呈现而非推进**：GM 让玩家感知到压力/机会的存在，玩家主动响应才激活

### 1.4 活物感的来源

> **风吹过来，机械结构自己动。不需要有人手动操作关节。**

玩家输入 = 风。引擎机械响应 = 联动。GM = 解说。

不是"LLM 用工具操作世界"（那是提线木偶），而是"输入到达 → 引擎自行处理 → 结果流入总线 → 所有消费者各自反应"。

### 1.5 场景总线（Scene Bus）

图节点（子地点/区域）同时也是**消息总线**的物理载体。所有主体的行为和发言都写入同一条总线：

```
子地点节点 state.scene_bus:
  [
    {actor: "player",       type: "action",  content: "向小神官走近"},
    {actor: "guild_girl",   type: "speech",  content: "有什么事吗？"},
    {actor: "priestess",    type: "emotion", content: "低头不语，情绪低落"},
    {actor: "engine",       type: "state",   content: "event:guild_quest_01 → available"},
  ]
```

**谁写入总线**：
- 玩家行动（player input）
- NPC 自主发言（npc_dialogue 结果）
- 队友自主反应（teammate agent 结果）
- 引擎状态变更（事件解锁、好感度变化、时间推进等）

**谁消费总线**：
- GM：读取后生成叙述 + 决定工具调用
- 队友 Agent：读取后决定自己的反应
- NPC Agent（未来）：读取后决定自主行为

总线解决了信号分发问题——不需要为每个消费者定制路由，所有人从同一个源头读取。

### 1.6 GM = 旁观者 + 风

GM 不生产世界内容（不代替 NPC 说话、不代替队友反应），GM 只做两件事：

**旁观者**：以自己的人格（幽默、腹黑、看热闹不嫌事大）消费总线信号，把机械事件变成生动的场景叙述。

> "你看你那迫不及待贴近漂亮女孩的样子——不过她现在情绪可不太好，也许得送点礼物？"

**风**：对于引擎无法机械处理的模糊意图，GM 将其解读为结构化信号交给引擎执行。GM 不直接操作世界，而是把风引导到正确的机械关节上。

```
总线信号 ──→ GM 消费 ──┬→ 叙述（旁观者视角：评论、提示、氛围渲染）
                       └→ 意图解读（风：将模糊输入转化为引擎可执行的结构化信号）
```

**原则**：各主体自产信息，GM 只消费不代言。能机械处理的不经过 GM。

### 1.7 从苦力到艺术家

引擎接管机械操作，不是削弱 AI，是释放 AI。

**当前**：1 个 GM agent 包揽一切——调用工具、代言 NPC、代替队友反应、叙述氛围。大量 token 消耗在跑腿上。

**目标**：多个专精 agent 各司其职——

| 角色 | 只做 AI 才能做的事 |
|------|-------------------|
| GM | 旁观者叙述、氛围渲染、模糊意图解读、创意裁决 |
| NPC agent × N | 用自己的性格/记忆/动机说话 |
| 队友 agent × N | 自主决策、情感反应、主动互动 |
| 引擎 | 机械操作（条件/状态/时间/位置）——不需要 AI |

AI agent 的总数增加，每个 agent 的创意密度提升。好的 DM 不花时间查表算骰——那是规则书的事。DM 的价值在于把规则结果变成活的叙事。

### 1.8 层叠图与统一扩散

整个世界是层层叠加的小图，扩散激活是跨层的统一查询语言。

```
玩家说 "哥布林"
  ↓ 扩散激活同时命中多层图
  │
  ├─ 子地点会话图：上次在公会大厅聊哥布林时说了什么
  ├─ 队友个人图：女神官记得上次哥布林洞窟的创伤
  ├─ 区域知识图：这个地区的哥布林最近活动频繁
  └─ 世界知识图：哥布林的一般习性和弱点
  ↓
  合并 → 注入总线 → 所有 agent 消费
```

现有 GraphScope 已覆盖世界/章节/区域/子地点/角色/营地六个层级，RecallOrchestrator 已支持多 scope 查询。需要补充的：

| 层级 | GraphScope | 现状 | 新增 |
|------|-----------|------|------|
| 子地点 | `location(cid, aid, lid)` | scope 存在，未充分利用 | **会话图**：回合结束 → flash 图谱化 → 话题节点 + 发言节点 |
| 队友 | `character(char_id)` | 仅 NPC 有 MemoryGraph | **队友个人图**：队友的经历/情感/观点做图谱化 |

新图挂到正确的 GraphScope 下，即可自动参与跨层扩散激活——无需额外路由。

---

## 二、已完成的基础

| 层级 | 已建成 | 相关文档 |
|------|--------|---------|
| 图建模 | WorldGraph 容器、6 步构图、多层节点与关系边 | `世界活图详细设计.md` |
| 行为引擎 | 7 种触发器、10 种条件、6 种动作、tick 主循环、级联传播 | `图世界能力矩阵（实施中）.md` |
| 事件全生命周期 | 6 态状态机 + 多阶段 + 分支结局 + 失败/超时/冷却 | `C9引擎完善与管线升级计划.md` |
| 状态回报 | world_state_update 8 类变更 → GM 上下文 | `pipeline_orchestrator.py` |
| GM Prompt | 呈现而非推进、世界引导者角色定义 | `flash_agentic_system.md` |
| 快照持久化 | 脏追踪 + 增量快照 + Firestore 持久化 | `snapshot.py` |
| 316 个测试 | 世界系统核心全覆盖 | `tests/test_*` |

---

## 三、前进方向

### 方向 A：总线驱动架构 — 引擎执行，总线流转，LLM 吹风

> 合并原方向 A（信号丰富化）+ B（多消费者路由）+ E（机械层下沉）

**核心转变**：从"LLM 用工具操作世界"（提线木偶）到"引擎自行响应输入，总线广播结果，LLM 叙述+引导"（Strandbeest）。

**当前**：
```
玩家说 "我走向森林"
  → GM（LLM）理解意图 → GM 调用 navigate("forest") → 结果返回 GM → GM 叙述
```

**目标**：
```
玩家说 "我走向森林"
  → 写入总线
  → 引擎机械处理：验证连接 → 推进时间 → 更新位置 → ON_EXIT/ON_ENTER → 级联
  → 结果写入总线
  → 所有消费者读总线：GM 叙述、队友反应、NPC 响应
```

#### A.1 场景总线基础设施

**挂载位置**：子地点节点。区域是概念，子地点才是发生活动的地方。

**实现进展（2026-02-18）**：
- ✅ 回合末 `SceneBus` 图谱化已接入主流程（`scene_bus.clear()` 前执行，失败降级不阻断）
- ✅ 进入子地点时的扩散激活召回已接入，并以 SYSTEM 条目注入当回合总线

**两层结构**：

```
┌─ 瞬时层：scene_bus（内存，当回合所有 actor 的发言/动作）
│    → 回合结束后清空
│
└─ 持久层：会话图（子地点节点的 GraphScope.location() 下）
     → 话题节点 + 发言节点 + ABOUT/RESPONDS_TO 边
     → flash 图谱化（回合结束时，类似 MemoryGraphizer）
     → 进入子地点时，扩散激活召回相关历史 → 注入总线
```

**瞬时总线条目**：

```python
BusEntry = {
    "id": str,                  # 唯一 ID，供 RESPONDS_TO 引用
    "actor": str,               # "player" | npc_id | teammate_id | "engine" | "gm"
    "type": str,                # "action" | "speech" | "state" | "narration"
    "content": str,             # 人可读内容
    "round": int,
    "game_time": str,           # "第1天 14:30"
    "responds_to": str | None,  # 回复哪条 entry（可选）
    "topics": list[str],        # 关联话题标签（图谱化时用）
}
```

**持久会话图**（挂在 `GraphScope.location(cid, aid, lid)` 下）：

```
节点类型：
  topic:     {name: "哥布林任务", last_round: 5, mention_count: 3}
  utterance: {actor: "guild_girl", content: "...", round: 3, game_time: "..."}

边类型：
  ABOUT:       utterance → topic
  BY:          utterance → actor 节点（NPC/队友/player）
  RESPONDS_TO: utterance → utterance
```

**图谱化**：回合结束 → flash 模型从总线条目中提取话题、关联关系 → 写入持久会话图。复用 MemoryGraphizer 同一模式。

**召回**：进入子地点时 → 用玩家上下文做扩散激活 → 命中话题节点 → 扩散到关联发言 → 注入总线作为历史上下文。跨层激活同时命中子地点会话图 + 队友个人图 + 区域/世界知识图（1.8）。

**回合执行顺序**：

```
1. 玩家输入 → 写入总线
2. 引擎机械处理 → 写入总线（位置变更、事件触发、时间推进等）
3. NPC agents 读总线 → 被触发的 NPC 自主响应 → 写入总线
4. GM 读总线（含 1-3）→ 旁观者叙述 → 写入总线
5. 队友 agents 读总线（含 1-4）→ 自主反应 → 写入总线
6. flash 图谱化：总线条目 → 提取话题 → 写入子地点持久会话图
7. 清空瞬时总线
```

**写入者**：玩家行动、NPC 发言、队友反应、引擎状态变更、GM 叙述
**消费者**：所有人从同一条总线读取，不需要专线路由

#### A.2 引擎作为意图执行器

**两步流程**：玩家自由文本 → 意图解析（flash 分类 + 图结构约束匹配）→ 引擎执行 or GM 兜底。

**意图解析**：借鉴传统 CRPG 的约束输入思路。图结构本身定义了"当前可选动作空间"——CONNECTS 边 = 合法目的地，HOSTS 的 NPC 节点 = 可对话对象，inventory = 可用物品。意图解析只需将自由文本匹配到这些候选项上，匹配不上的才交给 GM。

**现有基础设施评估**：

| 意图类型 | 基础设施覆盖 | 直接执行？ | 需要新建 |
|---------|-------------|-----------|---------|
| **MOVE** 移动 | 95% — navigate() 核心逻辑完整（连接验证/时间推进/ON_EXIT/ON_ENTER） | ✅ | 从工具包装中提取为引擎函数 |
| **TALK** 对话 | 100% — NPC 三层 AI 系统完整（Passerby/Secondary/Main） | ✅ | 路由到 NPC agent 而非 GM 调用 |
| **EXAMINE** 观察 | 80% — get_area_context() + get_location_context() 已有 | ⚠️ | 聚合包装 examine() |
| **USE_ITEM** 物品 | 70% — inventory 操作有，ITEM_EFFECTS 模板有 | ⚠️ | 物品效果执行器 |
| **REST** 休息 | 85% — update_time() + heal_player() 已有 | ✅ | rest() 语义包装 |
| **SOCIAL** 技能检定 | 75% — ability_check() d20 机制已有 | ⚠️ | 验证 proficiency 完整性 |
| **COMBAT** 战斗 | 100% — 战斗引擎完全独立 | ✅ | 无 |

**结论**：三个最高频意图（MOVE/TALK/COMBAT）完全能直接执行。核心逻辑已在 v4_agentic_tools.py 中，只需从 LLM 工具包装中拆出为引擎可直接调用的函数。补 3-4 个轻量包装即可达到 90%+ 覆盖。

**行动方向**：
1. 从 v4_agentic_tools.py 提取 MOVE/TALK/COMBAT 的核心逻辑为独立引擎函数
2. 新建意图解析器（复用现有 flash_analysis，输出结构化意图而非 GM 工具选择）
3. 补齐 EXAMINE/USE_ITEM/REST 的轻量包装
4. GM 工具集缩减为：仅保留 `creative_action()`（处理引擎无法分类的创意行为）

**GM 剩余的主动权**：只处理引擎无法机械判定的模糊情况（如玩家意图不明确时的解读、图上没有定义的创意行为）。

#### A.3 各主体自产信息 + Agent 生命周期

**原则**：谁的发言谁自己产，结果写入总线。GM 不代言。

**总线参与规则**：

```
始终在总线：队伍成员（队友 agent 始终活跃）
触发加入：
  - 玩家主动对话（TALK 意图匹配到 NPC）
  - 引擎行为触发（ON_ENTER 问候、ON_DISPOSITION 好感度反应）
  - 玩家在 NPC 所在子地点（被动感知，可选）
不在总线：其他位置的 NPC
```

**NPC agent 生命周期**（复用现有 InstanceManager）：

```
休眠（WorldGraph 节点，无活跃 agent）
  → 触发唤醒（玩家对话 / 引擎行为 / 进入子地点）
  → 活跃（InstanceManager 实例化，读总线，响应，写总线）
  → 回归休眠（对话结束 / 玩家离开，实例留在池中 LRU）
```

**NPC agent 上下文组装**（现有基础设施已覆盖大部分）：

| 来源 | 现有？ | 说明 |
|------|--------|------|
| 角色数据 | ✅ WorldGraph 节点 | 性格、动机、disposition |
| 叙事蒙版 | ✅ narrative_directive | 世界书提取的角色背景 |
| 对话记忆 | ✅ MemoryGraph | 长期语义记忆 |
| 工作记忆 | ✅ ContextWindow | 当轮对话上下文 |
| 场景历史 | 🆕 子地点会话图 | 扩散激活召回相关历史（A.1） |

**队友 agent**：始终活跃，上下文 = 上表 + CompanionInstance 事件日志 + 队友个人图（1.8 新增）。

**记忆召回策略**：不做自动 SA（太吵太贵），recall_memory 作为按需工具保留。agent 遇到记忆中没有的话题时主动调用扩散激活——和人主动回忆一样。

**agent 输出自动化**：agent 的文本输出自动包装为 BusEntry 写入总线，不需要显式"写入"工具。agent 输出中的机械意图（如"我来撬锁"）由 A.2 意图解析器统一处理，引擎自动执行。

**队友工具集**（仅保留需要判断力的）：

| 工具 | 用途 | 为什么需要 AI |
|------|------|-------------|
| update_disposition | 好感度自主判断 | 价值判断："这件事让我开心/不爽" |
| choose_combat_action | 战斗战术决策 | 人格表达：勇猛冲锋 vs 谨慎治疗 |
| recall_memory | 按需记忆召回 | 主动回忆："这个好像在哪见过..." |
| buy_item（未来） | 消费偏好 | 人格表达：冲动消费 vs 务实囤药 |

**信息流**：

- **NPC**：被唤醒 → 读总线 → 自主回复 → 写入总线
- **队友**：始终读总线 → 自主决定是否反应 → 写入总线
- **引擎**：条件满足 → 状态变更 → 写入总线
- **GM**：读总线全部内容 → 旁观者叙述 → 写入总线

#### A.4 GM 角色重定义

GM 从"全知全能的操作员"变为"消费总线的旁观者 + 引导风"：

- **消费不代言**：读到 NPC 发言后评论，不替 NPC 说话
- **旁观者人格**：幽默、腹黑、看热闹不嫌事大、适时提供有用信息
- **风的角色**：对模糊意图做出解读，引导引擎处理；对引擎处理不了的创意场景做叙事裁决
- **GM prompt 改造**：基于现有 `flash_agentic_system.md`，删除工具操作指导，强化旁观者人格定义和总线消费指导

---

### 方向 B：战斗 AI 自主行动 — 队友与 NPC 的战场决策

**核心问题**：战斗中队友行动由谁决策？当前缺乏队友/NPC 的独立战斗 AI。

**方向**：
- 队友 agent 读取战斗状态（从总线或战斗引擎）→ 根据自身性格和战术偏好 → choose_combat_action
- 勇猛型冲锋、谨慎型治疗、策略型控场——战斗风格是人格表达
- NPC 敌人 AI 已有（`ai_opponent.py`），队友 AI 复用同一框架但用角色性格驱动
- 未来扩展：商店系统中队友自主购买装备（buy_item）

**相关设计**：`队友Agent化与世界活图计划.md` Phase A、`app/combat/ai_opponent.py`

---

### 方向 C：管线升级 — 给骨架穿上更好的蒙版

**核心问题**：引擎能消费的字段（completion_conditions、on_complete、stages、outcomes、activation_type），管线还没提取。数据缺口导致引擎空转。

**方向**：
- v2 提取 prompt 已就绪（`chapter_orchestration_v2.md`），需要全量执行
- 从 76 万字原始 lorebook 中提取完整字段，通过 Batch API 一次性完成
- 后处理脚本自动推导 unlock_events + 引用校验

**相关设计**：`C9引擎完善与管线升级计划.md` 第四步、`数据源强化规格书.md`

---

### 方向 D：新功能立项

| 功能 | 来源 | 说明 |
|------|------|------|
| U3 物品图化 | 能力矩阵 | HAS_ITEM 边实例化，物品作为图节点 |
| U13 快速旅行 | 能力矩阵 | waypoint 系统 |
| U14 营地系统 | 能力矩阵 | 角色私聊、同伴对话、角色事件 |
| U16 NPC 日程 | 能力矩阵 | schedule_table → ON_TIME Behavior |
| 商店系统 | V4 想法 | 买卖、讨价还价、好感影响价格、队友自主购买 |
| 环境掷骰检定 | V4 想法 | 探索/搜索/陷阱等 |

---

## 四、方向之间的关系

```
方向 C（管线升级：补数据）
  │
  │  数据到位后引擎自动生效
  ↓
方向 A（总线驱动架构）
  │  A.1 总线基础设施
  │  A.2 引擎作为意图执行器
  │  A.3 各主体自产 + Agent 生命周期 + 队友 Agent 化
  │  A.4 GM 角色重定义
  │
  │  总线 + 战斗引擎就绪后
  ↓
方向 B（战斗 AI 自主行动）
  │
  │  基础能力就绪后，扩展新功能
  ↓
方向 D（新功能立项）
```

**A 是核心**——总线 + 引擎执行 + 多主体自产 + 队友 Agent 化，统一在一个架构下。
C（管线补数据）可以与 A 并行推进。B（战斗 AI）需要 A 的总线基础。D 是最后扩展。

---

## 五、与现有设计文档的对应

| 本文方向 | 对应文档 | 关系 |
|---------|---------|------|
| A 总线驱动架构 | 新方向（迭代设计产生） | 合并原 A（信号丰富化）+ B（多消费者路由）+ E（机械层下沉）+ 队友 Agent 化；吸收 `多主体叙事系统设计.md` T1-T4 |
| B 战斗 AI 自主行动 | `队友Agent化与世界活图计划.md` Phase A + `ai_opponent.py` | 战斗中的独立决策专项 |
| C 管线升级 | `C9引擎完善与管线升级计划.md` 第四步 + `数据源强化规格书.md` | 引擎侧已就绪，等管线补数据 |
| D 新功能 | `图世界能力矩阵（实施中）.md` 第四步 | U3/U13/U14/U16 |
