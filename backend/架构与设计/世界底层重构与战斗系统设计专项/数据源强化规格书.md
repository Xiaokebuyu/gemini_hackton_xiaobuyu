# 数据源强化规格书

> 更新: 2026-02-15
> 用途: 手动编辑 `data/goblin_slayer/structured_new/chapters_v2.json` 的参考规格
> 前提: WorldGraph 引擎 C8 已上线，本文档描述引擎能消费的所有数据字段

---

## 一、当前数据缺失总览

```
chapters_v2.json: 82 章节, 323 事件

已有 (OK):
  ✅ trigger_conditions   322/323 (99.7%)
  ✅ narrative_directive   全部有
  ✅ is_required           全部有
  ✅ transitions           全部章节有

缺失 (需补):
  ❌ on_complete           0/323  → 无奖励、无级联解锁
  ❌ completion_conditions 0/323  → 事件只能靠 LLM 手动 complete
  ❌ stages                0/323  → 无多阶段事件
  ❌ outcomes              0/323  → 无分支结局
```

---

## 二、事件完整字段规格 (StoryEvent)

```jsonc
{
  // === 已有字段 ===
  "id": "ch_4_1_event_2",                        // 唯一 ID
  "name": "第一章：怪诞委托",                      // 显示名
  "description": "触发番外卷第一章剧情",            // 描述（可选）
  "is_required": true,                            // true=主线, false=支线
  "is_repeatable": false,                         // 可重复？
  "cooldown_rounds": 0,                           // 重复冷却回合数
  "narrative_directive": "引导玩家进入...",          // 给 LLM 的叙事指令
  "trigger_conditions": { ... },                  // 解锁条件（何时 locked→available）
  "side_effects": [],                             // legacy，不再使用

  // === 需补字段 ===

  // 完成条件：满足后引擎自动将事件标记为 completed
  // 若为 null → 只能由 LLM 调用 complete_event 工具手动完成
  "completion_conditions": { ... } | null,

  // 完成后的副作用
  "on_complete": {
    "unlock_events": ["evt_id_1", "evt_id_2"],    // 解锁的事件 ID
    "add_xp": 200,                                // 经验奖励
    "add_items": [                                 // 物品奖励
      {"item_id": "healing_potion", "name": "治疗药水", "quantity": 2}
    ],
    "narrative_hint": "完成后的过渡叙述指引"         // 可选
  },

  // 多阶段事件（可选，详见第五节）
  "stages": [ ... ],

  // 分支结局（可选，详见第六节）
  "outcomes": [ ... ]
}
```

---

## 三、条件系统完整参考 (ConditionGroup)

`trigger_conditions` 和 `completion_conditions` 都使用同一套条件系统。

### 3.1 结构

```jsonc
{
  "operator": "and",    // "and" | "or" | "not"
  "conditions": [
    // 可以嵌套 ConditionGroup 或直接写 Condition
    {"type": "...", "params": { ... }},
    {"operator": "or", "conditions": [ ... ]}  // 嵌套
  ]
}
```

### 3.2 九种条件类型

| type | params | 含义 | 示例 |
|------|--------|------|------|
| `location` | `area_id`, `sub_location`(可选) | 玩家在指定位置 | `{"area_id": "frontier_town"}` |
| `npc_interacted` | `npc_id`, `min_interactions`(默认1) | 与 NPC 交互次数 | `{"npc_id": "priestess", "min_interactions": 3}` |
| `time_passed` | `min_day`(默认0), `min_hour`(默认0) | 游戏时间已过 | `{"min_day": 5}` |
| `rounds_elapsed` | `min_rounds`, `max_rounds`(可选) | 本章回合数范围 | `{"min_rounds": 3, "max_rounds": 10}` |
| `party_contains` | `character_id` | 队伍中有指定角色 | `{"character_id": "priestess"}` |
| `event_triggered` | `event_id` | 指定事件已完成 | `{"event_id": "ch_4_1_event_1"}` |
| `objective_completed` | `objective_id` | 章节目标已完成 | `{"objective_id": "obj_1"}` |
| `game_state` | `state` | 游戏状态匹配 | `{"state": "in_combat"}` |
| `flash_evaluate` | `prompt` | LLM 语义判断 | `{"prompt": "玩家是否已经了解了线索？"}` |

### 3.3 条件组合示例

**简单条件**（到达位置）:
```json
{"operator": "and", "conditions": [
  {"type": "location", "params": {"area_id": "frontier_town"}}
]}
```

**复合条件**（到达位置 + 与 NPC 对话）:
```json
{"operator": "and", "conditions": [
  {"type": "location", "params": {"area_id": "frontier_town"}},
  {"type": "npc_interacted", "params": {"npc_id": "guild_girl", "min_interactions": 1}}
]}
```

**嵌套条件**（在 A 或 B 位置 + 事件链 + 非战斗）:
```json
{"operator": "and", "conditions": [
  {"operator": "or", "conditions": [
    {"type": "location", "params": {"area_id": "frontier_town"}},
    {"type": "location", "params": {"area_id": "cow_girl_farm"}}
  ]},
  {"type": "event_triggered", "params": {"event_id": "ch_1_1_event_3"}},
  {"operator": "not", "conditions": [
    {"type": "game_state", "params": {"state": "in_combat"}}
  ]}
]}
```

**纯语义判定**（LLM 评估）:
```json
{"operator": "and", "conditions": [
  {"type": "flash_evaluate", "params": {"prompt": "玩家是否成功说服了村长协助边境防御？考虑对话中是否展示了诚意和逻辑。"}}
]}
```

---

## 四、`on_complete` 详细规格

### 4.1 完整结构

```jsonc
{
  "on_complete": {
    // 解锁事件列表 — 这些事件的 trigger_conditions 可能还有别的条件，
    // 但 unlock_events 提供了显式的正向链接让引擎主动检查
    "unlock_events": ["ch_4_1_event_3", "ch_5_2_event_1"],

    // XP 奖励 — 直接加到玩家 XP
    "add_xp": 200,

    // 物品奖励 — 加到玩家背包
    "add_items": [
      {"item_id": "gold_coin", "name": "金币", "quantity": 50},
      {"item_id": "healing_potion", "name": "治疗药水", "quantity": 2}
    ],

    // 叙事指引（可选）— 告诉 LLM 完成后怎么过渡
    "narrative_hint": "任务完成后，公会柜台小姐会递来一封密信..."
  }
}
```

### 4.2 XP 参考值

| 事件性质 | XP 范围 | 说明 |
|---------|---------|------|
| 章节开启/过渡 | 50-100 | 到达新地点、接受委托 |
| 主线调查/对话 | 100-200 | 收集情报、与关键 NPC 交流 |
| 主线推进 | 200-400 | 完成阶段性目标 |
| 章节终结 | 400-800 | 大事件收尾 |
| Boss 战/高潮 | 500-1000 | 决定性战斗 |
| 支线小任务 | 50-150 | 非必需内容 |

### 4.3 `unlock_events` 自动推导规则

`unlock_events` 可以从 trigger_conditions 反向推导：

```
如果事件 B 的 trigger_conditions 包含:
  {"type": "event_triggered", "params": {"event_id": "事件A的ID"}}

那么事件 A 的 on_complete.unlock_events 应包含 "事件B的ID"
```

这一步可以用脚本自动完成（见第八节）。手动编辑时只需关注 XP 和物品。

---

## 五、多阶段事件 (stages)

### 5.1 使用场景

- Boss 战（潜入→战斗→撤离）
- 长线调查任务（收集线索→推理→对峙）
- 多地点任务（A地领任务→B地执行→A地回报）

### 5.2 完整结构

```jsonc
{
  "stages": [
    {
      "id": "stage_1",                           // 阶段 ID（事件内唯一）
      "name": "收集线索",                          // 阶段名
      "description": "在小镇中寻找失踪事件的线索",   // 描述
      "narrative_directive": "引导玩家在小镇内探索，与居民对话收集信息",

      // 阶段目标（可选，给 LLM 显示的清单）
      "objectives": [
        {
          "id": "obj_talk_guard",
          "text": "与镇守队长对话",
          "required": true,                       // true=必须完成才能推进
          "completion_hint": "玩家与 guard_captain NPC 交互后标记"
        },
        {
          "id": "obj_check_scene",
          "text": "调查失踪现场",
          "required": true,
          "completion_hint": "玩家到达 sub_location 'crime_scene' 后标记"
        },
        {
          "id": "obj_optional_clue",
          "text": "询问酒馆的旅人",
          "required": false,                      // 可选目标
          "completion_hint": "与 tavern_traveler NPC 交互"
        }
      ],

      // 阶段完成条件（机械判定，同 completion_conditions 格式）
      "completion_conditions": {
        "operator": "and",
        "conditions": [
          {"type": "npc_interacted", "params": {"npc_id": "guard_captain", "min_interactions": 1}},
          {"type": "location", "params": {"area_id": "frontier_town", "sub_location": "crime_scene"}}
        ]
      }
    },
    {
      "id": "stage_2",
      "name": "追踪嫌疑人",
      "narrative_directive": "线索指向森林深处...",
      "completion_conditions": {
        "operator": "and",
        "conditions": [
          {"type": "location", "params": {"area_id": "whispering_woods"}}
        ]
      }
    },
    {
      "id": "stage_3",
      "name": "最终对峙",
      "narrative_directive": "高潮场景——揭露真凶",
      "completion_conditions": {
        "operator": "and",
        "conditions": [
          {"type": "flash_evaluate", "params": {"prompt": "玩家是否成功揭露了真凶的身份并做出了最终选择？"}}
        ]
      }
    }
  ]
}
```

### 5.3 阶段状态机

```
事件 activated → stage_1 (active) → stage_2 (active) → stage_3 (active) → event completed
```

- 每个阶段的 `completion_conditions` 满足后自动推进到下一阶段
- 最后一个阶段完成 = 整个事件完成
- 无 completion_conditions 的阶段由 LLM 手动推进

### 5.4 注意事项

- `stages` 为空数组 `[]` 或不存在 = 传统单阶段事件（向后兼容）
- 有 `stages` 时，事件自身的 `completion_conditions` 会被忽略（由最后一个 stage 控制）
- objectives 是给 LLM 的展示信息，不影响机械判定（completion_conditions 才影响）

---

## 六、分支结局 (outcomes)

### 6.1 使用场景

- 道德选择（救人 vs 追敌）
- 战斗结果（完美胜利 vs 惨胜 vs 失败）
- 外交谈判（和平解决 vs 武力胁迫）

### 6.2 完整结构

```jsonc
{
  "outcomes": [
    {
      "id": "outcome_perfect",
      "description": "完美通关——零伤亡清剿巢穴",

      // 选择/触发条件 — 满足则选此结局
      // outcomes 按顺序评估，第一个满足条件的被选中
      // conditions=null 作为 fallback（放最后）
      "conditions": {
        "operator": "and",
        "conditions": [
          {"type": "flash_evaluate", "params": {"prompt": "全队是否无一阵亡或重伤？"}}
        ]
      },

      // 奖励
      "rewards": {
        "xp": 500,
        "gold": 200,
        "items": ["goblin_champion_trophy"]
      },

      // 声望变化（预留，当前引擎未消费）
      "reputation_changes": {
        "adventurer_guild": 10,
        "frontier_town": 5
      },

      // 解锁事件
      "unlock_events": ["special_commendation_event"],

      // 世界标记（预留）
      "world_flags": {
        "goblin_nest_cleared": true,
        "hero_reputation": "rising"
      },

      // 叙事指引
      "narrative_hint": "公会为小队举办了庆功宴，冒险者们纷纷投来敬佩的目光"
    },
    {
      "id": "outcome_normal",
      "description": "成功清剿但付出了代价",
      "conditions": null,                        // ← fallback，前面的都不满足就用这个
      "rewards": {"xp": 300, "gold": 100},
      "reputation_changes": {"adventurer_guild": 5},
      "unlock_events": [],
      "world_flags": {"goblin_nest_cleared": true},
      "narrative_hint": "任务完成了，但代价沉重"
    }
  ]
}
```

### 6.3 评估规则

1. outcomes 按数组顺序依次评估 conditions
2. 第一个 conditions 满足的 outcome 被选中
3. `conditions: null` = 无条件匹配，作为 fallback
4. **必须至少有一个 outcome 的 conditions 为 null**（兜底）
5. 无 outcomes 字段 = 使用事件自身的 on_complete（向后兼容）

---

## 七、地图数据参考

### 7.1 已有地图 (10 张)

| ID | 名称 | Region | 危险 |
|----|------|--------|------|
| frontier_town | 边境小镇 | 边境地区 | low |
| cow_girl_farm | 牧牛妹农场 | 边境地区 | low |
| water_town | 水之都 | 西方未知境 | medium |
| whispering_woods | 轻语森林 | 西方未知境 | medium |
| underground_waterway | 地下水道 | 水之都(地下) | high |
| mirror_lake | 镜之湖 | 轻语森林深处 | medium |
| sol_tower | 索尔之塔 | 兰德索尔 | high |
| landosol_city | 兰德索尔城 | 大陆南部 | low |
| velen | 维伦 | 大陆南部 | medium |
| narukami_island | 鸣神岛 | 鸣神群岛 | extreme |

### 7.2 可用的 area_id 值

在 `completion_conditions` 和 `trigger_conditions` 中 `location` 条件的 `area_id` 必须使用上述 ID。

### 7.3 可用的 NPC ID 值（主要角色）

**Main tier (7)**:
`goblin_slayer`, `priestess`, `high_elf_archer`, `dwarf_shaman`, `lizard_priest`, `guild_girl`, `cow_girl`

**Secondary tier (124)**: 见 `characters.json`

---

## 八、自动推导脚本使用说明

阶段 1 的 `unlock_events` 可以用脚本自动生成。脚本逻辑：

```
输入: chapters_v2.json
处理:
  1. 扫描所有事件的 trigger_conditions
  2. 提取 type="event_triggered" 的 params.event_id
  3. 构建反向映射: {被依赖事件: [依赖它的事件列表]}
  4. 为每个有 unlock 目标的事件创建/更新 on_complete.unlock_events
输出: 更新后的 chapters_v2.json
```

预期结果: 241 个事件获得 unlock_events，320 条解锁关系。

需要我写这个脚本时说一声。

---

## 九、编辑优先级建议

```
P0 (必做):
  ├─ on_complete.unlock_events  → 脚本自动，5 分钟
  └─ on_complete.add_xp         → 手动，按 XP 参考值

P1 (推荐):
  └─ completion_conditions       → 手动，主线事件优先

P2 (增强):
  ├─ on_complete.add_items       → 手动，关键事件
  └─ on_complete.narrative_hint  → 手动，过渡叙述

P3 (进阶):
  ├─ stages                      → 手动，选 5-10 个关键事件
  └─ outcomes                    → 手动，选 5-10 个选择点
```

建议先完成 vol_4 (ch_4_1~ch_4_6) 作为试点，验证后再推广到其他卷。

---

## 十、章节事件链速查

### vol_4 事件链 (ch_4_1 → ch_4_6)

```
ch_4_1_event_1 (番外卷开启) ← 入口，无前置
  ├→ ch_4_1_event_2 (第一章：怪诞委托)
  └→ ch_5_2_event_1 (跨章)

ch_4_1_event_2
  └→ ch_4_2_event_1

ch_4_2_event_1 → ch_4_2_event_2 → ch_4_2_event_3 → ch_4_2_event_4 → ch_4_3_event_1

ch_4_3_event_1 → ch_4_3_event_2 → ch_4_3_event_3 → ch_4_4_event_1

ch_4_4_event_1 → ch_4_4_event_2 → ch_4_4_event_3 → ch_4_4_event_4 → ch_4_5_event_1

ch_4_5_event_1 → ch_4_5_event_2 → ch_4_5_event_3 → ch_4_5_event_4 → ch_4_6_event_1

ch_4_6_event_1 → ch_4_6_event_2 → ch_4_6_event_3 → ch_4_6_event_4
  └→ ch_5_1_event_1 (跨章到 vol_5)
```

---

## 附录：现有物品 ID 参考 (items.json)

编辑 `add_items` 时可引用的物品（部分）:

| item_id | name | type | rarity |
|---------|------|------|--------|
| gear_standard_kit | 标准冒险装备包 | tool | common |
| potion_healing | 治疗药水 | consumable | common |
| weapon_short_sword | 短剑 | weapon | common |

> 也可以自定义新 item_id，格式不限制。引擎会直接将 add_items 数组内容追加到玩家背包。
