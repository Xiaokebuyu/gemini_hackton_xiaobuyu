# 图谱系统审视与改进方向

> 状态：📝 已审视，改进分优先级执行
> 背景：阶段 4 多 Agent 全面使用图谱记忆，审视现有系统是否适配

---

## 一、扩散激活现状

### 算法

- **位置**：`app/services/spreading_activation.py`
- **类型**：双向迭代扩散（前向 + 反向 × 0.7 衰减）
- **参数**：`max_iterations=3, decay=0.6, fire_threshold=0.1, output_threshold=0.15`
- **跨 scope 衰减**：narrative↔personal = 0.5，跨章节 = 0.4，因果边保底 = 0.6
- **复杂度**：O(iterations × (V + E))，典型 30-150ms

### Scope 加载

- **recall()**（`recall_orchestrator.py:49`）：加载 5-6 个 scope（角色 + 地点 + 区域 + 章节 + 阵营 + 世界）
- **recall_v4()**（`recall_orchestrator.py:218`）：优化为 3 个 scope（地点 + 区域 + 角色）
- 所有 scope 合并为一张大图，activation 自由扩散（仅有衰减，无硬隔离）
- 典型节点数：合并后 1500-2500 节点

### 意图配置

不同意图使用不同参数（`RECALL_CONFIGS`）：
- `exploration`：depth=1, threshold=0.3（浅层）
- `dialogue`：depth=2, threshold=0.2（中层）
- `recall`：depth=3, threshold=0.1（深层）
- `combat`：depth=1, threshold=0.4（急迫场景）

---

## 二、问题诊断

### P1. 无角色级信息隔离（必须修复）

所有角色共享同一个 recall 配置，NPC 可以"回忆"到其他角色图的私密记忆（虽有 50% 衰减，但仍可激活）。

**影响**：阶段 4 中 NPC、队友、GM 同时 recall，信息泄漏不可接受。

**修复方案**：按角色配 scope

```python
RECALL_SCOPES = {
    "npc": ["character", "location"],           # 自己 + 当前地点
    "teammate": ["character", "camp", "location"], # 自己 + 队伍 + 当前地点
    "gm": ["character", "area", "chapter"],      # GM图 + 区域 + 章节
}
```

**改动量**：~30 行（recall_orchestrator 新增 role 参数 + scope 过滤）

### P2. 每次 recall 的 Firestore 开销（应优化）

NPC 对话流中每轮都可能 recall，5-6 次 Firestore 读取 × 多个 NPC = 大量 IO。

**现状**：
- 每个 scope 加载所有节点（`nodes_ref.stream()`）
- 无缓存，每次 recall 重新加载

**优化方向**：
- 按角色缩减 scope 数量（P1 已解决）
- 会话内缓存静态 scope（世界图、章节图不会每轮变）
- 懒加载：先激活角色图，不够再扩展到地点图

### P3. 场景总线图谱化太粗糙（可推后）

**现状**（`memory_graphizer.py` scene_bus 模式）：
- 纯规则化，无 LLM 参与
- 只生成 utterance 节点（importance=0.4）+ topic 节点（importance=0.35）
- 边类型仅 3 种：BY / ABOUT / RESPONDS_TO
- 缺失：语义提取、态度变化、隐含信息

**会话图谱化**（session_history 模式）质量还行：
- LLM 提取 event_group + sub_events + 实体 + 关系
- 主观视角（第一人称）
- 完整 transcript 保留
- 重要性 LLM 评分

### P4. 无矛盾追踪（可推后）

同一 NPC 对同一目标的信任/不信任边可共存，无更新/覆盖机制。

### P5. 无时间衰减（可推后）

6 个月前的闲聊 importance 不会自动降低。

### P6. 去重依赖 LLM（可推后）

当前做法：50 个已有节点塞进 prompt 让 LLM 引用。缺陷：
- 50 个节点上限远不够大图
- LLM 可能忽略指令创建重复节点
- 随图增长问题恶化

---

## 三、改进优先级

| 优先级 | 改进项 | 原因 | 时机 |
|--------|--------|------|------|
| **P0 必做** | 按角色配 recall scope (P1) | 信息隔离 + 性能，多 Agent 必需 | 阶段 4a |
| **P0 必做** | GM 图谱 scope 新建 | GM 持久化记忆基础设施 | 阶段 4a |
| **P1 建议** | 会话内静态 scope 缓存 (P2) | 减少 Firestore IO | 阶段 4b |
| **P2 可选** | 场景总线图谱化增强 (P3) | 提升记忆质量 | 阶段 4c 或独立迭代 |
| **P3 推后** | 矛盾追踪 (P4) | 重要但复杂 | 独立迭代 |
| **P3 推后** | 时间衰减 (P5) | 重要但复杂 | 独立迭代 |
| **P3 推后** | 去重机制改进 (P6) | 需要向量相似度 | 独立迭代 |

---

## 四、改进方向（远期参考）

### 方向 A：分层图谱化

```
第 1 层: 快速规则化 (现有场景总线模式，每轮执行)
  → 发言 + 话题 + 锚边，零 LLM 成本

第 2 层: LLM 深度提取 (现有会话模式，上下文压缩时执行)
  → event_group + 实体 + 关系 + 情感，1 次 LLM 调用

第 3 层: 周期性整理 (新，每 N 轮或 persist 时)
  → 合并重复节点 + 更新矛盾关系 + 衰减旧节点
  → 1 次 LLM 调用
```

### 方向 B：图谱化 prompt 增强

不改架构，只改提取质量：
- 矛盾检测指令（新信息与旧节点矛盾时更新而非新建）
- 置信度字段（"我不确定" → confidence: 0.3）
- 时间衰减指令（重新评估旧节点当前重要性）

### 方向 C：增量更新

```
每条消息 → 轻量规则提取 → 累积变更
压缩触发时 → 1 次 LLM → 整合 + 去重 + 关系推理
```

---

## 变更日志

| 日期 | 操作 |
|------|------|
| 2026-02-21 | 创建：扩散激活 + 图谱化现状审视，问题诊断 6 项，改进优先级 + 远期方向 |
