```mermaid
flowchart TB
    subgraph Frontend["ğŸ–¥ï¸ å‰ç«¯æ§åˆ¶å°"]
        FE["frontend/index.html + app.js<br>å¥åº·æ£€æŸ¥/åˆ›å»ºä¼šè¯/å‘é€æ¶ˆæ¯<br>ä¸»é¢˜/Artifact/ç‰ˆæœ¬æŸ¥è¯¢"]
    end

    subgraph FastAPI["âš¡ FastAPI åº”ç”¨å±‚ - main.py"]
        direction TB
        HEALTH["/ & /health<br>æœåŠ¡ä¿¡æ¯ä¸å¥åº·æ£€æŸ¥"]
        CHAT["chat.py<br>POST /api/chat ä¸»å¯¹è¯å…¥å£<br>POST /api/sessions åˆ›å»ºä¼šè¯<br>GET /api/sessions/.../messages"]
        TOPICS["topics.py<br>GET .../topics ä¸»é¢˜åˆ—è¡¨<br>GET .../topics/tid ä¸»é¢˜è¯¦æƒ…<br>GET .../artifact & /versions"]
    end

    subgraph Services["ğŸ”§ æœåŠ¡å±‚"]
        direction TB
        
        subgraph CoreServices["æ ¸å¿ƒé“¾è·¯æœåŠ¡"]
            CTX_LOOP["context_loop.py<br>ä¸Šä¸‹æ–‡é‡æ„å¾ªç¯<br>æ£€æµ‹ NEED_CONTEXT<br>æœ€å¤šé‡è¯• max_context_retry"]
            CTX_BUILD["context_builder.py<br>build ç”Ÿæˆä¸Šä¸‹æ–‡<br>load_all_artifacts<br>format_messages<br>build_system_prompt"]
            ARCHIVE["archive_service.py<br>check_should_archive<br>execute_archive<br>analyze_messages<br>find_mergeable_topic<br>merge_into_topic"]
        end
        
        subgraph AIServices["AI ä¸è§£ææœåŠ¡"]
            LLM["llm_service.py<br>generate_response<br>analyze_messages_for_archive<br>should_merge_topics<br>merge_artifacts"]
            ARTIFACT["artifact_service.py<br>parse_artifact_sources<br>get_all_sections<br>find_section_by_keyword<br>extract_section_content"]
        end
        
        subgraph DataService["æ•°æ®è®¿é—®æœåŠ¡"]
            FS["firestore_service.py<br>ä¼šè¯: create/get/update_session<br>æ¶ˆæ¯: add/get/mark_archived<br>ä¸»é¢˜: create/get/update_topic<br>ç‰ˆæœ¬: save/get_artifact_versions"]
        end
    end

    subgraph Storage["ğŸ—„ï¸ Firestore æ•°æ®å±‚"]
        direction LR
        SESSIONS["users/user_id/sessions/session_id<br>ä¼šè¯å…ƒæ•°æ®"]
        MESSAGES["../messages<br>æ¶ˆæ¯è®°å½•<br>is_archived, thread_id"]
        TOPICS_DB["../topics<br>ä¸»é¢˜<br>summary, current_artifact"]
        VERSIONS["../topics/thread_id/artifact_versions<br>Artifact ç‰ˆæœ¬å†å²"]
    end

    subgraph Config["âš™ï¸ é…ç½® config.py"]
        CFG["å½’æ¡£: active_window_size, archive_threshold<br>ä¸Šä¸‹æ–‡: max_context_retry, context_request_pattern<br>Gemini: API_KEY, gemini_*_model<br>Firestore: CREDENTIALS, database"]
    end

    subgraph Models["ğŸ“¦ æ•°æ®æ¨¡å‹"]
        MSG["Message<br>is_archived, thread_id"]
        TOPIC["Topic<br>summary, current_artifact"]
        SESSION["Session<br>created_at, updated_at"]
    end

    %% ä¸»è¦è¿æ¥
    FE -->|HTTP è¯·æ±‚| FastAPI
    
    CHAT -->|1.ä¿å­˜ç”¨æˆ·æ¶ˆæ¯| FS
    CHAT -->|2.è§¦å‘å½’æ¡£æ£€æŸ¥| ARCHIVE
    CHAT -->|3.ä¸Šä¸‹æ–‡å¾ªç¯| CTX_LOOP
    CHAT -->|4.ä¿å­˜åŠ©æ‰‹æ¶ˆæ¯| FS
    
    ARCHIVE -->|åˆ†ææ¶ˆæ¯ç”ŸæˆArtifact| LLM
    ARCHIVE -->|è¯»å†™ä¸»é¢˜ä¸æ¶ˆæ¯| FS
    
    CTX_LOOP -->|æ„å»ºä¸Šä¸‹æ–‡| CTX_BUILD
    CTX_LOOP -->|ç”Ÿæˆå›å¤| LLM
    CTX_LOOP -->|NEED_CONTEXTæ—¶æŸ¥æ‰¾| ARTIFACT
    CTX_LOOP -->|åŠ è½½åŸå§‹å†å²| FS
    
    CTX_BUILD -->|åŠ è½½æ‰€æœ‰Artifacts| FS
    
    ARTIFACT -->|è·å–ä¸»é¢˜åˆ—è¡¨| FS
    
    TOPICS -->|æŸ¥è¯¢ä¸»é¢˜/Artifact/ç‰ˆæœ¬| FS
    
    FS --> SESSIONS
    FS --> MESSAGES
    FS --> TOPICS_DB
    FS --> VERSIONS
    
    CFG -.->|é…ç½®å‚æ•°| Services
    Models -.->|æ•°æ®ç»“æ„| FS
```
