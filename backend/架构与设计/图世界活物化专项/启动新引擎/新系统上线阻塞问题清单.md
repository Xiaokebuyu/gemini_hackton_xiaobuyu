# 新系统上线阻塞问题清单

> 创建时间：2026-02-19
> 状态：诊断中 → 方案设计中
> 前置：Direction A 代码层面 F01-F25 全部完成（147/147 测试通过）
> 核心结论：**新架构外面套了层旧壳。引擎/总线/多主体全部就位，但旧路由还在、降级链太深、数据没到位，运行时大概率走旧路径。**

---

## 〇、架构决策记录

> 2026-02-19 讨论确定

| # | 决策 | 说明 |
|---|------|------|
| AD1 | NPC 与队友同级 | NPC 是独立 agent，和队友平级。区别仅在于：不可入队、场景内固定。NPC 发言独立触发，GM 不代言 |
| AD2 | 前端快捷按钮直通后端 | 按钮点击绕过意图解析，直发结构化指令。优先级最低，系统稳定后再做 |
| AD3 | 私聊写入角色图 | 私聊内容写入角色 MemoryGraph，扩散激活时可被召回 |
| AD4 | 子地点是总线的物理载体 | 所有实体（玩家/NPC/队友）必须处于具体子地点中，总线才能正常工作 |
| AD5 | 先修引擎堵点，后补数据 | 数据到位是引擎生效的前提，但当前先解决引擎本身的结构性阻塞 |

---

## 一、问题总览

| # | 问题 | 严重度 | 类别 | 状态 |
|---|------|--------|------|------|
| **B0** | **初始化系统缺失 — 玩家/NPC 不在子地点** | **致命** | 架构/流程 | 待设计 |
| B1 | 队友不出现 — Party 无自动创建机制 | **高** | 数据/流程 | 待修（被 B0 包含） |
| B2 | NPC 不在子地点 — 字段路径不匹配 | **高** | 数据/代码 | 待修（被 B0 包含） |
| B3 | 级联降级链 — 任何一环失败静默回退旧行为 | **高** | 架构 | 待修 |
| B4 | 旧路由完整存在 — 8 个旧端点仍可访问 | **中** | 清理 | 清理中 |
| B5 | Coordinator/FlashCPU 旧方法残留 | **中** | 清理 | 清理中 |
| B6 | world_runtime.py 旧运行时方法（⚠️ 3 个有 V4 交叉依赖） | **中** | 清理 | 清理中 |
| B7 | 前端旧 API 封装残留 | **低** | 清理 | 清理中 |
| B8 | NPC 独立化改造 | **高** | 架构 | 待设计（依赖 AD1） |
| B9 | GM 工具集缩减 | **中** | 架构 | 待分析（依赖 B8） |
| B10 | 前端 NPC 交互入口 | **中** | 前端 | 待设计 |
| B11 | 前端总线可视化 | **中** | 前端 | 待设计 |

---

## 二、详细诊断

### B0: 初始化系统缺失 — 玩家/NPC 不在子地点（B1、B2 的根因）

**症状**: 新建会话后，玩家在区域级（area），不在任何子地点中。NPC 也查不到。队伍不存在。SceneBus 没有子地点锚点。整个总线驱动架构空转。

**根因 — 初始化链路没有保证"所有人在子地点"**:

```
当前 start_session() 流程：
  1. 选择起始区域 → player_location = area_id     ✅
  2. sub_location = None                            ← 致命：总线无锚点
  3. Party 不创建                                    ← B1 根因
  4. NPC 不放入子地点 resident_npcs                  ← B2 根因
  5. SceneBus(area_id, sub_location=None)            ← 总线虽创建但无子地点语义

结果：
  → SceneBus 有但无意义（子地点 = None）
  → IntentResolver 匹配 NPC 失败（HOSTS 边查不到人）
  → 队友阶段被跳过（Party = None）
  → 引擎的 ON_ENTER 行为不触发（没有进入子地点的动作）
  → 体感 = 旧系统
```

**设计原则**（AD4）：子地点是总线的物理载体。子地点 = 场景容器 = 消息总线 = 事件状态机的作用域。没有子地点，就没有场景。

**新初始化流程设计**:

```
start_session() 或 角色创建完成后：
  1. 确定起始区域 → player_location = area_id
  2. 确定起始子地点：
     a. 区域定义中标记 default_sub_location（推荐）
     b. 或取第一个 sub_location
     c. 不存在子地点 → 自动创建 "广场" 类型默认子地点
  3. 放置玩家到子地点 → sub_location = sub_id
  4. 自动创建 Party → 从章节配置读取初始队友列表
  5. 队友位置同步 → 跟随玩家到同一子地点
  6. 确认 NPC 在位：
     a. 从 WorldGraph HOSTS 边查询该子地点的 NPC
     b. fallback：从角色 profile 的 default_map 匹配
     c. 写入 sub_location.resident_npcs（如果未填充）
  7. SceneBus(area_id, sub_location=sub_id) → 总线锚定到子地点
  8. 触发 ON_ENTER 行为 → 引擎正式开始运转

初始化完成后的保证：
  ✅ 玩家在子地点
  ✅ 队友在同一子地点
  ✅ NPC 在其配置的子地点
  ✅ SceneBus 有明确的子地点锚点
  ✅ 引擎可以触发 ON_ENTER 行为
```

**涉及文件**:
- `app/services/admin/world_runtime.py:102-177` — `start_session()` 需要重写
- `app/runtime/session_runtime.py:329-338` — `_init_scene_bus()` 需要保证 sub_location 不为 None
- `app/services/party_service.py` — 需要新增 `auto_create_party()` 方法
- `app/runtime/world_instance.py` — 需要提供 `get_default_sub_location(area_id)` 方法
- 世界数据：区域定义需要 `default_sub_location` 字段

**未来延伸**：子地点作为独立场景容器的概念，天然支持洞穴/副本等扩展——进入副本 = 进入一个有独立总线和事件状态机的子地点。

**与 B1/B2 的关系**：B0 解决后，B1（Party 自动创建）和 B2（NPC 放置）作为 B0 的子步骤一并解决。

---

### B1: 队友不出现 — Party 无自动创建机制

**症状**: 每个场景都没有加载对应的 agent 队友。

**根因链条**:

```
PartyService.get_party() 查 Firestore: worlds/{wid}/parties/{sid}
  → 文档不存在 → 返回 None
  → session.party = None
  → pipeline_orchestrator.py:391 `if party and party.get_active_members()` 为 False
  → 队友整个阶段被跳过（zero output）
```

Party 必须由玩家通过 `POST /{wid}/{sid}/party` 或游戏内 `add_teammate` 工具主动创建。**没有任何自动创建/自动加载机制**。

**涉及文件**:
- `app/services/party_service.py:67-82` — `get_party()` 查询逻辑
- `app/runtime/session_runtime.py:248-259` — `_restore_party()` 调用点
- `app/services/admin/pipeline_orchestrator.py:391-410` — 队友阶段门控

**需要决策**:
- 方案 A：世界初始化时自动创建默认 Party（从世界数据中读取初始队友配置）
- 方案 B：角色创建时自动创建 Party 并加入章节默认队友
- 方案 C：保持手动创建，但在 UI/CLI 中增加引导

---

### B2: NPC 不在子地点 — 字段路径不匹配

**症状**: 世界初始化后角色不在子地点中出现。

**根因 — 双层问题**:

#### 问题 2a: `get_characters_in_area()` 只查 `profile.metadata.default_map`

```python
# world_instance.py:267-285 — 只查这个路径
metadata = profile.get("metadata", {})
default_map = metadata.get("default_map", "")  # 只查这里
```

但 `GraphBuilder._extract_char_field()` 是双路径查找（先 `profile.metadata`，后根级）。如果提取管线把 `default_map` 写在根级而非 `profile.metadata` 下，NPC 不出现在 area context 中。

#### 问题 2b: ~~子地点 `resident_npcs` 未填充~~ → 经审计确认：已填充 ✅

```
审计结果（2026-02-19）：
  maps/frontier_town/info/data.sub_locations[].resident_npcs 全部已填充
  WorldInstance.get_characters_at_sublocation('frontier_town', 'guild_hall') 返回 10 个 NPC ✅
  
真正的问题：GraphBuilder 不从 resident_npcs 构建 HOSTS 边
  → 只从角色的 default_sub_location 字段构建（该字段 0/133 角色有值）
  → 导致运行时图上 NPC 只挂在区域级，不挂在子地点级
```

**涉及文件**:
- `app/runtime/world_instance.py:267-304` — 两个查询方法
- `app/runtime/graph_builder.py:936-1006` — 角色节点构建 + HOSTS 边
- `app/tools/worldbook_graphizer/unified_pipeline.py` — 提取管线输出格式
- Firestore: `worlds/{wid}/characters/{char_id}` 文档结构
- Firestore: `worlds/{wid}/maps/{area_id}` 子地点结构

**需要决策**:
- 修 `get_characters_in_area()` 增加根级 fallback（对齐 `_extract_char_field` 的双路径）
- 确认提取管线是否正确填充 `resident_npcs`
- 或者：放弃静态配置，改为运行时从 WorldGraph HOSTS 边动态查询

---

### B3: 级联降级链 — 静默回退旧行为

**症状**: 改动的效果基本看不到。系统在运行时静默走旧路径。

**降级链路图**:

```
WorldGraph 构建失败（session_runtime.py:381-383）
  │ _world_graph_failed = True
  │
  ├→ BehaviorEngine 不运行（事件系统全部跳过）
  ├→ IntentResolver 无法解析意图（引擎前置执行跳过）
  ├→ engine_executed = None → GM 拿到完整工具集
  └→ 体感 = 和旧系统一模一样

SceneBus 初始化失败（session_runtime.py:329-338）
  │ player_location = None → scene_bus = None
  │
  ├→ 11 处 `if session.scene_bus:` 全部跳过
  ├→ 玩家输入不写总线
  ├→ NPC Reactor 不触发
  ├→ 图谱化不执行
  └→ 体感 = 和旧系统一模一样

NPC Reactor 异常（pipeline_orchestrator.py:268-270）
  │ except Exception: logger.warning(...)
  └→ NPC 自主反应消失，静默

队友 agentic 生成失败（teammate_response_service.py:982-1013）
  │ except → fallback 到 simple（无工具）
  │ except → 返回 None
  └→ 队友沉默或无工具响应
```

**11 处 `if session.scene_bus:` 检查** (`pipeline_orchestrator.py`):

| 行号 | 用途 | 跳过后果 |
|------|------|---------|
| L178 | 玩家输入写入总线 | 总线为空，GM 没有总线信号 |
| L211 | pre-tick hints 写入 | 事件信号丢失 |
| L236 | engine 结果写入 | 引擎执行结果不进总线 |
| L243 | bus_summary 注入 context | GM 上下文缺总线摘要 |
| L290 | GM 工具调用结果写入 | 工具结果不进总线 |
| L385 | 队友 bus_summary | 队友看不到总线 |
| L413 | 队友响应写入 | 队友反应不进总线 |
| L455 | post-tick hints | 事件信号丢失 |
| L473 | 图谱化 | 持久层不工作 |
| ... | ... | ... |

**关键降级触发条件**:
- `player_location` 为 None → SceneBus 不创建
- WorldGraph 构建失败（任何 `_build_*` 步骤异常）→ 引擎全部跳过
- `area_def` 不存在或加载异常 → AreaRuntime 不初始化

**涉及文件**:
- `app/runtime/session_runtime.py:295-338` — area restore + scene_bus init
- `app/runtime/session_runtime.py:370-383` — WorldGraph build
- `app/services/admin/pipeline_orchestrator.py` — 11 处条件检查
- `app/services/teammate_response_service.py:982-1013` — 双层 fallback

**需要决策**:
- 方案 A：将关键降级点从 warning 升级为 error（至少让问题可见）
- 方案 B：保证 SceneBus 必定创建（即使 area 不存在也用默认 bus）
- 方案 C：在 pipeline 入口添加前置检查，缺必要条件时快速失败而非静默降级

---

### B4: 旧路由完整存在（8 个端点） ✅ 已清理

**文件**: `app/routers/game_v2.py`

| 旧端点 | 走的旧方法 | V4 等价 |
|--------|-----------|---------|
| `POST /scene` | `enter_scene()` | `/input` + 引擎自动处理 |
| `POST /navigate` | `AdminCoordinator.navigate()` | `/input` "去XX" |
| `POST /time/advance` | `advance_time()` | `/input` "休息" |
| `POST /advance-day` | `advance_day()` | `/input` "休息到明天" |
| `POST /dialogue/start` | `start_dialogue()` | `/input` "和XX说话" |
| `POST /dialogue/end` | `end_dialogue()` | 自动管理 |
| `POST /sub-location/enter` | `enter_sub_location()` | `/input` "进入XX" |
| `POST /sub-location/leave` | `leave_sub_location()` | `/input` "离开XX" |

> ⚠️ 原文档漏了 `/sub-location/leave`（实际 8 个，非 7 个）

这些端点完全绕过 V4 pipeline，走旧的 `AdminCoordinator` → `WorldRuntime` → `FlashCPU.generate_gm_narration()` 链路。前端已不调用这些端点。

---

### B5: AdminCoordinator / FlashCPU 旧方法残留 ✅ 已清理

**`admin_coordinator.py` — 纯遗留方法（已删除）**:

| 方法 | 原调用者 | 状态 |
|------|---------|------|
| `narrate_state_change()` | 旧路由 `/navigate`, `/time/advance` 等 | ✅ 已删 |
| `enter_scene()` | 旧路由 `/scene` + CLI | ✅ 已删 |
| `start_dialogue()` | 旧路由 `/dialogue/start` + CLI | ✅ 已删 |
| `end_dialogue()` | 旧路由 `/dialogue/end` + CLI | ✅ 已删 |
| `navigate()` | 旧路由 `/navigate` + MCP tools | ✅ 已删 |
| `advance_day()` | 旧路由 `/advance-day` | ✅ 已删 |
| `_build_context()` | 上述旧方法内部 | ✅ 已删 |
| `_refresh_chapter_context()` | 上述旧方法内部 | ✅ 已删 |
| `_build_change_summary()` | 上述旧方法内部 | ✅ 已删 |

**`admin_coordinator.py` — V4 交叉依赖方法（保留）**:

| 方法 | V4 调用者 | 保留原因 |
|------|----------|---------|
| `advance_time()` | MCP time_tools → V4 可能复用 | 简单委托，保留 |
| `enter_sub_location()` | MCP navigation_tools | 简单委托，保留 |
| `leave_sub_location()` | MCP navigation_tools | 简单委托，保留 |

**`flash_cpu_service.py` — 4 个旧叙述方法（已删除）**:

| 方法 | 用途 | 状态 |
|------|------|------|
| `generate_gm_narration()` | 旧路由的叙述生成 | ✅ 已删 |
| `_load_gm_narration_prompt()` | 加载旧 prompt | ✅ 已删 |
| `_build_chapter_guidance()` | 旧章节上下文 | ✅ 已删 |
| `_sanitize_tavern_text()` | 旧文本清洗 | ✅ 已删 |

**`flash_cpu_service.py` — FlashOperation 遗留分支（已删除）**:

| 分支 | 说明 | 状态 |
|------|------|------|
| `FlashOperation.NAVIGATE` | V4 navigate 有独立实现 | ✅ 已删 |
| `FlashOperation.ENTER_SUBLOCATION` | V4 通过 session_runtime 处理 | ✅ 已删 |

> 保留的 FlashOperation: UPDATE_TIME, NPC_DIALOGUE, START_COMBAT, ADD/REMOVE_TEAMMATE, DISBAND_PARTY, ABILITY_CHECK — 均被 V4 agentic tools 使用。

**另删**: `app/prompts/flash_gm_narration.md` — 仅被 `_load_gm_narration_prompt()` 使用

---

### B6: world_runtime.py 旧运行时 ✅ 部分清理

**文件**: `app/services/admin/world_runtime.py`

**纯遗留方法（已删除）**:

| 方法 | 说明 | 状态 |
|------|------|------|
| `navigate()` | V4 有独立实现（v4_agentic_tools.navigate） | ✅ 已删 |
| `advance_day()` | 仅旧路由 `/advance-day` 调用 | ✅ 已删 |
| `_generate_travel_narration()` | 仅 navigate() 内部调用 | ✅ 已删 |
| `_record_movement_event()` | 仅 navigate() 内部调用 | ✅ 已删 |

**V4 交叉依赖方法（保留）**:

| 方法 | V4 调用链 | 保留原因 |
|------|----------|---------|
| `enter_sub_location()` | `session_runtime.enter_sublocation()` → 此方法 | V4 直接依赖 |
| `leave_sub_location()` | `session_runtime.leave_sublocation()` → 此方法 | V4 直接依赖 |
| `advance_time()` | `v4_agentic_tools.advance_time()` → `FlashOperation.UPDATE_TIME` → 此方法 | V4 直接依赖 |

> ⚠️ 原文档声称"world_runtime.py 的方法只服务旧路由链路" — **不正确**。上述 3 个方法是 V4 管线的活跃依赖。

---

### B7: 前端旧 API 封装（低优先级）

**文件**: `frontend/src/api/gameApi.ts`

死代码候选：`enterScene()`, `navigate()`, `advanceTime()`, `startDialogue()`, `endDialogue()`

前端主要走 `useStreamGameInput()`（SSE `/input/stream`），但这些旧封装仍在导出。

---

## 三、修复优先级

```
第一层：让新系统跑起来（引擎堵点）        ← 当前焦点
  B0  初始化系统重设计（包含 B1 + B2）
      → 玩家/NPC/队友都在子地点
      → Party 自动创建
      → SceneBus 有子地点锚点
  B3  关键降级点可见化
      → warning → error，至少让问题可见
      → 保证 SceneBus 必定创建
    ↓
第二层：切断旧入口                          ✅ 已完成
  B4  下线 8 个旧路由端点                    ✅
  B5  删 Coordinator/FlashCPU 旧方法          ✅
  B6  收缩 world_runtime（保留 V4 交叉依赖）   ✅
  B7  前端旧 API 封装（已无死代码）            ✅
    ↓
第三层：NPC 独立化 + GM 工具集缩减（AD1）
  B8  NPC 从 GM 代言改为独立 agent 触发
  B9  GM 工具集分析与缩减
    ↓
第四层：前端适配
  B10 NPC 交互入口
  B11 总线可视化
  B7  删旧 API 封装
    ↓
最后：前端优化
  AD2 快捷按钮直通后端（绕过意图解析）
```

---

## 四、数据审计：final-world 第一章可行性

> 2026-02-19 深度审计

### 4.1 审计结论

**数据足以支撑运行时消费。** WorldInstance 能正确加载所有关键数据。问题在初始化流程和 GraphBuilder 的数据利用方式上，不在原始数据本身。

### 4.2 实测验证结果

```
WorldInstance.initialize('final-world') 加载结果：
  area_registry: 10 areas ✅
  character_registry: 133 chars ✅

frontier_town:
  sub_locations: 7 个 ✅（全部带 resident_npcs）
    guild_hall:          11 NPCs (guild_girl, goblin_slayer, high_elf_archer...)
    tavern_guild:         2 NPCs (beastgirl_waitress, witch)
    blacksmith_workshop:  2 NPCs (forge_master, forge_apprentice)
    temple_earth_mother:  1 NPC  (priestess)
    tailor_shop:          1 NPC  (the_seamstress)
    inn_coiled_serpent:   1 NPC  (puti)
    red_light_district:   2 NPCs (albedo, charr)
  connections: 3 个 ✅ → cow_girl_farm(walk), whispering_woods(travel), water_town(travel)

get_characters_in_area('frontier_town'): 41 个角色 ✅
get_characters_at_sublocation('frontier_town', 'guild_hall'): 10 个 NPC ✅
get_characters_at_sublocation('frontier_town', 'temple_earth_mother'): priestess ✅

ch_1_1: 8 个事件，trigger_conditions 完整 ✅
```

### 4.3 数据可用矩阵

| 数据 | Firestore 路径 | 有无 | WorldInstance 可读 | GraphBuilder 可消费 |
|------|---------------|------|-------------------|-------------------|
| 子地点定义 | `maps/{id}/info/data.sub_locations[]` | ✅ 7个 | ✅ → `AreaDefinition.sub_locations` | ✅ → CONTAINS 边 |
| 子地点 NPC | `maps/{id}/info/data.sub_locations[].resident_npcs` | ✅ 已填充 | ✅ → `SubLocationDef.resident_npcs` | ⚠️ 不使用（见 4.4） |
| 区域连接 | `maps/{id}/info/data.connections[]` | ✅ 3条 | ✅ → `AreaDefinition.connections` | ✅ → CONNECTS 边 |
| 角色 default_map | `characters/{id}/profile.metadata.default_map` | ⚠️ 66/133 | ✅ 双路径查找 | ✅ → HOSTS 边（区域级） |
| 角色 default_sub_location | `characters/{id}/profile.metadata.default_sub_location` | ❌ 0/133 | — | ❌ → HOSTS 只能到区域 |
| 章节事件 | `chapters/ch_1_1.events[]` | ✅ 8个 | ✅ → `chapter_registry` | ✅ → EVENT_DEF 节点 |
| 章节初始队伍 | `chapters/ch_1_1.initial_party` | ❌ 不存在 | — | — |
| 知识图谱边类型 | `graphs/world/edges/` | ❌ 1961条全 unknown | ✅ 可读 | ⚠️ SA 无法按类型过滤 |

### 4.4 GraphBuilder 数据利用缺口

**核心矛盾**：`resident_npcs` 信息在子地点定义中存在，但 GraphBuilder 的 `_build_characters()` 只从角色自身的 `default_sub_location` 字段创建 HOSTS 边——该字段 133 个角色全为空。

```
数据实际存储位置：
  maps/frontier_town/info/data.sub_locations[0].resident_npcs = ['guild_girl', ...]
                                                                ↑ 数据在这里

GraphBuilder 查找位置：
  characters/guild_girl.profile.metadata.default_sub_location = None
                                                                ↑ 但它查这里（空）

结果：
  HOSTS 边只创建到区域级（frontier_town），不到子地点级（guild_hall）
  IntentResolver 的 TALK 匹配只能到"在 frontier_town 里"，不能到"在 guild_hall 里"
```

**修复方案**：GraphBuilder._build_characters() 增加 `resident_npcs` 反向查找——遍历 `area_def.sub_locations`，为每个 `resident_npcs` 列表中的角色创建子地点级 HOSTS 边。不需要改 Firestore 数据。

### 4.5 提取管线 vs 运行时的格式差异

| 问题 | 详情 | 影响 |
|------|------|------|
| Location ID 格式不一致 | 管线 `graph_prefill.py` 用 `{area}__{sub}`，GraphBuilder 用 `loc_{area}_{sub}` | 知识图谱节点和运行时图节点 ID 不匹配，扩散激活无法跨层命中 |
| 知识图谱边全是 unknown | 1961 条边无类型标注 | 扩散激活无法按关系类型过滤/加权 |
| 地图根文档 vs info/data | 根文档字段为空，数据在 info/data 子文档 | WorldInstance 已正确处理（读 info/data），不影响运行 |
| `target_map_id` vs `target_area_id` | 管线写 `target_map_id`，运行时期望 `target_area_id` | WorldInstance 已处理转换，不影响运行 |

### 4.6 第一章可运行性评估

```
引擎层（GraphBuilder 构建运行时图）：
  ✅ CONTAINS 边：world → region → area → sub_location    可构建
  ✅ CONNECTS 边：area ↔ area                              可构建
  ⚠️ HOSTS 边：area → NPC                                 只到区域级（需修 GraphBuilder）
  ✅ HAS_EVENT 边：area → event                            可构建
  ✅ GATE 边：chapter → chapter                            可构建
  ❌ MEMBER_OF 边：player/teammate → camp                  需 Party 存在（B1）

意图解析层（IntentResolver）：
  ✅ MOVE：有 CONNECTS 边，可匹配目的地
  ⚠️ TALK：HOSTS 边只到区域级，子地点匹配需修复
  ✅ LEAVE：有 sub_location 数据
  ✅ REST：关键词匹配，不依赖图
  ⚠️ EXAMINE：部分依赖图节点

数据层（WorldInstance 查询）：
  ✅ get_characters_in_area()：41 个角色可查
  ✅ get_characters_at_sublocation()：resident_npcs 可查
  ✅ AreaDefinition.sub_locations：7 个子地点
  ✅ AreaDefinition.connections：3 个连接
```

---

## 五、修改计划（基于审计结果更新）

### 第一层：让新系统跑起来

```
B0  初始化系统重设计
  ├─ B0.1 start_session() 自动选择起始子地点
  │       frontier_town → 默认 guild_hall（或第一个 sub_location）
  │       涉及: world_runtime.py start_session()
  │
  ├─ B0.2 GraphBuilder 增加 resident_npcs 反向 HOSTS
  │       遍历 area_def.sub_locations → 为每个 resident_npc 创建子地点级 HOSTS 边
  │       涉及: graph_builder.py _build_characters()
  │       数据依赖: 无（info/data 已有 resident_npcs）
  │
  ├─ B0.3 Party 自动创建
  │       方案: 角色创建后，自动创建 Party 并加入章节关联 NPC 中 tier=main 的作为初始队友
  │       候选: priestess(main), goblin_slayer(?), high_elf_archer(main), dwarf_shaman(main)
  │       涉及: world_runtime.py + party_service.py
  │       数据依赖: character_registry 已有 tier 字段
  │
  └─ B0.4 SceneBus 保证创建
          sub_location 不为 None 时锚定到子地点
          涉及: session_runtime.py _init_scene_bus()

B3  关键降级点可见化
  ├─ WorldGraph 构建失败 → 至少 error 日志，不静默
  ├─ SceneBus 未创建 → error 日志 + 原因
  └─ 可选：pipeline 入口前置检查
```

### 第二层到第四层（不变，等第一层稳定后推进）

### 数据层面后续（非阻塞，可并行）

```
D-DATA-1  知识图谱边重标注
  1961 条 unknown 边 → 重跑 --relabel-edges 标注关系类型
  影响: 扩散激活质量提升（当前也能工作，只是无法按类型过滤）

D-DATA-2  Location ID 格式统一
  graph_prefill.py 和 graph_builder.py 使用统一的 loc_{area}_{sub} 格式
  影响: 知识图谱节点和运行时图节点可对齐

D-DATA-3  章节初始队伍配置
  在 chapter 文档中增加 initial_companions 字段
  或: 由运行时从 tier=main + available_areas 推导（无需改数据）
```

---

## 六、后端架构总览（修改参考）

### 6.1 整体规模

| 层级 | 目录 | 文件数 | 代码行 | 说明 |
|------|------|--------|--------|------|
| Runtime | `app/runtime/` | 12 | ~3,400 | 运行时状态管理（V4 核心） |
| World 引擎 | `app/world/` | 13 | ~5,700 | 图世界引擎 |
| Services | `app/services/` | 22 | ~9,800 | 业务逻辑 |
| Admin 编排 | `app/services/admin/` | 10 | ~7,700 | 管线编排 |
| Models | `app/models/` | 24 | ~3,100 | 数据模型 |
| Routes | `app/routers/` | 2 | ~1,300 | HTTP 端点 |
| MCP | `app/mcp/` | 12 | ~1,100 | MCP 工具服务器 |
| Combat | `app/combat/` | 21 | ~5,000 | D&D 战斗系统 |
| Prompts | `app/prompts/` | 10 | ~870 | LLM 提示词 |
| Tools/CLI | `app/tools/` | 38 | ~11,800 | 提取管线/初始化/CLI |
| Tests | `tests/` | 49 | ~15,500 | ~599 个测试函数 |
| **合计** | | **~213** | **~65,000+** | |

### 6.2 架构分层

```
┌─────────────────────────────────────────────────────┐
│  Frontend (React/Vite)                              │
│  ↕ SSE /input/stream + REST APIs                    │
├─────────────────────────────────────────────────────┤
│  Router: game_v2.py                                 │
│  ├─ V4: POST /input, /input/stream  ← 主入口       │
│  ├─ Legacy: /navigate, /scene, /dialogue/start...   │
│  └─ Read: /location, /party, /time, /context...     │
├─────────────────────────────────────────────────────┤
│  Admin 编排层                                        │
│  ├─ AdminCoordinator (1,765 行) — 入口协调器        │
│  ├─ PipelineOrchestrator (790 行) — V4 三阶段管线   │
│  ├─ FlashCPUService (952 行) — Agentic LLM 执行     │
│  ├─ V4AgenticToolRegistry (2,532 行) — GM 25+ 工具  │
│  └─ TeammateAgenticTools (301 行) — 队友 3 个工具   │
├─────────────────────────────────────────────────────┤
│  World 图引擎层                                      │
│  ├─ WorldGraph (866 行) — 内存图容器 + NetworkX     │
│  ├─ GraphBuilder (1,191 行) — 6 步构图              │
│  ├─ BehaviorEngine (1,195 行) — tick+条件+动作      │
│  ├─ IntentResolver (435 行) — 纯图匹配意图解析      │
│  ├─ IntentExecutor (845 行) — 引擎前置执行          │
│  ├─ SceneBus (164 行) — 场景总线                    │
│  ├─ NPCReactor (280 行) — NPC 自主反应              │
│  ├─ PlayerNodeView (480 行) — 图节点⇔角色适配器     │
│  └─ Snapshot (327 行) — 图快照持久化                │
├─────────────────────────────────────────────────────┤
│  Runtime 运行时层                                    │
│  ├─ GameRuntime (65 行) — 全局单例                  │
│  ├─ WorldInstance (360 行) — 世界静态数据注册表      │
│  ├─ SessionRuntime (1,062 行) — 会话统一状态管理    │
│  ├─ AreaRuntime (587 行) — 区域生命周期             │
│  ├─ ContextAssembler (337 行) — 6 层上下文组装      │
│  └─ CompanionInstance (225 行) — 同伴实例           │
├─────────────────────────────────────────────────────┤
│  Services 业务服务层                                 │
│  ├─ NPC AI: InstanceManager + TieredAI + ContextWindow │
│  ├─ 记忆: MemoryGraph + SpreadingActivation + Flash    │
│  ├─ 队友: TeammateResponseService + Visibility         │
│  ├─ 叙事: NarrativeService (1,321 行)                  │
│  ├─ 图谱化: MemoryGraphizer + SceneBusGraphizer       │
│  ├─ LLM: LLMService (918 行) — Gemini 封装            │
│  └─ 其他: Party, Time, Character, Combat, Passerby     │
├─────────────────────────────────────────────────────┤
│  Persistence: Firestore + MCP (Game Tools + Combat)  │
└─────────────────────────────────────────────────────┘
```

### 6.3 关键文件速查表

#### Runtime 层 (`app/runtime/`)

| 文件 | 行数 | 职责 |
|------|------|------|
| `session_runtime.py` | 1,062 | 会话级统一状态管理，restore/persist 生命周期 |
| `area_runtime.py` | 587 | 区域生命周期，子地点/访问记录/NPC 上下文 |
| `context_assembler.py` | 337 | 纯机械 6 层上下文组装 |
| `world_instance.py` | 360 | 世界静态数据注册表（启动时一次性加载） |
| `companion_instance.py` | 225 | 同伴三层记忆（短/中/长期） |
| `game_runtime.py` | 65 | WorldInstance 缓存单例 |
| `models/area_state.py` | 144 | SubLocationDef, AreaConnection, AreaDefinition |
| `models/layered_context.py` | 81 | LayeredContext 6 层数据包 |

#### World 图引擎层 (`app/world/`)

| 文件 | 行数 | 职责 |
|------|------|------|
| `world_graph.py` | 866 | 内存图容器，节点/边 CRUD，脏追踪，层级查询 |
| `graph_builder.py` | 1,191 | 从 WorldInstance 6 步构建运行时图 |
| `behavior_engine.py` | 1,195 | tick 主循环，7 触发器 / 10 条件 / 6 动作 |
| `intent_resolver.py` | 435 | 纯图结构意图匹配（MOVE/TALK/LEAVE/REST/EXAMINE/USE_ITEM） |
| `intent_executor.py` | 845 | 引擎前置执行（状态变更 + 总线写入，不生成叙述） |
| `scene_bus.py` | 164 | 回合级场景总线，publish / get_round_summary |
| `npc_reactor.py` | 280 | NPC 自主反应收集（max 2/round，Passerby 模型） |
| `player_node.py` | 480 | PlayerCharacter ⇔ 图节点适配器 |
| `snapshot.py` | 327 | 图快照序列化/反序列化 |
| `event_propagation.py` | 195 | BFS 事件传播 + 衰减 |
| `models.py` | 428 | WorldNode/WorldEdge/Behavior/Action/TickContext |
| `constants.py` | 334 | D&D 5e 参考常量表 |

#### Admin 编排层 (`app/services/admin/`)

| 文件 | 行数 | 职责 |
|------|------|------|
| `pipeline_orchestrator.py` | 790 | V4 三阶段管线（上下文→Agentic→后处理） |
| `admin_coordinator.py` | 1,765 | 入口协调器（含 legacy 方法） |
| `flash_cpu_service.py` | 952 | agentic_process_v4() + legacy narration |
| `v4_agentic_tools.py` | 2,532 | GM 25+ 工具注册表 |
| `teammate_agentic_tools.py` | 301 | 队友 3 工具（disposition/recall/combat） |
| `world_runtime.py` | 523 | start_session + 旧导航/时间方法 |
| `recall_orchestrator.py` | 360 | 多 scope 扩散激活编排 |
| `event_service.py` | 516 | 事件入图 + 多角色分发 |
| `event_llm_service.py` | 484 | 事件解析/编码/视角转换 |
| `state_manager.py` | 93 | 内存 GameState + StateDelta |

#### Services 业务层 (`app/services/`)

| 文件 | 行数 | 职责 |
|------|------|------|
| `llm_service.py` | 918 | Gemini API 封装（text/json/agentic/stream） |
| `narrative_service.py` | 1,321 | 章节/事件/目标/地图解锁/章节转换 |
| `memory_graphizer.py` | 1,127 | 对话 → 图谱节点（session_history / scene_bus 双模式） |
| `teammate_response_service.py` | 1,118 | 队友决策/响应/流式 |
| `graph_store.py` | 1,048 | Firestore 图谱持久化（GraphScope v2 寻址） |
| `mcp_client_pool.py` | 887 | MCP 连接池单例（健康检查/重连/工具超时） |
| `area_navigator.py` | 677 | 地图导航 / A* 寻路 |
| `instance_manager.py` | 655 | NPC 实例池（LRU 淘汰 + 图谱化） |
| `session_history.py` | 541 | 会话历史管理 + ContextWindow + 图谱化 |
| `context_window.py` | 520 | 200K token 上下文窗口 |
| `passerby_service.py` | 508 | 路人 NPC 管理 |
| `event_llm_service.py` | 484 | 事件 LLM 能力 |
| `flash_llm_service.py` | 453 | Flash 记忆 LLM 能力 |
| `memory_graph.py` | 443 | 内存图结构 + NetworkX 索引 |
| `character_service.py` | 426 | 角色创建/验证/D&D 规则 |
| `flash_service.py` | 412 | 单角色记忆操作 |
| `action_options_service.py` | 300 | 可用动作生成 |
| `party_service.py` | 296 | Party CRUD + 位置同步 |
| `time_manager.py` | 267 | 游戏时间管理 |
| `spreading_activation.py` | 263 | CRPG-aware 扩散激活算法 |
| `tiered_ai_service.py` | 219 | NPC 三层 AI 响应 |
| `teammate_visibility_manager.py` | 195 | 队友信息可见性过滤 |
| `ability_check_service.py` | 194 | D&D 技能检定 + 防滥用 |
| `scene_bus_graphizer.py` | 142 | SceneBus → 地点图谱适配 |

### 6.4 V4 管线主流程状态

```
玩家输入 → POST /input/stream
  → AdminCoordinator.process_player_input_v3_stream()
    → PipelineOrchestrator.process()

A 阶段（上下文组装）：
  SessionRuntime.restore()
    ├─ GameState 加载          ✅
    ├─ PlayerCharacter 加载    ✅
    ├─ Party 加载              ⚠️ Party 不存在 → None → 队友跳过 [B0.3]
    ├─ NarrativeProgress 加载  ✅
    ├─ AreaRuntime 加载        ✅
    ├─ SceneBus 创建           ⚠️ sub_location=None → 无锚点 [B0.1]
    └─ WorldGraph 构建         ⚠️ HOSTS 只到区域级 [B0.2]
  BehaviorEngine.pre_tick()    ✅（如果 WorldGraph 构建成功）
  IntentResolver.resolve()     ⚠️ TALK 匹配受限 [B0.2]
  IntentExecutor.dispatch()    ✅
  NPCReactor.collect()         ✅
  ContextAssembler.assemble()  ✅

B 阶段（Agentic 会话）：
  FlashCPU.agentic_process_v4()  ✅
  V4AgenticToolRegistry (25+)    ✅

C 阶段（后处理）：
  BehaviorEngine.post_tick()     ✅
  TeammateResponseService        ⚠️ Party=None 时跳过 [B0.3]
  SessionHistory.record()        ✅
  SceneBusGraphizer              ✅
  SessionRuntime.persist()       ✅
```

### 6.5 数据流全景

```
提取管线（worldbook_graphizer）
  │
  ├─ maps.json → MapLoader → Firestore: maps/{id}/info/data
  │                          (sub_locations + resident_npcs + connections ✅)
  │
  ├─ characters.json → CharacterLoader → Firestore: characters/{id}
  │                    (profile.metadata.default_map ✅, default_sub_location ❌)
  │
  ├─ chapters_v2.json → Firestore: chapters/{id}
  │                     (events + trigger_conditions + transitions ✅, initial_party ❌)
  │
  ├─ world_graph.json → GraphPrefillLoader → Firestore: graphs/world/nodes, edges
  │                     (1,961 edges 全 unknown ⚠️)
  │
  └─ mainlines.json → Firestore: mainlines/{id}
                      (chapter_graph + chapters ✅)
      ↓
WorldInstance.initialize()  ← 从 Firestore 加载全部静态数据（验证通过 ✅）
      ↓
GraphBuilder.build()  ← 从 WorldInstance 构建运行时图
  │ CONTAINS ✅  CONNECTS ✅  HOSTS ⚠️(区域级)  HAS_EVENT ✅  GATE ✅
      ↓
WorldGraph → BehaviorEngine / IntentResolver / IntentExecutor / SceneBus
```

### 6.6 子系统状态总览

#### 完全就绪

| 系统 | 核心文件 | 测试 |
|------|---------|------|
| WorldGraph 容器 | `world_graph.py` | ✅ |
| GraphBuilder 6 步构图 | `graph_builder.py` | ✅ |
| BehaviorEngine | `behavior_engine.py` | ✅ 75 tests |
| 事件传播 | `event_propagation.py` | ✅ 16 tests |
| IntentResolver | `intent_resolver.py` | ✅ |
| IntentExecutor | `intent_executor.py` | ✅ |
| SceneBus | `scene_bus.py` | ✅ |
| NPCReactor | `npc_reactor.py` | ✅ |
| 快照持久化 | `snapshot.py` | ✅ |
| 扩散激活 | `spreading_activation.py` | ✅ 34 tests |
| NPC 三层 AI | `tiered_ai_service.py` | ✅ |
| NPC 实例池 | `instance_manager.py` | ✅ |
| 200K ContextWindow | `context_window.py` | ✅ |
| 队友响应 | `teammate_response_service.py` | ✅ |
| 叙事系统 | `narrative_service.py` | ✅ |
| D&D 战斗 | `combat/` 21 files | ✅ |
| 记忆图谱化 | `memory_graphizer.py` | ✅ |
| 总线图谱化 | `scene_bus_graphizer.py` | ✅ |
| LLM 服务 | `llm_service.py` | ✅ |
| MCP 连接池 | `mcp_client_pool.py` | ✅ |

#### 需要修复

| 系统 | 问题 | 阻塞项 |
|------|------|--------|
| `start_session()` | 不分配子地点，Party 不创建 | **B0** |
| `_build_characters()` | 不从 `resident_npcs` 建子地点级 HOSTS | **B0.2** |
| `_init_scene_bus()` | sub_location=None 时无锚点 | **B0.4** |
| 旧路由 7 端点 | 绕过 V4 管线 | B4 |
| AdminCoordinator | 11 个 legacy 方法 | B5 |
| WorldRuntime | navigate/advance_time 等旧方法 | B6 |
| FlashCPU | `generate_gm_narration()` 等 4 个 legacy | B5 |
| 知识图谱边 | 1,961 条全 `unknown` | D-DATA-1 |
| Location ID 格式 | `graph_prefill` vs `graph_builder` 不一致 | D-DATA-2 |

---

## 七、待讨论 / 待细化

| # | 问题 | 说明 |
|---|------|------|
| B0.3 | 初始队友选择策略 | 硬编码章节配置？还是运行时从 tier + available_areas 推导？ |
| B8 | NPC 独立触发的管线流程 | NPC 在管线的哪个阶段被触发？和 NPCReactor 的关系？输出如何进 SSE？ |
| B9 | GM 工具集具体削哪些 | 需要逐个分析 25+ 工具，确定哪些已被引擎覆盖、哪些移交 NPC、哪些保留给 GM |
| B10 | NPC 交互入口的 UX 设计 | 点击 NPC → 对话面板？还是 NPC 列表选择？和 LocationCard 的关系？ |
| B11 | 总线可视化的展示形式 | 类似聊天室的多角色时间线？还是叙事流中的内联标注？ |

---

## 八、遗留清理执行明细（B4-B7）

> 2026-02-19 执行，391 测试全通过，零回归

### 改动文件清单

| 文件 | 操作 | 删除/修改内容 |
|------|------|-------------|
| `app/routers/game_v2.py` | 删除 8 个路由 + 2 个内联 Model + 清理 import | 见下方 B4 明细 |
| `app/services/admin/admin_coordinator.py` | 删除 9 个方法 + 清理 import | 见下方 B5-coordinator 明细 |
| `app/services/admin/flash_cpu_service.py` | 删除 4 个旧叙述方法 + 2 个 FlashOperation 分支 + 3 个辅助方法 | 见下方 B5-flash 明细 |
| `app/services/admin/world_runtime.py` | 删除 4 个方法 + 1 个死参数 + 清理 import | 见下方 B6 明细 |
| `app/mcp/tools/navigation_tools.py` | 删除 `navigate` MCP 工具 | 见下方 MCP 明细 |
| `app/prompts/flash_gm_narration.md` | **整文件删除** | 旧 GM 叙述 prompt，仅被 `_load_gm_narration_prompt()` 使用 |
| `app/tools/game_master_cli.py` | 适配 3 个命令改走 V4 管线 | `/scene`, `/talk`+`/leave`, `/day` |
| `tests/test_navigation_fallback_and_sublocation.py` | 删除 7 个废弃测试 | 测试已删除的 NAVIGATE/ENTER_SUBLOCATION 分支 |

### B4: `app/routers/game_v2.py` — 删除 8 个旧路由

| 删除的路由 | 删除的处理函数 |
|-----------|-------------|
| `POST /{wid}/sessions/{sid}/scene` | `enter_scene()` |
| `POST /{wid}/sessions/{sid}/navigate` | `navigate()` |
| `POST /{wid}/sessions/{sid}/time/advance` | `advance_time()` |
| `POST /{wid}/sessions/{sid}/advance-day` | `advance_day()` |
| `POST /{wid}/sessions/{sid}/dialogue/start` | `start_dialogue()` |
| `POST /{wid}/sessions/{sid}/dialogue/end` | `end_dialogue()` |
| `POST /{wid}/sessions/{sid}/sub-location/enter` | `enter_sub_location()` |
| `POST /{wid}/sessions/{sid}/sub-location/leave` | `leave_sub_location()` |

同时删除：
- 内联 `class AdvanceTimeRequest(BaseModel)` — 仅被 `/time/advance` 路由使用
- 内联 `class EnterSubLocationRequest(BaseModel)` — 仅被 `/sub-location/enter` 路由使用
- 清理 import：`EnterSceneRequest`, `EnterSceneResponse`, `NavigateRequest`, `PlayerInputResponse`, `StartDialogueRequest`, `StartDialogueResponse`

### B5-coordinator: `app/services/admin/admin_coordinator.py` — 删除 9 个方法

| 删除的方法 | 行数（约） | 说明 |
|-----------|----------|------|
| `_build_context()` | ~105 行 | 旧上下文构建，并行读 Firestore |
| `_refresh_chapter_context()` | ~75 行 | 旧章节进度刷新 |
| `narrate_state_change()` | ~20 行 | 旧路由统一叙述入口 |
| `_build_change_summary()` | ~10 行 | 旧变更摘要构建 |
| `enter_scene()` | ~25 行 | 旧场景进入 |
| `start_dialogue()` | ~15 行 | 旧对话开始 |
| `end_dialogue()` | ~5 行 | 旧对话结束 |
| `navigate()` | ~15 行 | 旧导航委托（→ `world_runtime.navigate()`） |
| `advance_day()` | ~2 行 | 旧推进日委托（→ `world_runtime.advance_day()`） |

清理 import：`SceneState`, `FlashOperation`, `FlashRequest`

### B5-flash: `app/services/admin/flash_cpu_service.py` — 删除叙述方法 + FlashOperation 分支

**删除的旧叙述方法：**

| 删除的方法 | 行数（约） | 说明 |
|-----------|----------|------|
| `_load_gm_narration_prompt()` | ~8 行 | 加载旧 prompt 文件 |
| `generate_gm_narration()` | ~55 行 | 旧独立叙述生成（标记 [LEGACY]） |
| `_sanitize_tavern_text()` | ~5 行 | SillyTavern 占位符替换 |
| `_build_chapter_guidance()` | ~35 行 | 旧章节引导文本构建 |

**删除的 FlashOperation 分支：**

| 删除的分支 | 行数（约） | 说明 |
|-----------|----------|------|
| `FlashOperation.NAVIGATE` | ~40 行 | V4 有独立实现（`v4_agentic_tools.navigate()`） |
| `FlashOperation.ENTER_SUBLOCATION` | ~45 行 | V4 通过 `session_runtime.enter_sublocation()` 处理 |

**删除的辅助方法（仅被 ENTER_SUBLOCATION 分支调用）：**

| 删除的方法 | 行数（约） | 说明 |
|-----------|----------|------|
| `_resolve_enter_sub_location_id()` | ~85 行 | 子地点 ID 模糊匹配/解析 |
| `_match_sub_location_from_context()` | ~10 行 | 上下文中子地点名称匹配 |
| `_matches_location_candidate()` | ~15 行 | 通用名称/ID 模糊比较 |

同时简化 `runtime_required_ops` 检查：从 3 个 op 集合检查简化为只检查 `UPDATE_TIME`

### B6: `app/services/admin/world_runtime.py` — 删除 4 个方法

| 删除的方法 | 行数（约） | 说明 |
|-----------|----------|------|
| `navigate()` | ~125 行 | 旧导航全流程（含 A* 寻路、LLM 叙述、事件生成） |
| `_generate_travel_narration()` | ~30 行 | 旅途 LLM 叙述（仅 `navigate()` 调用） |
| `_record_movement_event()` | ~35 行 | 移动事件写入图谱（仅 `navigate()` 调用） |
| `advance_day()` | ~10 行 | 推进游戏日（仅旧路由调用） |

同时清理：
- `__init__` 参数 `llm_service` — 仅被 `_generate_travel_narration()` 使用
- `_get_event_generator()` 方法 — 仅被 `navigate()` 使用
- import：`Event`, `EventContent`, `EventType`, `GMEventIngestRequest`, `EventGenerator`, `LLMService`, `StateDelta`

### MCP: `app/mcp/tools/navigation_tools.py` — 删除 navigate 工具

删除 `navigate()` MCP 工具函数（~14 行）— 调用已删除的 `admin_coordinator.navigate()`。

保留：`get_location()`, `enter_sublocation()`, `leave_sublocation()` — 对应的 coordinator 方法仍存在。

### CLI: `app/tools/game_master_cli.py` — 适配

| 命令 | 旧行为 | 新行为 |
|------|-------|-------|
| `/scene` | 调用 `coordinator.enter_scene()` | 提示已废弃，引导直接输入 |
| `/talk <npc>` | 调用 `coordinator.start_dialogue()` | 转发到 `process_input("和{npc}说话")` 走 V4 管线 |
| `/leave` | 调用 `coordinator.end_dialogue()` | 转发到 `process_input("结束对话")` 走 V4 管线 |
| `/day` | 调用 `coordinator.advance_day()` | 转发到 `process_input("休息到明天")` 走 V4 管线 |

### Tests: `tests/test_navigation_fallback_and_sublocation.py` — 删除 7 个测试

| 删除的测试 | 测试的已删内容 |
|-----------|-------------|
| `test_enter_sublocation_accepts_sub_location_name` | `FlashOperation.ENTER_SUBLOCATION` |
| `test_enter_sublocation_keeps_sub_location_id_priority` | `FlashOperation.ENTER_SUBLOCATION` |
| `test_enter_sublocation_accepts_destination_alias` | `FlashOperation.ENTER_SUBLOCATION` |
| `test_enter_sublocation_accepts_location_alias` | `FlashOperation.ENTER_SUBLOCATION` |
| `test_navigate_calls_runtime_directly` | `FlashOperation.NAVIGATE` |
| `test_enter_sublocation_returns_state_delta` | `FlashOperation.ENTER_SUBLOCATION` |

保留：`test_update_time_calls_runtime_directly` — 测试仍存在的 `FlashOperation.UPDATE_TIME`

---

## 九、实测诊断（2026-02-20）

> 方法：uvicorn 启动 FastAPI + curl 调用 API，创建会话 → 创角色 → 发送 3 轮输入
> 世界：final-world，会话：sess_36014a88

### 9.1 运行时状态快照（诊断脚本验证）

```
WorldGraph 构建:  ✅ 成功（573 节点 / 610 边，无异常）
SceneBus 创建:    ✅ 已创建（area_id="frontier_town"，sub_location=None）
NPC 节点:         ✅ 133 个全部创建
HOSTS 边（area级）: 41 个 NPC 挂在 frontier_town
HOSTS 边（子地点级）: 0 个（全空）
无 HOSTS 边的 NPC:  92 个（无 default_map 的角色完全"漂浮"）
sub_location:      None（B0.1 确认）
Party:             None（B0.3 确认）
```

### 9.2 关键认知修正

| 之前的假设 | 实测真相 | 影响 |
|-----------|---------|------|
| SceneBus 为 None | **SceneBus 已创建**（area_id 存在即创建） | B0.4 严重度下调：11 个 `if session.scene_bus:` 检查全部通过 |
| WorldGraph 构建失败 | **构建成功**（573 节点/610 边） | B3 部分失效：`_world_graph_failed` 未被设置 |
| NPC 完全不可发现 | **41 个 NPC 有 area 级 HOSTS 边** | IntentResolver/NPCReactor 能发现区域内 NPC |
| NPCReactor 不运行 | **运行了，但 NPC 相关度评分为 0** | NPC 不反应是因为玩家输入未提及任何 NPC 名字（符合设计） |
| GM 走旧路径 | **走的是 V4 pipeline**（source="v4_pipeline"） | 引擎+总线+GM agentic 全链条在工作 |

### 9.3 三轮实测详情

**第 1 轮**："我环顾四周，观察这个公会大厅的环境"
- 引擎：IntentResolver 未匹配到高置信意图 → GM 兜底
- GM 工具：`activate_event`（failed: locked）+ `generate_scene_image`（success）
- NPC 自主反应：空（无人被提及，相关度=0）
- 队友：空（无 Party）
- 叙述：高质量环境描写 ✅

**第 2 轮**："我走向柜台，和那位小姐说话..."
- 引擎：IntentResolver TALK 匹配？→ 可能因"小姐"太模糊未匹配到 guild_girl → GM 兜底
- GM 工具：`npc_dialogue(guild_girl)` ✅ + `activate_event(ch_1_1_event_1)` ✅
- sub_location 仍为 None
- 观察：**GM 代言 NPC**（提线木偶模式），而非 NPC 自主发言

**第 3 轮**："我想去公会附属酒馆看看"
- 引擎：IntentResolver 匹配到 MOVE/ENTER_SUBLOCATION → 引擎前置执行成功
- **sub_location 变为 tavern_guild** ✅
- GM 工具调用：0（引擎已处理，GM 只做叙述）
- 观察：**这正是 Direction A 的设计预期**——引擎机械处理，GM 只叙述

### 9.4 根因链条（修正版）

```
resident_npcs 数据完整（guild_hall: 11 NPC, tavern_guild: 2 NPC, ...）
        ↓ 但
GraphBuilder 只看 char.default_sub_location（133 个全空）
        ↓ 所以
HOSTS 边只到 area 级（41 个），子地点级 = 0
        ↓ 导致
NPCReactor/IntentResolver 能发现 NPC 但不知道谁在哪个子地点
        ↓ 同时
start_session() 设 sub_location=None
        ↓ 导致
玩家起始不在任何子地点，SceneBus 无子地点语义
        ↓ 同时
Party 不自动创建
        ↓ 导致
队友响应整阶段跳过
```

### 9.5 修正后的优先级

```
优先级 1（引擎精度）:
  B0.2  GraphBuilder 从 resident_npcs 创建子地点级 HOSTS 边
        → NPC 精确定位到子地点，NPCReactor 能区分"谁在酒馆""谁在公会"
  B0.1  start_session() 自动选择起始子地点
        → 玩家有初始锚点

优先级 2（队友系统）:
  B0.3  Party 自动创建
        → 队友响应阶段不再跳过

优先级 3（前端适配 — 新增）:
  B12   前端显示当前子地点可交互 NPC 列表
        → 玩家能看到谁在身边，点击直接发起对话
  B13   前端适配引擎模式
        → 子地点切换 UI、NPC 交互入口、总线可视化

优先级 4（辅助）:
  B0.4  SceneBus fallback（严重度已下调）
  B3    降级日志
```

---

## 十、待讨论：前端 NPC 显示与引擎适配

### 10.1 问题

当前前端看到的 `npcs_present: []`（创建会话响应），玩家完全不知道身边有谁。引擎知道 41 个 NPC 在 frontier_town，但这个信息没传到前端。

### 10.2 设计思路（待讨论）

**后端需要提供的信息**：
- 当前子地点的 NPC 列表（从 resident_npcs 或 HOSTS 边）
- 每个 NPC 的基本信息（名字、tier、occupation、简短描述）
- NPC 是否可交互（在场 vs 不在场）

**前端需要的交互**：
- NPC 列表展示（在 LocationCard 或独立面板）
- 点击 NPC → 发起对话（直发结构化指令 or 走 `/input`）
- NPC 自主发言的展示（区别于 GM 叙述）
- 队友反应的展示

### 10.3 与 AD2 的关系

AD2（前端快捷按钮直通后端）优先级最低。但 NPC 列表点击交互是否属于 AD2？
还是说它更像一个基础 UI 信息展示——不绕过意图解析，只是帮玩家组织输入？

---

## 十一、变更日志

| 日期 | 操作 |
|------|------|
| 2026-02-19 | 创建文档，录入 B1-B7 诊断结果 |
| 2026-02-19 | 新增 B0（初始化系统重设计）、架构决策 AD1-AD5、B8-B11；重新排列优先级 |
| 2026-02-19 | 完成 Firestore 数据审计（final-world），确认数据可支撑运行时；识别 GraphBuilder 数据利用缺口；细化 B0 子任务和修改计划 |
| 2026-02-19 | 完成后端全面调查，新增第六章：后端架构总览（规模/分层/文件速查/管线状态/数据流/子系统状态） |
| 2026-02-19 | **执行遗留清理 B4-B7**（详见第八章）：8 文件改动，~985 行遗留代码删除，391 测试全通过 |
| 2026-02-20 | **实测诊断**：uvicorn + curl 验证 3 轮完整 pipeline；运行诊断脚本确认 WorldGraph/SceneBus/HOSTS 边真实状态；修正 B0.4 严重度；新增 B12/B13 前端适配项 |
