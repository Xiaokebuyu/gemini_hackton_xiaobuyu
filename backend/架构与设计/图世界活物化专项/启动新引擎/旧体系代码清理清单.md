# 旧体系代码清理清单

> 日期：2026-02-19  
> 目的：定位 V4 主链路之外的旧体系代码，给后续“删旧留新”做执行清单。

---

## 结论先看

- 当前主链路已经是 V4：`/api/game/{world}/sessions/{id}/input` 与 `/input/stream` 都走 `PipelineOrchestrator`。
- “旧体系残留”主要集中在三块：
  - 按动作拆分的旧路由链路（`/navigate`、`/time/advance`、`/dialogue/start`、`/scene` 等）
  - 旧叙述链路（`narrate_state_change()` -> `generate_gm_narration()`）
  - 各种兼容 fallback（会在引擎失败时回退到旧工具/旧思路）
- 前端当前主要走 SSE `/input/stream`，但仍保留大量旧 API 封装与 legacy hook。

---

## A. 确认属于旧体系的核心残留（优先清理）

### A1. 旧路由簇（按动作拆分）

文件：`backend/app/routers/game_v2.py`

旧链路路由（不属于 V4 单入口范式）：
- `/scene`
- `/navigate`
- `/time/advance`
- `/dialogue/start`
- `/dialogue/end`
- `/advance-day`
- `/sub-location/enter`

说明：
- 这些端点会走 `AdminCoordinator` 的旧方法，不经过 V4 的“玩家输入 -> 引擎/总线 -> GM”统一链路。

---

### A2. AdminCoordinator 旧方法簇

文件：`backend/app/services/admin/admin_coordinator.py`

可归类为旧体系的方法：
- `narrate_state_change()`
- `enter_scene()`
- `start_dialogue()`
- `end_dialogue()`
- `_build_context()`
- `_refresh_chapter_context()`
- `_build_change_summary()`

间接旧路径代理：
- `navigate()`
- `advance_time()`
- `enter_sub_location()`
- `leave_sub_location()`

备注：
- 这些方法与旧路由簇耦合紧密，通常应“路由 + 方法 + 调用链”一并删除。

---

### A3. FlashCPU 旧叙述链路

文件：`backend/app/services/admin/flash_cpu_service.py`

明确带 legacy 标记的方法：
- `generate_gm_narration()`（注释已标注 `[LEGACY]`）
- `_load_gm_narration_prompt()`
- `_build_chapter_guidance()`
- `_sanitize_tavern_text()`

说明：
- 这组函数主要服务旧路由的“状态变更后补叙述”模式，不是 V4 agentic 主链路必需。

---

### A4. 旧运行时服务（以按动作 API 为中心）

文件：`backend/app/services/admin/world_runtime.py`

旧链路常用方法：
- `navigate()`
- `advance_time()`
- `enter_sub_location()`
- `leave_sub_location()`
- `_generate_travel_narration()`
- `_record_movement_event()`

说明：
- 该服务仍被旧路由和部分兼容接口调用，不能直接整体删；建议先砍旧路由，再分拆保留“仍被新链路需要”的最小子集。

---

## B. 前端残留（多为兼容/死代码）

### B1. Legacy 非流式 Hook（未发现实际业务调用）

文件：`frontend/src/api/hooks/useGameInput.ts`
- 文件头已注明：`useGameInput — legacy non-streaming`
- `useGameInput()` 保留了旧的非流式 `/input` 调用路径

### B2. 旧 API 封装函数（定义存在，未发现业务调用）

文件：`frontend/src/api/gameApi.ts`
- `enterScene()`
- `navigate()`
- `advanceTime()`
- `startDialogue()`
- `endDialogue()`

说明：
- 目前前端业务组件主要使用 `useStreamGameInput()`（SSE `/input/stream`）。
- 上述函数更像历史兼容壳，建议和旧后端路由一起清理。

---

## C. 测试与工具链残留

### C1. 测试仍覆盖旧路由

主要文件：
- `backend/tests/test_fastapi_to_mcp.py`
- `backend/tests/E2E_TEST_REPORT.md`（报告中包含旧端点验证项）

影响：
- 删除旧路由前，需要先改测试策略，避免 CI 因旧接口断言失败。

### C2. CLI/调试工具仍走旧接口语义

主要文件：
- `backend/app/tools/game_master_cli.py`（`/scene`、`/dialogue` 命令语义）

影响：
- 清理后需同步升级 CLI（改为统一走 `/input`/`/input/stream` 语义）。

---

## D. 不是“旧代码”但会产生旧体感的 fallback 点

这些点不建议直接删，但要纳入治理：

- `backend/app/services/admin/pipeline_orchestrator.py`
  - 引擎前置执行失败时，会回退到 GM 全工具链（体感像旧体系）
- `backend/app/world/intent_executor.py`
  - 当图不可用或执行失败时，会把控制权交回 GM 路径
- `backend/app/services/admin/v4_agentic_tools.py`
  - 存在 world graph 不可用时的降级分支

说明：
- 这是“容错层”，不是纯旧代码。彻底去掉前需要确保意图覆盖率和稳定性足够高。

---

## E. 已发现的明显死代码候选

文件：`backend/app/services/admin/admin_coordinator.py`
- `_generate_chapter_transition()`：未发现运行时调用（仅设计文档提及）
- `_detect_output_anomalies()`：仅测试调用

建议：
- 可单独开一个“小清理 PR”先移除，风险较低。

---

## F. 推荐清理顺序（从低风险到高风险）

1. **前端先瘦身**
   - 删除 `useGameInput()` 和未使用的旧 API 封装函数。
2. **下线旧路由**
   - 从 `game_v2.py` 删除按动作拆分端点（保留 `/input`、`/input/stream` 主链路）。
3. **删 Coordinator 旧方法**
   - 删除 `narrate_state_change()`、`enter_scene()`、`start_dialogue()`、`end_dialogue()` 等。
4. **删 FlashCPU 旧叙述链路**
   - 删除 `generate_gm_narration()` 及其辅助函数。
5. **收缩 world_runtime**
   - 仅保留新链路确实依赖的最小能力。
6. **最后处理 fallback**
   - 在稳定性达标后，逐步收紧“失败回退旧路径”的容错分支。

---

## G. 清理时的联动改动清单

- 更新后端接口文档：
  - `backend/README.md`
  - `backend/README_EN.md`
  - `backend/CLAUDE.md`
- 更新前端导出：
  - `frontend/src/api/index.ts`
- 更新测试：
  - 替换旧端点断言为 `/input` 或 `/input/stream` 驱动
- 更新脚本/CLI：
  - `backend/app/tools/game_master_cli.py`

---

## H. 一句话策略

先把“旧路由 + 旧叙述链”从线上路径剥离，再处理 fallback；否则看起来永远像“新架构外面套了层旧壳”。

