# V4 ç®¡çº¿éªŒæ”¶ â€” å¾…ä¿®å¤é¡¹

> éªŒæ”¶æ—¥æœŸ: 2026-02-11
> åŸºäºè®¾è®¡æ–‡æ¡£ `V3ç®¡çº¿ä¼˜åŒ–-Aé˜¶æ®µé‡æ„æ–¹æ¡ˆ.md` å’Œ `V3ç®¡çº¿ä¼˜åŒ–-BCé˜¶æ®µé‡æ„æ–¹æ¡ˆ.md` é€é¡¹å¯¹ç…§

---

## A é˜¶æ®µ: ä¸Šä¸‹æ–‡ç»„è£…

### ä¸¥é‡ (æ•°æ®åŒ…ç¼ºå¤±)

#### ~~1. æ•°æ®åŒ…â‘¢ æˆ˜æ–—å®ä½“æœªæ³¨å…¥~~ âœ… å·²ä¿®å¤
- **ä¿®å¤**: `AreaRuntime.get_area_context()` æ–°å¢æˆ˜æ–—å®ä½“æ³¨å…¥â€”â€”`monsters`ï¼ˆæŒ‰ `danger_level` è¿‡æ»¤ï¼Œä¸Šé™ 10ï¼‰ã€`available_skills`ï¼ˆæŒ‰ç©å®¶èŒä¸šè¿‡æ»¤ï¼Œä¸Šé™ 15ï¼‰ã€`item_reference`ï¼ˆå…¨é‡ç²¾ç®€ï¼Œä¸Šé™ 25ï¼‰
- å­—æ®µç²¾ç®€æ§åˆ¶ token é¢„ç®—ï¼ˆæè¿°æˆªæ–­ 150-200 å­—ç¬¦ï¼‰ï¼Œæœ€å ~3K-5K tokens
- Prompt `flash_agentic_system.md` Layer 2 æ–°å¢å­—æ®µæè¿° + Â§3 æˆ˜æ–—å®ä½“å‚è€ƒä½¿ç”¨æŒ‡å¯¼
- **è¯æ®**: `app/runtime/area_runtime.py:get_area_context()`, `app/prompts/flash_agentic_system.md`

#### ~~2. æ•°æ®åŒ…â‘¥ å¥½æ„Ÿåº¦æ˜¯ç©ºå ä½~~ âœ… å·²ä¿®å¤
- **ä¿®å¤**: `PipelineOrchestrator._inject_dispositions()` åœ¨ Aâ†’B é˜¶æ®µä¹‹é—´æ³¨å…¥åœ¨åœº NPC + é˜Ÿå‹çš„å¥½æ„Ÿåº¦æ•°æ®ï¼ˆapproval/trust/fear/romance + recent_changesï¼‰
- ä» `area_context.npcs` + `dynamic_state.party_members` æ”¶é›† NPC IDï¼Œ`asyncio.gather` å¹¶è¡Œ `get_disposition()`
- å…¨é›¶å¥½æ„Ÿåº¦è¢«è¿‡æ»¤ï¼Œhistory è£å‰ªåˆ°æœ€è¿‘ 5 æ¡
- Prompt `flash_agentic_system.md` Â§3D æ–°å¢å¥½æ„Ÿåº¦å‚è€ƒæŒ‡å¯¼
- **è¯æ®**: `app/services/admin/pipeline_orchestrator.py:_inject_dispositions()`

#### 3. Memory å±‚å§‹ç»ˆä¸º None
- **è®¾è®¡è¦æ±‚**: A é˜¶æ®µå¯é€‰é¢„çƒ­ â€” å›¾è°±éç©ºæ—¶ç”¨æœºæ¢°ç§å­åšä¸€æ¬¡æ‰©æ•£æ¿€æ´»
- **ç°çŠ¶**: `ContextAssembler` å†™æ­» `memory=None`ï¼Œ`PipelineOrchestrator` ä¹Ÿæœªå¡«å……
- **å½±å“**: åŠ¨æ€å›¾è°±è®°å¿†åªèƒ½é€šè¿‡ B é˜¶æ®µ `recall_memory` å·¥å…·æŒ‰éœ€å¬å›ï¼ŒA é˜¶æ®µæ— é¢„çƒ­
- **ä¿®å¤ä½ç½®**: `app/services/admin/pipeline_orchestrator.py` çš„ A é˜¶æ®µæœ«å°¾
- **å¤‡æ³¨**: è®¾è®¡æ–‡æ¡£è¯´"å¯é€‰"ï¼Œæ¸¸æˆæ—©æœŸå›¾è°±ä¸ºç©ºæ—¶è‡ªåŠ¨è·³è¿‡ã€‚å¯å»¶å

### å·²ä¿®å¤ (2026-02-11)

#### 4. ç¼ºå°‘å·çº§å™äº‹æ¦‚è¿°
- **ä¿®å¤**: `_get_chapter_context()` ä» `world.mainline_registry[mainline_id]` æ³¨å…¥ `current_mainline: {id, name, description}`

#### 5. ç¼ºå°‘ä¸‹ä¸€ç« é¢„è§ˆ
- **ä¿®å¤**: `_get_chapter_context()` ä» `transitions[0].target_chapter_id` â†’ `chapter_registry[target]` æ³¨å…¥ `next_chapter_preview: {id, name, narrative_hint, available_areas}`

#### 29. character_roster æœªæ³¨å…¥ world_contextï¼ˆå®¡è®¡æ–°å‘ç°ï¼‰
- **ä¿®å¤**: `ContextAssembler.assemble()` ä» `world.character_registry` æ³¨å…¥ç²¾ç®€è§’è‰²èŠ±åå†Œ `[{id, name, description, location}]`

#### 30. Prompt å­—æ®µåä¸å®é™…ä»£ç ä¸ä¸€è‡´ï¼ˆå®¡è®¡æ–°å‘ç°ï¼‰
- **ä¿®å¤**: `flash_agentic_system.md` Layer 0/1/4 å­—æ®µåå¯¹é½ä»£ç å®é™…è¾“å‡ºçš„ key å
- æ¶‰åŠ: `world_background`â†’`background`, `chapter_name`â†’`name`, `player_character`â†’`player_summary`, `teammates`â†’`party_members`, `time`â†’`game_time`, `conversation_history`â†’`recent_history_preview`, åˆ é™¤ç©ºå€¼ `dispositions`

---

## é—ç•™æ¸…ç†

### å·²ä¿®å¤ (2026-02-11)

#### 6. V3 agentic_tools.py æœªåˆ é™¤
- **ä¿®å¤**: ç¡®è®¤ `run_required_tool_repair` åœ¨ V4 ç®¡çº¿ä¸­æ— è°ƒç”¨æ–¹ï¼Œå·²åˆ é™¤ `agentic_tools.py` å¹¶æ¸…ç† `flash_cpu_service.py` ä¸­çš„ V3 å¯¼å…¥

#### 7. 6 ä¸ªæµ‹è¯•æ–‡ä»¶å¼•ç”¨å·²åˆ é™¤æ¨¡å—
- **ä¿®å¤**: ç¡®è®¤ 6 ä¸ªæµ‹è¯•æ–‡ä»¶å…¨éƒ¨æµ‹è¯•å·²åºŸå¼ƒçš„ V3 åŠŸèƒ½ï¼ˆagentic_enforcement / condition_engine / story_director æ¨¡å—å‡å·²åˆ é™¤ï¼‰ï¼Œå·²åˆ é™¤å…¨éƒ¨ 6 ä¸ªè¿‡æ—¶æµ‹è¯•æ–‡ä»¶

### å·²ä¿®å¤ (2026-02-11)

#### 8. AdminCoordinator é—ç•™æ–¹æ³•
- **ä¿®å¤**: å·²åˆ é™¤ `process_player_input_v2()` / `process_player_input_v2_stream()` / `execute_action()` / `_action_id_to_input()` / `_get_available_actions()` å…± 5 ä¸ª V2 é—ç•™æ–¹æ³•
- è·¯ç”±å±‚ (`game_v2.py`) å·²ç§»é™¤ V2 fallbackï¼Œç›´æ¥è°ƒç”¨ V3/V4 ç®¡çº¿
- CLI (`game_master_cli.py`) å·²è¿ç§»åˆ° V3
- æµ‹è¯• (`test_game_v2_api.py`) å·²ç§»é™¤ `FakeCoordinatorV2Only` å’Œ V2 fallback æµ‹è¯•
- **ä¿ç•™**: `_build_context()` / `narrate_state_change()` / `enter_scene()` â€” ä»è¢« navigate/time/dialogue ç­‰ç‹¬ç«‹è·¯ç”±ä½¿ç”¨

#### 9. AreaRuntime æœªä½¿ç”¨çš„å­—æ®µ
- **ä¿®å¤**: `area_graph` / `npc_contexts` å­—æ®µå£°æ˜å¤„å·²æ·»åŠ  Phase 5+ TODO æ³¨é‡Šï¼Œæ ‡è®°ä¸ºå·²çŸ¥å»¶è¿ŸåŠŸèƒ½
- **çŠ¶æ€**: ä¿ç•™ä¸º Phase 5+ é¢„ç•™ï¼ˆè®¾è®¡æ–‡æ¡£ `V3ç®¡çº¿ä¼˜åŒ–-BCé˜¶æ®µé‡æ„æ–¹æ¡ˆ.md` ä¸­æœ‰å®Œæ•´è§„æ ¼ï¼‰

---

## B é˜¶æ®µ: å·¥å…·å±‚ & äº‹ä»¶ç³»ç»Ÿ

### å·²ä¿®å¤ (2026-02-11)

#### 10. `leave_sublocation` å·¥å…·ç¼ºå¤±
- **ä¿®å¤**: `v4_agentic_tools.py` æ³¨å†Œ `leave_sublocation` å·¥å…·ï¼Œå§”æ‰˜ `SessionRuntime.leave_sublocation()`
- **åŒæ­¥**: `flash_agentic_system.md` æ·»åŠ æ„å›¾æ˜ å°„å’Œ Layer 3 æç¤º

#### 11. `complete_objective` å·¥å…·ç¼ºå¤±
- **ä¿®å¤**: `v4_agentic_tools.py` æ–°å¢ `complete_objective` å·¥å…·ï¼Œåœ¨ SessionRuntime å†…å­˜ä¸­æ“ä½œ `narrative.objectives_completed`
- **åŒæ­¥**: `flash_agentic_system.md` æ–°å¢ Â§5 ç« èŠ‚ç›®æ ‡æŒ‡å¯¼ + ç¡¬è§„åˆ™

#### 12. äº‹ä»¶åˆå§‹åŒ–æœªè§¦å‘
- **ä¿®å¤**: `session_runtime.py` çš„ `_restore_area()` å’Œ `enter_area()` ä¸­ï¼ŒFirestore æ— äº‹ä»¶æ—¶ä» `chapter_registry` åˆå§‹åŒ–

### å¾…ä¿®å¤

#### 13. äº‹ä»¶ç”Ÿæˆæ¡†æ¶ä¸å®Œæ•´
- **è®¾è®¡è¦æ±‚**: `AreaEvent` éœ€è¦ `completion_conditions` å’Œ `on_complete` ç”¨äºçŠ¶æ€æœºè‡ªåŠ¨æ¨è¿›
- **ç°çŠ¶**: `initialize_events_from_chapter()` ä¸­ `completion_conditions=None`, `on_complete=None`
- **å½±å“**: äº‹ä»¶æ— æ³•é€šè¿‡ `check_events()` è‡ªåŠ¨ä» activeâ†’completedï¼Œåªèƒ½ç”± LLM æ‰‹åŠ¨è°ƒç”¨ `complete_event`
- **ä¿®å¤ä½ç½®**: `StoryEvent` æ¨¡å‹éœ€æ‰©å±•ï¼Œæˆ– `initialize_events_from_chapter()` éœ€ä»ç« èŠ‚æ•°æ®æå–

#### 14. Router ç«¯ç‚¹æœªè¿ç§»åˆ° V4
- **ç°çŠ¶**: `/navigate`ã€`/sub-location/enter`ã€`/sub-location/leave` ç­‰è·¯ç”±ä»èµ° V3 `AdminCoordinator` çš„æ—§è·¯å¾„
- **å½±å“**: é€šè¿‡å•ç‹¬è·¯ç”±è°ƒç”¨çš„å¯¼èˆªæ“ä½œä¸ç»è¿‡ V4 Pipeline
- **ä¿®å¤**: å°†è¿™äº›è·¯ç”±çš„å®ç°å§”æ‰˜åˆ° V4 Pipelineï¼Œæˆ–æ ‡è®°ä¸º deprecated å¼•å¯¼å‰ç«¯ä½¿ç”¨ `/input`

---

## ä¼˜å…ˆçº§æ’åº

| ä¼˜å…ˆçº§ | é¡¹ç›® | é˜»æ–­è¿è¡Œ? |
|--------|------|----------|
| âœ… | #7 åˆ é™¤è¿‡æ—¶æµ‹è¯•æ–‡ä»¶ | å·²ä¿®å¤ |
| âœ… | #1 æ³¨å…¥æˆ˜æ–—å®ä½“ | å·²ä¿®å¤ |
| âœ… | #2 æ³¨å…¥å¥½æ„Ÿåº¦ | å·²ä¿®å¤ |
| âœ… | #6 æ¸…ç† V3 agentic_tools | å·²ä¿®å¤ |
| âœ… | #4 å·çº§æ¦‚è¿° | å·²ä¿®å¤ |
| âœ… | #5 ä¸‹ä¸€ç« é¢„è§ˆ | å·²ä¿®å¤ |
| âœ… | #29 character_roster æ³¨å…¥ | å·²ä¿®å¤ |
| âœ… | #30 Prompt å­—æ®µåå¯¹é½ | å·²ä¿®å¤ |
| âœ… | #8 æ¸…ç† deprecated æ–¹æ³• | å·²ä¿®å¤ |
| P3 | #3 Memory é¢„çƒ­ | å¦ (B é˜¶æ®µå·¥å…·å¯è¡¥å¿) |
| âœ… | #9 æ¸…ç†æœªç”¨å­—æ®µ | å·²ä¿®å¤ (Phase 5+ TODO æ³¨é‡Š) |
| âœ… | #10 leave_sublocation å·¥å…· | å·²ä¿®å¤ |
| âœ… | #11 complete_objective å·¥å…· | å·²ä¿®å¤ |
| âœ… | #12 äº‹ä»¶åˆå§‹åŒ– | å·²ä¿®å¤ |
| P2 | #13 äº‹ä»¶ completion_conditions | å¦ (LLM æ‰‹åŠ¨è¡¥å¿) |
| P2 | #14 Router V4 è¿ç§» | å¦ (å‰ç«¯å¯ç”¨ /input) |

---

## å¤éªŒè¡¥å…… (2026-02-11 ç¬¬äºŒè½®)

> æœ¬èŠ‚ä¸ºæœ¬æ¬¡é€æ¡å¤éªŒæ–°å¢é¡¹ï¼ŒåŸºäºå½“å‰ä»£ç å®é™…å®ç°è¡¥å……ï¼Œä¸è¦†ç›–å‰æ–‡æ¡ç›®ã€‚

### A é˜¶æ®µæ–°å¢å¾…ä¿®å¤

#### 15. ~~A é˜¶æ®µä»åœ¨åšé¢„åˆ¤æ–­ï¼ˆè¿èƒŒ"é›¶åˆ¤æ–­"åŸåˆ™ï¼‰~~ âœ… å·²ä¿®å¤
- **ä¿®å¤**: ç§»é™¤ `PipelineOrchestrator` ä¸­ B é˜¶æ®µå‰çš„ `check_events()` å’Œ `check_chapter_transition()` é¢„æ£€æŸ¥
- äº‹ä»¶çŠ¶æ€æœºæ£€æŸ¥ç°åœ¨åªåœ¨ C1 é˜¶æ®µæ‰§è¡Œä¸€æ¬¡ï¼ˆç¬¦åˆè®¾è®¡æ–‡æ¡£ `V3ç®¡çº¿ä¼˜åŒ–-BCé˜¶æ®µé‡æ„æ–¹æ¡ˆ.md` C é˜¶æ®µæ–°æµç¨‹ï¼‰
- A é˜¶æ®µæ¢å¤ä¸ºçº¯æ•°æ®ç»„è£…ï¼Œé›¶åˆ¤æ–­

#### 16. ~~æ•°æ®åŒ…â‘ åœ°ç‚¹å¢å¼ºå­—æ®µä»ä¸å®Œæ•´~~ âœ… å·²ä¿®å¤
- **ä¿®å¤**: æ¨¡å‹å±‚ `AreaDefinition` / `SubLocationDef` æ–°å¢ `key_features`ã€`available_actions`ã€`passerby_spawn_rate` ä¸“ç”¨å­—æ®µ
- åŠ è½½å±‚ `WorldInstance._parse_area_definition()` ä» Firestore æ•°æ®æå–åˆ°ä¸“ç”¨å­—æ®µï¼ˆä¸å†ä¸¢è¿› metadataï¼‰
- è¾“å‡ºå±‚ `AreaRuntime.get_area_context()` åŒºåŸŸçº§æ–°å¢ `key_features` / `available_actions`ï¼Œå­åœ°ç‚¹è¡¥å…¨ `resident_npcs` / `available_actions`ï¼Œè¿æ¥è¡¥å…¨ `requirements`

#### 17. ~~æ•°æ®åŒ…â‘¡ NPC è¿‡æ»¤ä¸æ¸…æ´—è§„åˆ™æœªè½åœ°~~ ğŸ”§ éƒ¨åˆ†ä¿®å¤
- **å·²ä¿®å¤**: å­åœ°ç‚¹è¿‡æ»¤ï¼ˆç©å®¶åœ¨å­åœ°ç‚¹æ—¶è°ƒç”¨ `get_characters_at_sublocation()`ï¼Œä»…è¿”å› `resident_npcs`ï¼‰+ å­—æ®µæ¸…æ´—æ‰å¹³åŒ–ï¼ˆ`_clean_npc_for_context()` å»é™¤ `system_prompt`/`state`/åµŒå¥—ç»“æ„/null å­—æ®µï¼‰+ tier åˆ†çº§ï¼ˆ`example_dialogue` ä»… main å±‚çº§æ³¨å…¥ï¼‰
- **å»¶å**: ç« èŠ‚è¿‡æ»¤ â€” å½“å‰æ•°æ®æ—  per-chapter NPC è¦†ç›–æœºåˆ¶ï¼Œarea-level è¿‡æ»¤å·²è¶³å¤Ÿ
- **è¯æ®**: `app/runtime/area_runtime.py:_clean_npc_for_context()`, `app/runtime/area_runtime.py:get_area_context()`

#### 18. ~~æ•°æ®åŒ…â‘¤åŸºç¡€çŠ¶æ€ä»æ˜¯æ‘˜è¦æ³¨å…¥ï¼Œéå…¨é‡ç»“æ„~~ âœ… å·²ä¿®å¤
- **ä¿®å¤**: `_build_dynamic_state()` ä¸­ `player_summary` â†’ `player_character`ï¼ˆ`model_dump` å…¨é‡ç»“æ„ï¼Œæ’é™¤æ—¶é—´æˆ³ï¼‰ï¼›`party_members` è¡¥å…¨ `personality` / `current_mood` å­—æ®µ
- **åŒæ­¥**: `flash_agentic_system.md` Layer 4 å­—æ®µæè¿°å¯¹é½

#### 19. ~~Wave 1/2/3 åˆ†æ³¢å¹¶è¡Œè£…é…æœªå®ç°~~ âœ… å·²ä¿®å¤
- **ä¿®å¤**: `SessionRuntime.restore()` é‡æ„ä¸º Wave 1/2 åˆ†æ³¢å¹¶è¡Œâ€”â€”Wave 1 ç”¨ `asyncio.gather` å¹¶è¡ŒåŠ è½½ GameState + Player + Party + Narrativeï¼ˆä¸»è·¯å¾„ï¼‰ï¼ŒWave 2 ä¸²è¡Œæ‰§è¡Œä¾èµ–é¡¹ï¼ˆæ—¶é—´æå– + Narrative fallback + AreaRuntimeï¼‰
- `AreaRuntime.load()` å†…éƒ¨ 3 è·¯ Firestore è¯»å–ï¼ˆstate + events + visitsï¼‰ä¹Ÿæ”¹ä¸º `asyncio.gather` å¹¶è¡Œ

---

## B+C é˜¶æ®µå¤éªŒç»“æœ

### å·²å¯¹é½ï¼ˆç¡®è®¤ï¼‰

- V4 ä¸»é“¾è·¯å·²ä½¿ç”¨ `PipelineOrchestrator + ContextAssembler + V4AgenticToolRegistry`  
  è¯æ®: `app/services/admin/pipeline_orchestrator.py:90`, `app/services/admin/flash_cpu_service.py:611`
- `leave_sublocation` / `complete_objective` / `activate_event` / `complete_event` / `advance_chapter` / `update_disposition` å·²åœ¨ V4 å·¥å…·é›†ä¸­  
  è¯æ®: `app/services/admin/v4_agentic_tools.py:96`, `app/services/admin/v4_agentic_tools.py:929`
- è¾“å…¥ä¸»ç«¯ç‚¹ `/input` ä¸ `/input/stream` å·²èµ° V4 å¤„ç†å‡½æ•°  
  è¯æ®: `app/routers/game_v2.py:432`, `app/routers/game_v2.py:466`

### å·²ä¿®å¤ (2026-02-11)

#### 20. ~~`navigate` ä»å¯ç»•è¿‡ç« èŠ‚å¯è¾¾åŒºä¸è¿æ¥æ ¡éªŒ~~ âœ… å·²ä¿®å¤
- **ä¿®å¤**: `v4_agentic_tools.py:navigate()` æ–°å¢ä¸‰å±‚æ ¡éªŒâ€”â€”(1) ç« èŠ‚é—¨æ§: `chapter.available_maps` éç©ºæ—¶ç›®æ ‡å¿…é¡»åœ¨åˆ—è¡¨ä¸­ (2) è¿æ¥æ ¡éªŒ: `current_area.connections` ä¸­å¿…é¡»å­˜åœ¨åˆ°ç›®æ ‡çš„è¿æ¥ (3) æ—…è¡Œæ—¶é—´æ¨è¿›: è§£æè¿æ¥çš„ `travel_time` â†’ æ¨è¿› `GameTimeState`
- æ ¡éªŒæ”¾åœ¨å·¥å…·å±‚è€Œé `SessionRuntime.enter_area()`ï¼Œå› ä¸º session restore ä¸åº”è¢«é—¨æ§
- `_resolve_area_id()` ä¼˜å…ˆåŒ¹é…è¿æ¥ç›®æ ‡åç§°ï¼Œå† fallback å…¨å±€åŒ¹é…

#### 21. ~~`advance_chapter` æœªèµ°å™äº‹æœåŠ¡è½¬æ¢æµç¨‹~~ âœ… å·²ä¿®å¤
- **ä¿®å¤**: å†…è” `NarrativeService.transition_to_chapter()` å®Œæ•´é€»è¾‘åˆ° V4 å·¥å…·ï¼šæ—§ç« èŠ‚å®Œæˆè®°å½•(`chapters_completed`) + äº‹ä»¶é‡ç½®(`events_triggered`) + æ—¶é—´æˆ³(`chapter_started_at`) + åˆ†æ”¯å†å²(`branch_history`) + `active_chapters` æ¸…ç† + è¿”å› `new_maps_unlocked`
- **æ–°å¢å‚æ•°**: `transition_type`ï¼ˆnormal/branch/failure/skipï¼‰
- **è®¾è®¡å†³ç­–**: ä¸å§”æ‰˜ NarrativeServiceï¼ˆé¿å… Firestore åŒé‡è¯»å†™ä¸å†…å­˜å¯¹è±¡ä¸åŒæ­¥ï¼‰ï¼Œç›´æ¥æ“ä½œ `session.narrative` ç”± C5 ç»Ÿä¸€æŒä¹…åŒ–

#### 22. ~~`npc_dialogue` æœªç»´æŠ¤ `npc_interactions` è®¡æ•°~~ âœ… å·²ä¿®å¤
- **ä¿®å¤**: `npc_dialogue` æˆåŠŸåè‡ªåŠ¨é€’å¢ `session.narrative.npc_interactions[npc_id]` å¹¶ `mark_narrative_dirty()`ï¼Œç”± C é˜¶æ®µ `session.persist()` ç»Ÿä¸€æŒä¹…åŒ–
- **é™„å¸¦æ”¹è¿›**: NPC å¯¹è¯ç‹¬ç«‹å‘ˆç°â€”â€”æ–°å¢ `npc_responses` é€šé“ï¼ˆå¹³è¡Œäº `teammate_responses`ï¼‰ï¼ŒSSE æµæ–°å¢ `npc_response` äº‹ä»¶ï¼Œprompt æ–°å¢ Â§7.5 ç¦æ­¢ GM å¤è¿° NPC å°è¯

#### 23. ~~"ç§»é™¤ enforcement + repair"åªå®Œæˆä¸€åŠï¼ˆé—ç•™æ—§ä¿®å¤é“¾ï¼‰~~ âœ… å·²ä¿®å¤
- **ä¿®å¤**: V3 `agentic_tools.py` å·²åˆ é™¤ï¼Œ`run_required_tool_repair` å·²æ¸…é™¤ï¼Œ`FlashCPUService` ä¸å†å¯¼å…¥ V3 `AgenticToolRegistry`ï¼Œä»…ä½¿ç”¨ `V4AgenticToolRegistry`ã€‚ç›¸å…³ V3 æµ‹è¯•æ–‡ä»¶ä¹Ÿå·²å…¨éƒ¨åˆ é™¤ã€‚éš #6/#8 ä¸€å¹¶å®Œæˆã€‚

#### 24. ~~å›¾è°± scope ç®€åŒ–ï¼ˆ2 æ´»è·ƒï¼‰æœªè½å®~~ âœ… å·²ä¿®å¤
- **ä¿®å¤**: `create_memory` ç§»é™¤ chapter/world å›é€€é“¾â€”â€”ç¼ºå°‘ area ä¿¡æ¯æ—¶é™çº§åˆ° `GraphScope.character("player")`ï¼ˆç©å®¶ä¸ªäººè®°å¿†ï¼‰ï¼Œè€Œéæ³„æ¼åˆ°å…±äº« scope
- **ä¿ç•™**: `GraphScope` 6 ç§ç±»å‹ä¸å˜ï¼ˆworld/chapter/location/camp ä»…ç”¨äºé¢„ç½®æ•°æ®å’Œ recall è¯»å–ï¼Œéè¿è¡Œæ—¶åŠ¨æ€å†™å…¥ï¼‰
- **è¯æ®**: `app/services/admin/v4_agentic_tools.py` create_memory scope é€‰æ‹©é€»è¾‘

### C é˜¶æ®µæ–°å¢å¾…ä¿®å¤

#### 25. ~~C é˜¶æ®µç¼ºå°‘"åç½®ç« èŠ‚è½¬æ¢é‡è¯„ä¼°"~~ âœ… å·²ä¿®å¤
- **ä¿®å¤**: ä¸¤å¤„è¡¥é½â€”â€”(1) C é˜¶æ®µ `PipelineOrchestrator` åœ¨ `check_events()` åæ–°å¢ `check_chapter_transition()` è°ƒç”¨ï¼Œç»“æœé€šè¿‡ `CoordinatorResponse.chapter_info` è¿”å›å‰ç«¯ (2) A é˜¶æ®µ `ContextAssembler._get_chapter_context()` æ–°å¢æœºæ¢°æ¡ä»¶è¯„ä¼°ï¼Œæ»¡è¶³æ—¶æ³¨å…¥ `chapter_transition_available` å­—æ®µï¼Œä¸ prompt `Â§6 ç« èŠ‚è½¬æ¢` å¯¹é½
- **è¯æ®**: `app/services/admin/pipeline_orchestrator.py:136`, `app/runtime/context_assembler.py:141`

#### 26. ~~`session.persist()` æœªæŒä¹…åŒ– AreaRuntime æ¯è½®çŠ¶æ€~~ âœ… å·²ä¿®å¤
- **ä¿®å¤**: `AreaRuntime` æ–°å¢ `persist_state()` æ–¹æ³•ï¼ˆå¢é‡ä¿å­˜ state + eventsï¼Œä¸ç”Ÿæˆæ‘˜è¦ä¸æ¸…ç†å†…å­˜ï¼‰ï¼Œ`unload()` å¤ç”¨è¯¥æ–¹æ³•æ¶ˆé™¤é‡å¤ä»£ç ï¼Œ`SessionRuntime.persist()` æœ«å°¾æ–°å¢ç¬¬ 5 æ­¥è°ƒç”¨ `current_area.persist_state()`
- **è¯æ®**: `app/runtime/area_runtime.py:persist_state()`, `app/runtime/session_runtime.py:persist()`

#### 27. ~~AreaRuntime çš„ area_graph / npc_contexts ç”Ÿå‘½å‘¨æœŸæœªæ‰“é€š~~ âœ… å·²ä¿®å¤
- **ä¿®å¤**: `AreaRuntime.load()` æ‰©å±•ä¸º 5 è·¯å¹¶è¡Œï¼ˆæ–°å¢ `_load_area_graph()` + `_load_npc_contexts()`ï¼‰ï¼›`persist_state()` æ–°å¢ area_graphï¼ˆé€šè¿‡ `GraphStore.save_graph_v2(merge=True)`ï¼‰å’Œ npc_contexts æŒä¹…åŒ–ï¼›`unload()` æ¸…ç† `area_graph=None`
- **ä¾èµ–é“¾æ‰“é€š**: `PipelineOrchestrator` â†’ `SessionRuntime(graph_store=)` â†’ `AreaRuntime.load(chapter_id=, graph_store=)`
- **è¯æ®**: `app/runtime/area_runtime.py`, `app/runtime/session_runtime.py`, `app/services/admin/pipeline_orchestrator.py`

#### 28. ~~åŒä¼´å…±äº«äº‹ä»¶é“¾è·¯æœªé—­ç¯ï¼ˆ`session.companions` æœªæ¢å¤/æŒä¹…åŒ–ï¼‰~~ âœ… å·²ä¿®å¤
- **ä¿®å¤**: `SessionRuntime` æ–°å¢ `_restore_companions()` æ–¹æ³•ï¼ˆä» Party æ´»è·ƒæˆå‘˜åˆ›å»º `CompanionInstance` å¹¶ `load()`ï¼‰ï¼Œåœ¨ `restore()` Wave 2 æœ«å°¾è°ƒç”¨ï¼›`persist()` æ–°å¢ç¬¬ 6 æ­¥éå† `companions` è°ƒç”¨ `save()`
- **åŒé‡åˆ†å‘ä¿®å¤**: ç§»é™¤ `PipelineOrchestrator` C é˜¶æ®µå†—ä½™çš„ Phase 5C åˆ†å‘ä»£ç å—ï¼Œäº‹ä»¶åˆ†å‘ç»Ÿä¸€ç”± `AreaRuntime._apply_on_complete()` â†’ `_dispatch_event_to_companions()` å®Œæˆ
- **è¯æ®**: `app/runtime/session_runtime.py:_restore_companions()`, `app/runtime/session_runtime.py:persist()`
