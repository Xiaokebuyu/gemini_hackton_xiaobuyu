# V4 管线验收 — 待修复项

> 验收日期: 2026-02-11
> 基于设计文档 `V3管线优化-A阶段重构方案.md` 和 `V3管线优化-BC阶段重构方案.md` 逐项对照

---

## A 阶段: 上下文组装

### 严重 (数据包缺失)

#### 1. 数据包③ 战斗实体未注入
- **设计要求**: 按 danger_level 过滤怪物、按职业过滤技能、物品全量注入
- **现状**: `WorldInstance` 已实现 `get_monsters_for_danger()` / `get_skills_for_classes()` / `item_registry`，但 `ContextAssembler` 和 `AreaRuntime.get_area_context()` 均未调用
- **影响**: LLM 无法在叙述中引用怪物属性、技能效果、物品信息
- **修复位置**: `app/runtime/context_assembler.py` 或 `app/runtime/area_runtime.py:get_area_context()`

#### 2. 数据包⑥ 好感度是空占位
- **设计要求**: 注入在场 NPC 的 approval/trust/fear/romance + 最近变化记录
- **现状**: `_build_dynamic_state()` 中硬编码 `state["affinity"] = {}`
- **影响**: LLM 不知道 NPC 对玩家的态度，无法根据好感度调整对话语气
- **修复位置**: `app/runtime/context_assembler.py:_build_dynamic_state()`
- **数据来源**: `graph_store.get_all_dispositions(world_id, character_id)`

#### 3. Memory 层始终为 None
- **设计要求**: A 阶段可选预热 — 图谱非空时用机械种子做一次扩散激活
- **现状**: `ContextAssembler` 写死 `memory=None`，`PipelineOrchestrator` 也未填充
- **影响**: 动态图谱记忆只能通过 B 阶段 `recall_memory` 工具按需召回，A 阶段无预热
- **修复位置**: `app/services/admin/pipeline_orchestrator.py` 的 A 阶段末尾
- **备注**: 设计文档说"可选"，游戏早期图谱为空时自动跳过。可延后

### 中等 (数据不完整)

#### 4. 缺少卷级叙事概述
- **设计要求**: `current_mainline: {id, name, description}` 提供整体叙事方向 (~200-400 token)
- **现状**: `_get_chapter_context()` 只返回 `mainline_id`，无名称和描述
- **修复位置**: `app/runtime/context_assembler.py:_get_chapter_context()`
- **数据来源**: `session.world.mainline_registry[mainline_id]`

#### 5. 缺少下一章预览
- **设计要求**: `next_chapter_preview: {id, name, narrative_hint, available_areas}`
- **现状**: 未实现
- **修复位置**: `app/runtime/context_assembler.py:_get_chapter_context()`
- **数据来源**: 当前章节 `transitions[0].target_chapter_id` → `chapter_registry[target]`

---

## 遗留清理

### 严重

#### 6. V3 agentic_tools.py 未删除
- **现状**: `agentic_tools.py` (35KB) 与 `v4_agentic_tools.py` (53KB) 并存
- **影响**: `flash_cpu_service.py` 仍导入 V3 的 `AgenticToolRegistry`（用于 `run_required_tool_repair`）
- **修复**: 确认 repair 流程是否还需要，不需要则删除 `agentic_tools.py` 并清理导入

#### 7. 6 个测试文件引用已删除模块
- `tests/test_agentic_enforcement.py` → 导入 `agentic_enforcement`
- `tests/test_admin_v3_alignment.py` → 导入 `agentic_enforcement`
- `tests/test_game_v2_error_mapping.py` → 导入 `agentic_enforcement`
- `tests/test_story_director_v2.py` → 导入 `story_director` + `condition_engine`
- `tests/test_condition_engine.py` → 导入 `condition_engine`
- `tests/test_agentic_tool_schema_diagnostic.py` → 条件导入 `agentic_enforcement`
- **影响**: 这些测试会因 ImportError 失败
- **修复**: 删除这些过时的测试文件

### 中等

#### 8. AdminCoordinator 遗留方法
- `process_player_input_v2()` / `process_player_input_v2_stream()` — 标记 deprecated 但未删除
- `_build_context()` — 仍被 `narrate_state_change()` / `enter_scene()` 等端点使用
- **修复**: v2 方法可删除；`_build_context()` 需确认依赖端点是否迁移到 V4

#### 9. AreaRuntime 未使用的字段
- `npc_contexts: Dict[str, Any] = {}` — 声明但从未填充
- `area_graph: Optional[Any] = None` — 声明但从未初始化
- **影响**: 无功能影响，代码噪声
- **修复**: 保留作为 Phase 5+ 预留，或添加注释说明

---

## B 阶段: 工具层 & 事件系统

### 已修复 (2026-02-11)

#### 10. `leave_sublocation` 工具缺失
- **修复**: `v4_agentic_tools.py` 注册 `leave_sublocation` 工具，委托 `SessionRuntime.leave_sublocation()`
- **同步**: `flash_agentic_system.md` 添加意图映射和 Layer 3 提示

#### 11. `complete_objective` 工具缺失
- **修复**: `v4_agentic_tools.py` 新增 `complete_objective` 工具，在 SessionRuntime 内存中操作 `narrative.objectives_completed`
- **同步**: `flash_agentic_system.md` 新增 §5 章节目标指导 + 硬规则

#### 12. 事件初始化未触发
- **修复**: `session_runtime.py` 的 `_restore_area()` 和 `enter_area()` 中，Firestore 无事件时从 `chapter_registry` 初始化

### 待修复

#### 13. 事件生成框架不完整
- **设计要求**: `AreaEvent` 需要 `completion_conditions` 和 `on_complete` 用于状态机自动推进
- **现状**: `initialize_events_from_chapter()` 中 `completion_conditions=None`, `on_complete=None`
- **影响**: 事件无法通过 `check_events()` 自动从 active→completed，只能由 LLM 手动调用 `complete_event`
- **修复位置**: `StoryEvent` 模型需扩展，或 `initialize_events_from_chapter()` 需从章节数据提取

#### 14. Router 端点未迁移到 V4
- **现状**: `/navigate`、`/sub-location/enter`、`/sub-location/leave` 等路由仍走 V3 `AdminCoordinator` 的旧路径
- **影响**: 通过单独路由调用的导航操作不经过 V4 Pipeline
- **修复**: 将这些路由的实现委托到 V4 Pipeline，或标记为 deprecated 引导前端使用 `/input`

---

## 优先级排序

| 优先级 | 项目 | 阻断运行? |
|--------|------|----------|
| P0 | #7 删除过时测试文件 | 是 (pytest 失败) |
| P1 | #1 注入战斗实体 | 否 (影响叙事质量) |
| P1 | #2 注入好感度 | 否 (影响 NPC 交互质量) |
| P1 | #6 清理 V3 agentic_tools | 否 (代码冗余) |
| P2 | #4 卷级概述 | 否 (影响叙事方向) |
| P2 | #5 下一章预览 | 否 (影响章节引导) |
| P2 | #8 清理 deprecated 方法 | 否 |
| P3 | #3 Memory 预热 | 否 (B 阶段工具可补偿) |
| P3 | #9 清理未用字段 | 否 |
| ✅ | #10 leave_sublocation 工具 | 已修复 |
| ✅ | #11 complete_objective 工具 | 已修复 |
| ✅ | #12 事件初始化 | 已修复 |
| P2 | #13 事件 completion_conditions | 否 (LLM 手动补偿) |
| P2 | #14 Router V4 迁移 | 否 (前端可用 /input) |
