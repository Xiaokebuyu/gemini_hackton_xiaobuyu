# C9 å¼•æ“å®Œå–„ä¸ç®¡çº¿å‡çº§è®¡åˆ’

> æ—¥æœŸ: 2026-02-16ï¼ˆ2026-02-18 æ›´æ–°ï¼šå¼•æ“ä¾§å…¨éƒ¨å®Œæˆï¼‰
> åˆ†æ”¯: buyuçš„å¼‚ä¸–ç•Œå†’é™©
> å‰ç½®: C8 BehaviorEngine å…¨é¢åˆ‡æ¢å·²å®Œæˆ
> ç›®æ ‡: è¡¥é½å¼•æ“è®¾è®¡è§„æ ¼ä¸­çš„æœªå®ç°èƒ½åŠ› â†’ å‡çº§æå–ç®¡çº¿ â†’ æ•°æ®å›å¡«
>
> **ç›¸å…³æ–‡æ¡£**:
> - `å›¾ä¸–ç•Œèƒ½åŠ›çŸ©é˜µï¼ˆå®æ–½ä¸­ï¼‰.md` â€” æ€»çŠ¶æ€è¿½è¸ª + æ‰§è¡Œè®¡åˆ’
> - `å›¾ä¸–ç•Œèƒ½åŠ›çŸ©é˜µP1-P8è§£å†³æ–¹æ¡ˆ.md` â€” P1-P8 éƒ¨åˆ†å®ç°é¡¹é€é¡¹æ–¹æ¡ˆ
> - `å›¾ä¸–ç•Œèƒ½åŠ›çŸ©é˜µU1-U24è§£å†³æ–¹æ¡ˆ.md` â€” U1-U24 æœªå®ç°é¡¹é€é¡¹æ–¹æ¡ˆï¼ˆå«ä¸‰æ¡è®¾è®¡åŸåˆ™ï¼‰
>
> **å®æ–½è¿›åº¦ï¼ˆ2026-02-18ï¼‰**:
> - E1 (EventStage) âœ… + E2 (EventOutcome) âœ… + E3 (pending_flash) âœ… + E4 (activation_type + å¤±è´¥æœºåˆ¶) âœ… + E5.1 (Player) âœ… + E5.2 (ON_STATE_CHANGE) âœ…
> - P1-P12 å…¨éƒ¨å®Œæˆ âœ…ï¼ˆå«æ¸…ç†ï¼šP9/P11/U17/U18/U20/U23ï¼‰
> - **å¼•æ“ä¾§å…¨éƒ¨å®Œæˆ**ã€‚å‰©ä½™ï¼šç¬¬å››æ­¥ç®¡çº¿å‡çº§ï¼ˆP1+P2+P3 ä¸–ç•Œä¹¦é‡æå–ï¼‰+ æ–°åŠŸèƒ½ï¼ˆU13/U14/U16ï¼‰
>
> æœ¬æ–‡ä»¶çš„ Sprint è®¡åˆ’å·²è¢«èƒ½åŠ›çŸ©é˜µä¸­çš„"æ‰§è¡Œè®¡åˆ’"ç« èŠ‚å–ä»£ï¼Œä»¥ä¸¤ä»½è§£å†³æ–¹æ¡ˆæ–‡æ¡£ä¸ºå‡†ã€‚

---

## ä¸€ã€å½“å‰æ€åŠ¿

### 1.1 ä¸‰æ–¹å·®è·æ€»è§ˆ

ç»è¿‡å¯¹è®¾è®¡æ–‡æ¡£ã€å¼•æ“ä»£ç ã€æå–ç®¡çº¿ã€åŸå§‹ä¸–ç•Œä¹¦çš„å…¨é¢ä¾¦å¯Ÿï¼Œå‘ç°ä¸‰ä¸ªå±‚é¢å­˜åœ¨æ˜¾è‘—å·®è·ï¼š

```
è®¾è®¡è§„æ ¼ï¼ˆä¸–ç•Œå›¾æ•°æ®æ¨¡å‹è®¾è®¡.mdï¼‰
  â”œâ”€ event_def: 20+ å­—æ®µï¼Œå« stages/outcomes/activation_type/visibility/...
  â”œâ”€ äº‹ä»¶ç”Ÿå‘½å‘¨æœŸ: 6 æ€ + 4 ç§æ¿€æ´» + å¤šé˜¶æ®µ + åˆ†æ”¯ç»“å±€ + å¤±è´¥æœºåˆ¶
  â””â”€ å¯¼èˆª: å¿«é€Ÿæ—…è¡Œ/è¥åœ°/åœ°ç‰¢è¿æ¥/é­é‡æ£€å®š

å¼•æ“å®ç°ï¼ˆapp/world/ï¼‰
  â”œâ”€ âœ… åŸºç¡€äº‹ä»¶é—­ç¯: trigger_conditions â†’ unlock â†’ complete â†’ å‰¯ä½œç”¨
  â”œâ”€ âœ… æ¡ä»¶ç³»ç»Ÿ: 9 ç§ç±»å‹å®Œæ•´
  â”œâ”€ âŒ stages: æ¨¡å‹å­˜åœ¨ï¼Œé›¶æ¥å…¥
  â”œâ”€ âŒ outcomes: æ¨¡å‹å­˜åœ¨ï¼Œé›¶æ¥å…¥
  â”œâ”€ âŒ activation_type: æ—  ON_ENTER/discovery è¡Œä¸ºç”Ÿæˆ
  â”œâ”€ âŒ pending_flash: äº§å‡ºä½†æœªæ³¨å…¥ agentic æµ
  â”œâ”€ âœ… player å…¥å›¾: PlayerNodeView + å¿«ç…§æŒä¹…åŒ– + æˆ˜æ–—åŒæ­¥ï¼ˆU2 å·²å®Œæˆï¼‰
  â””â”€ âŒ item å®ä½“: æœªå»ºå›¾ï¼ˆU3 å»¶åï¼‰

ç®¡çº¿è¾“å‡ºï¼ˆchapters_v2.jsonï¼‰
  â”œâ”€ âœ… trigger_conditions: 322/323
  â”œâ”€ âŒ completion_conditions: 0/323
  â”œâ”€ âŒ on_complete: 0/323
  â”œâ”€ âŒ stages/outcomes/activation_type/...: å…¨éƒ¨ä¸ºé›¶
  â””â”€ âš ï¸ æºæ•°æ®åˆ©ç”¨ç‡: åŸå§‹ lorebook 76 ä¸‡å­—è¢«å‹ç¼©åˆ° 3000 å­—ç¬¦/ç« 
```

### 1.2 æ ¸å¿ƒåˆ¤æ–­

**å¼•æ“ä¼˜å…ˆï¼Œç®¡çº¿è·Ÿè¿›ã€‚** ç†ç”±ï¼š

1. ç®¡çº¿æ˜¯å¼•æ“çš„æ•°æ®ä¾›ç»™æ–¹â€”â€”å¼•æ“æ¶ˆè´¹è§„æ ¼æœªç¡®å®šï¼Œç®¡çº¿æå–çš„æ•°æ®æ ¼å¼å¯èƒ½å¯¹ä¸ä¸Š
2. å¼•æ“çš„ `completion_conditions` å’Œ `on_complete` å·²ç»å®Œæ•´æ”¯æŒâ€”â€”è¿™éƒ¨åˆ†å¯ä»¥è·³è¿‡å¼•æ“ç›´æ¥è¡¥æ•°æ®
3. `stages/outcomes` éœ€è¦å¼•æ“å…ˆå®ç°æ¶ˆè´¹é€»è¾‘ï¼Œæ•°æ®æ‰æœ‰æ„ä¹‰
4. `pending_flash` é—­ç¯æ˜¯è¯­ä¹‰æ¡ä»¶çš„åŸºç¡€ï¼Œå†³å®šäº† `flash_evaluate` åœ¨ `completion_conditions` ä¸­çš„å¯ç”¨æ€§

### 1.3 åŸå§‹ä¸–ç•Œä¹¦è¯„ä¼°

| ä¿¡æ¯æº | æ¡ç›®æ•° | æ€»å­—æ•° | ç®¡çº¿åˆ©ç”¨ç‡ |
|-------|--------|--------|-----------|
| åŸå§‹ lorebookï¼ˆ`__å“¥å¸ƒæ—æ€æ‰‹ 9.30å®¶äº§ä¼˜åŒ–.json`ï¼‰ | 415 | 76 ä¸‡å­— | çº¦ 10% |
| å…¶ä¸­å‰§æƒ…ç« èŠ‚ | 86 | 22 ä¸‡å­— | **æˆªæ–­åˆ° 3000 å­—/ç« ** |
| å…¶ä¸­ç³»ç»Ÿè§„åˆ™ | 58 | â€” | æœªåˆ©ç”¨ |
| å…¶ä¸­è§’è‰²å¡ | 67 | â€” | éƒ¨åˆ†æå– |

æ¯ä¸ªç« èŠ‚æ¡ç›®åŒ…å«ç»“æ„åŒ–çš„äº‹ä»¶æ¨¡æ¿ï¼ˆäº‹ä»¶åˆ—è¡¨ã€äº‹ä»¶ç›®æ ‡ã€ç©å®¶é€‰æ‹© A/B/Cã€NPC ååº”ã€ç³»ç»Ÿå¼•å¯¼ï¼‰ï¼Œ**è¶³ä»¥æ¨å¯¼ completion_conditionsã€on_completeã€activation_typeã€ç”šè‡³ outcomes**ã€‚

---

## äºŒã€å¼•æ“å®Œå–„è·¯çº¿å›¾

### Phase E1: EventStage ä¸»æµç¨‹åŒ– âœ… å·²å®Œæˆ

> ä¾èµ–: æ— 
> å½±å“: æ”¯æŒå¤šé˜¶æ®µä»»åŠ¡ï¼ˆæ½œå…¥â†’æˆ˜æ–—â†’æ’¤ç¦»ã€æ”¶é›†çº¿ç´¢â†’æ¨ç†â†’å¯¹å³™ï¼‰
> **çŠ¶æ€**: 2026-02-17 å®Œæˆã€‚å®æ–½è®°å½•è§ `~/.claude/plans/flickering-sauteeing-galaxy.md`ã€‚è¦†ç›– U4/U6/U11/U21/U22/P10/U24ï¼Œ29 ä¸ªæ–°æµ‹è¯•ã€‚

#### E1.1 graph_builder å¢å¼º

**æ–‡ä»¶**: `app/world/graph_builder.py` â€” `_event_to_behaviors()`

å½“å‰åªç”Ÿæˆ 2 ä¸ª Behaviorï¼ˆunlock + completeï¼‰ï¼Œéœ€è¦ä¸ºæœ‰ stages çš„äº‹ä»¶é¢å¤–ç”Ÿæˆï¼š

```python
# ä¼ªä»£ç : ä¸ºæ¯ä¸ª stage è½¬æ¢ç”Ÿæˆ Behavior
if event_data.stages:
    for i, stage in enumerate(event_data.stages):
        if stage.completion_conditions:
            next_stage_id = event_data.stages[i + 1].id if i + 1 < len(stages) else None

            behaviors.append(Behavior(
                id=f"bh_stage_{event_node_id}_{stage.id}",
                trigger=TriggerType.ON_TICK,
                conditions=ConditionGroup(
                    operator="and",
                    conditions=[
                        # äº‹ä»¶å¿…é¡»æ˜¯ active ä¸”å½“å‰é˜¶æ®µåŒ¹é…
                        Condition(type="game_state", params={"state": f"stage:{stage.id}"}),
                        # + stage è‡ªèº«çš„å®Œæˆæ¡ä»¶
                        *stage.completion_conditions.conditions
                    ]
                ),
                actions=[
                    # æ¨è¿›åˆ°ä¸‹ä¸€é˜¶æ®µ æˆ– å®Œæˆäº‹ä»¶
                    Action(type=ActionType.CHANGE_STATE, target="self",
                           params={"updates": {
                               "current_stage": next_stage_id or "__completed__",
                               f"stage_progress.{stage.id}": True
                           }}),
                    # å¦‚æœæ˜¯æœ€åä¸€ä¸ª stageï¼Œè§¦å‘äº‹ä»¶å®Œæˆ
                    *([] if next_stage_id else complete_actions),
                ],
                once=True,
                priority=6,  # ç•¥ä½äº complete behavior
            ))

    # æœ‰ stages æ—¶ï¼Œäº‹ä»¶æ¿€æ´»æ—¶è®¾ç½®åˆå§‹ stage
    # åœ¨ unlock behavior çš„ actions ä¸­åŠ å…¥ current_stage åˆå§‹åŒ–
```

**å…³é”®è®¾è®¡å†³ç­–**:

- stage æ¨è¿›ç”± Behavior è‡ªåŠ¨é©±åŠ¨ï¼ˆcompletion_conditions æ»¡è¶³æ—¶ï¼‰
- æ—  completion_conditions çš„ stage ç”± LLM å·¥å…·æ‰‹åŠ¨æ¨è¿›
- æœ‰ stages æ—¶ï¼Œäº‹ä»¶è‡ªèº«çš„ completion_conditions è¢«å¿½ç•¥ï¼ˆæœ€åä¸€ä¸ª stage æ§åˆ¶ï¼‰
- stage çŠ¶æ€å­˜å‚¨åœ¨ `event_def.state.current_stage` å’Œ `event_def.state.stage_progress`

#### E1.2 v4_agentic_tools å¢å¼º

**æ–‡ä»¶**: `app/services/admin/v4_agentic_tools.py`

æ–°å¢å·¥å…·:

```python
async def advance_stage(self, event_id: str, stage_id: str = None) -> Dict:
    """
    æ‰‹åŠ¨æ¨è¿›äº‹ä»¶é˜¶æ®µã€‚
    - æ—  stage_id: æ¨è¿›åˆ°ä¸‹ä¸€ä¸ªé˜¶æ®µ
    - æœ‰ stage_id: è·³è½¬åˆ°æŒ‡å®šé˜¶æ®µï¼ˆéœ€éªŒè¯é¡ºåºï¼‰

    æ ¡éªŒ:
    1. äº‹ä»¶å¿…é¡» status=active
    2. å¦‚æœå½“å‰ stage æœ‰ required objectives æœªå®Œæˆï¼Œæ‹’ç»æ¨è¿›
    """

async def complete_objective(self, event_id: str, objective_id: str) -> Dict:
    """
    æ ‡è®°äº‹ä»¶ç›®æ ‡å®Œæˆã€‚
    - æ›´æ–° event_def.state.objective_progress[objective_id] = True
    - è§¦å‘ post-tick æ£€æŸ¥ï¼ˆobjective å®Œæˆå¯èƒ½æ»¡è¶³ stage.completion_conditionsï¼‰
    """
```

ä¿®æ”¹ç°æœ‰å·¥å…·:

```python
async def complete_event(self, event_id: str, outcome: str = None) -> Dict:
    """
    æ‰©å±•: å¢åŠ  outcome å‚æ•°ã€‚
    - æ—  outcome: ä½¿ç”¨é»˜è®¤å®Œæˆé€»è¾‘ï¼ˆç°æœ‰è¡Œä¸ºï¼‰
    - æœ‰ outcome: éªŒè¯ outcome.conditions â†’ åº”ç”¨ outcome ç‰¹å®šå¥–åŠ±
    """
```

#### E1.3 ä¸Šä¸‹æ–‡è¾“å‡ºå¢å¼º

**æ–‡ä»¶**: `app/runtime/area_runtime.py` æˆ– `session_runtime.py`

äº‹ä»¶æ‘˜è¦ä¸­åŠ å…¥ stage ä¿¡æ¯:

```python
# äº‹ä»¶ä¸Šä¸‹æ–‡ï¼ˆç»™ LLM çœ‹çš„ï¼‰
{
    "event_id": "ch_1_2_event_3",
    "status": "active",
    "current_stage": {
        "id": "stage_2",
        "name": "è¿½è¸ªå«Œç–‘äºº",
        "narrative_directive": "çº¿ç´¢æŒ‡å‘æ£®æ—æ·±å¤„...",
        "objectives": [
            {"id": "obj_1", "text": "åˆ°è¾¾è½»è¯­æ£®æ—", "completed": False},
            {"id": "obj_2", "text": "æ‰¾åˆ°éšè—çº¿ç´¢", "completed": True}
        ]
    },
    "stage_progress": {"stage_1": True, "stage_2": False}
}
```

#### E1.4 æµ‹è¯•

```
tests/test_c9_stages.py:
  - test_stage_progression_auto      # completion_conditions æ»¡è¶³è‡ªåŠ¨æ¨è¿›
  - test_stage_progression_manual    # LLM å·¥å…·æ‰‹åŠ¨æ¨è¿›
  - test_stage_objectives_tracking   # objective å®Œæˆè¿½è¸ª
  - test_last_stage_completes_event  # æœ€åé˜¶æ®µå®Œæˆ = äº‹ä»¶å®Œæˆ
  - test_stage_with_no_conditions    # æ— æ¡ä»¶é˜¶æ®µéœ€æ‰‹åŠ¨æ¨è¿›
```

---

### Phase E2: EventOutcome ä¸»æµç¨‹åŒ– âœ… å·²å®Œæˆ

> ä¾èµ–: E1ï¼ˆstage å®Œæˆåæ‰è¯„ä¼° outcomeï¼‰
> å½±å“: æ”¯æŒåˆ†æ”¯ç»“å±€ï¼ˆé“å¾·é€‰æ‹©ã€æˆ˜æ–—ç»“æœã€å¤–äº¤è°ˆåˆ¤ï¼‰
> **çŠ¶æ€**: 2026-02-17 ä¸ E1 åŒæ‰¹å®Œæˆã€‚è¦†ç›– U5ï¼ŒCodex å®¡æŸ¥åä¿®å¤ 5 é¡¹é—®é¢˜ã€‚

#### E2.1 graph_builder å¢å¼º

```python
# ä¼ªä»£ç : ä¸ºå®¢è§‚æ¡ä»¶ outcome ç”Ÿæˆ Behavior
if event_data.outcomes:
    for outcome in event_data.outcomes:
        if outcome.conditions:  # æœ‰æ¡ä»¶çš„ outcome â†’ Behavior è‡ªåŠ¨åˆ¤å®š
            behaviors.append(Behavior(
                id=f"bh_outcome_{event_node_id}_{outcome.id}",
                trigger=TriggerType.ON_TICK,
                conditions=ConditionGroup(
                    operator="and",
                    conditions=[
                        # äº‹ä»¶å¿…é¡»æ˜¯ active æˆ–åˆš completed
                        Condition(type="game_state", params={"state": "event_completing"}),
                        *outcome.conditions.conditions
                    ]
                ),
                actions=[
                    Action(type=ActionType.CHANGE_STATE, target="self",
                           params={"updates": {"outcome": outcome.id}}),
                    # outcome ç‰¹å®šå¥–åŠ±
                    *_outcome_reward_actions(outcome),
                ],
                once=True,
                priority=4,
            ))
```

**æ··åˆåˆ¶**:
- å®¢è§‚æ¡ä»¶ outcomeï¼ˆå¦‚"å…¨å‘˜å­˜æ´»"ï¼‰â†’ Behavior è‡ªåŠ¨åˆ¤å®š
- ç©å®¶é€‰æ‹© outcomeï¼ˆå¦‚"æ€æ­» vs æ”¾èµ°"ï¼‰â†’ LLM è°ƒç”¨ `complete_event(event_id, outcome="mercy")`
- `conditions=null` çš„ outcome ä½œä¸º fallback

#### E2.2 outcome å¥–åŠ±åº”ç”¨

**æ–‡ä»¶**: `app/runtime/session_runtime.py` â€” `_apply_tick_side_effects()`

æ–°å¢äº‹ä»¶ç±»å‹å¤„ç†:

```python
# å·²æœ‰:
# - "xp_awarded" â†’ player.xp += amount
# - "item_granted" â†’ player.inventory.append(item)

# æ–°å¢:
elif event.event_type == "reputation_changed":
    faction = event.data.get("faction")
    delta = event.data.get("delta", 0)
    world_root = self.world_graph.get_node("world_root")
    reps = world_root.state.setdefault("faction_reputations", {})
    reps[faction] = reps.get(faction, 0) + delta

elif event.event_type == "world_flag_set":
    key = event.data.get("key")
    value = event.data.get("value")
    world_root = self.world_graph.get_node("world_root")
    flags = world_root.state.setdefault("world_flags", {})
    flags[key] = value

elif event.event_type == "gold_awarded":
    amount = event.data.get("amount", 0)
    world_root = self.world_graph.get_node("world_root")
    world_root.state["party_gold"] = world_root.state.get("party_gold", 0) + amount
```

#### E2.3 outcome éªŒè¯

```python
# v4_agentic_tools.py â€” complete_event() æ‰©å±•
async def complete_event(self, event_id: str, outcome_key: str = None) -> Dict:
    # ...existing logic...

    if outcome_key:
        # æŸ¥æ‰¾ outcome å®šä¹‰
        outcomes = node.properties.get("outcomes", {})
        outcome = outcomes.get(outcome_key)
        if not outcome:
            return {"error": f"Unknown outcome: {outcome_key}"}

        # éªŒè¯æ¡ä»¶
        if outcome.get("conditions"):
            eval_result = self._evaluator.evaluate(
                ConditionGroup(**outcome["conditions"]), ctx
            )
            if not eval_result.satisfied:
                return {"error": f"Outcome conditions not met for: {outcome_key}"}

        # åº”ç”¨ outcome ç‰¹å®šå¥–åŠ±
        self._apply_outcome_rewards(outcome, event_id, node)

    # ...rest of existing logic...
```

---

### Phase E3: pending_flash é—­ç¯ âœ… å·²å®Œæˆ

> ä¾èµ–: æ— ï¼ˆå¯ä¸ E1/E2 å¹¶è¡Œï¼‰
> å½±å“: ä½¿ `flash_evaluate` æ¡ä»¶ç±»å‹åœ¨ä¸»æµç¨‹ä¸­çœŸæ­£å¯ç”¨
> **çŠ¶æ€**: 2026-02-18 å®Œæˆã€‚U7+U12ï¼Œå½“è½®é—­ç¯ï¼ˆpre-tick æŒ‚èµ· â†’ LLM è¯„ä¼° â†’ post-tick é‡åˆ¤ï¼‰ã€‚

#### E3.1 ä¸Šä¸‹æ–‡æ³¨å…¥

**æ–‡ä»¶**: `app/services/admin/pipeline_orchestrator.py` â€” A4/C1 é˜¶æ®µ

```python
# A4: pre-tick å
tick_result = await session.run_behavior_tick("pre")

if tick_result.pending_flash:
    # å°†å¾…è¯„ä¼°çš„è¯­ä¹‰æ¡ä»¶æ³¨å…¥ agentic ä¸Šä¸‹æ–‡
    context.pending_flash_conditions = [
        {
            "behavior_id": pf.behavior_id,
            "prompt": pf.params.get("prompt"),
            "context": pf.params.get("context", ""),
        }
        for pf in tick_result.pending_flash
    ]
```

**æ–‡ä»¶**: `app/runtime/context_assembler.py`

```python
# åœ¨ area_context ä¸­åŠ å…¥ pending_flash
if pending_flash_conditions:
    area_context["pending_evaluations"] = [
        f"[éœ€è¦åˆ¤æ–­] {pf['prompt']}"
        for pf in pending_flash_conditions
    ]
```

#### E3.2 å·¥å…·å›æŠ¥

**æ–‡ä»¶**: `app/services/admin/v4_agentic_tools.py`

```python
async def report_flash_evaluation(
    self, condition_prompt: str, result: bool, reasoning: str = ""
) -> Dict:
    """
    LLM å›æŠ¥è¯­ä¹‰æ¡ä»¶è¯„ä¼°ç»“æœã€‚
    - å°†ç»“æœå†™å…¥ session çš„ flash_results ç¼“å­˜
    - post-tick æ—¶ BehaviorEngine ä½¿ç”¨è¿™äº›ç»“æœé‡æ–°è¯„ä¼°
    """
```

#### E3.3 post-tick é‡è¯„ä¼°

```python
# C1: post-tick æ—¶
# å¦‚æœæœ‰ flash è¯„ä¼°ç»“æœï¼Œé‡æ–°è¿è¡Œç›¸å…³ behaviors
if session.flash_results:
    tick_ctx.flash_results = session.flash_results
    tick_result_post = await session.run_behavior_tick("post")
    session.flash_results.clear()
```

---

### Phase E4: æ¿€æ´»æ–¹å¼ + å¤±è´¥æœºåˆ¶ âœ… å·²å®Œæˆ

> ä¾èµ–: E1ï¼ˆstage æ¨è¿›ï¼‰
> å½±å“: ä¸°å¯Œäº‹ä»¶è§¦å‘å’Œç»ˆæ­¢æ–¹å¼
> **çŠ¶æ€**: 2026-02-18 å®Œæˆã€‚U8 activation_type 4 ç§è¡Œä¸ºç”Ÿæˆ + U9 è¶…æ—¶/å†·å´ï¼ˆEVENT_ROUNDS_ELAPSED + reset_behaviorsï¼‰+ U10 fail_event å·¥å…·ã€‚

#### E4.1 activation_type behaviors

**æ–‡ä»¶**: `app/world/graph_builder.py`

```python
# _event_to_behaviors() æ‰©å±•

activation_type = event_data.properties.get("activation_type", "event_driven")

if activation_type == "auto_enter":
    # è¿›å…¥åŒºåŸŸè‡ªåŠ¨æ¿€æ´»
    behaviors.append(Behavior(
        id=f"bh_autoenter_{event_node_id}",
        trigger=TriggerType.ON_ENTER,
        conditions=ConditionGroup(operator="and", conditions=[
            Condition(type="game_state",
                      params={"state": f"event_status:{EventStatus.AVAILABLE}"})
        ]),
        actions=[
            Action(type=ActionType.CHANGE_STATE, target="self",
                   params={"updates": {"status": EventStatus.ACTIVE}})
        ],
        once=True,
        priority=8,
    ))

elif activation_type == "discovery":
    # å‘ç°å‹: éœ€è¦æ„ŸçŸ¥æ£€å®š
    check = event_data.properties.get("discovery_check", {"skill": "perception", "dc": 15})
    behaviors.append(Behavior(
        id=f"bh_discover_{event_node_id}",
        trigger=TriggerType.ON_ENTER,
        conditions=None,  # è¿›å…¥å°±è§¦å‘æ£€å®šæç¤º
        actions=[
            Action(type=ActionType.NARRATIVE_HINT, target="self",
                   params={"text": f"[æ„ŸçŸ¥æ£€å®š DC {check['dc']}] é™„è¿‘ä¼¼ä¹æœ‰ä»€ä¹ˆéšè—çš„ä¸œè¥¿..."})
        ],
        once=True,
    ))
```

#### E4.2 failure behaviors

```python
# è¶…æ—¶å¤±è´¥
time_limit = event_data.properties.get("time_limit")
if time_limit:
    behaviors.append(Behavior(
        id=f"bh_timeout_{event_node_id}",
        trigger=TriggerType.ON_TICK,
        conditions=ConditionGroup(operator="and", conditions=[
            Condition(type="rounds_elapsed", params={"min_rounds": time_limit})
        ]),
        actions=[
            Action(type=ActionType.CHANGE_STATE, target="self",
                   params={"updates": {"status": EventStatus.FAILED, "outcome": "timeout"}})
        ],
        once=True,
        priority=3,
    ))
```

#### E4.3 fail_event å·¥å…·

```python
async def fail_event(self, event_id: str, reason: str = "") -> Dict:
    """
    LLM æ‰‹åŠ¨æ ‡è®°äº‹ä»¶å¤±è´¥ã€‚
    - è®¾ç½® status=FAILED, outcome="failure"
    - åº”ç”¨å¤±è´¥åæœï¼ˆå¦‚æœ outcomes ä¸­æœ‰ failure outcomeï¼‰
    - çº§è”é€šçŸ¥
    """
```

---

### Phase E5: å®ä½“è¡¥å…¨ âœ… å·²å®Œæˆ

> ä¾èµ–: æ— ï¼ˆå¯ç‹¬ç«‹è¿›è¡Œï¼‰
> å½±å“: ç»Ÿä¸€çŠ¶æ€ç®¡ç†ï¼Œå‡å°‘æ—è·¯
> **çŠ¶æ€**: 2026-02-18 å…¨éƒ¨å®Œæˆã€‚E5.1 Player å…¥å›¾ + E5.2 ON_STATE_CHANGEã€‚

#### E5.1 Player èŠ‚ç‚¹å»ºå›¾ âœ… å·²å®Œæˆï¼ˆU2 ä¸“é¡¹ï¼‰

**æ–‡ä»¶**: `app/world/graph_builder.py` â€” Step 6 æ‰©å±•

```python
# Step 6b: Player èŠ‚ç‚¹
player_node = WorldNode(
    id="player",
    type=WorldNodeType.PLAYER,
    name=session.player.name or "å†’é™©è€…",
    properties={},
    state=default_player_state(),  # ä» session.player åˆå§‹åŒ–
)
wg.add_node(player_node)
wg.add_edge("player", "camp", "member_of", role="leader")

# è®¾ç½®å½“å‰ä½ç½®
if session.state.current_area:
    current_loc = _resolve_location(session)
    if current_loc:
        wg.add_edge(current_loc, "player", "hosts", role="visitor")
```

#### E5.2 ON_STATE_CHANGE è§¦å‘å™¨

**æ–‡ä»¶**: `app/world/world_graph.py`

```python
def merge_state(self, node_id: str, updates: Dict[str, Any]) -> None:
    # ...existing merge logic...

    # è®°å½•å˜æ›´çš„ key
    changed_keys = set(updates.keys())
    self._state_changes_this_tick.setdefault(node_id, set()).update(changed_keys)
```

**æ–‡ä»¶**: `app/world/behavior_engine.py` â€” tick() æ‰©å±•

```python
# åœ¨ ON_TICK behaviors ä¹‹åï¼Œæ£€æŸ¥ ON_STATE_CHANGE
for node_id, changed_keys in wg._state_changes_this_tick.items():
    node = wg.get_node(node_id)
    for bh in node.get_active_behaviors(TriggerType.ON_STATE_CHANGE):
        if bh.watch_key and bh.watch_key in changed_keys:
            # è¯„ä¼°æ¡ä»¶ + æ‰§è¡Œ
            ...
wg._state_changes_this_tick.clear()
```

---

## ä¸‰ã€ç®¡çº¿å‡çº§è·¯çº¿å›¾

> å‰ç½®: Phase E1 + E2 å®Œæˆï¼ˆå¼•æ“èƒ½æ¶ˆè´¹æ–°å­—æ®µï¼‰

### Phase P1: ä¸Šä¸‹æ–‡å¢å¼º

> ç›®æ ‡: è®© Phase 3 LLM çœ‹åˆ°åŸå§‹ lorebook çš„å®Œæ•´å™äº‹å†…å®¹

#### P1.1 lorebook æ¡ç›®ç´¢å¼•

**æ–‡ä»¶**: `app/tools/worldbook_graphizer/unified_pipeline.py`

```python
def _build_chapter_content_index(self, entries_path: Path) -> Dict[str, str]:
    """
    ä»åŸå§‹ lorebook æ„å»ºç« èŠ‚ â†’ å®Œæ•´å†…å®¹çš„ç´¢å¼•ã€‚

    entry_type ç¤ºä¾‹: "ç¬¬å››å·:ç¬¬ä¸€ç« :æ–°æ‰‹æˆ˜å£«ä¸è§ä¹ åœ£å¥³çš„æ•…äº‹"
    è¿”å›: {"vol_4_ch_1": "å®Œæ•´çš„ 2000-4000 å­—å†…å®¹", ...}
    """
    index = {}
    for entry in load_entries(entries_path):
        if _is_chapter_entry(entry):
            ch_key = _parse_chapter_key(entry["entry_type"])
            index[ch_key] = entry["content"]
    return index
```

#### P1.2 Phase 3 prompt ç»„è£…ä¿®æ”¹

```python
# æ›¿æ¢åŸæ¥çš„æˆªæ–­æè¿°
chapter_description = ch.get("description", "")[:3000]  # â† æ—§

# æ–°: ä¼˜å…ˆä½¿ç”¨åŸå§‹ lorebook å†…å®¹
lorebook_content = chapter_content_index.get(ch_id, "")
chapter_description = lorebook_content if lorebook_content else ch.get("description", "")
# ä¸æˆªæ–­! Gemini æ”¯æŒé•¿ä¸Šä¸‹æ–‡
```

#### P1.3 æ–°å¢ä¸Šä¸‹æ–‡å˜é‡

```python
# ä¼ ç»™ LLM çš„é¢å¤–ä¸Šä¸‹æ–‡
prompt = prompt_template.format(
    chapter_id=ch_id,
    chapter_name=ch.get("name", ""),
    chapter_description=chapter_description,  # â† å®Œæ•´ lorebook å†…å®¹
    known_maps=known_maps,
    known_npcs=known_npcs,
    known_items=known_items,                   # â† æ–°å¢: ç‰©å“ ID åˆ—è¡¨
    previous_events=previous_events,
    xp_reference=XP_REFERENCE_TABLE,           # â† æ–°å¢: XP å‚è€ƒå€¼è¡¨
    condition_types=CONDITION_TYPES_REFERENCE,  # â† æ–°å¢: æ¡ä»¶ç±»å‹å‚è€ƒ
)
```

### Phase P2: Schema æ‰©å±•

> ç›®æ ‡: è®© LLM æå–æ‰€æœ‰å¼•æ“å¯æ¶ˆè´¹çš„å­—æ®µ

#### P2.1 chapter_orchestration.md æ”¹é€ 

æ‰©å±• JSON schemaï¼Œæ–°å¢å­—æ®µ:

```jsonc
{
  "events": [
    {
      // === å·²æœ‰å­—æ®µ ===
      "id": "{chapter_id}_event_1",
      "name": "äº‹ä»¶åç§°",
      "description": "äº‹ä»¶æè¿°",
      "is_required": true,
      "trigger_conditions": { ... },
      "narrative_directive": "...",

      // === æ–°å¢å­—æ®µ ===

      // äº‹ä»¶é‡è¦æ€§
      "importance": "main",           // main / side / personal / flavor

      // æ¿€æ´»æ–¹å¼
      "activation_type": "event_driven",  // npc_given / auto_enter / event_driven / discovery

      // ä»»åŠ¡å‘èµ· NPCï¼ˆä»… npc_given æ—¶ï¼‰
      "quest_giver": null,            // NPC ID æˆ– null

      // å®Œæˆæ¡ä»¶ï¼ˆæ»¡è¶³åå¼•æ“è‡ªåŠ¨æ ‡è®°å®Œæˆï¼Œnull = LLM æ‰‹åŠ¨å®Œæˆï¼‰
      "completion_conditions": null,   // ConditionGroup æˆ– null

      // å®Œæˆåæ•ˆæœ
      "on_complete": {
        "add_xp": 100,                // ç»éªŒå¥–åŠ±
        "add_items": [],              // ç‰©å“å¥–åŠ± [{item_id, name, quantity}]
        "narrative_hint": ""          // å®Œæˆåçš„è¿‡æ¸¡å™è¿°æŒ‡å¼•
        // unlock_events ç”±åå¤„ç†è„šæœ¬è‡ªåŠ¨æ¨å¯¼ï¼Œä¸éœ€è¦ LLM æå–
      },

      // å›åˆé™åˆ¶ï¼ˆå¯é€‰ï¼Œnull = æ— é™åˆ¶ï¼‰
      "time_limit": null,

      // å¤šé˜¶æ®µï¼ˆå¯é€‰ï¼Œä»…å¤æ‚äº‹ä»¶éœ€è¦ï¼‰
      "stages": [],

      // åˆ†æ”¯ç»“å±€ï¼ˆå¯é€‰ï¼Œä»…æœ‰é€‰æ‹©ç‚¹çš„äº‹ä»¶éœ€è¦ï¼‰
      "outcomes": []
    }
  ]
}
```

#### P2.2 æå–æŒ‡å¯¼å¼ºåŒ–

åœ¨ prompt ä¸­å¢åŠ å­—æ®µæå–åŸåˆ™:

```markdown
## æ–°å¢å­—æ®µæå–åŸåˆ™

### completion_conditions
- å¦‚æœåŸæ–‡ä¸­æœ‰æ˜ç¡®çš„å®Œæˆæ ‡å¿—ï¼ˆå¦‚"å‡»è´¥é¦–é¢†"ã€"åˆ°è¾¾æŸåœ°"ã€"ä¸ NPC å¯¹è¯"ï¼‰ï¼Œ
  æå–ä¸ºç»“æ„åŒ–æ¡ä»¶
- å¦‚æœå®Œæˆæ ‡å¿—æ˜¯ä¸»è§‚çš„ï¼ˆå¦‚"è¯´æœæ‘é•¿"ã€"èµ¢å¾—ä¿¡ä»»"ï¼‰ï¼Œä½¿ç”¨ flash_evaluate æ¡ä»¶
- å¦‚æœå®Œæˆæ ‡å¿—ä¸æ˜ç¡®ï¼Œè®¾ä¸º nullï¼ˆç•™ç»™ LLM è¿è¡Œæ—¶åˆ¤æ–­ï¼‰

### on_complete.add_xp å‚è€ƒå€¼
- ç« èŠ‚å¼€å¯/è¿‡æ¸¡: 50-100
- ä¸»çº¿è°ƒæŸ¥/å¯¹è¯: 100-200
- ä¸»çº¿æ¨è¿›: 200-400
- ç« èŠ‚ç»ˆç»“: 400-800
- Boss æˆ˜: 500-1000
- æ”¯çº¿å°ä»»åŠ¡: 50-150

### activation_type åˆ¤æ–­è§„åˆ™
- åŸæ–‡ä¸­æœ‰"NPC å§”æ‰˜/äº¤ä»˜ä»»åŠ¡"â†’ npc_given
- åŸæ–‡ä¸­æœ‰"è¿›å…¥æŸåœ°æ—¶è§¦å‘"â†’ auto_enter
- å‰ç½®äº‹ä»¶å®Œæˆåè‡ªç„¶è§¦å‘ â†’ event_drivenï¼ˆæœ€å¸¸ç”¨ï¼‰
- éšè—/éœ€è¦æ¢ç´¢å‘ç° â†’ discovery

### stages ä½¿ç”¨åœºæ™¯
- ä»…ç”¨äºæ˜æ˜¾åˆ†ä¸ºå¤šä¸ªé˜¶æ®µçš„å¤æ‚äº‹ä»¶
- ç®€å•çš„å•æ­¥äº‹ä»¶ä¸è¦åŠ  stages
- æ¯ä¸ª stage åº”æœ‰ç‹¬ç«‹çš„ narrative_directive

### outcomes ä½¿ç”¨åœºæ™¯
- ä»…ç”¨äºæœ‰æ˜ç¡®é€‰æ‹©åˆ†æ”¯çš„äº‹ä»¶
- å¿…é¡»è‡³å°‘æœ‰ä¸€ä¸ª conditions=null çš„ fallback outcome
- æŒ‰è¯„ä¼°ä¼˜å…ˆçº§æ’åˆ—ï¼ˆæœ€å¥½çš„ç»“å±€åœ¨å‰ï¼‰
```

### Phase P3: åå¤„ç†

#### P3.1 unlock_events è‡ªåŠ¨æ¨å¯¼è„šæœ¬

```python
# scripts/derive_unlock_events.py

def derive_unlock_events(chapters_v2: List[Dict]) -> List[Dict]:
    """
    ä» trigger_conditions åå‘æ¨å¯¼ unlock_eventsã€‚

    é€»è¾‘:
    1. æ‰«ææ‰€æœ‰äº‹ä»¶çš„ trigger_conditions
    2. æå– type="event_triggered" çš„ event_id
    3. æ„å»ºåå‘æ˜ å°„: {è¢«ä¾èµ–äº‹ä»¶: [ä¾èµ–å®ƒçš„äº‹ä»¶]}
    4. å†™å…¥è¢«ä¾èµ–äº‹ä»¶çš„ on_complete.unlock_events
    """
```

#### P3.2 å¼•ç”¨å®Œæ•´æ€§æ ¡éªŒ

```python
def validate_references(chapters_v2, maps, characters, items):
    """
    æ ¡éªŒæ‰€æœ‰å¼•ç”¨çš„åˆæ³•æ€§:
    - trigger_conditions ä¸­çš„ area_id â†’ maps
    - trigger_conditions ä¸­çš„ npc_id â†’ characters
    - on_complete.add_items ä¸­çš„ item_id â†’ items
    - transition.target_chapter_id â†’ chapters
    """
```

---

## å››ã€å®æ–½ä¾èµ–å›¾

```
E3 (pending_flash) âœ… â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                                      â”‚
E1 (EventStage) âœ… â”€â”€â†’ E2 (EventOutcome) âœ… â”€â”€â†’ E4 (æ¿€æ´»/å¤±è´¥) âœ… â”€â”€â†’ P1+P2+P3 (ç®¡çº¿å‡çº§) ğŸ”²
                                                      â”‚
E5.1 (Player) âœ… â”€â”€â†’ E5.2 (ON_STATE_CHANGE) âœ… â”€â”€â”€â”€â”€â”€â”˜
                                                      â”‚
                                            world_state_update âœ… â”€â”€â†’ å¤šä¸»ä½“å™äº‹ T1-T4 ğŸ”²
```

**å¼•æ“ä¾§å…¨éƒ¨å®Œæˆ** (2026-02-18):
- ~~E1 (stages)~~ âœ… â€” U4/U6/U11/U21/U22/P10/U24
- ~~E2 (outcomes)~~ âœ… â€” U5 + Codex å®¡æŸ¥ä¿®å¤
- ~~E3 (pending_flash)~~ âœ… â€” U7/U12ï¼Œå½“è½®é—­ç¯
- ~~E4 (æ¿€æ´»/å¤±è´¥)~~ âœ… â€” U8/U9/U10ï¼Œactivation_type + è¶…æ—¶/å†·å´ + fail_event
- ~~E5.1 (Player)~~ âœ… â€” U2 ä¸“é¡¹
- ~~E5.2 (ON_STATE_CHANGE)~~ âœ… â€” merge_state diff â†’ behavior æ¶ˆè´¹
- ~~world_state_update~~ âœ… â€” _build_world_state_update + GameState.metadata æŒä¹…åŒ–

**å‰©ä½™**:
- ç®¡çº¿å‡çº§ P1+P2+P3ï¼ˆç« èŠ‚é‡æå–ï¼šv2 prompt å·²å°±ç»ªï¼Œå¾…å…¨é‡æ‰§è¡Œï¼‰
- å¤šä¸»ä½“å™äº‹ T1-T4ï¼ˆè®¾è®¡æ–‡æ¡£å·²å†™ï¼Œå¾…å®æ–½ï¼‰
- æ–°åŠŸèƒ½ç«‹é¡¹ U3/U13/U14/U16

---

## äº”ã€æ•°æ®æºåˆ°å¼•æ“çš„å®Œæ•´æ˜ å°„

### 5.1 åŸå§‹ lorebook â†’ ç®¡çº¿æå– â†’ å¼•æ“æ¶ˆè´¹

```
åŸå§‹ lorebook ç« èŠ‚æ¡ç›®
â”‚
â”œâ”€ "ä¸»è¦ç›®æ ‡"
â”‚   â†’ objectives (ç« èŠ‚çº§)
â”‚
â”œâ”€ "ç« èŠ‚äº‹ä»¶åˆ—è¡¨" (1.1, 1.2, 1.3...)
â”‚   â†’ events[].id, events[].name
â”‚
â”œâ”€ "ç« èŠ‚äº‹ä»¶ç›®æ ‡"
â”‚   â†’ completion_conditions (å¯èƒ½æ˜¯ location/npc_interacted/flash_evaluate)
â”‚
â”œâ”€ "ç³»ç»Ÿå¼•å¯¼" (é€‰æ‹© A/B/C)
â”‚   â†’ outcomes[] (æ¯ä¸ªé€‰æ‹© = ä¸€ä¸ª outcome)
â”‚   â†’ activation_type (å¦‚æœæè¿°äº†è§¦å‘æ–¹å¼)
â”‚
â”œâ”€ "ç¯å¢ƒæå†™" + "äººç‰©æå†™"
â”‚   â†’ narrative_directive (æ›´ä¸°å¯Œçš„å™äº‹æŒ‡å¼•)
â”‚
â”œâ”€ "é‡è¦è§„åˆ™"
â”‚   â†’ time_limit, is_repeatable
â”‚   â†’ completion_conditions ä¸­çš„ç‰¹æ®Šçº¦æŸ
â”‚
â””â”€ "äº’åŠ¨è§‚å¯Ÿ" (NPC ååº”)
    â†’ npc_interacted æ¡ä»¶
    â†’ quest_giver
```

### 5.2 ç®¡çº¿è¾“å‡º â†’ graph_builder â†’ BehaviorEngine

```
chapters_v2.json event
â”‚
â”œâ”€ trigger_conditions
â”‚   â†’ Unlock Behavior (ON_TICK, conditions, â†’ status=AVAILABLE)
â”‚
â”œâ”€ completion_conditions
â”‚   â†’ Complete Behavior (ON_TICK, conditions, â†’ status=COMPLETED + side effects)
â”‚
â”œâ”€ on_complete
â”‚   â”œâ”€ unlock_events â†’ EMIT_EVENT("event_unlocked")
â”‚   â”œâ”€ add_xp â†’ EMIT_EVENT("xp_awarded")
â”‚   â”œâ”€ add_items â†’ EMIT_EVENT("item_granted")
â”‚   â””â”€ narrative_hint â†’ (å·¥å…·å±‚æ˜¾ç¤º)
â”‚
â”œâ”€ stages[]
â”‚   â†’ Stage Transition Behaviors (ON_TICK, stage.completion_conditions)
â”‚   â†’ é˜¶æ®µç›®æ ‡è¿½è¸ª (state.objective_progress)
â”‚
â”œâ”€ outcomes{}
â”‚   â†’ Outcome Evaluation Behaviors (ON_TICK, outcome.conditions)
â”‚   â†’ Outcome Rewards (xp/gold/items/reputation/world_flags)
â”‚
â”œâ”€ activation_type
â”‚   â†’ auto_enter: ON_ENTER Behavior
â”‚   â†’ discovery: ON_ENTER + perception hint
â”‚   â†’ npc_given/event_driven: å·²æœ‰
â”‚
â””â”€ time_limit
    â†’ Timeout Behavior (ON_TICK, rounds_elapsed >= limit â†’ FAILED)
```

---

## å…­ã€èƒ½åŠ›çŸ©é˜µé¢„æœŸå˜åŒ–

å®Œæˆå…¨éƒ¨ Phase åï¼š

| èƒ½åŠ›é¡¹ | E1+E2 å‰ | E1+E2 å | E3 å | E4 å | **å½“å‰ï¼ˆæ¸…ç†åï¼‰** | P ç®¡çº¿å |
|-------|----------|----------|-------|-------|------------------|---------|
| stages ä¸»æµç¨‹ | âŒ | âœ… | âœ… | âœ… | **âœ…** | âœ… |
| outcomes ä¸»æµç¨‹ | âŒ | âœ… | âœ… | âœ… | **âœ…** | âœ… |
| Player å»ºå›¾ | âŒ | âœ… (E5.1) | âœ… | âœ… | **âœ…** | âœ… |
| pending_flash é—­ç¯ | âŒ | âŒ | âœ… | âœ… | **âœ…** | âœ… |
| ON_STATE_CHANGE | âŒ | âŒ | âœ… | âœ… | **âœ…** | âœ… |
| æ¿€æ´»æ–¹å¼å¤šæ ·åŒ– | âŒ | âŒ | âŒ | âœ… | **âœ…** | âœ… |
| å¤±è´¥/è¶…æ—¶/å†·å´æœºåˆ¶ | âŒ | âŒ | âŒ | âœ… | **âœ…** | âœ… |
| world_flags/å£°æœ›ä¸Šä¸‹æ–‡æ³¨å…¥ | âŒ | âŒ | âŒ | âŒ | **âœ…** | âœ… |
| completion_conditions æ•°æ® | 0% | 0% | 0% | 0% | **0%ï¼ˆå¼•æ“âœ…ï¼‰** | ~80% |
| on_complete æ•°æ® | 0% | 0% | 0% | 0% | **0%ï¼ˆå¼•æ“âœ…ï¼‰** | ~90% |
| stages æ•°æ® | 0% | 0% | 0% | 0% | **0%ï¼ˆå¼•æ“âœ…ï¼‰** | ~10% |
| outcomes æ•°æ® | 0% | 0% | 0% | 0% | **0%ï¼ˆå¼•æ“âœ…ï¼‰** | ~10% |

---

## ä¸ƒã€é£é™©ä¸æ³¨æ„äº‹é¡¹

1. **~~stage behavior æ¡ä»¶å†²çª~~**: âœ… å·²è§£å†³ã€‚æ¯ä¸ª stage behavior åŒ…å« `EVENT_STATE(current_stage == stage_id)` å®ˆå«ï¼Œåªæœ‰å½“å‰é˜¶æ®µçš„ behavior èƒ½è§¦å‘ã€‚`_wrap_with_guards()` è¾…åŠ©å‡½æ•°ç¡®ä¿åŸå§‹æ¡ä»¶ç»„çš„ or/not è¯­ä¹‰ä¸è¢«å±•å¹³ã€‚

2. **~~outcome è¯„ä¼°æ—¶æœº~~**: âœ… å·²è§£å†³ã€‚outcome behavior çš„æ¡ä»¶åŒ…å« `EVENT_STATE(status == COMPLETED) AND EVENT_STATE(outcome == None)`ï¼Œé…åˆ `once=True`ï¼Œç¡®ä¿åªåœ¨å®Œæˆç¬é—´è¯„ä¼°ä¸€æ¬¡ã€‚

3. **flash_evaluate å»¶è¿Ÿ**: è¯­ä¹‰æ¡ä»¶çš„è¯„ä¼°éœ€è¦ä¸€ä¸ª LLM è½®æ¬¡ï¼Œæ„å‘³ç€ pending_flash çš„ç»“æœåœ¨ä¸‹ä¸€ä¸ª tick æ‰å¯ç”¨ã€‚å¯èƒ½å¯¼è‡´ä¸€è½®å»¶è¿Ÿã€‚

4. **ç®¡çº¿é‡æå–çš„æ•°æ®è¿ç§»**: é‡æ–°æå–ä¼šè¦†ç›–ç°æœ‰ chapters_v2.json çš„ trigger_conditionsã€‚éœ€è¦å¯¹æ¯”éªŒè¯ï¼Œç¡®ä¿è´¨é‡ä¸é€€åŒ–ã€‚

5. **åŸå§‹ lorebook é•¿ä¸Šä¸‹æ–‡**: éƒ¨åˆ†ç« èŠ‚å†…å®¹ 4000+ å­—ç¬¦ï¼ŒåŠ ä¸Š prompt æ¨¡æ¿å’Œçº¦æŸï¼Œå•æ¬¡è¯·æ±‚å¯èƒ½è¾¾åˆ° 8000+ tokenã€‚éœ€ç¡®è®¤ Gemini æ¨¡å‹çš„ä¸Šä¸‹æ–‡çª—å£å’Œæˆæœ¬å½±å“ã€‚

---

> **ä¸‹ä¸€æ­¥**: é€‰æ‹©ä»å“ªä¸ª Phase å¼€å§‹å®æ–½ã€‚å»ºè®®ä» E1 (EventStage) å¼€å§‹ï¼Œå› ä¸ºå®ƒæ˜¯ E2 å’Œ E4 çš„å‰ç½®ã€‚
