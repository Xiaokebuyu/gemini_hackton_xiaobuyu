# 多主体叙事系统设计

> 创建时间：2026-02-18
> 状态：设计中，T1 前置（world_state_update）已实现，T1-T4 待实施
> 背景：当前叙事过于 GM 中心化，需要强化系统各主体的自主能动性
> 前置已完成：`pipeline_orchestrator.py` 已实现 `_build_world_state_update()` + `_merge_world_state_updates()` + GameState.metadata 跨回合持久化

---

## 一、设计哲学

好的 CRPG 叙事不是 GM 的独角戏，而是多主体协作的结果：

```
玩家行动
  ↓
┌─────────────────────────────────────────┐
│  GM：环境描写、氛围营造、机械判定结果   │  ← 已实现，但过于主导
│  NPC：自主对话、动机表达               │  ← 已有 npc_dialogue，但缺自主触发
│  队友：在场反应、情感联结              │  ← 已有 teammate_response，但上下文弱
│  系统：任务进度、物品获得、状态变更    │  ← 已有 world_state_update（部分）
└─────────────────────────────────────────┘
  ↓
玩家感知到一个活的世界
```

---

## 二、当前问题

### 2.1 队友上下文残缺

`TeammateResponseService.process_round_stream()` 接收的 `context` 是 B 阶段前组装的 `context_dict`，**不包含**：
- 本回合 GM 最终说了什么（GM 叙述内容）
- 本回合工具调用的结果（发生了什么）
- world_state_update（引擎告知的世界变更）

队友在对"本回合事件"盲目响应，而不是对"真实发生的场景"响应。

### 2.2 NPC 缺乏自主触发机制

NPC 的 ON_DISPOSITION 行为存在（好感度变化时触发），但：
- 触发结果（narrative_hints）已经通过 world_state_update 传给了 GM
- GM 叙述了 NPC 反应，但 NPC 自己没有说话
- 应该：好感度变化 → 触发 npc_dialogue（NPC 自主表达）

### 2.3 GM 承担了不该承担的表达

GM 当前在做：
- 环境描写 ✅（应该的）
- NPC 的情绪/反应描写 ❌（NPC 应该自己说话）
- 队友的心理活动描写 ❌（队友 AI 应该自主表达）
- 任务进度说明 ❌（系统 UI 应该呈现）

---

## 三、待实施项

### T1：队友上下文增强（高优先级）

**当前**：队友收到的 context 不含本轮场景
**目标**：队友收到"完整场景包"，包含：

```python
teammate_context = {
    **context_dict,                    # 基础世界状态
    "gm_narration": gm_narration,      # GM 本轮叙述（已产生）
    "world_state_update": world_state_update,  # 引擎状态变更
    "tool_calls_summary": [            # 本轮工具调用摘要
        {"tool": "npc_dialogue", "npc": "guild_girl", "success": True},
        ...
    ],
}
```

**改动位置**：`pipeline_orchestrator.py`，在调用 `teammate_response_service.process_round_stream()` 时传入增强后的 context。

**当前代码**（line ~220）：
```python
async for tm_event in self.teammate_response_service.process_round_stream(
    party=party,
    player_input=player_input,
    gm_response=gm_narration,
    context=context_dict,   # ← 只有这个，缺少本轮信息
):
```

**修改为**：
```python
teammate_ctx = {
    **context_dict,
    "gm_narration": gm_narration,
    "world_state_update": context_dict.get("world_state_update", {}),
    "this_round_tools": [
        {"name": tc.name, "success": tc.success, "args": tc.args}
        for tc in agentic_result.tool_calls
        if tc.name not in {"recall_memory", "generate_scene_image"}
    ],
}
async for tm_event in self.teammate_response_service.process_round_stream(
    party=party,
    player_input=player_input,
    gm_response=gm_narration,
    context=teammate_ctx,
):
```

---

### T2：NPC 自主触发机制（中优先级）

**目标**：当 ON_DISPOSITION behavior 触发时（好感度变化达到阈值），自动触发对应 NPC 的 npc_dialogue 调用，让 NPC 自主表达情感/反应。

**设计**：
- BehaviorEngine tick 结果中包含 NARRATIVE_HINT action
- NPC NARRATIVE_HINT 不只注入 GM 叙述，还应该触发 NPC 自主发言
- 需要在 pipeline_orchestrator 的 post-tick 处理中检查 NPC narrative_hints → 触发 npc_dialogue

**待设计**：
- NARRATIVE_HINT action 添加 `actor_npc_id` 参数（指定发言 NPC）
- pipeline_orchestrator 消费后自动调度 npc_dialogue
- 或者在 graph_builder 为 NPC 生成的 ON_DISPOSITION behavior 中直接使用 EMIT_EVENT 触发对话

---

### T3：场景信息标准化（中优先级）

**目标**：定义"当前场景包"（SceneContext）数据结构，所有代理（GM、队友、NPC）统一从这个包获取当前场景信息，而不是各自拼接。

```python
SceneContext = {
    "area": {...},           # 区域信息
    "present_npcs": [...],   # 在场 NPC
    "present_party": [...],  # 在场队友
    "player_action": str,    # 玩家本轮行动
    "gm_narration": str,     # GM 叙述（GM 完成后才有）
    "world_events": [...],   # 本轮发生的世界事件
    "time": {...},           # 当前时间
}
```

---

### T4：CompanionInstance 事件感知增强（低优先级，依赖 T1）

**当前**：CompanionInstance 通过 `add_event()` 接收 CompactEvent（轻量事件摘要）
**目标**：同伴不只知道"发生了什么事件"，还知道"这个事件是如何发展的"（包含 GM 叙述、工具调用过程）

---

## 四、实施顺序建议

```
T1（队友上下文）→ T3（场景包标准化）→ T2（NPC 自主触发）→ T4（Companion 增强）
```

T1 最简单，改一处传参，效果立竿见影（队友能对本轮真实发生的事作反应）。

---

## 五、与现有设计的关系

| 已完成 | 待实施 |
|--------|--------|
| `world_state_update` 注入 GM 上下文 | `world_state_update` 同步给队友（T1）|
| `TeammateResponseService` 基本框架 | 队友获得完整场景包（T1）|
| `CompanionInstance.add_event()` | Companion 获得 GM 叙述 + 工具摘要（T4）|
| ON_DISPOSITION behavior 触发 | NPC 自主 npc_dialogue（T2）|
| `world_state_update.narrative_hints` | 区分 GM hints vs NPC hints（T2 前置）|
