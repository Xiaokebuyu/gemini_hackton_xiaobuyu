# 阶段 1：地基修补（治屎山）

> 状态：✅ 完成（1.5 ✅ → 1.1 ✅ → 1.2 ✅ → 1.3 ✅ → 1.4 ✅ → 1.6 ✅ → 1.7 ✅）
> 目标：不改架构，只收拢最脏的部分，为后续拆分打基础。
> 前置：无（首个阶段）

---

## 1.1 StateManager 实例梳理 ✅

**问题**：FlashCPUService 有 `state_manager or StateManager()` 回退，传 None 会创建独立实例；AdminCoordinator 有 7 处后期注入（placeholder None → 覆写）。

**已完成的改动**：

| 改动 | 文件 |
|------|------|
| 重排 AdminCoordinator `__init__` 构造顺序（party/character/recall 上移到 flash_cpu 之前） | `admin_coordinator.py` |
| 消除全部 7 处后期注入（placeholder None + 属性覆写），0 残留 | `admin_coordinator.py` |
| FlashCPU 添加 `recall_orchestrator` 构造参数 | `flash_cpu_service.py` |
| FlashCPU 添加 standalone StateManager 警告日志 | `flash_cpu_service.py` |
| 添加 StateManager `is` 同对象断言（WorldRuntime + FlashCPU） | `admin_coordinator.py` |

---

## 1.2 StatsManager — 收口 XP/Gold/HP 散写 ✅

**已完成的改动**：

| 改动 | 文件 |
|------|------|
| 新建纯函数模块：`add_xp`（含升级检查）、`add_gold`、`remove_gold`、`add_hp`、`remove_hp`、`set_hp` | `stats_manager.py`（新建） |
| 新增 D&D 常量：`HIT_DIE_BY_CLASS`、`CASTER_TYPE_BY_CLASS` | `constants.py` |
| 添加 `proficiency_bonus` setter + xp/gold/hp setter 非负约束 | `player_node.py` |
| 11 处 XP/Gold 散写 + 6 处 HP 散写 全部改为调用 stats_manager（共 17 处） | `v4_agentic_tools.py`(10)、`flash_cpu_service.py`(3)、`session_runtime.py`(2)、`intent_executor.py`(2) |
| 新建单元测试 23 条（XP 9 + Gold 6 + HP 8），全部通过 | `test_stats_manager.py`（新建） |
| **关键 bug 修复**：V4 pipeline 的 XP 写入路径现已包含 level-up 检查（移植自 CharacterService） | `stats_manager.add_xp()` |
| grep 验证：`player.xp =` / `player.gold =` 仅在 stats_manager.py 和 setter 中 | ✅ 零残留 |

---

## 1.3 Player 持久化路径加固 ✅

**已完成的改动**：

| 改动 | 文件 |
|------|------|
| `_persist_world_graph_snapshot()` 返回 `bool`，失败日志从 warning → error | `session_runtime.py` |
| 新增 `_fallback_persist_player()` — CharacterStore 兜底写入（PlayerNodeView → PlayerCharacter 转换） | `session_runtime.py` |
| 重写 `persist()` 步骤 3/7：脏标记延迟清除，仅在至少一条持久化路径成功后才清 | `session_runtime.py` |
| 快照失败不再 append "world_graph" 到 persisted 列表（修复误报日志） | `session_runtime.py` |
| 修复 `stats_manager` 顶层 import 导致的循环依赖（改为惰性 import） | `session_runtime.py` |
| 新建 8 条单元测试（快照成功/失败/兜底/双失败保留脏标记/PlayerNodeView 转换/日志级别） | `test_player_persistence.py`（新建） |

**持久化时序（修复后）**：
```python
# session_runtime.py persist()
步骤 3: player_was_dirty = self._dirty_player   # 仅记录，不清除

步骤 7a: if player_was_dirty → _fallback_persist_player()   # CharacterStore 兜底
步骤 7b: _persist_world_graph_snapshot() → snapshot_ok       # 主路径（返回 bool）
步骤 7c: if snapshot_ok → 清除脏标记 + "player"
         elif fallback_ok → 清除脏标记 + "player(fallback)"
         else → 保留脏标记 + logger.error              # 下次 persist 会重试
```

---

## 1.4 AdminWorldRuntime 残留清理 ✅

**已完成的改动**：

| 改动 | 文件 |
|------|------|
| SessionRuntime 注入 `_session_store`，内联 `persist_state`（StateManager + Firestore 双写） | `session_runtime.py` |
| SessionRuntime `_restore_game_state()` 内联 `get_state`（StateManager 缓存 → Firestore 回退 → 空兜底） | `session_runtime.py` |
| SessionRuntime `enter/leave_sublocation()` 去委托化（删除 `_world_runtime` 分支） | `session_runtime.py` |
| 完全移除 SessionRuntime 的 `_world_runtime` 依赖 | `session_runtime.py` |
| PipelineOrchestrator 用 `session_store` 替换 `world_runtime` | `pipeline_orchestrator.py` |
| FlashCPU UPDATE_TIME 内联（TimeManager + StateManager + SessionStore） | `flash_cpu_service.py` |
| FlashCPU `_apply_delta()` 内联持久化（直接写 SessionStore） | `flash_cpu_service.py` |
| 完全移除 FlashCPUService 的 `world_runtime` 依赖 | `flash_cpu_service.py` |
| AdminCoordinator `resume_session` / `get_context_async` 内联 `get_state` | `admin_coordinator.py` |
| AdminCoordinator `generate_opening_narration` 内联 `get_game_time` | `admin_coordinator.py` |
| AdminCoordinator `get_game_time` passthrough 内联（不再调 AWR） | `admin_coordinator.py` |
| AdminWorldRuntime 瘦身：删除 `persist_state` / `refresh_state` / `get_game_time`（~80 行） | `world_runtime.py` |
| 修复 `test_pipeline_teammate_stage` / `test_navigation_fallback_and_sublocation` 测试 | 3 个测试文件 |

**AWR 保留方法**：`start_session`、`get_current_location`、`advance_time`、`enter/leave_sub_location`（MCP passthrough 通道）

**解耦成果**：
- SessionRuntime：零 `_world_runtime` 引用
- FlashCPUService：零 `world_runtime` 引用
- PipelineOrchestrator：零 `world_runtime` 引用

---

## 1.5 死代码清理 ✅

**Codex 审计发现的死代码**（定义了但未被调用）：

| 死代码 | 位置 | 处理 |
|--------|------|------|
| `update_disposition_after_combat()` | `admin_coordinator.py:1334` | ✅ 已删除 |
| `StateManager.init_state()` | `state_manager.py:35` | ✅ 已删除 |
| `StateManager.list_deltas()` | `state_manager.py:91` | ✅ 已删除 |
| `SessionRuntime.mark_party_dirty()` | `session_runtime.py:1035` | ✅ 已删除 |
| `SessionRuntime.update_narrative()` | `session_runtime.py:1077` | ✅ 已删除 |
| `SessionRuntime.to_context_dict()` | `session_runtime.py:1090` | ✅ 已删除 |
| `AdminCoordinator.reset_instance()` | `admin_coordinator.py:67` | 保留（测试可能需要） |
| `GameRuntime.reset_instance()` | `game_runtime.py:36` | 保留（测试可能需要） |
| `ActionOptionsService` 整个类 | `action_options_service.py:19` | ✅ 已删除整文件 |
| `EventGenerator` 整个类 | `event_generator.py:59` | ✅ 已删除整文件 |

- [x] 批量清理上述死代码（-873 行，全量 grep 验证零残留引用）
- [x] 验证：测试无新增失败（62 个预存失败均为 MCP 模块缺失，非本次改动导致）

---

## 1.6 重复代码合并 ✅

**已完成的改动**：

| 改动 | 文件 |
|------|------|
| 新增 `sync_combat_rewards(player, combat_payload)` 纯函数 | `stats_manager.py` |
| `_sync_combat_to_graph()` 改为调用 `sync_combat_rewards()` | `v4_agentic_tools.py` |
| `sync_combat_result_to_character()` session 路径改为调用 `sync_combat_rewards()` | `flash_cpu_service.py` |
| 新增 `_apply_rewards()` 通用奖励应用方法（XP/Gold/Items/Reputation/WorldFlags） | `v4_agentic_tools.py` |
| `_apply_on_complete_from_graph()` 瘦身为数据映射 + 调用 `_apply_rewards()` | `v4_agentic_tools.py` |
| `_apply_outcome_rewards()` 瘦身为数据映射 + 调用 `_apply_rewards()` + 保留 `unlock_events` | `v4_agentic_tools.py` |
| 子地点进出评估后不合并（分层设计，职责不同） | — |
| 新建 6 条 `sync_combat_rewards` 单元测试 | `test_stats_manager.py` |

---

## 1.7 错误处理统一 ✅

**已完成的改动**：

| 改动 | 文件 |
|------|------|
| 消除 `except Exception: pass`（队伍加载）→ `logger.warning` | `admin_coordinator.py:279` |
| 消除 `except Exception:`（角色查询回退）→ `logger.debug` | `admin_coordinator.py:288` |
| `warning` → `error`（队伍自动创建失败） | `admin_coordinator.py:1105` |
| 消除 `except Exception: pass`（章节进度回退）→ `logger.warning` | `world_runtime.py:130` |
| 消除 bare `except Exception:`（finish_reason）→ `logger.debug` | `flash_cpu_service.py:157` |
| `warning` → `error`（战斗 player_state 填充失败） | `flash_cpu_service.py:219` |
| `warning` → `error` + `exc_info`（队友移除图谱化失败） | `flash_cpu_service.py:382` |
| `warning` → `error` + `exc_info`（解散队伍图谱化失败） | `flash_cpu_service.py:428` |
| `warning` → `error` + `exc_info`（NPC reactor 失败） | `pipeline_orchestrator.py:276` |
| `warning` → `error` + `exc_info`（scene bus graphize 失败） | `pipeline_orchestrator.py:479` |
| `warning` → `error`（chapter_info 构建失败） | `pipeline_orchestrator.py:594` |
| TypeError `raise` → `return payload`（AFC 参数错误不再中断工具链） | `v4_agentic_tools.py:117` |
| 消除 `except Exception: pass`（BehaviorEngine pre-activate tick）→ `logger.warning` | `v4_agentic_tools.py:1041` |
| 消除 `except Exception: pass`（条件解析）→ `logger.debug` | `area_runtime.py:535` |
| MCP inventory_tools HP 散写 → 改为调用 `stats_manager.add_hp()` | `inventory_tools.py:169` |
| `_state_manager._states` 私有字段直读 → 新增 `get_state_sync()` 公开方法 | `state_manager.py` + `admin_coordinator.py:1112` |

**规则**：
- [x] 消除所有 `except Exception: pass`（6 处 → 0 处，仅余 2 处 `except NotImplementedError: pass` Phase 2B 存根）
- [x] 数据一致性相关异常提升为 `error` 级别
- [x] 快照保存失败改为 error 级别日志（1.3 已完成）
- [x] AFC TypeError 不再 re-raise，返回错误 payload 让 LLM 自行纠正
- [x] MCP 物品使用 HP 写入收口到 stats_manager
- [x] StateManager 封装性修复（消除私有字段直读）

---

## 执行顺序（确定）

```
1.5 死代码清理（-873 行）                    ✅ 完成
  ↓
1.1 StateManager 梳理（消除 7 处后期注入）     ✅ 完成
  ↓
1.2 StatsManager 收口（17 处修改 + level-up 修复）  ✅ 完成
  ↓
1.3 Player 持久化加固（双路径 + 脏标记时序修复）  ✅ 完成
  ↓
1.4 AdminWorldRuntime 解耦（SR/FlashCPU/Pipeline 独立化）  ✅ 完成
  ↓
1.6 重复代码合并 + 1.7 错误处理统一（合并执行）  ✅ 完成
```

---

## 验证标准

- [ ] `pytest tests/ -v` 全量通过
- [x] grep 无直接 `player.xp` / `player.gold` 赋值（除 StatsManager 和 setter）
- [x] StateManager 三引用 `is` 同一对象（有断言保证）
- [x] Player 快照失败时有独立 CharacterStore 兜底（1.3 完成，8 条测试覆盖）
- [x] AdminWorldRuntime 核心依赖已解耦（SR/FlashCPU/Pipeline 零 world_runtime 引用）
- [x] 无死代码残留
- [x] 无 `except: pass`（4 处 → 0 处，1.7 完成）
- [x] 战斗奖励同步收口（`sync_combat_rewards` 共享函数，6 条测试覆盖）
- [x] 事件奖励发放收口（`_apply_rewards` 通用方法）

---

## 变更日志

| 日期 | 操作 |
|------|------|
| 2026-02-20 | 创建 |
| 2026-02-20 | Codex 深度审计后细化：补充完整写入点清单（11处）、AdminWorldRuntime 方法调用关系、Player 持久化 bug 细节、死代码/重复代码/错误处理三个新章节、执行顺序建议 |
| 2026-02-20 | **1.5 死代码清理完成**（-873 行）：删除 `update_disposition_after_combat`、`StateManager.init_state/list_deltas`、`mark_party_dirty`、`update_narrative`、`to_context_dict`、`ActionOptionsService` 整文件、`EventGenerator` 整文件。全量 grep 验证零残留引用，测试无新增失败 |
| 2026-02-20 | **1.1 StateManager 梳理完成**：重排 AdminCoordinator 构造顺序，消除全部 7 处后期注入（placeholder None + 属性覆写），FlashCPU 添加 `recall_orchestrator` 构造参数 + standalone 警告，添加 StateManager `is` 同对象断言。测试无新增失败（diff 零差异） |
| 2026-02-20 | **1.2 StatsManager 收口完成**：新建 `stats_manager.py`（6 函数）+ `test_stats_manager.py`（23 条）。17 处散写（XP 6 + Gold 5 + HP 6）全部收口。新增 `HIT_DIE_BY_CLASS`/`CASTER_TYPE_BY_CLASS` 常量 + `proficiency_bonus` setter + setter 非负约束。**关键 bug 修复**：V4 pipeline XP 写入现包含 level-up 检查。grep 零残留，全量回归零新增失败 |
| 2026-02-20 | **1.3 Player 持久化加固完成**：`_persist_world_graph_snapshot` 改返回 `bool` + 日志 warning→error。新增 `_fallback_persist_player`（CharacterStore 兜底，PlayerNodeView→PlayerCharacter 转换）。重写 `persist()` 步骤 3/7：脏标记延迟清除，仅至少一条路径成功后才清；快照失败不再误报 "world_graph"。修复 `stats_manager` 顶层 import 循环依赖（改惰性 import）。新建 `test_player_persistence.py`（8 条），全量回归零新增失败 |
| 2026-02-20 | **1.4 AdminWorldRuntime 解耦完成**：SessionRuntime 注入 `_session_store`，内联 `persist_state`/`get_state`/`enter_leave_sublocation`，完全移除 `_world_runtime` 依赖。FlashCPU 内联 UPDATE_TIME + `_apply_delta`，完全移除 `world_runtime`。PipelineOrchestrator 用 `session_store` 替换 `world_runtime`。AdminCoordinator 内联 `get_state`/`get_game_time` 调用点。AWR 瘦身删除 `persist_state`/`refresh_state`/`get_game_time`（~80 行）。修复 3 个测试文件。全量回归：62 failed / 553 passed（基线 63/552，净改善 +1） |
| 2026-02-20 | **1.6 + 1.7 合并完成**。**1.6 重复代码合并**：新增 `sync_combat_rewards()` 纯函数（`stats_manager.py`），战斗同步两处散写收口为共享调用；新增 `_apply_rewards()` 通用奖励方法（`v4_agentic_tools.py`），`_apply_on_complete_from_graph` 和 `_apply_outcome_rewards` 瘦身为数据映射层；子地点进出评估后不合并（分层设计）。**1.7 错误处理统一**：消除 4 处 `except: pass`→有日志；8 处 warning→error（数据一致性路径）；AFC TypeError 从 re-raise 改为 return payload。新增 6 条测试。全量回归：62 failed / 559 passed（+6 新测试，零新增失败） |
| 2026-02-20 | **Codex 审计补漏**：消除 2 处遗漏的 `except Exception: pass`（`v4_agentic_tools.py` BehaviorEngine tick + `area_runtime.py` 条件解析）；MCP `inventory_tools.py` HP 散写收口到 `stats_manager.add_hp()`；StateManager 新增 `get_state_sync()` 消除 `admin_coordinator.py` 私有字段直读。全量回归：62 failed / 559 passed（零变化） |
