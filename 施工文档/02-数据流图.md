# 📊 数据流图

> 通过简化的流程图理解数据如何在系统中流动

---

## 🔄 主对话流程

```
用户
  ↓
  发送消息
  ↓
┌─────────────────────────────────────┐
│  chat.py (POST /api/chat)           │
│  1. 保存用户消息                    │
└─────────────────────────────────────┘
  ↓
┌─────────────────────────────────────┐
│  archive_service.check_should_archive│
│  检查未归档消息数                   │
└─────────────────────────────────────┘
  ↓
  未归档消息 >= 10？
  ↓               ↓
 是              否
  ↓               ↓
  执行归档     跳过归档
  ↓
┌─────────────────────────────────────┐
│  context_loop.run()                 │
│  【核心循环】                       │
└─────────────────────────────────────┘
  ↓
┌─────────────────────────────────────┐
│  Step 1: context_builder.build()    │
│  构建上下文                         │
│  - 加载最近20条消息                 │
│  - 加载所有Artifacts的摘要          │
│  - 构建system prompt                │
└─────────────────────────────────────┘
  ↓
┌─────────────────────────────────────┐
│  Step 2: llm_service.generate_response│
│  调用Gemini API                     │
└─────────────────────────────────────┘
  ↓
  回复中有 "NEED_CONTEXT:" ？
  ↓               ↓
 是              否
  ↓               ↓
  ↓         保存回复并返回
  ↓               ↓
  ↓             用户
┌─────────────────────────────────────┐
│  Step 3: artifact_service           │
│  提取关键词并查找相关内容           │
│  - 解析 NEED_CONTEXT:关键词         │
│  - 在所有Artifacts中搜索            │
│  - 提取匹配的章节内容               │
└─────────────────────────────────────┘
  ↓
  回到 Step 1（最多重试3次）
  ↓
  达到重试上限或成功
  ↓
  保存回复并返回
  ↓
用户
```

---

## 📚 归档流程

```
触发归档
  ↓
┌─────────────────────────────────────┐
│  archive_service.execute_archive()  │
└─────────────────────────────────────┘
  ↓
┌─────────────────────────────────────┐
│  Step 1: 分析未归档消息             │
│  llm_service.analyze_messages_for_archive│
│  - 提取所有未归档的消息             │
│  - 让LLM分析并生成Artifacts         │
└─────────────────────────────────────┘
  ↓
  LLM返回格式化的Artifacts
  ↓
┌─────────────────────────────────────┐
│  Step 2: 查找可合并的主题           │
│  - 遍历Session内所有现有主题        │
│  - 对每个新Artifact判断是否应合并   │
│  - 使用LLM判断主题相似性            │
└─────────────────────────────────────┘
  ↓
  找到可合并主题？
  ↓               ↓
 是              否
  ↓               ↓
┌──────────────┐   ┌──────────────┐
│  合并Artifact│   │  创建新主题  │
│  - 调用LLM   │   │  - 保存新Topic│
│  - 更新版本  │   │  - 保存Artifact│
└──────────────┘   └──────────────┘
  ↓               ↓
  └───────┬───────┘
          ↓
┌─────────────────────────────────────┐
│  Step 3: 标记消息为已归档           │
│  - 更新 is_archived = True          │
│  - 填充 thread_id                   │
└─────────────────────────────────────┘
  ↓
归档完成
```

---

## 🔍 上下文检索流程

```
LLM回复包含 "NEED_CONTEXT:Python教程"
  ↓
┌─────────────────────────────────────┐
│  context_loop 检测到标记            │
└─────────────────────────────────────┘
  ↓
┌─────────────────────────────────────┐
│  artifact_service.parse_artifact_sources│
│  解析请求: ["Python教程"]           │
└─────────────────────────────────────┘
  ↓
┌─────────────────────────────────────┐
│  firestore_service.get_all_topics   │
│  获取当前Session所有主题            │
└─────────────────────────────────────┘
  ↓
  遍历每个Topic的Artifact
  ↓
┌─────────────────────────────────────┐
│  artifact_service.find_section_by_keyword│
│  在Artifact中搜索关键词             │
│  - 匹配章节标题                     │
│  - 使用模糊匹配                     │
└─────────────────────────────────────┘
  ↓
  找到匹配？
  ↓               ↓
 是              否
  ↓               ↓
┌──────────────┐   ┌──────────────┐
│  提取章节内容│   │  跳过该Artifact│
└──────────────┘   └──────────────┘
  ↓
  收集所有匹配的内容
  ↓
┌─────────────────────────────────────┐
│  重新构建上下文                     │
│  - 保留原有消息                     │
│  - 插入检索到的内容                 │
│  - 再次调用LLM                      │
└─────────────────────────────────────┘
  ↓
  生成最终回复
```

---

## 💾 数据存储结构

```
Firestore
  └── users/
      └── {user_id}/
          └── sessions/
              └── {session_id}/
                  ├── 📄 Session文档
                  │   ├── created_at: timestamp
                  │   └── updated_at: timestamp
                  │
                  ├── 📁 messages (子集合)
                  │   └── {message_id}/
                  │       ├── role: "user" | "assistant"
                  │       ├── content: string
                  │       ├── timestamp: timestamp
                  │       ├── is_archived: boolean
                  │       └── thread_id: string (可选)
                  │
                  └── 📁 topics (子集合)
                      └── {thread_id}/
                          ├── 📄 Topic文档
                          │   ├── title: string
                          │   ├── summary: string
                          │   ├── current_artifact: string
                          │   └── created_at: timestamp
                          │
                          └── 📁 artifact_versions (子集合)
                              └── {version_id}/
                                  ├── content: string
                                  ├── created_at: timestamp
                                  └── message_ids: array
```

---

## 🎯 关键路径

### 🟢 快速路径（无归档，无检索）
```
用户消息 → 保存 → 构建上下文 → LLM → 保存回复 → 返回
估计时间: 2-4秒
```

### 🟡 归档路径
```
用户消息 → 保存 → 归档(5-8秒) → 构建上下文 → LLM → 保存回复 → 返回
估计时间: 7-12秒
```

### 🟠 检索路径
```
用户消息 → 保存 → 构建上下文 → LLM(检测NEED_CONTEXT) 
→ 查找Artifact → 重新构建上下文 → LLM → 保存回复 → 返回
估计时间: 4-8秒
```

### 🔴 完整路径（归档+检索+重试）
```
用户消息 → 保存 → 归档 → 构建上下文 → LLM(检测NEED_CONTEXT) 
→ 查找Artifact → 重新构建上下文 → LLM(再次检测) 
→ 查找Artifact → 重新构建上下文 → LLM → 保存回复 → 返回
估计时间: 15-25秒
```

---

## 📊 数据量级

| 实体 | 预估量 | 说明 |
|------|--------|------|
| User | 1-1000 | 取决于用户数 |
| Session per User | 10-100 | 每个用户的会话数 |
| Message per Session | 50-500 | 每个会话的消息数 |
| Topic per Session | 5-50 | 每个会话的主题数 |
| Version per Topic | 1-10 | 每个主题的版本数 |

### 存储估算
- 每条消息: ~0.5-2KB
- 每个Artifact: ~2-10KB
- 单个Session: ~50-500KB
- 单个User: ~0.5-50MB

---

## 🔧 性能瓶颈点

1. **LLM调用** - 最耗时（2-5秒/次）
   - 优化：减少重试次数、使用更快的模型

2. **归档分析** - 次耗时（5-8秒）
   - 优化：批量处理、异步执行

3. **Firestore查询** - 较快（100-500ms）
   - 优化：添加索引、使用缓存

4. **Artifact解析** - 很快（10-50ms）
   - 优化：预编译正则、缓存结果

---

**💡 提示**: 理解数据流后，调试时就能准确定位问题出现在哪个环节！
