# Phase 4 收尾清理完成报告

## 完成概述

Phase 4a/4b/4c 主干迁移完成后的验收收尾，清理所有死代码路径、废弃接口、死测试，实装 D9 自动时间推进、SceneBus 成员可见性、D11 私聊 Pipeline 迁移、use_item MCP 清理。

**测试结果**：6 failed / 775 passed（仅剩 MCP 连接环境测试）
**基线对比**：从 19 failed / 759 passed → 6 failed / 775 passed（净减少 13 个失败，净增加 16 个通过）

---

## 已完成项

### S1: 死测试清理（-10 死测试）

| 文件 | 操作 | 说明 |
|------|------|------|
| `tests/test_admin_agentic_intent_inference.py` | 删除整个文件 | 2 测试引用不存在的 `_infer_agentic_intent_type` |
| `tests/test_party_system.py` | 删除整个文件 | 1 测试引用不存在的 `_determine_teammate_perspective` |
| `tests/test_admin_story_flow.py` | 删除 7 个死测试 | 保留 3 个存活测试 + 修复 `_state_manager` stub |

### S2: FlashOperation 死枚举（-10 枚举值 + -3 死测试）

从 `FlashOperation` 枚举中删除：
- `GET_PROGRESS`, `GET_STATUS`, `HEAL_PLAYER`, `DAMAGE_PLAYER`, `ADD_XP`, `ADD_ITEM`, `REMOVE_ITEM`（S2）
- `TRIGGER_NARRATIVE_EVENT`（S3）
- `UPDATE_TIME`（S5）

当前枚举仅保留 7 个活跃操作：`SPAWN_PASSERBY`, `NPC_DIALOGUE`, `START_COMBAT`, `ADD_TEAMMATE`, `REMOVE_TEAMMATE`, `DISBAND_PARTY`, `ABILITY_CHECK`

删除依赖这些枚举的 3 个测试 + 修剪 1 个测试中的 `TRIGGER_NARRATIVE_EVENT` 调用。

### S3: D12 trigger_event 旧路径清除

| 位置 | 删除内容 |
|------|---------|
| `app/routers/game_v2.py` | `trigger_narrative_event` 端点 + `TriggerEventRequest` 模型 |
| `app/services/admin/flash_cpu_service.py` | `FlashOperation.TRIGGER_NARRATIVE_EVENT` 处理块 |
| `app/mcp/tools/narrative_tools.py` | `trigger_event` MCP 工具函数 |

### S4: 废弃 MCP 工具清理（-8 工具函数）

| 文件 | 删除的工具 |
|------|-----------|
| `app/mcp/tools/character_tools.py` | `heal_player`, `damage_player`, `add_player_xp`, `set_player_hp` |
| `app/mcp/tools/inventory_tools.py` | `add_item`, `remove_item` |
| `app/mcp/tools/graph_tools.py` | `update_disposition` |
| `app/mcp/tools/time_tools.py` | `advance_time` |

### S5: 废弃方法清理（-6 方法 + -1 FlashCPU handler）

| 文件 | 删除的方法 |
|------|-----------|
| `app/services/admin/admin_coordinator.py` | `advance_time()`, `enter_sub_location()`, `leave_sub_location()` |
| `app/services/admin/world_runtime.py` | `advance_time()`, `enter_sub_location()`, `leave_sub_location()` |
| `app/services/admin/flash_cpu_service.py` | `FlashOperation.UPDATE_TIME` 处理块 |

### S6: D9 自动时间推进

**核心变更**：删除 LLM 可调用的 `update_time` 沉浸式工具，改为 Pipeline C 阶段自动推进 10 分钟。

| 文件 | 变更 |
|------|------|
| `app/world/immersive_tools.py` | 删除 `_normalize_advance_minutes()` + `update_time()` 工具 |
| `app/world/gm_extra_tools.py` | `ENGINE_TOOL_EXCLUSIONS` 移除 `move_area`/`rest` 条目 |
| `app/prompts/flash_agentic_system.md` | 删除 update_time 相关指令，新增"时间自动推进"说明 |
| `app/services/admin/pipeline_orchestrator.py` | C1c 添加 `session.advance_time(10)`，move_area/rest 时跳过 |

### S7: SceneBus 成员可见性

| 文件 | 变更 |
|------|------|
| `app/world/scene_bus.py` | `get_visible_entries()` 新增成员校验：非成员且非系统 actor 返回空列表 |
| `tests/test_scene_bus.py` | 新增 `TestMemberVisibility` 测试类（7 个用例） |

### S8: D11 私聊接入 Pipeline

**核心变更**：`AdminCoordinator.process_private_chat_stream()` 从直接处理改为委托到 `PipelineOrchestrator.process_private_chat_stream()`，完整对齐 `/interact/stream` 管线。

**新增能力**：
- SessionRuntime restore/persist（统一状态管理）
- AgenticExecutor + 沉浸式工具（NPC 可改好感度、创建记忆等）
- SceneBus 写入 + 图谱化
- SessionHistory 记录
- 对话选项生成
- InstanceManager 双层认知保留（上下文窗口 + 记忆图谱化）
- GM/队友观察在私密模式下跳过

**SSE 事件格式变更**（前端需同步更新）：
```
旧: chat_start → chat_chunk(多次) → chat_end
新: interact_start → [tool events] → npc_response → dialogue_options → complete
```

| 文件 | 变更 |
|------|------|
| `app/services/admin/pipeline_orchestrator.py` | 新增 `process_private_chat_stream()` + `__init__` 添加 instance_manager |
| `app/services/admin/admin_coordinator.py` | 重写 `process_private_chat_stream()` 为委托（-70 行） |
| `tests/test_private_chat_pipeline.py` | 新建 12 个测试用例 |

### S9: use_item MCP 工具清理

**核心变更**：删除 `app/mcp/tools/inventory_tools.py` 中的 `use_item` MCP 工具函数（-49 行）。

**理由**：IntentExecutor.execute_use_item() 已正确处理物品使用（内存操作 + mark_player_dirty → SessionRuntime.persist），MCP use_item 直接写 CharacterStore 是遗留旁路。

---

## 测试现状

```
6 failed / 775 passed（仅 MCP 连接环境测试）
```

所有非环境测试全绿。所有推迟项已完成。
