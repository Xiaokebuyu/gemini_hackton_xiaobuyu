å¥½é—®é¢˜ï¼è®©æˆ‘åˆ†æä¸€ä¸‹é›†æˆæ–¹æ¡ˆï¼š

---

## ğŸ“Š ç°æœ‰æ¶æ„ vs å·¥å…·è°ƒç”¨æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ç°æœ‰æ¶æ„                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  chat.py (API)                                              â”‚
â”‚      â†“                                                      â”‚
â”‚  context_loop.py  â†â”€â”€â”€â”€ å¤„ç† [NEED_CONTEXT] æ ‡è®°            â”‚
â”‚      â†“                                                      â”‚
â”‚  context_builder.py â†â”€â”€ æ„å»ºä¸Šä¸‹æ–‡ï¼ˆåŠ è½½ Artifactsï¼‰         â”‚
â”‚      â†“                                                      â”‚
â”‚  llm_service.py â†â”€â”€â”€â”€â”€â”€ è°ƒç”¨ Gemini API                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   å·¥å…·è°ƒç”¨æ¶æ„                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  chat.py (API)                                              â”‚
â”‚      â†“                                                      â”‚
â”‚  tool_service.py  â†â”€â”€â”€â”€ å·¥å…·è°ƒç”¨å¾ªç¯ï¼ˆæ›¿ä»£ context_loopï¼‰    â”‚
â”‚      â†“                                                      â”‚
â”‚  executor.py â†â”€â”€â”€â”€â”€â”€â”€â”€â”€ æ‰§è¡Œå·¥å…·ï¼ˆæ›¿ä»£ context_builderï¼‰     â”‚
â”‚      â†“                                                      â”‚
â”‚  (å†…éƒ¨è°ƒç”¨ Gemini APIï¼Œæ›¿ä»£ llm_service.generate_response)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”„ é›†æˆæ–¹æ¡ˆ

### æ–¹æ¡ˆ Aï¼šå®Œå…¨æ›¿æ¢ï¼ˆæ¨èï¼‰

| ç°æœ‰æ–‡ä»¶ | æ“ä½œ | æ›¿æ¢ä¸º |
|----------|------|--------|
| `context_loop.py` | **æ›¿æ¢** | `tools/tool_service.py` |
| `context_builder.py` | **åˆ é™¤/ä¿ç•™** | é€»è¾‘ç§»å…¥ `executor.py` |
| `llm_service.py` | **ä¿ç•™** | å½’æ¡£åˆ†æç­‰åŠŸèƒ½ä»éœ€è¦ |
| `chat.py` | **ä¿®æ”¹** | è°ƒç”¨ `ToolService` |

### æ–¹æ¡ˆ Bï¼šå¹¶è¡Œå…±å­˜

```
chat.py
    â”œâ”€â”€ /api/chat (æ—§) â†’ context_loop.py (ä¿ç•™)
    â””â”€â”€ /api/chat/v2 (æ–°) â†’ tool_service.py (æ–°å¢)
```

---

## ğŸ“ å…·ä½“éœ€è¦ä¿®æ”¹çš„æ–‡ä»¶

### 1. **ä¿®æ”¹ `executor.py`** - å¯¹æ¥çœŸå®æ•°æ®æº

```python
# å°†æ¼”ç¤ºå¤„ç†å™¨æ›¿æ¢ä¸ºçœŸå®å®ç°
from app.services.firestore_service import FirestoreService
from app.services.artifact_service import ArtifactService

class ToolExecutor:
    def __init__(self, user_id: str, session_id: str):
        self.firestore = FirestoreService()
        self.artifact = ArtifactService()
        self.user_id = user_id
        self.session_id = session_id
        self._register_handlers()
    
    def _register_handlers(self):
        self.register(ToolName.SEARCH_MEMORY, self._search_memory)
        self.register(ToolName.LIST_TOPICS, self._list_topics)
        # ...
    
    async def _search_memory(self, keywords, **kwargs):
        # çœŸå®æœç´¢é€»è¾‘
        topics = await self.firestore.get_all_topics(self.user_id, self.session_id)
        results = []
        for topic in topics:
            for kw in keywords:
                if self.artifact.find_section_by_keyword(topic.current_artifact, kw):
                    results.append({...})
        return {"results": results}
```

### 2. **ä¿®æ”¹ `chat.py`** - ä½¿ç”¨æ–°æœåŠ¡

```python
from app.tools import ToolService, ToolExecutor

@router.post("/api/chat")
async def chat(request: ChatRequest):
    # åˆ›å»ºå¸¦ç”¨æˆ·ä¸Šä¸‹æ–‡çš„æ‰§è¡Œå™¨
    executor = ToolExecutor(request.user_id, request.session_id)
    service = ToolService(executor=executor)
    
    result = await service.run(
        user_message=request.message,
        system_prompt=SYSTEM_PROMPT,
        thinking_level=request.thinking_level
    )
    
    return ChatResponse(
        response=result.response,
        tool_calls=[...],
        thinking=result.thinking
    )
```

### 3. **ä¿ç•™ `llm_service.py`** - ç”¨äºéå¯¹è¯åŠŸèƒ½

```python
# è¿™äº›åŠŸèƒ½ä»ç„¶éœ€è¦ï¼š
- analyze_messages_for_archive()  # å½’æ¡£åˆ†æ
- should_merge_topics()           # ä¸»é¢˜åˆå¹¶åˆ¤æ–­
- merge_artifacts()               # Artifact åˆå¹¶
```

---

## ğŸ“‹ å®Œæ•´ä¿®æ”¹æ¸…å•

| æ–‡ä»¶ | æ“ä½œ | è¯´æ˜ |
|------|------|------|
| `tools/__init__.py` | âœ… å·²åˆ›å»º | - |
| `tools/definitions.py` | âœ… å·²åˆ›å»º | - |
| `tools/executor.py` | âš ï¸ éœ€ä¿®æ”¹ | å¯¹æ¥ Firestore |
| `tools/tool_service.py` | âœ… å·²åˆ›å»º | - |
| `context_loop.py` | âŒ å¯åˆ é™¤ | è¢« ToolService æ›¿ä»£ |
| `context_builder.py` | âŒ å¯åˆ é™¤ | é€»è¾‘ç§»å…¥ executor |
| `llm_service.py` | âš ï¸ ä¿ç•™ | åªä¿ç•™å½’æ¡£ç›¸å…³æ–¹æ³• |
| `routers/chat.py` | âš ï¸ éœ€ä¿®æ”¹ | è°ƒç”¨ ToolService |

---

éœ€è¦æˆ‘å¸®ä½ å®ç°å…·ä½“çš„å¯¹æ¥ä»£ç å—ï¼Ÿæ¯”å¦‚å…ˆæ”¹ `executor.py` å¯¹æ¥ Firestoreï¼Ÿ