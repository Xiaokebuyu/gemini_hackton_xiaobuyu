# Phase 4b 执行完成报告

## 完成概述

Phase 4b 分为两批执行：

- **批次 A（基础设施）**：AgenticContext、AgenticExecutor、19 沉浸式工具、RoleRegistry、recall_for_role — 28 测试
- **批次 B（迁移 + 新功能）**：Teammate 迁移、NPC /interact 端点、NPCReactor 简化、清理 — 45 测试

## 关键架构决策

### 1. V4 工具 vs 沉浸式工具 —— 不是替换关系

深入分析后发现：
- **V4AgenticToolRegistry**（26 工具）= GM 全知视角的**机械操作**（heal_player, add_xp, npc_dialogue, update_time...）
- **immersive_tools**（19 工具）= Agent 第一人称的**自我表达**（react_to_interaction, share_thought, recall_experience...）
- 两者服务完全不同的目的，不是简单的新旧替代

**结论**：GM → AgenticExecutor 迁移延迟到 Phase 4c，需要先实装 GM 沉浸式工具替代 V4 业务逻辑。

### 2. Teammate 迁移 (B1)

**旧路径**：`TeammateAgenticToolRegistry`（3 工具）→ `llm_service.agentic_generate()`
**新路径**：`AgenticExecutor` + `RoleRegistry(role="teammate")` → 沉浸式工具

工具映射：
| 旧工具 | 新工具 | 说明 |
|--------|--------|------|
| update_my_disposition(target_id, deltas) | react_to_interaction(dimension, level, is_positive, reason) | FEELING_MAP 自然语言替代原始 deltas |
| recall_my_memory(seeds) | recall_experience(seeds) | recall_for_role(role="teammate") 限定 character+camp+location |
| choose_my_combat_action(action_id) | extra_tool: choose_battle_action(action_id) | 需 flash_cpu MCP，通过 extra_tools 注入 |

**战斗工具设计**：`choose_battle_action` 需要 flash_cpu MCP 访问，但 AgenticContext 不应持有 flash_cpu。解决方案：工厂函数 `_make_combat_action_tool()` 创建独立 callable，通过 `extra_tools` 参数注入。

**已删除**：`app/services/admin/teammate_agentic_tools.py`（302 行）

### 3. NPC /interact 端点 (B2)

全新功能，不影响现有代码。

**流程**：
```
Setup → NPC Agentic Response(必答) → GM Observer(可[PASS]) → Teammate Observer → Dialogue Options → Persist
```

设计要点：
- **顺序执行**：后续 Agent 需要看到前序 Agent 的回应
- **NPC 模型选择**：`node.properties.tier` / `node.state.is_essential` → main/secondary 模型
- **GM 观察者**：极简提示，默认 [PASS]，只在故事关键时刻介入
- **对话选项**：LLM 生成 4 个结构化 `DialogueOption`，失败回退通用选项
- **SceneBus 生命周期**：per-interaction clear，与主管线一致

新增模型：`InteractRequest`、`DialogueOption`（admin_protocol.py）
新增路由：`POST /{world_id}/sessions/{session_id}/interact/stream`

### 4. NPCReactor 简化 (B3)

**旧版**：NPC 相关度计算 + LLM 反应生成（Passerby 模型）
**新版**：NPC 相关度推荐 + 模板反应（无 LLM 调用）

简化原因：
- NPC 深度交互现在走 `/interact` 端点（使用沉浸式工具）
- NPCReactor 的 LLM 反应功能与 /interact 端点重叠
- 模板反应是原有 fallback，作为轻量自主反应足够

构造函数：`__init__(self, world_graph=None)` — 删除 instance_manager, use_llm, llm_service 参数
新增方法：`get_relevant_npcs()` — 返回按相关度排序的 NPC 列表

## 文件变更汇总

### 新增
| 文件 | 说明 |
|------|------|
| `tests/test_teammate_migration.py` | B1 迁移测试 (14 用例) |
| `tests/test_interact_endpoint.py` | B2 交互端点测试 (18 用例) |

### 修改
| 文件 | 说明 |
|------|------|
| `app/models/admin_protocol.py` | +InteractRequest, +DialogueOption |
| `app/routers/game_v2.py` | +interact_stream 路由 |
| `app/services/admin/admin_coordinator.py` | +process_interact_stream 委托 |
| `app/services/admin/pipeline_orchestrator.py` | +process_interact_stream, +_build_npc_system_prompt, +_select_npc_model, +_generate_dialogue_options; NPCReactor 构造简化 |
| `app/services/teammate_response_service.py` | _run_agentic_generation_payload 迁移到 AgenticExecutor |
| `app/services/npc_reactor.py` | 简化：删除 LLM 方法，新增 get_relevant_npcs |
| `tests/test_npc_reactor.py` | 删除 LLM 测试，新增 get_relevant_npcs 测试 |

### 删除
| 文件 | 行数 | 说明 |
|------|------|------|
| `app/services/admin/teammate_agentic_tools.py` | 302 | TeammateAgenticToolRegistry |
| `tests/test_teammate_agentic_tools.py` | ~100 | 旧工具测试 |

## Phase 4c 展望

| 任务 | 原因 |
|------|------|
| GM → AgenticExecutor | V4 26 工具含 ~500 行业务逻辑，immersive GM 工具多为 stub |
| V4AgenticToolRegistry 大规模缩减 | 需先实装 GM immersive 工具替代 V4 逻辑 |
| FlashCPU.agentic_process_v4() 废弃 | 依赖 GM 迁移完成 |
| 双重录制问题 | V4 工具自带 _timed()/_record()，AgenticExecutor 也录制 |
