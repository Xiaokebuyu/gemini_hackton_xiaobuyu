# 世界图数据模型设计

> 日期: 2026-02-14
> 分支: buyu的异世界冒险
> 父文档: `世界活图详细设计.md`
> 定位: Step C1 (models.py) 的完整规格，对标 BG3 级 CRPG
> 状态: 设计完成，待下一轮对话逐步实施

---

## 一、设计决策总表

### A. 章节-区域关系

| # | 决策 | 结论 |
|---|------|------|
| A1 | Z 轴层级 | `world → chapter → region → area → location → entities` |
| A2 | 叙事模型 | **叙事寓于空间** — 事件附着于区域，章节是区域故事的容器 |
| A3 | 章节与区域 | **多父引用** — 同一 region/area 可被多个 chapter 通过 CONTAINS 边引用 |
| A4 | 章节推进 | 图结构在 GraphBuilder 启动时全部建好，推进只改 state 不改结构 |
| A5 | tick 范围 | 从 `active_chapter` 向下遍历 `get_descendants()`，不评估全图 |
| A6 | scope chain | 向上遇到多父分支时，选 `state.status == "active"` 的 chapter |

### B. 节点字段

| # | 决策 | 结论 |
|---|------|------|
| B1 | parent_id | 移除，层级关系完全由 CONTAINS 边表达（支持多父） |
| B2 | monster/item/skill | **不进入 WorldGraph**，保留在 WorldInstance 静态注册表 |
| B3 | 玩家节点 | 玩家是 `type="player"` 的节点，与 NPC 共享角色字段 |
| B4 | 战斗属性 | 统一放在 node.state 中（D&D 5e 完整角色卡） |
| B5 | on_complete | 不保留为 properties，完全转换为 Behavior actions |
| B6 | D&D 字段完整度 | 对标 BG3，能加的全加（18技能/装备10格/法术系统/职业资源） |
| B7 | exhaustion | 单独字段 `exhaustion_level: int (0-6)`，不放 conditions 里 |
| B8 | region 层 | 新增 region 节点类型，位于 chapter 和 area 之间 |
| B9 | region behaviors | 架构天然支持（region 在 scope chain 上），数据层按需添加 |

### C. 事件生命周期

| # | 决策 | 结论 |
|---|------|------|
| C1 | 状态机 | 6 态: `locked / available / active / completed / failed / cooldown` |
| C2 | 激活方式 | 4 种基础设施全做: `npc_given / auto_enter / event_driven / discovery` |
| C3 | 可见性 | 显式 (explicit) + 隐式 (implicit)，基础设施先做 |
| C4 | 多阶段 | stages 内 objectives 可追踪（id/text/required），stage 推进用 Behavior |
| C5 | 分支结局 | **混合制**: 客观条件→Behavior 自动判定，玩家选择→LLM 工具调用 |
| C6 | 结局验证 | **Option B**: 每个 outcome 带 conditions，不满足则拒绝 |
| C7 | 失败触发 | 超时→Behavior / 条件破坏→Behavior / 叙事逻辑→LLM 工具 |
| C8 | 可重复事件 | event_def 级属性 `is_repeatable` + `repeat_cooldown` + 重置 Behavior |
| C9 | tick 过滤 | 不按 chapter_id 过滤，靠 status + once 标记自然隔离 |
| C10 | 跨事件因果 | 通过 event propagation + behavior 串联，无硬编码引用 |

### D. 导航与连接

| # | 决策 | 结论 |
|---|------|------|
| D1 | area 内移动 | town/field 自由移动，dungeon 必须走 CONNECTS 边 |
| D2 | 跨 region 连接 | 普通 CONNECTS 边，无特殊处理 |
| D3 | 快速旅行 | waypoint 机制 + 时间消耗 + 物资消耗 + 遭遇检定 |
| D4 | 营地导航 | 任意位置进入，记录 `return_location` |
| D5 | 触发粒度 | 三级: location + area + region，NPC 移动也触发 |
| D6 | 队友跟随 | 位置静默更新，不触发 ON_ENTER/ON_EXIT |
| D7 | 地牢 CONNECTS | 支持 one_way / hidden / requirements |
| D8 | 道路封锁 | CONNECTS 边属性 `blocked` + `blocked_reason` |
| D9 | 随机遭遇 | CONNECTS 边属性 `encounter_chance` + `encounter_table` |

---

## 二、图拓扑结构

### 2.1 Z 轴层级

```
Level 0: world_root (type=world)                      ← 全局唯一
Level 1: chapter_1, chapter_2, ..., camp               ← 叙事阶段 + 营地
Level 2: region_border, region_west, ...               ← 地理区域（新增层）
Level 3: frontier_town, goblin_cave, ...               ← 地图/区域
Level 4: guild_hall, tavern, cave_entrance, ...         ← 子地点
Level 5: npc_guild_girl, player, evt_goblin_quest, ... ← 实体（叶子节点）
```

### 2.2 多父引用

同一 region/area 可被多个 chapter 通过 CONTAINS 边引用：

```
chapter_1 ─[CONTAINS]→ region_border ─[CONTAINS]→ frontier_town
chapter_2 ─[CONTAINS]→ region_border  (同一个 region 节点，不是副本)
chapter_2 ─[CONTAINS]→ region_west    (新章节独有的新区域)
```

**规则**：
- 图结构在 GraphBuilder 启动时全部建好（所有章节的 CONTAINS 边一次性创建）
- 章节推进只改 `chapter.state.status`，不增删边
- 多父分支的 scope chain：向上时选 `status == "active"` 的 chapter

### 2.3 章节推进机制

```
chapter_1.state.status = "completed"
chapter_2.state.status = "active"
world_root.state.active_chapter = "chapter_2"

tick 活跃范围 = get_descendants("chapter_2")
  → 包含 chapter_2 下所有 region / area / location / entity
  → 包含被 chapter_2 引用的旧区域（如 region_border）及其后代
  → 旧章节的 completed 事件因 once=true 已消耗，不会重复触发
```

### 2.4 完整拓扑示例

```
world_root (type=world)
  │ state: {active_chapter: "ch_1_1", game_day: 1, game_hour: 8}
  │
  ├─ [CONTAINS] → ch_1_1 (type=chapter)
  │   │ properties: {name: "序章", order: 0, mainline_id: "vol_1",
  │   │              required_events: ["evt_goblin_quest", "evt_guild_intro"]}
  │   │ state: {status: "active", round_count: 0}
  │   │ behaviors: [{ON_TICK: all required_events completed → status="completed" + emit chapter_complete}]
  │   │
  │   ├─ [CONTAINS] → region_border (type=region)
  │   │   │ properties: {name: "边境地区", danger_level: "low"}
  │   │   │ state: {accessible: true, discovered: true}
  │   │   │
  │   │   ├─ [CONTAINS] → frontier_town (type=area)
  │   │   │   │ properties: {area_type: "town", free_movement: true, atmosphere: "喧闹"}
  │   │   │   │ state: {visited: true, visit_count: 3}
  │   │   │   │
  │   │   │   ├─ [CONTAINS] → guild_hall (type=location)
  │   │   │   │   │ properties: {interaction_type: "quest", is_waypoint: true}
  │   │   │   │   ├─ [HOSTS, role="resident"] → npc_guild_girl (type=npc)
  │   │   │   │   └─ [HOSTS, role="visitor"]  → npc_goblin_slayer (type=npc)
  │   │   │   │
  │   │   │   ├─ [CONTAINS] → tavern (type=location)
  │   │   │   │   └─ [HOSTS, role="merchant"] → npc_barkeeper (type=npc)
  │   │   │   │
  │   │   │   ├─ [HAS_EVENT] → evt_goblin_quest (type=event_def)
  │   │   │   │     properties: {chapter_id: "ch_1_1", activation_type: "npc_given",
  │   │   │   │                  visibility: "explicit", stages: [...], outcomes: {...}}
  │   │   │   │     state: {status: "available", discovered: true}
  │   │   │   │
  │   │   │   └─ [HAS_EVENT] → evt_ch2_new_threat (type=event_def)
  │   │   │         properties: {chapter_id: "ch_1_2"}
  │   │   │         state: {status: "locked"}  ← ch_1_2 的事件，当前章节不激活
  │   │   │
  │   │   └─ [CONTAINS] → goblin_cave (type=area)
  │   │       │ properties: {area_type: "dungeon", free_movement: false, danger_level: "medium"}
  │   │       ├─ [CONTAINS] → cave_entrance (type=location)
  │   │       │   └─ [CONNECTS, direction="both"] → narrow_tunnel
  │   │       ├─ [CONTAINS] → narrow_tunnel (type=location)
  │   │       │   └─ [CONNECTS, direction="both"] → boss_chamber
  │   │       └─ [CONTAINS] → boss_chamber (type=location)
  │   │               properties: {lighting: "dark"}
  │   │
  │   └─ [CONNECTS, travel_time_hours=0.5] ← frontier_town ↔ goblin_cave
  │
  ├─ [GATE, conditions={...}] → ch_1_2 (type=chapter)
  │   │ state: {status: "locked"}
  │   ├─ [CONTAINS] → region_border   ← 同一个 region，多父引用！
  │   └─ [CONTAINS] → region_west (type=region)
  │       └─ [CONTAINS] → elf_forest (type=area)  ← 新章节独有区域
  │
  ├─ camp (type=camp)
  │   │ state: {supplies: 10, morale: "normal"}
  │   ├─ [MEMBER_OF] → player (type=player)
  │   │     state: {level: 1, hp: 25, max_hp: 25, current_location: "guild_hall", ...}
  │   ├─ [MEMBER_OF] → teammate_priestess (type=npc)
  │   │     properties: {tier: "main", ai_combat_personality: "support"}
  │   │     state: {level: 1, hp: 20, max_hp: 20, mood: "focused"}
  │   └─ [MEMBER_OF] → teammate_high_elf (type=npc)
  │
  └─ [RELATES_TO, type="ally", strength=0.8] ← npc_guild_girl ↔ npc_goblin_slayer
```

---

## 三、节点类型字段规格

> 所有字段通过 `WorldNode.properties: Dict` 和 `WorldNode.state: Dict` 存储。
> 下表列出每种 type 的约定字段——不是强制 schema，是数据规范。

### 3.1 `world` — 根节点（全图唯一）

| 归属 | 字段 | 类型 | 说明 |
|------|------|------|------|
| properties | name | str | 世界名称 |
| properties | description | str | 世界描述 |
| state | active_chapter | str | 当前活跃章节 ID |
| state | game_day | int | 游戏日 |
| state | game_hour | int | 小时 (0-23) |
| state | game_minute | int | 分钟 (0-59) |
| state | world_flags | dict[str, Any] | 决策标记 `{"killed_npc_a": true}` |
| state | faction_reputations | dict[str, int] | 阵营声望 `{"adventurer_guild": 50}` |
| state | party_gold | int | 队伍金币 |

### 3.2 `chapter` — 叙事阶段

| 归属 | 字段 | 类型 | 说明 |
|------|------|------|------|
| properties | name | str | 章节名 |
| properties | order | int | 章节顺序 |
| properties | mainline_id | str | 所属卷 (vol_1, vol_2...) |
| properties | description | str | 章节概述 |
| properties | objectives | list[str] | 目标描述列表 |
| properties | required_events | list[str] | 需完成的 event_def ID |
| properties | pacing | dict | `{min_rounds, ideal_rounds, max_rounds, stall_threshold, hint_escalation}` |
| properties | tags | list[str] | 标签 |
| state | status | str | `locked` / `active` / `completed` |
| state | started_at | Optional[str] | 激活时间 |
| state | completed_at | Optional[str] | 完成时间 |
| state | round_count | int | 本章已过回合数 |

### 3.3 `region` — 地理区域

| 归属 | 字段 | 类型 | 说明 |
|------|------|------|------|
| properties | name | str | 区域名 |
| properties | description | str | 描述 |
| properties | danger_level | str | `low` / `medium` / `high` / `extreme` |
| state | accessible | bool | 是否可进入 |
| state | discovered | bool | 玩家是否已发现 |

### 3.4 `area` — 地图

| 归属 | 字段 | 类型 | 说明 |
|------|------|------|------|
| properties | name | str | 地图名 |
| properties | description | str | 描述 |
| properties | atmosphere | str | 氛围描述 |
| properties | danger_level | str | `low` / `medium` / `high` / `extreme` |
| properties | key_features | list[str] | 地标 `["冒险者公会", "碎盾工坊"]` |
| properties | available_actions | list[str] | `["购物", "休息", "接任务"]` |
| properties | area_type | str | `town` / `field` / `dungeon` / `wilderness` / `camp` |
| properties | free_movement | bool | `true`=内部自由移动, `false`=走 CONNECTS 边 |
| state | accessible | bool | 是否可进入 |
| state | discovered | bool | 玩家是否已发现 |
| state | visited | bool | 是否访问过 |
| state | visit_count | int | 访问次数 |
| state | alert_level | str | `normal` / `cautious` / `high` / `lockdown` |
| state | environmental_effects | list[str] | `["大雾", "暴风雨"]` |

### 3.5 `location` — 子地点

| 归属 | 字段 | 类型 | 说明 |
|------|------|------|------|
| properties | name | str | 地点名 |
| properties | description | str | 描述 |
| properties | interaction_type | str | `quest` / `rest` / `shop` / `visit` / `dungeon` |
| properties | available_actions | list[str] | 可用行动 |
| properties | passerby_spawn_rate | float | 路人生成率 0.0-1.0 |
| properties | is_rest_point | bool | 可否休息 |
| properties | is_waypoint | bool | 快速旅行点 |
| properties | has_merchant | bool | 有商人 |
| properties | lighting | str | `bright` / `dim` / `dark` |
| properties | terrain | str | `normal` / `difficult` / `hazardous` |
| state | visited | bool | 是否访问过 |
| state | visit_count | int | 访问次数 |
| state | discovered | bool | 隐藏地点需感知检定发现 |
| state | is_locked | bool | 需要开锁或钥匙 |
| state | trap | Optional[dict] | `{type, dc, damage, detected, disarmed}` |
| state | loot_containers | list[dict] | `[{id, items, opened}]` |

### 3.6 角色共用字段（player + npc 共享）

> 完整 D&D 5e 角色卡。player 和 npc 类型的节点都包含这些字段。

**Properties（静态/半静态）：**

| 字段 | 类型 | 说明 |
|------|------|------|
| name | str | 名称 |
| race | str | 种族: 人类/精灵/矮人/半身人/兽人/... |
| subrace | Optional[str] | 亚种: 高等精灵/木精灵/... |
| character_class | str | 职业: fighter/priest/mage/ranger/rogue/... |
| subclass | Optional[str] | 子职业: 战斗大师/生命领域/... |
| background | Optional[str] | 背景: 侍僧/士兵/罪犯/贵族/... |
| alignment | Optional[str] | 阵营: lawful_good/neutral/chaotic_evil/... |
| appearance | str | 外貌描述 |
| backstory | str | 背景故事 |
| occupation | str | 职业称号 |
| age | Optional[int] | 年龄 |
| tags | list[str] | 标签 `["治愈者", "主角团"]` |
| aliases | list[str] | 别名 |
| racial_traits | list[str] | 种族特性 `["黑暗视觉", "精灵敏锐感官"]` |
| weapon_proficiencies | list[str] | 武器熟练 `["简单武器", "军用武器"]` |
| armor_proficiencies | list[str] | 护甲熟练 `["轻甲", "中甲", "盾牌"]` |
| tool_proficiencies | list[str] | 工具熟练 `["盗贼工具"]` |
| languages | list[str] | 语言 `["通用语", "精灵语"]` |

**State（可变）：**

| 字段 | 类型 | 说明 |
|------|------|------|
| level | int | 等级 |
| xp | int | 经验值 |
| abilities | dict | `{str: int, dex: int, con: int, int: int, wis: int, cha: int}` |
| hp | int | 当前生命值 |
| max_hp | int | 最大生命值 |
| temp_hp | int | 临时生命值 |
| hit_dice_remaining | int | 剩余生命骰（短休恢复用） |
| ac | int | 护甲等级 |
| speed | int | 移动速度 (feet) |
| proficiency_bonus | int | 熟练加值 (等级决定: 2-6) |
| initiative_bonus | int | 先攻加值 |
| skill_proficiencies | list[str] | 熟练技能 |
| skill_expertise | list[str] | 专精技能（双倍熟练加值） |
| saving_throw_proficiencies | list[str] | 豁免熟练 `["str", "con"]` |
| resistances | list[str] | 伤害抗性 `["fire", "poison"]` |
| vulnerabilities | list[str] | 伤害易伤 `["radiant"]` |
| immunities | list[str] | 伤害免疫 |
| condition_immunities | list[str] | 状态免疫 `["frightened"]` |
| equipment | dict | 装备栏（见下表） |
| inventory | list[dict] | 背包 `[{item_id, quantity}]` |
| attunement_slots | list[str] | 已协调魔法物品 (最多 3) |
| spells_known | list[str] | 已知法术 (skill_id) |
| spells_prepared | list[str] | 已准备法术 |
| cantrips | list[str] | 戏法（无限次） |
| spell_slots_max | dict[int, int] | 各环最大法术位 `{1: 4, 2: 3}` |
| spell_slots_used | dict[int, int] | 已消耗法术位 `{1: 1}` |
| spell_save_dc | int | 法术豁免 DC |
| spell_attack_bonus | int | 法术攻击加值 |
| concentration | Optional[str] | 当前专注法术 |
| class_features | list[str] | 已获得职业特性 |
| class_resources | dict[str, dict] | 职业资源 `{"rage": {max: 3, used: 1}}` |
| conditions | list[str] | 状态效果 `["poisoned", "blessed"]` |
| exhaustion_level | int | 力竭等级 (0-6) |
| is_alive | bool | 存活 |
| death_saves | dict | `{successes: 0, failures: 0}` |
| is_conscious | bool | 是否清醒 (hp > 0) |
| current_location | str | 当前 location 节点 ID |

**Equipment 装备栏（10 格，BG3 标准）：**

```
equipment: {
    main_hand:  Optional[str]    # 主手武器
    off_hand:   Optional[str]    # 副手/盾牌
    armor:      Optional[str]    # 身体护甲
    helmet:     Optional[str]    # 头盔
    cloak:      Optional[str]    # 披风
    gloves:     Optional[str]    # 手套
    boots:      Optional[str]    # 靴子
    amulet:     Optional[str]    # 项链
    ring_1:     Optional[str]    # 戒指 1
    ring_2:     Optional[str]    # 戒指 2
}
```

### 3.7 `npc` 专有字段（在共用字段基础上）

**Properties 新增：**

| 字段 | 类型 | 说明 |
|------|------|------|
| tier | str | `main` / `secondary` / `passerby` |
| personality | str | 性格描述 |
| speech_pattern | str | 说话方式 |
| example_dialogue | str | 示例台词 |
| importance | float | 叙事权重 0.0-1.0 |
| relationships | dict[str, str] | `{char_id: "拯救者、导师"}` |
| personal_quest_id | Optional[str] | 个人任务线 event_def ID |
| faction_id | Optional[str] | 所属阵营 |
| ai_combat_personality | str | `aggressive` / `defensive` / `support` / `tactical` / `cowardly` |
| schedule_table | Optional[dict] | `{morning: "guild_hall", evening: "tavern", night: "home"}` |

**State 新增：**

| 字段 | 类型 | 说明 |
|------|------|------|
| mood | str | `cheerful` / `neutral` / `angry` / `sad` / `frightened` |
| schedule | str | 当前作息阶段 `morning` / `afternoon` / `evening` / `night` |
| dispositions | dict[str, dict] | 好感度系统（多维度，见下方） |
| romance_stage | Optional[str] | `none` / `interested` / `active` / `committed` / `rejected` |
| is_hostile | bool | 是否敌对 |
| is_essential | bool | 是否不可杀死（关键 NPC 保护） |
| dialogue_flags | dict[str, bool] | `{"introduced": true, "knows_secret": false}` |

**好感度系统（dispositions）：**

```
dispositions: {
    "player": {
        "approval": 0,       # 总体认可度 (-100 ~ +100, BG3 式)
        "trust": 0,          # 信任
        "fear": 0,           # 畏惧
        "respect": 0,        # 尊重
        "affection": 0       # 好感/爱慕
    }
}
```

### 3.8 `player` 专有字段（在共用字段基础上）

> player 的 properties 几乎为空（玩家属性全在 state 中，都可变）。

**State 新增：**

| 字段 | 类型 | 说明 |
|------|------|------|
| inspiration | bool | 灵感点 |
| active_quests | list[str] | 当前追踪的 event_def ID |
| completed_quests | list[str] | 已完成任务 |
| failed_quests | list[str] | 已失败任务 |
| discovered_locations | list[str] | 已发现的 location ID |
| known_recipes | list[str] | 已学会的配方 |
| rest_state | dict | `{last_long_rest_day, last_short_rest_day, short_rests_today}` |

### 3.9 `event_def` — 故事事件

**Properties：**

| 字段 | 类型 | 说明 |
|------|------|------|
| name | str | 任务名 |
| description | str | 玩家可见的任务描述 |
| chapter_id | str | 所属章节 |
| is_required | bool | 章节必需 |
| importance | str | `main` / `side` / `personal` / `flavor` |
| narrative_directive | str | 给 LLM 的叙事指令（玩家不可见） |
| activation_type | str | `npc_given` / `auto_enter` / `event_driven` / `discovery` |
| visibility | str | `explicit`（任务日志可见）/ `implicit`（隐藏至发现） |
| discovery_check | Optional[dict] | `{"skill": "perception", "dc": 15}` |
| quest_giver | Optional[str] | 任务发起 NPC 节点 ID |
| recommended_level | Optional[int] | 建议等级 |
| time_limit | Optional[int] | 回合限制（null=无限制） |
| related_events | list[str] | 前置/后续 event_def ID |
| stages | list[EventStage] | 多阶段任务（见 3.9.1） |
| outcomes | dict[str, EventOutcome] | 分支结局（见 3.9.2） |
| is_repeatable | bool | 是否可重复 |
| repeat_cooldown | int | 重复冷却回合数 |

**State：**

| 字段 | 类型 | 说明 |
|------|------|------|
| status | str | `locked` / `available` / `active` / `completed` / `failed` / `cooldown` |
| discovered | bool | 玩家是否已发现（implicit 任务用） |
| current_stage | Optional[str] | 当前阶段 ID |
| stage_progress | dict[str, bool] | `{stage_id: completed}` |
| objective_progress | dict[str, bool] | `{objective_id: completed}` |
| outcome | Optional[str] | 完成/失败时的结局 key |
| started_at | Optional[str] | 开始时间 |
| completed_at | Optional[str] | 完成时间 |
| rounds_elapsed | int | 已耗回合 |
| repeat_count | int | 已完成次数（可重复事件用） |

#### 3.9.1 EventStage

```python
class EventStage(BaseModel):
    id: str                                # "stage_1"
    name: str                              # "找到哥布林巢穴入口"
    description: str                       # 阶段描述
    narrative_directive: str               # 给 LLM 的指令
    objectives: list[EventObjective]       # 可追踪目标
    completion_conditions: ConditionGroup  # 阶段完成条件
```

#### 3.9.2 EventObjective

```python
class EventObjective(BaseModel):
    id: str                                # "obj_ask_guild"
    text: str                              # "询问公会情报"
    required: bool                         # true=必须完成, false=可选
    completion_hint: str                   # 给 LLM: "当玩家与公会柜台交谈后标记完成"
```

#### 3.9.3 EventOutcome

```python
class EventOutcome(BaseModel):
    description: str                       # "成功清除了哥布林巢穴"
    conditions: Optional[ConditionGroup]   # 验证条件（LLM 调用时必须满足）
    rewards: dict                          # {xp: int, gold: int, items: list[str]}
    reputation_changes: dict[str, int]     # {"adventurer_guild": +10}
    unlock_events: list[str]               # 解锁的 event_def ID
    world_flags: dict[str, Any]            # {"goblin_nest_cleared": true}
    narrative_hint: str                    # 结局叙事指令
```

### 3.10 `camp` — 营地（全图唯一）

| 归属 | 字段 | 类型 | 说明 |
|------|------|------|------|
| properties | name | str | "营地" |
| state | supplies | int | 物资（长休消耗） |
| state | morale | str | `high` / `normal` / `low` / `critical` |
| state | rest_available | bool | 当前是否可休息 |
| state | camp_events_triggered | list[str] | 已触发的营地事件 |
| state | upgrade_level | int | 营地等级 |
| state | facilities | list[str] | `["篝火", "简易工坊", "祭坛"]` |
| state | return_location | str | 进营地前的 location ID |
| state | return_area | str | 进营地前的 area ID |

---

## 四、边类型与属性

### 4.1 WorldEdgeType 枚举

```python
class WorldEdgeType(str, Enum):
    CONTAINS = "contains"          # 层级包含 (world→chapter→region→area→location)
    CONNECTS = "connects"          # 区域/地点连接
    HOSTS = "hosts"                # 实体驻扎 (location→npc)
    HAS_EVENT = "has_event"        # 事件归属 (area→event_def)
    HAS_ITEM = "has_item"          # 物品放置 (location→item_instance)
    MEMBER_OF = "member_of"        # 成员关系 (npc→camp)
    GATE = "gate"                  # 章节门控 (chapter→chapter)
    RELATES_TO = "relates_to"      # 角色关系 (npc↔npc)
```

### 4.2 各边类型携带属性

**CONTAINS** — 纯结构

```python
# 无额外属性
{"relation": "contains"}
```

**CONNECTS (area ↔ area)** — 区域间连接

```python
{
    "relation": "connects",
    "travel_time": "30分钟",             # 旅行时间（显示用）
    "travel_time_hours": 0.5,            # 旅行时间（计算用）
    "connection_type": "walk",           # walk / travel / sail / climb / teleport
    "danger": "safe",                    # safe / risky / deadly
    "requirements": None,               # Optional[ConditionGroup] 通行条件
    "encounter_chance": 0.0,             # 遭遇概率 0.0-1.0
    "encounter_table": None,             # Optional[str] 遭遇表 ID
    "blocked": False,                    # 是否封锁
    "blocked_reason": "",                # 封锁原因
    "bidirectional": True,               # 双向通行
    # 事件传播衰减
    "propagation": {
        "up": 0.8, "down": 0.6, "horizontal": 0.5,
        "filter": []                     # 只传播匹配的事件类型
    }
}
```

**CONNECTS (location ↔ location)** — 地牢内连接

```python
{
    "relation": "connects",
    "direction": "both",                 # both / one_way
    "requirements": None,               # Optional[ConditionGroup] 开锁/检定
    "is_hidden": False,                  # 隐藏通道
    "discovery_check": None,             # Optional: {"skill": "perception", "dc": 14}
}
```

**HOSTS** — 实体驻扎

```python
{"relation": "hosts", "role": "resident"}   # resident / visitor / merchant / guard
```

**HAS_EVENT** — 事件归属

```python
{"relation": "has_event"}   # 无额外属性
```

**HAS_ITEM** — 物品放置

```python
{"relation": "has_item"}    # 无额外属性
```

**MEMBER_OF** — 成员关系

```python
{"relation": "member_of", "role": "member"}   # leader / member
```

**GATE** — 章节门控

```python
{
    "relation": "gate",
    "conditions": {...},                 # ConditionGroup 门控条件
    "priority": 0,                       # 多个 GATE 的优先级
    "narrative_hint": "随着冒险的深入..." # 过渡叙事提示
}
```

**RELATES_TO** — 角色关系

```python
{
    "relation": "relates_to",
    "relationship_type": "ally",         # ally / enemy / mentor / family / romantic
    "description": "拯救者、导师",
    "strength": 0.8                      # 关系强度 0.0-1.0
}
```

---

## 五、行为系统模型

### 5.1 TriggerType

```python
class TriggerType(str, Enum):
    ON_TICK = "on_tick"                   # 每回合评估
    ON_ENTER = "on_enter"                 # 实体进入此节点作用域
    ON_EXIT = "on_exit"                   # 实体离开此节点作用域
    ON_EVENT = "on_event"                 # 收到传播来的 WorldEvent
    ON_STATE_CHANGE = "on_state_change"   # 自身或子节点 state 变化
    ON_DISPOSITION = "on_disposition"      # 好感度越过阈值
    ON_TIME = "on_time"                   # 游戏时间满足条件
```

### 5.2 ActionType

```python
class ActionType(str, Enum):
    EMIT_EVENT = "emit_event"             # 发射 WorldEvent（触发传播）
    CHANGE_STATE = "change_state"         # 修改目标节点的 state
    NARRATIVE_HINT = "narrative_hint"      # 注入叙事指令给 LLM
    SPAWN = "spawn"                       # 创建新节点
    REMOVE = "remove"                     # 移除节点
    CHANGE_EDGE = "change_edge"           # 修改边属性
```

### 5.3 Action

```python
class Action(BaseModel):
    type: ActionType
    target: str = "self"                  # 目标节点 ID / "self" / "parent" / "player"
    params: Dict[str, Any] = {}

# params 按 ActionType:
#
# EMIT_EVENT:      {event_type, data, visibility}
# CHANGE_STATE:    {updates: Dict, merge: bool=True}
# NARRATIVE_HINT:  {text, priority: "high"/"normal"/"low"}
# SPAWN:           {node: WorldNode(partial), parent: str}
# REMOVE:          (无，target 即要删除的节点)
# CHANGE_EDGE:     {source, target, updates: Dict}
```

### 5.4 Behavior

```python
class Behavior(BaseModel):
    id: str
    trigger: TriggerType

    # 触发器专用过滤器
    event_filter: Optional[str] = None        # ON_EVENT: 事件类型 "combat_started"
    disposition_filter: Optional[dict] = None  # ON_DISPOSITION: {"dimension": "trust", "gte": 50}
    watch_key: Optional[str] = None           # ON_STATE_CHANGE: 监听的 state key

    # 条件 — 完全复用 ConditionGroup (8+1 条件类型)
    conditions: Optional[ConditionGroup] = None

    # 动作
    actions: list[Action]

    # 控制
    priority: int = 0                          # 同 tick 内执行顺序
    once: bool = False                         # 触发一次后永久禁用
    cooldown_ticks: int = 0                    # 冷却回合数
    enabled: bool = True                       # 可动态开关

    # 运行时状态（存在 node.state 中，非 Behavior 本身）
    # node.state.behavior_fired: list[str]     — once 类型已触发的 behavior ID
    # node.state.behavior_cooldowns: dict      — {behavior_id: remaining_ticks}
```

### 5.5 WorldEvent

```python
class WorldEvent(BaseModel):
    event_id: str = Field(default_factory=lambda: f"we_{uuid4().hex[:8]}")
    event_type: str                       # combat_started / quest_completed / ...
    origin_node: str                      # 事件发生的节点 ID
    timestamp: datetime
    game_day: int = 0
    game_hour: int = 0
    actor: str = ""                       # 发起者 "player" / npc_id
    data: Dict[str, Any] = {}

    # 传播控制
    visibility: str = "scope"             # "local" / "scope" / "global"
    strength: float = 1.0                 # 初始强度
    min_strength: float = 0.1             # 停止传播阈值
```

### 5.6 TickContext

```python
class TickContext(BaseModel):
    session: Any                          # SessionRuntime
    phase: str = "pre"                    # "pre" (A4) / "post" (C1)
    player_location: str = ""             # 当前 location 节点 ID
    game_day: int = 1
    game_hour: int = 8
    active_chapter: str = ""
    party_members: list[str] = []         # 队友节点 ID
    events_triggered: list[str] = []      # 本 session 已触发事件
    objectives_completed: list[str] = []
    round_count: int = 0
```

---

## 六、事件生命周期

### 6.1 状态机

```
                    ┌──────────────────────────────────┐
                    │                                  │
                    ▼                                  │ is_repeatable
                 LOCKED                                │ && cooldown 到
                    │                                  │
                    │ unlock behavior                   │
                    │ (ON_TICK conditions met)          │
                    ▼                                  │
               AVAILABLE ──────────────────────────── COOLDOWN
                    │                                  ▲
                    │ activation (4种方式)              │
                    ▼                                  │
                 ACTIVE                                │
                    │                                  │
          ┌────────┼────────┐                          │
          ▼        ▼        ▼                          │
      stage 1 → stage 2 → stage N                     │
       (objectives tracked per stage)                  │
          │        │        │                          │
          └────────┼────────┘                          │
                   │                                   │
          ┌────────┴────────┐                          │
          │                 │                          │
          ▼                 ▼                          │
      COMPLETED          FAILED                        │
      (outcome=X)       (outcome="failure")            │
          │                 │                          │
          │  is_repeatable? │                          │
          └────────┬────────┘                          │
                   │ yes                               │
                   └───────────────────────────────────┘
```

### 6.2 四种激活方式

| 方式 | 说明 | 机制 |
|------|------|------|
| `npc_given` | 从 NPC 对话中接取 | LLM 工具调用 `activate_event()` |
| `auto_enter` | 进入区域/地点自动激活 | ON_ENTER behavior |
| `event_driven` | 被其他事件/剧情强制激活 | ON_EVENT behavior |
| `discovery` | 探索发现型（需检定） | ON_ENTER + 感知检定 → discovered=true → LLM 激活 |

### 6.3 多阶段推进

每个 stage 转换 = 一个 Behavior (once=true)：

```
Behavior(id="evt_goblin_quest_stage1to2",
         trigger=ON_TICK,
         conditions={status=="active" AND stage_1.completion_conditions},
         actions=[change_state(current_stage="stage_2")],
         once=True)
```

stage 内的 objectives 各自独立追踪：
```
stage.objectives = [
    {id: "obj_1", text: "询问公会情报", required: true},
    {id: "obj_2", text: "询问猎人线索", required: false},
]
event_def.state.objective_progress = {"obj_1": false, "obj_2": true}
```

### 6.4 分支结局

**混合制**：

| 判定方式 | 例子 | 机制 |
|---------|------|------|
| Behavior 自动 | 时间耗尽→failure / 怪物全灭→victory | ON_TICK / ON_EVENT behavior |
| LLM 工具调用 | 杀死 vs 放走哥布林（玩家选择） | `complete_event(event_id, outcome)` |

**结局验证**: 每个 outcome 带 `conditions: ConditionGroup`，LLM 调用时必须满足，否则拒绝。

### 6.5 失败触发

| 路径 | 例子 | 机制 |
|------|------|------|
| 超时 | 回合限制到了 | Behavior ON_TICK: rounds_elapsed >= time_limit |
| 条件破坏 | 任务 NPC 死了 | Behavior ON_EVENT: entity_killed(quest_giver) |
| LLM 判定 | 玩家主动放弃 | 工具调用 `fail_event(event_id, reason)` |

### 6.6 可重复事件

```
event_def.properties:
  is_repeatable: true
  repeat_cooldown: 24     # 回合

完成后 → status="cooldown"
冷却到期 → 重置 Behavior 触发：
  status="available", current_stage=null, stage_progress={},
  objective_progress={}, outcome=null, rounds_elapsed=0
  + 重新启用所有 once behaviors
```

### 6.7 跨事件因果

通过 event propagation 串联，不硬编码：

```
evt_bar_brawl 完成
  → emit_event("combat_ended")
  → 传播到 frontier_town 下所有节点
  → goblin_scout.behavior ON_EVENT: combat_ended → fled=true + emit "scout_escaped"
  → evt_goblin_quest.behavior ON_EVENT: scout_escaped → narrative_hint("探子趁乱逃走...")
```

### 6.8 tick 过滤

不按 chapter_id 过滤事件。tick 遍历 active_chapter 的所有后代，事件的自然隔离靠：
- `status == "completed"` 的事件不重新触发（once behaviors 已消耗）
- 新章节的事件初始 `status == "locked"`，等待 unlock behavior

---

## 七、导航模型

### 7.1 area 内移动

| area_type | free_movement | 规则 |
|-----------|---------------|------|
| town / field / wilderness | true | location 间自由移动，无需 CONNECTS 边 |
| dungeon / cave / ruins | false | 必须沿 CONNECTS 边移动（线性/分支拓扑） |

### 7.2 area 间移动

通过 CONNECTS 边，携带 travel_time、danger、encounter_chance、blocked 等属性。

### 7.3 快速旅行

```
条件:
  1. 当前位置的 location.is_waypoint == true
  2. 目标是 discovered == true 的 waypoint
  3. 没有战斗/事件锁定

触发时:
  - game_time += CONNECTS.travel_time_hours
  - camp.supplies -= travel_cost（旅途消耗）
  - roll CONNECTS.encounter_chance → 可能中断
  - ON_EXIT 当前 location + area (+ region if changed)
  - ON_ENTER 目标 area (+ region if changed) + location
  - 中间区域的触发器不触发
```

### 7.4 营地导航

```
进入营地:
  - 任何位置都可以 → camp 节点
  - camp.state.return_location = player 当前 location
  - camp.state.return_area = player 当前 area

离开营地:
  - 返回 return_location
  - ON_ENTER 触发（如果有新的 behaviors）
```

### 7.5 ON_ENTER / ON_EXIT 触发规则

**触发粒度: 三级**

```
跨区域移动 (guild_hall@frontier_town → cave_entrance@goblin_cave):
  1. ON_EXIT  guild_hall      (location 级)
  2. ON_EXIT  frontier_town   (area 级)
  3. ON_EXIT  region_border   (region 级，仅换 region 时)
  4. ON_ENTER region_xxx      (region 级，仅换 region 时)
  5. ON_ENTER goblin_cave     (area 级)
  6. ON_ENTER cave_entrance   (location 级)

同 area 内移动 (guild_hall → tavern):
  1. ON_EXIT  guild_hall      (location 级)
  2. ON_ENTER tavern          (location 级)
  — area/region 级不触发
```

**实体规则**:
- 玩家移动：触发所有 ON_ENTER/ON_EXIT
- NPC 移动（日程等）：也触发 ON_ENTER/ON_EXIT（entity_id 区分）
- 队友跟随：current_location 静默更新，**不触发**

---

## 八、D&D 5e 参考常量

> 实现时放在 `app/world/constants.py`。具体数值表（职业模板、法术位进度、XP 表）待后续填充。

```python
ABILITY_SCORES = ["str", "dex", "con", "int", "wis", "cha"]

SKILLS = {
    "athletics": "str",
    "acrobatics": "dex", "sleight_of_hand": "dex", "stealth": "dex",
    "arcana": "int", "history": "int", "investigation": "int",
    "nature": "int", "religion": "int",
    "animal_handling": "wis", "insight": "wis", "medicine": "wis",
    "perception": "wis", "survival": "wis",
    "deception": "cha", "intimidation": "cha",
    "performance": "cha", "persuasion": "cha",
}

DAMAGE_TYPES = [
    "slashing", "piercing", "bludgeoning",
    "fire", "cold", "lightning", "thunder",
    "acid", "poison", "radiant", "necrotic",
    "force", "psychic",
]

CONDITIONS = [
    "blinded", "charmed", "deafened", "frightened",
    "grappled", "incapacitated", "invisible", "paralyzed",
    "petrified", "poisoned", "prone", "restrained",
    "stunned", "unconscious",
    # 增益
    "blessed", "hasted", "inspired", "shielded",
    "raging", "concentrating",
]

ALIGNMENTS = [
    "lawful_good", "neutral_good", "chaotic_good",
    "lawful_neutral", "true_neutral", "chaotic_neutral",
    "lawful_evil", "neutral_evil", "chaotic_evil",
]
```

---

## 九、世界模板格式

> 标准 CRPG 世界书格式。未来新的世界数据按此模板填充。

```yaml
# ===== world_config.yaml =====
world:
  name: str                    # 必填
  description: str             # 必填

# ===== chapters.yaml =====
chapters:
  - id: str                    # 必填, 如 "ch_1_1"
    mainline_id: str           # 必填, 如 "vol_1"
    name: str                  # 必填
    order: int                 # 必填
    description: str           # 必填
    objectives: [str]          # 必填, 至少 1 个
    required_events: [str]     # 必填, 引用 events 的 id
    pacing:                    # 必填
      min_rounds: int
      ideal_rounds: int
      max_rounds: int
      stall_threshold: int
      hint_escalation: [str]
    regions:                   # 必填, 本章涉及的区域
      - region_id: str
        is_new: bool           # 本章新开放 vs 延续上一章
    events:                    # 必填, 本章的故事节点
      - id: str                # 必填
        area_id: str           # 必填, 事件绑定到哪个 area
        name: str              # 必填
        description: str       # 必填
        importance: str        # 必填: main / side / personal / flavor
        narrative_directive: str   # 必填
        is_required: bool      # 必填
        activation_type: str   # 必填: npc_given / auto_enter / event_driven / discovery
        visibility: str        # 可选, 默认 "explicit"
        discovery_check: {skill: str, dc: int}   # 可选
        quest_giver: str       # 可选, character id
        time_limit: int        # 可选
        stages:                # 可选（单阶段任务可省略）
          - id: str
            name: str
            description: str
            narrative_directive: str
            objectives:
              - id: str
                text: str
                required: bool
                completion_hint: str
            completion_conditions: ConditionGroup
        outcomes:              # 必填（至少一个结局）
          outcome_key:
            description: str
            conditions: ConditionGroup   # 可选（null=无条件）
            rewards: {xp: int, gold: int, items: [str]}
            reputation_changes: {faction_id: int}
            unlock_events: [str]
            world_flags: {key: value}
            narrative_hint: str
        is_repeatable: bool    # 可选, 默认 false
        repeat_cooldown: int   # 可选, 默认 0
    transitions:               # 必填, 章节间门控
      - target_chapter_id: str
        conditions: ConditionGroup
        priority: int
        narrative_hint: str

# ===== regions.yaml =====
regions:
  - id: str                    # 必填
    name: str                  # 必填
    description: str           # 必填
    danger_level: str          # 必填: low / medium / high / extreme
    areas:                     # 必填
      - id: str                # 必填
        name: str              # 必填
        description: str       # 必填
        atmosphere: str        # 可选
        danger_level: str      # 可选, 继承 region
        area_type: str         # 必填: town / dungeon / field / wilderness
        key_features: [str]    # 可选
        available_actions: [str]  # 可选
        connections:           # 可选
          - target_area_id: str
            travel_time: str
            travel_time_hours: float
            connection_type: str
            danger: str
            encounter_chance: float
        locations:             # 必填, 至少 1 个
          - id: str
            name: str
            description: str
            interaction_type: str
            available_actions: [str]
            resident_npcs: [character_id]
            is_rest_point: bool
            is_waypoint: bool
            has_merchant: bool
            lighting: str
            passerby_spawn_rate: float
            # 地牢专用: location 间连接
            connects_to:       # 可选 (area_type=dungeon 时使用)
              - target_location_id: str
                direction: str
                requirements: ConditionGroup
                is_hidden: bool

# ===== characters.yaml =====
characters:
  - id: str                    # 必填
    name: str                  # 必填
    tier: str                  # 必填: main / secondary / passerby
    race: str                  # 必填
    character_class: str       # 必填
    default_location: str      # 必填, location id
    personality: str           # 必填（不可为空！）
    speech_pattern: str        # 必填
    appearance: str            # 必填
    backstory: str             # 必填
    occupation: str            # 可选
    age: int                   # 可选
    importance: float          # 必填, 0.0-1.0
    alignment: str             # 可选
    relationships:             # 可选
      character_id: description
    tags: [str]                # 可选
    aliases: [str]             # 可选
    personal_quest_id: str     # 可选
    faction_id: str            # 可选
    ai_combat_personality: str # 可选, 默认 "tactical"
    # D&D 属性（可选，不填则由 class_templates 自动生成）
    level: int
    abilities: {str, dex, con, int, wis, cha}
    equipment: {main_hand, armor, ...}
    spells_known: [str]
```

---

> **下一步**: 在下个对话中根据此文档 + `世界活图详细设计.md` 逐步实现 C1 (models.py) → C2 → ... → C7。
