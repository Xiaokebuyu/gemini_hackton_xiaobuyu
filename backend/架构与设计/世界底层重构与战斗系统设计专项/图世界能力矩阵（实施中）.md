# 图世界能力矩阵（实施中）

更新时间：2026-02-18（引擎侧全部完成 + world_state_update 回注 LLM + 管线 v2 prompt 重设计）
进度摘要：E1-E5 ✅ | P1-P12 ✅ | U1-U12/U17-U24 ✅ | world_state_update ✅ | 管线 v2 章节重提取 🔲 | 多主体叙事 T1-T4 🔲
评估范围：`app/world/*`、`app/runtime/session_runtime.py`、`app/runtime/context_assembler.py`、`app/runtime/area_runtime.py`、`app/services/admin/pipeline_orchestrator.py`、`app/services/admin/v4_agentic_tools.py`、`app/services/admin/flash_cpu_service.py`、`app/tools/worldbook_graphizer/`、`tests/test_*graph*|*behavior*|*propagation*|*snapshot*|*c7*|*c8*`

状态定义：
- 已实现：主流程可用，且有代码/测试支撑。
- 部分实现：有能力基础，但链路未闭环或默认数据未覆盖。
- 未实现：仅模型占位或未接入运行时主流程。

### 解决方案文档

| 文档 | 范围 | 日期 |
|------|------|------|
| `图世界能力矩阵P1-P8解决方案.md` | P1-P8 部分实现项 + Player 入图专项 + 双轨数据源迁移 | 2026-02-16 |
| `图世界能力矩阵U1-U24解决方案.md` | U1-U24 未实现项（四组：事件生命周期/实体与世界状态/导航高级/构图与模型） | 2026-02-17 |

### 贯穿性设计原则（P1-P8 + U1-U24 讨论确立）

1. **引擎驱动 + 状态回报**：BehaviorEngine 是主驱动，LLM 工具调用作为手动覆盖手段
2. **系统是真理源，LLM 是叙述者**：地图/条件/时间由引擎决定，LLM 只负责叙述
3. **引擎先就绪，管线后升级**：引擎做到"有数据就能跑"，管线补数据后自动生效

---

## 已实现

| 能力域 | 能力项 | 代码入口 | 验证依据 | 说明 |
|---|---|---|---|---|
| 图建模 | 多层节点与关系边模型（world/chapter/region/area/location/npc/event/camp） | `app/world/models.py` | `tests/test_graph_builder.py` (44 tests) | 图层级和关系类型已统一。 |
| 构图 | 6 步构图（world/chapter-gate/geography/events/npc/party） | `app/world/graph_builder.py` | `tests/test_graph_builder.py` (44 tests) | 会话恢复时可直接生成完整世界图。 |
| 行为引擎 | 条件评估(10种) + 动作执行(6种) + tick 主循环 + 级联传播 | `app/world/behavior_engine.py` | `tests/test_behavior_engine.py` (57 tests) | tick() 覆盖 ON_TICK/ON_TIME/ON_DISPOSITION；ON_EVENT 通过级联覆盖。新增 EVENT_STATE 条件类型 (U4)。 |
| 事件传播 | 带衰减 BFS 传播、最大深度与最小强度控制 | `app/world/event_propagation.py` | `tests/test_event_propagation.py` (16 tests) | **P4 已修复**: scope 仅垂直传播，global 水平+垂直(MAX_DEPTH=8)。 |
| 会话集成 | pre/post tick 接入主 pipeline | `app/services/admin/pipeline_orchestrator.py` | `tests/test_c8_migration.py::test_tick_replaces_check_events` | C8 后事件系统由 BehaviorEngine 单轨驱动。 |
| 事件闭环 | activate/complete 事件、同步 narrative、级联解锁 | `app/services/admin/v4_agentic_tools.py` | `tests/test_c8_migration.py` (3 tests) | 工具层可驱动事件状态推进。 |
| 章节推进 | 基于 gate 边判定章节切换（含优先级排序） | `app/runtime/session_runtime.py` | `tests/test_c8_migration.py::test_chapter_transition_from_graph` | 已替代旧章节检查路径。 |
| 副作用（完整） | 6 种副作用全覆盖 + 双层去重 | `session_runtime.py` `v4_agentic_tools.py` `graph_builder.py` | `tests/test_p7_side_effects.py` (12 tests) | xp/item/gold/reputation/world_flag/unlock 全部可用。双路径（自动tick+手动工具）+ event_id 精确去重 + blanket_key 跨路径去重。修复同源多实例去重 BUG。 |
| 快照 | 脏状态捕获、节点增删、边变更压缩、恢复回放 | `app/world/snapshot.py` | `tests/test_snapshot.py` (37 tests) | 支持跨会话恢复图运行态，含行为状态持久化。 |
| 上下文输出 | area_context 事件摘要来自图，含 completion_hint + stage/objective/outcome 信息 | `app/runtime/area_runtime.py` `session_runtime.py` | `tests/test_c8_migration.py` + `tests/test_c9_stages.py` (P10) | LLM 可获得完整事件进度信息（当前阶段、目标完成度、可用结局）。 |
| 工具面 | 导航、对话、记忆、时间、战斗、队伍、事件、章节、好感度、出图、阶段推进、事件目标 | `app/services/admin/v4_agentic_tools.py` | 运行时工具注册 `get_tools()` | v4 工具集已统一。新增 advance_stage + complete_event_objective (U11/U6)。 |
| D&D 常量 | 完整 5e 角色卡默认值（30+ 字段）、技能/伤害/状态/阵营/装备 | `app/world/constants.py` | `graph_builder` 消费 | `default_character_state()`/`default_npc_state()`/`default_player_state()` 覆盖所有设计字段。 |
| Player 入图 | Player 节点建图 + PlayerNodeView 适配器 + 快照持久化 + 战斗同步 | `app/world/player_node.py` `graph_builder.py` `session_runtime.py` | `tests/test_player_node_view.py` (19) + `test_c7_integration.py` U2 (12) | 图为 player 唯一运行时权威源；SessionRuntime.player 返回 PlayerNodeView；persist() 不再调 character_store；战斗结果通过 _sync_combat_to_graph 写图。 |
| 事件多阶段 | EventStage 主流程化 — 自动推进 + 手动推进 + 目标追踪 | `graph_builder.py` `v4_agentic_tools.py` `behavior_engine.py` | `tests/test_c9_stages.py` (29 tests) | 有 stages 的事件为每个 stage 生成推进 Behavior (EVENT_STATE 守卫)；无 completion_conditions 的 stage 由 advance_stage 手动推进；objectives 追踪写回 event_def.state.objective_progress。 |
| 事件分支结局 | EventOutcome 主流程化 — 自动判定 + 手动选择 + 条件验证 | `graph_builder.py` `v4_agentic_tools.py` | `tests/test_c9_stages.py` (29 tests) | 有 conditions 的 outcome 生成自动判定 Behavior；complete_event(outcome_key=...) 支持手动选择 + 条件验证 + 状态回滚；outcome 奖励包含 xp/gold/items/reputation/world_flags/unlock_events。 |
| 事件状态守卫 | unlock/complete/stage/outcome 行为均有 EVENT_STATE 状态守卫 | `graph_builder.py` | `tests/test_c9_stages.py` + `tests/test_graph_builder.py` | 6a: unlock 只在 LOCKED 触发，complete 只在 ACTIVE 触发，stage 守卫 current_stage 匹配，outcome 守卫 COMPLETED+outcome==None。条件组合保留原始 operator 语义 (or/not 不被展平)。 |
| 导航生命周期 | navigate() 触发 ON_ENTER/ON_EXIT + HOSTS 边更新 + 队友同步 | `v4_agentic_tools.py` `behavior_engine.py` | `tests/test_p1_p6_integration.py` P1 (10 tests) | navigate() 完成后调 handle_exit/handle_enter；HOSTS 边从旧区域移到新区域；队友 HOSTS 边跟随同步；narrative_hints 注入返回结果。 |
| 战斗事件融合 | 战斗结束发射 combat_ended WorldEvent + ON_EVENT 行为响应 | `v4_agentic_tools.py` `behavior_engine.py` | `tests/test_p1_p6_integration.py` P6 (5 tests) | choose_combat_action 战斗结束时构造 WorldEvent → handle_event → ON_EVENT 行为触发 → narrative_hints 回传。 |
| pending_flash 闭环 | FLASH_EVALUATE 当轮闭环：pre-tick 挂起 → LLM 评估 → post-tick 重判 | `behavior_engine.py` `pipeline_orchestrator.py` `v4_agentic_tools.py` | `tests/test_behavior_engine.py` TestPendingFlashPropagation (4 tests) | _eval_flash_evaluate 改为 satisfied=False；pipeline 注入 pending_flash 到 context；report_flash_evaluation 工具存缓存；post-tick 查缓存重评估。(U7/U12) |
| activation_type 行为生成 | 4 种激活方式生成对应触发器 Behavior | `graph_builder.py` `behavior_engine.py` `models/narrative.py` | `tests/test_graph_builder.py` TestActivationTypeBehaviors (6 tests) | npc_given: 无 unlock 行为；auto_enter: ON_ENTER；discovery: ON_ENTER + NARRATIVE_HINT；event_driven/其他: ON_TICK（临时策略）。(U8) |
| 事件失败/超时/冷却 | FAILED + COOLDOWN 两态可达；超时行为 + 冷却重置行为 | `graph_builder.py` `behavior_engine.py` `session_runtime.py` `world_graph.py` | `tests/test_graph_builder.py` TestTimeout/TestCooldown + `test_behavior_engine.py` TestEvalEventRoundsElapsed (10 tests) | EVENT_ROUNDS_ELAPSED 新条件；bh_timeout_(once/priority=3)；bh_cooldown_(非 once/priority=2)；_sync_tick_to_narrative 统一 COOLDOWN 转换；reset_behaviors() API。(U9) |
| fail_event 工具 | LLM 手动标记事件失败（ACTIVE→FAILED）+ 级联 + COOLDOWN | `v4_agentic_tools.py` | 工具注册 get_tools() | 工具路径与 timeout behavior 对称；发射 event_failed WorldEvent；is_repeatable 事件自动进冷却路径。(U10) |
| 世界状态注入上下文 | world_flags + faction_reputations 注入 dynamic_state | `context_assembler.py` `session_runtime.py` | — | _build_dynamic_state 从 world_root 读取并始终注入两个键；build_tick_context 补填 world_flags（P9/U17/U18/U20）|
| WorldEvent.actor 填充 | 工具触发的事件补填 actor="player" | `v4_agentic_tools.py` | — | activate_event + complete_event + fail_event 创建 WorldEvent 时填 actor；event_completed.data 加 source 区分手动/工具路径。(U23) |
| 条件摘要补全 | ROUNDS_ELAPSED 条件生成中文摘要 | `area_runtime.py` | — | _summarize_single_condition 补 ROUNDS_ELAPSED → "经过至少 N 回合"；GAME_STATE/EVENT_ROUNDS_ELAPSED 保持不暴露（内部机制）。(P11) |
| world_state_update 回注 | TickResult 状态变更结构化公报注入 LLM 上下文 | `pipeline_orchestrator.py` | — | _build_world_state_update 提取 8 类变更（事件解锁/完成/失败、world_flags、faction_reputations、NPC 状态、WorldEvent 副作用、narrative_hints）；_merge_world_state_updates 按 event_id 去重；pre-tick 注入 context_dict，post-tick 存 GameState.metadata 跨回合持久化。flash_agentic_system.md 同步更新。|

---

## 部分实现

> 解决方案详见 `图世界能力矩阵P1-P8解决方案.md`

| # | 能力域 | 能力项 | 严重度 | 状态 | 解决方案 | 改动摘要 |
|---|---|---|---|---|---|---|
| P1 | 触发器 | `ON_ENTER/ON_EXIT` 运行时触发 | 高 | ✅ **已完成** | navigate() 调 handle_enter/exit + HOSTS 边更新 | `v4_agentic_tools.py`: navigate() 成功后调 handle_exit(旧区域) + handle_enter(新区域)；_update_hosts_edges 移动 player HOSTS 边；_update_party_hosts_edges 同步队友 |
| P2 | 触发器 | `ON_DISPOSITION` 闭环 | 高 | ✅ **已完成** | update_disposition 直接写图节点 | `v4_agentic_tools.py`: 重写 update_disposition，写 NPC node.state.dispositions；`pipeline_orchestrator.py`: 新增 `_inject_dispositions_from_graph()` 从图读好感度，替代旧 Firestore 路径 |
| P3 | 触发器 | `ON_TIME` 时间驱动 | 中 | 不改 | 引擎已完备，NPC 日程标记 U16 | — |
| P4 | 传播语义 | `scope` 与 `global` 区分度 | 中 | ✅ **已完成** | scope 去掉 CONNECTS 水平传播，global MAX_DEPTH=8 | `event_propagation.py`: scope 仅垂直 CONTAINS 传播(MAX_DEPTH_SCOPE=3)，global 水平+垂直(MAX_DEPTH_GLOBAL=8)；`test_event_propagation.py`: 适配测试（scope 不水平、horizontal decay 改用 global） |
| P5 | 地理层 | region 元数据 | 低 | 不改 | 归入管线升级 | — |
| P6 | 战斗融合 | 图世界与战斗状态一体化 | 高 | ✅ **已完成** | 层1: _sync_combat_to_graph 写 player 图节点；层2: 发射 combat_ended WorldEvent | `v4_agentic_tools.py`: choose_combat_action 战斗结束时构造 WorldEvent(event_type="combat_ended") → engine.handle_event → ON_EVENT 行为响应；combat_event_hints 注入返回结果 |
| P7 | 副作用 | 奖励类型覆盖 | 高 | ✅ **已完成** | 6 种副作用全覆盖 + 去重修复 | `graph_builder.py`: 新增 gold_awarded/reputation_changed/world_flag_set 三种 EMIT_EVENT 生成；`session_runtime.py`: 双层去重(event_id+blanket_key) + 3 种新 WorldEvent 消费；`v4_agentic_tools.py`: 手动路径 3 种副作用补全 |
| P8 | 导航 | 基础区域移动 | 高 | ✅ **已完成** | navigate 从图读 CONNECTS 边 + blocked 检查骨架 | `v4_agentic_tools.py`: navigate() 优先从 WorldGraph CONNECTS 边读连接（含 blocked 检查骨架），降级回退旧路径；_resolve_area_id() 优先从图查询；`graph_builder.py`: CONNECTS 边补传 description 字段 |
| P9 | 上下文 | TickContext 构建完整性 | 高 | ✅ **已完成** | build_tick_context 从 world_root.state 读取 world_flags 填入 TickContext（随 U17/U20 本轮完成） |
| P10 | 上下文 | 事件摘要输出 | 高 | ✅ **已完成** | 事件摘要含 stage 进度、objectives、available_outcomes | `session_runtime.py`: get_event_summaries_from_graph 输出 current_stage（id/name/directive/objectives）+ stage_progress + available_outcomes；`area_runtime.py`: _summarize_single_condition 覆盖 EVENT_STATE |
| P11 | 条件摘要 | `_summarize_completion_conditions` | 低 | ✅ **已完成** | _summarize_single_condition 补 ROUNDS_ELAPSED → "经过至少 N 回合"；GAME_STATE/EVENT_ROUNDS_ELAPSED 保持不暴露（内部机制，Codex 建议） |
| P12 | 枚举使用 | EventStatus 枚举 vs 裸字符串 | 低 | ✅ **已完成** | 关键路径裸字符串替换为枚举 | `v4_agentic_tools.py`: activate/complete_event 全部使用 EventStatus 枚举；`graph_builder.py`: chapter status 使用 ChapterStatus 枚举；`session_runtime.py`: _sync_tick_to_narrative / get_event_summaries 使用 EventStatus |

---

## 未实现

> 解决方案详见 `图世界能力矩阵U1-U24解决方案.md`

| # | 能力域 | 能力项 | 严重度 | 解决方案 | 执行步骤 |
|---|---|---|---|---|---|
| U1 | 触发器 | `ON_STATE_CHANGE` 运行时触发 | 高 | ✅ **已完成** | merge_state 记录真实 diff → behavior_engine.tick() 末尾消费 ON_STATE_CHANGE behaviors；watch_key 精确匹配；tick 后清空（E5.2） |
| U2 | 实体建图 | Player 节点构建 | 中 | ✅ **已完成** | Player 入图专项（P1-附）全部落地 |
| U3 | 物品建图 | `HAS_ITEM` 实例化 | 中 | **延后**，独立设计专项（物品图化） | 第四步（新功能） |
| U4 | 事件模型 | `EventStage` 主流程化 | 高 | ✅ **已完成** | graph_builder 为有 completion_conditions 的 stage 生成推进 Behavior + EVENT_STATE 守卫；activate_event 初始化 current_stage；ConditionType.EVENT_STATE 新增 |
| U5 | 事件模型 | `EventOutcome` 主流程化 | 高 | ✅ **已完成** | complete_event(outcome_key) + 条件验证 + 状态回滚；有条件 outcome 生成自动判定 Behavior；_apply_outcome_rewards 处理 xp/gold/items/reputation/world_flags/unlock_events |
| U6 | 事件模型 | `EventObjective` 追踪 | 高 | ✅ **已完成** | complete_event_objective 工具写 event_def.state.objective_progress + 补偿 tick |
| U7 | 语义条件 | `pending_flash` 闭环 | 高 | ✅ **已完成** | _eval_flash_evaluate 改为 satisfied=False；pipeline 注入 pending_flash；report_flash_evaluation 存缓存；post-tick 查缓存重判（E3） |
| U8 | 事件激活 | `activation_type` 行为生成 | 高 | ✅ **已完成** | npc_given: 无 unlock 行为；auto_enter: ON_ENTER；discovery: ON_ENTER + NARRATIVE_HINT；event_driven/其他: ON_TICK（临时策略）（E4） |
| U9 | 事件失败 | 失败/超时/冷却/重置 | 高 | ✅ **已完成** | EVENT_ROUNDS_ELAPSED 新条件类型；bh_timeout_(priority=3)；bh_cooldown_(priority=2)；_sync_tick_to_narrative 统一 COOLDOWN 转换；WorldGraph.reset_behaviors()（E4） |
| U10 | 工具 | `fail_event()` | 高 | ✅ **已完成** | 手动覆盖手段；发射 event_failed WorldEvent + cascade；is_repeatable 进 COOLDOWN 路径（E4） |
| U11 | 工具 | `advance_stage()` | 高 | ✅ **已完成** | 新增工具，手动推进 + required objectives 校验 + 最后 stage 自动完成事件 + 补偿 tick + _sync_tick_to_narrative |
| U12 | 工具 | `report_flash_evaluation()` | 高 | ✅ **已完成** | 结果存 session.flash_results；post-tick 查缓存（E3） |
| U13 | 导航高级 | 快速旅行 (waypoint) | 中 | **新功能立项**，本轮修复后设计实施 | 第四步（新功能） |
| U14 | 导航高级 | 营地导航 → 营地系统 | 中 | **扩展设计**，整合角色私聊/同伴对话/角色事件 | 第四步（新功能） |
| U15 | 导航高级 | CONNECTS 边丰富属性 | 中 | description 断裂已随 P8 修复；其余属性（blocked/danger/encounter_chance）随管线补充 | 第三步（description ✅ 已修） |
| U16 | NPC 日程 | schedule_table → Behavior | 低 | **延后**，Sprint 5 处理 | 第四步（新功能） |
| U17 | 世界状态 | `world_flags` 持久化与注入 | 高 | ✅ **已完成** | 存储+副作用（P7）+ TickContext.world_flags 填充（P9）+ context_assembler dynamic_state 注入（U20） |
| U18 | 世界状态 | `faction_reputations` 声望 | 中 | ✅ **已完成** | 存储+副作用（P7）+ context_assembler dynamic_state 注入（本轮） |
| U19 | 世界状态 | `party_gold` 金币系统 | 中 | ✅ **P7+U2 已完成**: player.state.gold + 副作用 + 战斗金币全链路可用 | — |
| U20 | 上下文 | `world_flags` 注入 context | 中 | ✅ **已完成** | context_assembler._build_dynamic_state 始终注入 world_flags + faction_reputations（从 world_root 节点读取） |
| U21 | 构图 | event_def properties 缺失 | 高 | ✅ **已完成** | graph_builder 透传 stages/outcomes/activation_type/importance/quest_giver/time_limit/visibility/discovery_check/recommended_level/cooldown_rounds + completion_conditions 序列化 |
| U22 | 构图 | event_def state 初始化 | 中 | ✅ **已完成** | 补全 8 个初始 state 字段: status/current_stage/stage_progress/objective_progress/outcome/activated_at_round/rounds_elapsed/failure_reason |
| U23 | 模型 | `WorldEvent.actor` 死字段 | 低 | ✅ **已完成** | activate_event/complete_event/fail_event 创建 WorldEvent 时填 actor="player"；event_completed.data 加 source 字段区分手动/工具路径 |
| U24 | 模型 | `TickContext.session` 未使用 | 低 | ✅ **已完成** | build_tick_context 传入 session=self；_eval_event_state 通过 ctx.session.world_graph 访问图节点状态 |

---

## 数据源差距

| 数据维度 | 设计规格 | 管线输出 | 引擎消费 | 瓶颈 | 当前引擎状态 |
|---------|---------|---------|---------|------|-------------|
| completion_conditions | ✅ | ❌ 0/323 | ✅ 完整 | **管线未提取** | ✅ 不变 |
| on_complete (xp/items/unlock) | ✅ | ❌ 0/323 | ✅ 完整 | **管线未提取** | ✅ 不变 |
| importance | ✅ | ❌ | ✅ 读取 | **管线未提取** | ✅ 不变 |
| activation_type | ✅ 4种 | ❌ | ✅ **完整** | **仅管线未提取** | ✅ U21 透传 + U8 行为生成已完成（4 种触发器） |
| stages | ✅ | ❌ 0/323 | ✅ **完整** | **仅管线未提取** | ✅ U4 已完成: 自动推进 + 手动推进 + 目标追踪 + P10 上下文输出 |
| outcomes | ✅ | ❌ 0/323 | ✅ **完整** | **仅管线未提取** | ✅ U5 已完成: 自动判定 + 手动选择 + 条件验证 + 奖励应用 |
| time_limit | ✅ | ❌ | ✅ 透传 | **仅管线未提取** | ✅ U21 已透传，U9 超时行为待做 |
| quest_giver | ✅ | ❌ | ✅ 透传 | **仅管线未提取** | ✅ U21 已透传 |
| visibility | ✅ | ❌ | ✅ 透传 | **仅管线未提取** | ✅ U21 已透传 |

> **U4/U5/U6/U11/U21/U22 实施完成后**，所有事件相关数据维度的引擎侧已就绪。瓶颈统一变为"仅管线未提取"。管线升级（第四步）补数据后自动生效。

原始 lorebook（76万字, 415条目）利用率约 10%，章节内容被截断到 3000 字符后喂给提取 LLM。

---

## 数据质量问题（C9 新增）

| 维度 | 发现 | 影响 |
|------|------|------|
| 角色 default_map | 65/131 (49.6%) 角色缺失 `default_map` | HOSTS 边可能指向错误位置 |
| 角色 sub_location | 25 个角色引用不存在的 sub_location（如 priestess→temple, guild_girl→guild_hall） | maps.json 未导出 sub_locations |
| 空 trigger_conditions | 1/323 事件（ch_4_1_event_1）conditions 为空列表 → 永真 Behavior | 设计意图（入口事件），非 bug |
| 可重复事件 | 0/323 事件 is_repeatable=true | COOLDOWN 路径无实际数据验证 |
| 跨章 event_id 引用 | 所有 event_triggered 引用均合法 | ✅ 数据完整 |

---

## 测试覆盖分析（C9 新增）

### 测试统计

| 测试文件 | 用例数 | 覆盖域 |
|---------|--------|--------|
| test_behavior_engine.py | **71** | 触发器/条件(含 EVENT_STATE/EVENT_ROUNDS_ELAPSED)/动作/级联 + TestEvalEventRoundsElapsed(6) + TestResetBehaviors(2) |
| test_graph_builder.py | **57** | 6步构图/节点/边/状态守卫 + TestActivationTypeBehaviors(6) + TestTimeoutBehavior(3) + TestCooldownBehavior(5) |
| test_snapshot.py | 37 | 快照捕获/恢复/序列化 |
| **test_c9_stages.py** | **29** | **U4/U5/U6/U11/U21/U22/P10 全覆盖: 阶段推进/结局判定/目标追踪/状态守卫/上下文输出/工具层/兼容性** |
| test_event_propagation.py | 16 | 传播/衰减/深度/防环 + P4 scope/global 语义 |
| test_graph_scope.py | 17 | GraphScope 验证 |
| test_c8_migration.py | 9 | C8 切换验证 |
| test_graph_store_v2.py | 17 | 图持久化 |
| test_player_node_view.py | 19 | PlayerNodeView 适配器 + translate 往返 |
| test_c7_integration.py (U2) | 12 | Player 入图集成（节点/边/快照/session.player） |
| test_p1_p6_integration.py | 15 | P1 navigate HOSTS+enter/exit + P6 combat WorldEvent |
| test_p7_side_effects.py | 12 | P7 副作用 6 类型全覆盖 + 去重修复 |
| test_spreading_activation.py | 5 | 扩散激活/子图提取/路径查找 |
| **合计** | **316** (可运行，不含需 mcp 依赖的集成测试) | 世界系统核心 |

### 触发器测试覆盖

| 触发器类型 | 测试数 | 覆盖状态 | 缺口 |
|-----------|--------|---------|------|
| ON_TICK | 8 | ✅ 充分 | — |
| ON_EVENT | 12 | ✅ 充分 | — |
| ON_ENTER | 6 | ✅ 充分 | P1 集成：navigate 触发 + HOSTS 边更新 + hints 注入 + 无引擎降级 |
| ON_EXIT | 3 | ✅ 有限 | P1 集成：navigate 触发 + 旧位置 context 验证 |
| ON_TIME | 2 | ⚠️ 有限 | 缺 overnight wrap-around 边界 |
| ON_DISPOSITION | 2 | ⚠️ 有限 | 缺阈值边界测试 |
| ON_STATE_CHANGE | **8** | ✅ **充分** | TestOnStateChange: set_state/merge_state 追踪 + 行为触发 + once 标记 + tick 后清空 |

### 关键测试盲区

| 盲区 | 影响 |
|------|------|
| ~~ON_STATE_CHANGE 触发器~~ | ✅ 已完全覆盖（E5.2 TestOnStateChange 8 tests） |
| 多父节点 scope chain 解析 | 多 chapter 共享 region 的路径选择未验证 |
| ~~scope vs global 传播边界~~ | ✅ P4 修复后已验证（test_scope_no_connects_edge, test_scope_reaches_sibling_via_parent） |
| 快照恢复后行为冷却连续性 | 冷却中行为是否正确恢复未完整验证 |
| 级联行为链交互 | 复杂行为链可能死锁或无限循环 |
| COOLDOWN → AVAILABLE 完整周期集成 | 目前有单元测试，缺端到端会话级集成测试 |

### Codex 审查发现与修复（U4/U5/U6 实施后）

2026-02-17 实施后提交 Codex (OpenAI o4-mini) 审查，发现 9 个问题，修复 5 个：

| # | 严重度 | 问题 | 修复 |
|---|--------|------|------|
| 1 | **严重** | ConditionGroup `or`/`not` operator 展平为 `and` | ✅ 新增 `_wrap_with_guards()` 辅助函数，非 and 时嵌套原始组 |
| 2 | **严重** | `_summarize_completion_conditions(None, raw)` 传 None 做 self | ✅ 改为 `@staticmethod`，移除 self 参数 |
| 3 | **高** | 补偿 tick 结果未同步 narrative | ✅ 加 `_sync_tick_to_narrative(tick_result)` |
| 4 | **高** | `_apply_outcome_rewards` 不处理 `unlock_events` | ✅ 添加显式解锁逻辑 |
| 5 | **中** | 锁定事件提示条件优先级反 | ✅ 改为 `trigger_conditions or completion_conditions` |
| 6 | **中** | 自动阶段推进不更新 `stage_progress` | 设计如此，浅合并不支持嵌套路径，P10 从列表推导 |
| 7 | **高** | objective→stage 不闭环 | 设计如此，stage 条件用标准类型，objectives 是展示/追踪用 |
| 8 | **中** | 测试覆盖空洞 | 29 测试覆盖核心路径，后续迭代补充集成路径 |
| 9 | **低** | 类型约束偏弱 (str vs Enum) | 保持 str 灵活性，数据来自 LLM 提取 |

---

## 执行计划（P1-P8 + U1-U24 定调后更新）

> 详见两份解决方案文档和 `C9引擎完善与管线升级计划.md`

### 第一步：基础设施 + 事件结构化（P1-P8 第一步 + U 第一步，可并行）

**P 系列基础设施**（独立，无前置）— ✅ 全部完成:
- ~~P2: update_disposition 写图节点~~ ✅ 已完成
- ~~P4: scope/global 传播语义修正~~ ✅ 已完成
- ~~P8: navigate 从图读 CONNECTS 边 + blocked/encounter 骨架~~ ✅ 已完成
- ~~P12: 枚举替换裸字符串~~ ✅ 已完成

**U 系列事件结构化**（并行）:
- ~~U2: Player 入图（P1-附专项）~~ ✅ 已完成（PlayerNodeView 适配器 + translate_character_to_node + 图构建 + 快照持久化 + 战斗同步，45 tests）
- ~~U4/U5/U6 + U21/U22: EventStage/Outcome/Objective 主流程化 + event_def 补全~~ ✅ 已完成（阶段推进/结局判定/目标追踪/属性透传/状态初始化，29 tests）
- ~~U11: advance_stage 工具（随 U4）~~ ✅ 已完成（手动推进 + objectives 校验 + 补偿 tick）
- ~~P10: 事件摘要补全（随 U4）~~ ✅ 已完成（stage/objective/outcome 信息注入上下文）
- ~~U24: TickContext.session 赋值~~ ✅ 已完成（build_tick_context 传 session=self，EVENT_STATE 条件消费）
- U7 + U12: pending_flash 当轮闭环（pre-tick 挂起 → LLM 评估 → post-tick 判定）
- U1: ON_STATE_CHANGE（merge_state diff hook + 引擎 handler）

### 第二步：功能闭环（依赖第一步）— ✅ 全部完成

**P 系列闭环** — ✅ 全部完成:
- ~~P1: navigate 调 handle_enter/exit + HOSTS 边更新~~ ✅（15 tests）
- ~~P6: 战斗结束发射 combat_ended WorldEvent + ON_EVENT 行为响应~~ ✅（5 tests）
- ~~P7: 副作用 6 种全覆盖 + 去重修复~~ ✅（12 tests）
- ~~P9/P11: TickContext 补全 + 条件摘要~~ ✅（随 U17/U20 本轮完成）

**U 系列能力完善** — ✅ 全部完成:
- ~~U8: activation_type 行为生成~~ ✅（E4）
- ~~U9 + U10: 失败/超时/冷却 + fail_event 工具~~ ✅（E4）
- ~~U17/U18/U20: 世界状态系统~~ ✅（本轮清理）

### 第三步：清理 + 小修 — ✅ 全部完成

- ~~U15: CONNECTS description 断裂修复~~ ✅（随 P8）
- ~~U23: WorldEvent.actor 填充~~ ✅（本轮）
- ~~P11: 条件摘要补 ROUNDS_ELAPSED~~ ✅（本轮）

### 第四步：新功能 + 管线升级

**管线升级**（依赖第二步）:
- 管线上下文增强 — lorebook 完整内容
- Schema 扩展 — prompt 新增所有可消费字段
- 后处理 — unlock_events 脚本 + 引用校验 + 全量重提取

**新功能立项**:
- U13: 快速旅行 waypoint
- U14: 营地系统（扩展设计：角色私聊/同伴对话/角色事件）
- U16: NPC 日程系统（schedule_table → ON_TIME Behavior）
- U3: 物品图化（HAS_ITEM 边 + loot_containers）
