# 箱庭驱动的世界初始化系统设计

## 核心理念

将世界组织为**箱庭（Sandbox/Map）网络**，每个箱庭是一个独立的小世界，包含：
- 地点描述和环境
- NPC 列表（主要/次要/路人）
- 可交互元素（物品、技能、事件）
- 与其他箱庭的连接

---

## 设计决策

| 决策项 | 选择 | 说明 |
|--------|------|------|
| 路人 NPC 记忆 | 地图级持久化 | 存储在地图共享记忆节点，离开后保留 |
| 图谱化时机 | 预处理 | 用工具预先处理 worldbook，生成结构化数据 |
| 数据来源 | 重新提取 | 从 worldbook_full.md 重新提取地图结构 |
| ID 命名 | 混合使用 | Firestore 用英文 ID，显示用中文名 |

---

## 架构概览

```
┌─────────────────────────────────────────────────────────────────────┐
│                         World: goblin_slayer                         │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│   ┌──────────────┐    ┌──────────────┐    ┌──────────────┐          │
│   │   frontier   │────│   forest     │────│   cave       │          │
│   │  (边境小镇)  │    │  (森林边缘)  │    │  (哥布林巢穴) │          │
│   ├──────────────┤    ├──────────────┤    ├──────────────┤          │
│   │ 主要 NPC:    │    │ 主要 NPC:    │    │ 敌对 NPC:    │          │
│   │  - 女神官    │    │  - 妖精弓手  │    │  - 哥布林    │          │
│   │  - 哥布林杀手│    │  - 矿人道士  │    │  - 萨满      │          │
│   │ 次要 NPC:    │    │  - 蜥蜴僧侣  │    │              │          │
│   │  - 柜台小姐  │    │              │    │              │          │
│   │  - 酒馆老板娘│    │              │    │              │          │
│   │ 路人 NPC:    │    │ 路人 NPC:    │    │              │          │
│   │  - 新手冒险者│    │  - 旅行商人  │    │              │          │
│   │  - 铁匠学徒  │    │              │    │              │          │
│   └──────────────┘    └──────────────┘    └──────────────┘          │
│                                                                      │
│   全局资源:                                                          │
│   ├── 持久化角色 (characters/) ← 主要/次要 NPC 的独立记忆            │
│   ├── 世界知识 (graphs/gm/) ← 全局事件、历史、规则                   │
│   └── 世界地图 (world_map) ← 箱庭拓扑关系                            │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

---

## NPC 分层机制

| 层级 | 存储位置 | 实例生命周期 | 示例 |
|------|----------|-------------|------|
| **主要 NPC** | `characters/{id}/` | 永久持久化 | 女神官、哥布林杀手 |
| **次要 NPC** | `characters/{id}/` | 永久持久化 | 柜台小姐、酒馆老板娘 |
| **路人 NPC** | `maps/{map_id}/passerby/` | 地图级持久化 | 新手冒险者、铁匠学徒 |

### 路人 NPC 特点
- 临时 Pro+Flash 实例
- 记忆节点存储在地图共享空间
- 玩家离开地图后实例销毁，但记忆保留
- 再次进入地图时可恢复之前的对话记忆

---

## Firestore 数据结构

```
worlds/{world_id}/
├── meta/                              # 世界元数据
│   ├── name: "哥布林杀手世界"
│   ├── theme: "黑暗奇幻"
│   └── world_map: { ... }             # 箱庭拓扑图
│
├── maps/{map_id}/                     # 箱庭数据
│   ├── info/                          # 地图基础信息
│   │   ├── name: "边境小镇"
│   │   ├── description: "..."
│   │   ├── atmosphere: "繁忙、喧嚣"
│   │   ├── connections: ["forest", "guild_hall"]
│   │   └── available_actions: [...]
│   │
│   ├── npcs/                          # 地图 NPC 配置
│   │   ├── main: ["priestess", "goblin_slayer"]
│   │   ├── secondary: ["guild_girl", "tavern_keeper"]
│   │   └── passerby_templates: [...]  # 路人生成模板
│   │
│   ├── items/                         # 可获取物品
│   ├── events/                        # 可触发事件
│   │
│   └── memories/                      # 地图共享记忆（路人 NPC）
│       ├── nodes/{node_id}
│       └── edges/{edge_id}
│
├── characters/{character_id}/         # 持久化角色
│   ├── profile/                       # CharacterProfile
│   ├── state/                         # 运行时状态
│   ├── current_map: "frontier"        # 当前所在地图
│   ├── nodes/                         # 个人记忆图谱
│   └── edges/
│
├── graphs/
│   └── gm/                            # GM 全局图谱
│       ├── nodes/
│       └── edges/
│
└── progression/                       # 进度追踪（可选）
    └── current_chapter: 1
```

---

## 世界书图谱化流程

### 输入
- `worldbook_full.md` (1.7MB 详细世界观)

### 输出
- `maps.json` - 箱庭定义和连接
- `characters.json` - 角色资料和所属地图
- `world_graph.json` - 全局知识图谱
- `world_map.json` - 世界地图描述

### 图谱化 Prompt 设计

```markdown
# 任务：世界书结构化提取

## 输入
{worldbook_content}

## 提取要求

### 1. 地图/箱庭提取
对于每个可探索的地点，提取：
- id: 英文标识符 (如 "frontier_town")
- name: 中文名称
- description: 环境描述
- atmosphere: 氛围
- connections: 可到达的其他地图
- available_actions: 在此可执行的动作类型

### 2. NPC 分类
将世界书中的角色分为：
- main: 剧情核心角色（如女神官、哥布林杀手）
- secondary: 重要配角（如柜台小姐、酒馆老板娘）
- passerby_templates: 路人模板（如"新手冒险者"、"商人"）

对于每个 NPC，标注其：
- 默认所在地图
- 重要性等级
- 与其他角色的关系

### 3. 世界地图生成
描述整个世界的地理结构：
- 主要区域
- 区域间的路径
- 危险程度标注

### 4. 章节/进度结构（可选）
如果世界书有明确的剧情线：
- 各章节的解锁条件
- 各章节可访问的地图
- 关键剧情事件

## 输出格式
{json_schema}
```

---

## 实现文件结构

```
app/tools/
├── worldbook_graphizer/              # 世界书图谱化工具
│   ├── __init__.py
│   ├── graphizer.py                  # 主入口
│   ├── map_extractor.py              # 地图/箱庭提取
│   ├── npc_classifier.py             # NPC 分类
│   ├── world_map_generator.py        # 世界地图生成
│   └── prompts/                      # LLM Prompts
│       ├── map_extraction.md
│       ├── npc_classification.md
│       └── world_map.md
│
├── world_initializer/                # 世界初始化器
│   ├── __init__.py
│   ├── initializer.py                # 主编排器
│   ├── map_loader.py                 # 地图数据加载
│   ├── character_loader.py           # 角色资料加载
│   └── graph_loader.py               # 图谱数据加载
│
└── init_world_cli.py                 # CLI 统一入口
```

---

## CLI 命令设计

```bash
# ============ 阶段 1: 世界书图谱化 ============
# 从 worldbook 提取结构化数据（预处理）
python -m app.tools.init_world_cli graphize \
    --worldbook data/goblin_slayer/worldbook_full.md \
    --output data/goblin_slayer/structured/

# 输出:
# data/goblin_slayer/structured/
# ├── maps.json           # 箱庭定义
# ├── characters.json     # 角色分类
# ├── world_graph.json    # 全局图谱
# └── world_map.json      # 世界地图

# ============ 阶段 2: 初始化到 Firestore ============
# 加载结构化数据到 Firestore
python -m app.tools.init_world_cli load \
    --world goblin_slayer \
    --data-dir data/goblin_slayer/structured/

# 仅加载地图
python -m app.tools.init_world_cli load --world goblin_slayer --maps-only

# 仅加载特定角色
python -m app.tools.init_world_cli load --world goblin_slayer --character priestess

# 验证模式
python -m app.tools.init_world_cli load --world goblin_slayer --dry-run
```

---

## 运行时地图加载流程

```
玩家进入新地图
    │
    ▼
┌──────────────────────────────────────────┐
│ MapLoader.enter_map(world_id, map_id)    │
└──────────────────────────────────────────┘
    │
    ├─── 1. 加载地图信息
    │    └── maps/{map_id}/info
    │
    ├─── 2. 激活主要/次要 NPC 实例
    │    └── InstanceManager.get_or_create(npc_id)
    │        └── 从 characters/{npc_id}/ 加载资料和记忆
    │
    ├─── 3. 准备路人 NPC 模板
    │    └── 从 maps/{map_id}/npcs/passerby_templates 加载
    │
    ├─── 4. 恢复路人 NPC 记忆（如有）
    │    └── 从 maps/{map_id}/memories/ 加载
    │
    └─── 5. 生成地图描述
         └── GM 生成进入场景的叙述

玩家离开地图
    │
    ▼
┌──────────────────────────────────────────┐
│ MapLoader.leave_map(world_id, map_id)    │
└──────────────────────────────────────────┘
    │
    ├─── 1. 持久化主要/次要 NPC 状态
    │    └── 已由 InstanceManager 自动处理
    │
    ├─── 2. 持久化路人 NPC 记忆
    │    └── 保存到 maps/{map_id}/memories/
    │
    └─── 3. 销毁路人 NPC 实例
         └── 释放内存
```

---

## 路人 NPC 实例管理

```python
class PasserbyManager:
    """路人 NPC 管理器"""

    def __init__(self, map_id: str, world_id: str):
        self.map_id = map_id
        self.world_id = world_id
        self.instances: Dict[str, NPCInstance] = {}

    async def spawn_passerby(self, template_id: str) -> NPCInstance:
        """根据模板生成路人 NPC"""
        template = await self._load_template(template_id)

        # 生成唯一 ID（地图级）
        passerby_id = f"passerby_{self.map_id}_{uuid4().hex[:8]}"

        # 创建临时实例
        instance = NPCInstance(
            npc_id=passerby_id,
            world_id=self.world_id,
            config=NPCConfig(
                npc_id=passerby_id,
                name=self._generate_name(template),
                personality=template.personality_template,
                speech_pattern=template.speech_pattern,
            ),
            # 使用地图共享的记忆存储
            memory_store_path=f"maps/{self.map_id}/memories",
        )

        # 尝试恢复之前的记忆
        await instance.load_memories_from_map()

        self.instances[passerby_id] = instance
        return instance

    async def persist_all(self):
        """离开地图时持久化所有路人记忆"""
        for instance in self.instances.values():
            await instance.save_memories_to_map()
        self.instances.clear()
```

---

## 世界地图数据结构

```json
{
  "world_map": {
    "name": "四方世界 - 边境地区",
    "description": "王国西部边境，哥布林威胁最严重的地区...",
    "regions": [
      {
        "id": "frontier_region",
        "name": "边境地区",
        "maps": ["frontier_town", "guild_hall", "farm"],
        "danger_level": "low"
      },
      {
        "id": "wilderness",
        "name": "荒野",
        "maps": ["forest", "cave_entrance", "goblin_nest"],
        "danger_level": "high"
      }
    ],
    "connections": [
      {"from": "frontier_town", "to": "guild_hall", "type": "walk", "time": "5min"},
      {"from": "frontier_town", "to": "farm", "type": "walk", "time": "20min"},
      {"from": "frontier_town", "to": "forest", "type": "travel", "time": "2hours"},
      {"from": "forest", "to": "cave_entrance", "type": "explore", "time": "varies"}
    ]
  }
}
```

---

## 实施阶段

### Phase 1: 世界书图谱化工具
1. 创建 `worldbook_graphizer/` 模块
2. 设计 LLM Prompt 用于结构化提取
3. 实现地图提取、NPC 分类、世界地图生成
4. 输出结构化 JSON 文件

### Phase 2: 数据加载器
1. 创建 `world_initializer/` 模块
2. 实现地图数据加载到 Firestore
3. 实现角色资料加载
4. 实现图谱数据加载

### Phase 3: 运行时支持
1. 修改 `GameMasterService` 支持地图切换
2. 实现 `PasserbyManager` 路人 NPC 管理
3. 修改 `InstanceManager` 支持地图级记忆存储
4. 更新 `play.py` 支持地图导航

### Phase 4: 集成测试
1. 图谱化 goblin_slayer worldbook
2. 初始化到 Firestore
3. 测试地图切换和 NPC 交互
4. 测试路人 NPC 记忆持久化

---

## 关键修改文件

| 文件 | 操作 | 说明 |
|------|------|------|
| `app/tools/worldbook_graphizer/` | 新建 | 世界书图谱化工具 |
| `app/tools/world_initializer/` | 新建 | Firestore 初始化器 |
| `app/tools/init_world_cli.py` | 新建 | CLI 统一入口 |
| `app/services/game_master_service.py` | 修改 | 添加地图切换支持 |
| `app/services/instance_manager.py` | 修改 | 支持路人 NPC |
| `app/services/passerby_manager.py` | 新建 | 路人 NPC 管理 |
| `app/models/map.py` | 新建 | 地图数据模型 |
| `play.py` | 修改 | 添加地图导航命令 |

---

## 验证方案

```bash
# 1. 世界书图谱化
python -m app.tools.init_world_cli graphize \
    --worldbook data/goblin_slayer/worldbook_full.md \
    --output data/goblin_slayer/structured/

# 检查输出文件
cat data/goblin_slayer/structured/maps.json | jq '.maps | length'
# 预期: 多个地图定义

# 2. 初始化到 Firestore
python -m app.tools.init_world_cli load \
    --world goblin_slayer \
    --data-dir data/goblin_slayer/structured/

# 3. 测试地图切换
python play.py -w goblin_slayer
/map                    # 查看当前地图
/travel forest          # 前往森林
/npcs                   # 查看当前地图 NPC
/talk 新手冒险者        # 与路人对话

# 4. 测试路人记忆持久化
/travel frontier_town   # 返回边境小镇
/travel forest          # 再次前往森林
/talk 新手冒险者        # 应该记得之前的对话
```

---

## 风险与应对

| 风险 | 应对 |
|------|------|
| 世界书提取不准确 | 分阶段提取，人工审核中间结果 |
| LLM 输出格式不稳定 | 使用结构化输出 (JSON mode)，添加校验 |
| 地图数量过多 | 支持按需加载，优先处理核心地图 |
| 路人记忆膨胀 | 设置记忆上限，自动清理旧记忆 |
