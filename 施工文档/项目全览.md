 é¡¹ç›®æ·±åº¦ä»£ç åˆ†ææŠ¥å‘Š
ä¸€ã€é¡¹ç›®æ¦‚è§ˆ
è¿™æ˜¯ä¸€ä¸ª LLM é•¿æœŸè®°å¿†ç³»ç»Ÿï¼Œæ ¸å¿ƒç›®çš„æ˜¯ä¸ºå¤§è¯­è¨€æ¨¡å‹ï¼ˆLLMï¼‰æä¾›æŒä¹…åŒ–çš„ä¸Šä¸‹æ–‡è®°å¿†èƒ½åŠ›ï¼Œè§£å†³ LLM å¯¹è¯ä¸­çš„"å¥å¿˜"é—®é¢˜ã€‚

æŠ€æœ¯æ¶æ„
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    å‰ç«¯æ§åˆ¶å°                            â”‚
â”‚              (HTML + CSS + JavaScript)                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚ HTTP API
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  FastAPI åç«¯                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚   Routers   â”‚â”€â”€â”‚   Services   â”‚â”€â”€â”‚    Models     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â–¼               â–¼               â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Firestoreâ”‚   â”‚ Gemini   â”‚   â”‚ Cloudflare   â”‚
    â”‚ æ•°æ®åº“    â”‚   â”‚ API      â”‚   â”‚ (é¢„ç•™)       â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

äºŒã€æ ¸å¿ƒæ¦‚å¿µè§£é‡Š
1. çƒ­è®°å¿† vs å†·è®°å¿†
ç±»å‹	è¯´æ˜	å®ç°çŠ¶æ€
çƒ­è®°å¿†	æœ€è¿‘çš„æ´»è·ƒå¯¹è¯æ¶ˆæ¯ï¼ˆé»˜è®¤20æ¡ï¼‰	âœ… å·²å®ç°
å†·è®°å¿†	å½’æ¡£åçš„ Artifact çŸ¥è¯†æ–‡æ¡£	âœ… å·²å®ç°
å‘é‡æ£€ç´¢	åŸºäºè¯­ä¹‰ç›¸ä¼¼åº¦çš„æ£€ç´¢	ğŸ”„ é¢„ç•™ï¼ˆCloudflare Workers AIï¼‰
2. æ»‘åŠ¨çª—å£å½’æ¡£æœºåˆ¶
æ¶ˆæ¯æµåŠ¨ç¤ºæ„ï¼š
                    active_window_size = 20
                           â†“
[msg1][msg2][msg3]...[msg20][msg21]...[msg40]
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€å¾…å½’æ¡£åŒºåŸŸâ”€â”€â”€â”€â”€â”€â”˜â””â”€â”€â”€æ´»è·ƒçª—å£â”€â”€â”€â”€â”˜
         â†“
    å½“æ€»æ•° >= archive_threshold(40) æ—¶
         â†“
    è§¦å‘å½’æ¡£ï¼Œç”Ÿæˆ Artifact

3. ä¸Šä¸‹æ–‡è¯·æ±‚æœºåˆ¶ ([NEED_CONTEXT: å…³é”®è¯])
å½“ LLM å›å¤ä¸­åŒ…å«è¿™ä¸ªç‰¹æ®Šæ ‡è®°æ—¶ï¼Œç³»ç»Ÿä¼šï¼š

è§£æå‡ºå…³é”®è¯
åœ¨ Artifact ä¸­æœç´¢åŒ¹é…çš„ç« èŠ‚
åŠ è½½å…³è”çš„åŸå§‹æ¶ˆæ¯åˆ°ä¸Šä¸‹æ–‡
é‡æ–°ç”Ÿæˆå›å¤
ä¸‰ã€ä»£ç æ–‡ä»¶é€ä¸€è§£æ
ğŸ“ backend/app/main.pyï¼ˆåº”ç”¨å…¥å£ï¼‰
# ç¬¬4-7è¡Œï¼šå¯¼å…¥ä¾èµ–
from fastapi import FastAPI
from fastapi.middleware.cors import CORSMiddleware
from app.config import settings, validate_config
from app.routers import chat_router, topics_router

# ç¬¬10-14è¡Œï¼šåˆ›å»º FastAPI åº”ç”¨å®ä¾‹
app = FastAPI(
    title="LLM è®°å¿†ç³»ç»Ÿ API",
    description="åŸºäº Firestore çš„ä¸­æ–­é©±åŠ¨ä¸Šä¸‹æ–‡ç³»ç»Ÿ",
    version="0.1.0",
)

å…³é”®çŸ¥è¯†ç‚¹ï¼š

FastAPI() æ˜¯åˆ›å»º Web åº”ç”¨çš„å…¥å£
CORSMiddleware å…è®¸å‰ç«¯è·¨åŸŸè®¿é—®åç«¯
@app.on_event("startup") è£…é¥°å™¨å®šä¹‰å¯åŠ¨æ—¶æ‰§è¡Œçš„å‡½æ•°
@app.get("/") è£…é¥°å™¨å°†å‡½æ•°æ˜ å°„åˆ° HTTP GET è¯·æ±‚
ğŸ“ backend/app/config.pyï¼ˆé…ç½®ç®¡ç†ï¼‰
# ç¬¬6-7è¡Œï¼šåŠ è½½ .env æ–‡ä»¶
from dotenv import load_dotenv
load_dotenv()

# ç¬¬13-45è¡Œï¼šé…ç½®ç±»å®šä¹‰
class Settings(BaseModel):
    # Firebase é…ç½®
    google_application_credentials: str = os.getenv(
        "GOOGLE_APPLICATION_CREDENTIALS", 
        "./firebase-credentials.json"
    )
    
    # çƒ­è®°å¿†é…ç½®
    active_window_size: int = 20        # æ´»è·ƒçª—å£å¤§å°
    archive_threshold: int = 40          # å½’æ¡£è§¦å‘é˜ˆå€¼
    max_context_retry: int = 3           # ä¸Šä¸‹æ–‡é‡è¯•æ¬¡æ•°
    context_request_pattern: str = r'\[NEED_CONTEXT:\s*(.+?)\]'  # æ­£åˆ™è¡¨è¾¾å¼

å…³é”®çŸ¥è¯†ç‚¹ï¼š

os.getenv("KEY", "é»˜è®¤å€¼") ä»ç¯å¢ƒå˜é‡è¯»å–é…ç½®
pydantic.BaseModel æä¾›æ•°æ®éªŒè¯å’Œç±»å‹æ£€æŸ¥
æ­£åˆ™è¡¨è¾¾å¼ r'\[NEED_CONTEXT:\s*(.+?)\]' åŒ¹é… [NEED_CONTEXT: xxx] æ ¼å¼
ğŸ“ backend/app/models/ï¼ˆæ•°æ®æ¨¡å‹ï¼‰
session.py - ä¼šè¯æ¨¡å‹
class Session(SessionBase):
    session_id: str                                    # ä¼šè¯å”¯ä¸€æ ‡è¯†
    created_at: datetime = Field(default_factory=datetime.now)  # åˆ›å»ºæ—¶é—´
    updated_at: datetime = Field(default_factory=datetime.now)  # æ›´æ–°æ—¶é—´

message.py - æ¶ˆæ¯æ¨¡å‹
class MessageRole(str, Enum):   # æšä¸¾ç±»å‹ï¼Œç»§æ‰¿ str å’Œ Enum
    USER = "user"               # ç”¨æˆ·æ¶ˆæ¯
    ASSISTANT = "assistant"     # åŠ©æ‰‹æ¶ˆæ¯
    SYSTEM = "system"           # ç³»ç»Ÿæ¶ˆæ¯

class Message(MessageBase):
    message_id: str             # æ¶ˆæ¯ID
    role: MessageRole           # è§’è‰²
    content: str                # å†…å®¹
    thread_id: Optional[str]    # å…³è”çš„ä¸»é¢˜IDï¼ˆå½’æ¡£åè®¾ç½®ï¼‰
    is_excluded: bool = False   # æ˜¯å¦æ’é™¤ï¼ˆä¸å‚ä¸ä¸Šä¸‹æ–‡ï¼‰
    is_archived: bool = False   # æ˜¯å¦å·²å½’æ¡£
    timestamp: datetime         # æ—¶é—´æˆ³

topic.py - ä¸»é¢˜æ¨¡å‹
class TopicThread(TopicBase):
    thread_id: str              # ä¸»é¢˜ID
    title: str                  # æ ‡é¢˜
    summary: str                # æ‘˜è¦
    current_artifact: str       # å½“å‰ Artifact å†…å®¹ï¼ˆMarkdownï¼‰

class ArtifactVersion(BaseModel):
    version_id: str             # ç‰ˆæœ¬ID
    content: str                # ç‰ˆæœ¬å†…å®¹
    message_ids: List[str]      # æºæ¶ˆæ¯IDåˆ—è¡¨

å…³é”®çŸ¥è¯†ç‚¹ï¼š

Enum æšä¸¾é™å®šå–å€¼èŒƒå›´
Optional[str] è¡¨ç¤ºå¯ä»¥æ˜¯ str æˆ– None
Field(default_factory=...) è®¾ç½®é»˜è®¤å€¼å·¥å‚å‡½æ•°
ç»§æ‰¿å…³ç³»ï¼šBase â†’ Create â†’ å®Œæ•´æ¨¡å‹
ğŸ“ backend/app/routers/chat.pyï¼ˆèŠå¤©è·¯ç”± - æ ¸å¿ƒï¼ï¼‰
è¿™æ˜¯æ•´ä¸ªç³»ç»Ÿçš„æ ¸å¿ƒå…¥å£ï¼Œå¤„ç†ç”¨æˆ·æ¶ˆæ¯çš„å®Œæ•´æµç¨‹ï¼š

@router.post("/chat", response_model=ChatResponse)
async def chat(request: ChatRequest):
    """
    å¤„ç†æµç¨‹:
    1. åˆ›å»ºæˆ–è·å–ä¼šè¯
    2. ä¿å­˜ç”¨æˆ·æ¶ˆæ¯
    3. æ£€æŸ¥å¹¶æ‰§è¡Œå½’æ¡£
    4. è¿è¡Œä¸Šä¸‹æ–‡å¾ªç¯ç”Ÿæˆå›å¤
    5. ä¿å­˜åŠ©æ‰‹æ¶ˆæ¯
    6. è¿”å›å“åº”
    """

è¯¦ç»†æµç¨‹å›¾ï¼š

ç”¨æˆ·å‘é€æ¶ˆæ¯
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. ä¼šè¯å¤„ç†              â”‚
â”‚   - æœ‰ session_id? è·å–  â”‚
â”‚   - æ²¡æœ‰? åˆ›å»ºæ–°ä¼šè¯      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. ä¿å­˜ç”¨æˆ·æ¶ˆæ¯          â”‚
â”‚   - role = USER          â”‚
â”‚   - å†™å…¥ Firestore       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. æ£€æŸ¥å½’æ¡£æ¡ä»¶          â”‚
â”‚   - æ´»è·ƒæ¶ˆæ¯ >= 40æ¡?    â”‚
â”‚   - æ˜¯ â†’ æ‰§è¡Œå½’æ¡£        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. ä¸Šä¸‹æ–‡å¾ªç¯            â”‚
â”‚   - æ„å»ºä¸Šä¸‹æ–‡           â”‚
â”‚   - è°ƒç”¨ Gemini ç”Ÿæˆå›å¤  â”‚
â”‚   - å¤„ç† NEED_CONTEXT    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. ä¿å­˜åŠ©æ‰‹æ¶ˆæ¯          â”‚
â”‚   - role = ASSISTANT     â”‚
â”‚   - æ›´æ–°ä¼šè¯æ—¶é—´æˆ³        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â–¼
    è¿”å› ChatResponse

ğŸ“ backend/app/services/firestore_service.pyï¼ˆæ•°æ®åº“æœåŠ¡ï¼‰
Firestore æ•°æ®ç»“æ„ï¼š

users/
â””â”€â”€ {user_id}/
    â””â”€â”€ sessions/
        â””â”€â”€ {session_id}/
            â”œâ”€â”€ æ–‡æ¡£å±æ€§ï¼šcreated_at, updated_at
            â”œâ”€â”€ messages/
            â”‚   â””â”€â”€ {message_id}/
            â”‚       â”œâ”€â”€ role
            â”‚       â”œâ”€â”€ content
            â”‚       â”œâ”€â”€ thread_id
            â”‚       â”œâ”€â”€ is_archived
            â”‚       â””â”€â”€ timestamp
            â””â”€â”€ topics/
                â””â”€â”€ {thread_id}/
                    â”œâ”€â”€ title
                    â”œâ”€â”€ summary
                    â”œâ”€â”€ current_artifact
                    â””â”€â”€ artifact_versions/
                        â””â”€â”€ {version_id}/
                            â”œâ”€â”€ content
                            â””â”€â”€ message_ids[]

å…³é”®æ–¹æ³•è§£æï¼š

# è·å–å¾…å½’æ¡£æ¶ˆæ¯ï¼ˆæ´»è·ƒçª—å£ä¹‹å¤–çš„ï¼‰
async def get_pending_archive_messages(
    self,
    user_id: str,
    session_id: str,
    active_window_size: int,
) -> List[Message]:
    # è·å–æ‰€æœ‰æ¶ˆæ¯
    # è¿‡æ»¤å‡ºæœªå½’æ¡£ã€æœªæ’é™¤çš„
    # å¦‚æœæ•°é‡ <= æ´»è·ƒçª—å£ï¼Œè¿”å›ç©º
    # å¦åˆ™è¿”å› [0 : æ€»æ•°-æ´»è·ƒçª—å£] è¿™äº›æ¶ˆæ¯
    return active[: len(active) - active_window_size]

# æ‰¹é‡æ ‡è®°æ¶ˆæ¯ä¸ºå·²å½’æ¡£
async def mark_messages_archived(
    self,
    user_id: str,
    session_id: str,
    message_ids: List[str],
    thread_id: str,
) -> None:
    batch = self.db.batch()  # æ‰¹é‡å†™å…¥ï¼Œæé«˜æ€§èƒ½
    for message_id in message_ids:
        batch.update(message_ref, {"is_archived": True, "thread_id": thread_id})
    batch.commit()  # ä¸€æ¬¡æ€§æäº¤

ğŸ“ backend/app/services/archive_service.pyï¼ˆå½’æ¡£æœåŠ¡ï¼‰
å½’æ¡£æ‰§è¡Œæµç¨‹ï¼š

async def execute_archive(self, user_id: str, session_id: str) -> Optional[str]:
    # 1. è·å–å¾…å½’æ¡£æ¶ˆæ¯
    pending_messages = await self.firestore.get_pending_archive_messages(...)
    
    # 2. ä½¿ç”¨ LLM åˆ†ææ¶ˆæ¯ï¼Œç”Ÿæˆ title/summary/artifact
    analysis = await self.analyze_messages(pending_messages)
    
    # 3. æŸ¥æ‰¾å¯åˆå¹¶çš„ç°æœ‰ä¸»é¢˜
    merge_target = await self.find_mergeable_topic(...)
    
    if merge_target:
        # 4a. åˆå¹¶åˆ°ç°æœ‰ä¸»é¢˜
        await self.merge_into_topic(...)
    else:
        # 4b. åˆ›å»ºæ–°ä¸»é¢˜
        thread_id = await self.firestore.create_topic(...)
    
    # 5. æ ‡è®°æ¶ˆæ¯ä¸ºå·²å½’æ¡£
    await self.firestore.mark_messages_archived(...)
    
    return thread_id

ä¸»é¢˜åˆå¹¶åˆ¤æ–­ï¼š

async def find_mergeable_topic(...) -> Optional[TopicThread]:
    # 1. å…ˆç²¾ç¡®åŒ¹é…æ ‡é¢˜ï¼ˆå¿½ç•¥å¤§å°å†™ï¼‰
    if topic.title.strip().lower() == new_title.strip().lower():
        return topic
    
    # 2. ä½¿ç”¨ LLM åˆ¤æ–­æ˜¯å¦åº”è¯¥åˆå¹¶
    should_merge = await self.llm.should_merge_topics(...)

ğŸ“ backend/app/services/llm_service.pyï¼ˆLLM æœåŠ¡ï¼‰
æ ¸å¿ƒæ–¹æ³•ï¼š

class LLMService:
    def __init__(self):
        genai.configure(api_key=settings.gemini_api_key)
        self.flash_model = genai.GenerativeModel(settings.gemini_flash_model)
        self.main_model = genai.GenerativeModel(settings.gemini_main_model)
    
    # è¾…åŠ©æ–¹æ³•ï¼šå»é™¤ä»£ç å—æ ‡è®°
    def _strip_code_block(self, text: str) -> str:
        # å¤„ç† ```json ... ``` æ ¼å¼
        
    # è¾…åŠ©æ–¹æ³•ï¼šè§£æ JSON
    def _parse_json(self, text: str) -> Optional[Dict[str, Any]]:
        # å…ˆå»é™¤ä»£ç å—ï¼Œå†è§£æ

å½’æ¡£åˆ†æ Prompt ç¤ºä¾‹ï¼š

prompt = f"""ä½ æ˜¯å½’æ¡£åŠ©æ‰‹ï¼Œéœ€è¦æŠŠä¸€æ®µå¯¹è¯æ•´ç†æˆä¸»é¢˜æ‘˜è¦å’ŒçŸ¥è¯†æ–‡æ¡£ã€‚

å¯¹è¯å†…å®¹:
{messages_text}

è¯·è¾“å‡º JSONï¼Œæ ¼å¼:
{{
  "title": "ä¸»é¢˜æ ‡é¢˜ï¼ˆå®½æ³›å¤§ç±»ï¼‰",
  "summary": "ç®€çŸ­æ‘˜è¦ï¼ˆç”¨äºåˆå¹¶åˆ¤æ–­ï¼‰",
  "artifact": "Markdown æ–‡æ¡£"
}}

Artifact è¦æ±‚:
1. ä½¿ç”¨ Markdown æ ‡é¢˜ç»„ç»‡å†…å®¹
2. åœ¨æ–°å¢æˆ–æ›´æ–°çš„ç« èŠ‚æ ‡é¢˜åæ·»åŠ ç´¢å¼•æ³¨é‡Š: <!-- sources: msg_xxx, msg_yyy -->
3. åªå¼•ç”¨æœ¬æ¬¡å¯¹è¯ä¸­å‡ºç°çš„ message_id
4. å†…å®¹ç®€æ´ã€å¯ç”¨äºåç»­æ£€ç´¢
"""

ğŸ“ backend/app/services/context_loop.pyï¼ˆä¸Šä¸‹æ–‡å¾ªç¯ - æ ¸å¿ƒï¼ï¼‰
è¿™æ˜¯å®ç°"æ™ºèƒ½å›æº¯"çš„å…³é”®ï¼š

async def run(self, user_id: str, session_id: str, user_query: str) -> Tuple[str, int]:
    loaded_messages: List[Message] = []  # é¢å¤–åŠ è½½çš„å†å²æ¶ˆæ¯
    retry_count = 0
    
    for _ in range(settings.max_context_retry):  # æœ€å¤šé‡è¯•3æ¬¡
        # 1. æ„å»ºä¸Šä¸‹æ–‡
        context = await self.context_builder.build(user_id, session_id, loaded_messages)
        
        # 2. ç”Ÿæˆå›å¤
        response = await self.llm.generate_response(context, user_query)
        
        # 3. æ£€æŸ¥æ˜¯å¦æœ‰ NEED_CONTEXT æ ‡è®°
        request_key = self.parse_context_request(response)
        if not request_key:
            return response, retry_count  # æ²¡æœ‰æ ‡è®°ï¼Œç›´æ¥è¿”å›
        
        # 4. æ ¹æ®å…³é”®è¯åŠ è½½å†å²æ¶ˆæ¯
        messages = await self.resolve_context_request(user_id, session_id, request_key)
        
        # 5. å»é‡åæ·»åŠ åˆ° loaded_messages
        loaded_messages.extend(new_messages)
        retry_count += 1
    
    # è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°ï¼Œè¿”å›æœ€åçš„å›å¤ï¼ˆå»é™¤æ ‡è®°ï¼‰
    return self.strip_context_request(last_response), retry_count

ä¸Šä¸‹æ–‡è¯·æ±‚è§£ææµç¨‹ï¼š

LLM å›å¤ï¼š"ä¹‹å‰è®¨è®ºçš„åˆ—è¡¨æ¨å¯¼å¼ [NEED_CONTEXT: åˆ—è¡¨æ¨å¯¼å¼] éœ€è¦è¡¥å……ç»†èŠ‚"
                                        â”‚
                                        â–¼
                          parse_context_request() æå– "åˆ—è¡¨æ¨å¯¼å¼"
                                        â”‚
                                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ resolve_context_request():                                   â”‚
â”‚   1. éå†æ‰€æœ‰ Topic                                          â”‚
â”‚   2. åœ¨æ¯ä¸ª Artifact ä¸­æœç´¢å…³é”®è¯                             â”‚
â”‚   3. æ‰¾åˆ°åŒ¹é…çš„ç« èŠ‚ â†’ è·å– sources é‡Œçš„ message_ids           â”‚
â”‚   4. æ ¹æ® message_ids åŠ è½½åŸå§‹æ¶ˆæ¯                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ğŸ“ backend/app/services/context_builder.pyï¼ˆä¸Šä¸‹æ–‡æ„å»ºå™¨ï¼‰
æ„å»ºå‘é€ç»™ LLM çš„å®Œæ•´ä¸Šä¸‹æ–‡ï¼š

async def build(self, user_id, session_id, additional_messages=None) -> str:
    parts = []
    
    # 1. ç³»ç»Ÿæç¤ºè¯
    parts.append(self.build_system_prompt())
    
    # 2. æ‰€æœ‰ Artifactï¼ˆå†·è®°å¿†ï¼‰
    artifacts_text = await self.load_all_artifacts(user_id, session_id)
    if artifacts_text:
        parts.append(f"## çŸ¥è¯†æ–‡æ¡£\n\n{artifacts_text}")
    
    # 3. é¢å¤–åŠ è½½çš„å†å²æ¶ˆæ¯ï¼ˆæ¥è‡ª NEED_CONTEXTï¼‰
    if additional_messages:
        parts.append(self.format_messages(additional_messages, "åŠ è½½çš„å†å²å¯¹è¯"))
    
    # 4. æ´»è·ƒçª—å£æ¶ˆæ¯ï¼ˆçƒ­è®°å¿†ï¼‰
    active_messages = await self.firestore.get_active_messages(...)
    parts.append(self.format_messages(active_messages, "æœ€è¿‘å¯¹è¯"))
    
    return "\n\n---\n\n".join(parts)

ç³»ç»Ÿæç¤ºè¯ï¼š

def build_system_prompt(self) -> str:
    return """## ç³»ç»Ÿè§’è‰²

ä½ æ˜¯ä¸€ä¸ªå…·æœ‰é•¿æœŸè®°å¿†èƒ½åŠ›çš„æ™ºèƒ½åŠ©æ‰‹ã€‚

**å…³äºçŸ¥è¯†æ–‡æ¡£:**
- ä½ å¯ä»¥è®¿é—®ä¹‹å‰å¯¹è¯ç§¯ç´¯çš„çŸ¥è¯†æ–‡æ¡£ï¼ˆArtifactï¼‰

**å…³äºå†å²å›æº¯:**
- å¦‚æœä½ éœ€è¦å›é¡¾ä¹‹å‰è®¨è®ºçš„å…·ä½“ç»†èŠ‚
- è¯·åœ¨å›å¤ä¸­ä½¿ç”¨ [NEED_CONTEXT: å…³é”®è¯] æ ‡è®°
- ç³»ç»Ÿä¼šä¸ºä½ åŠ è½½ç›¸å…³çš„åŸå§‹å¯¹è¯
"""

ğŸ“ backend/app/services/artifact_service.pyï¼ˆArtifact ç®¡ç†ï¼‰
Artifact æ ¼å¼ç¤ºä¾‹ï¼š

# Pythonå­¦ä¹ ç¬”è®°

## åˆ—è¡¨æ¨å¯¼å¼ <!-- sources: msg_001, msg_002 -->
åŸºæœ¬è¯­æ³•æ˜¯ `[expr for x in iterable if cond]`

## å¼‚æ­¥ç¼–ç¨‹ <!-- sources: msg_015, msg_016 -->
ä½¿ç”¨ asyncio å¤„ç† IO å¯†é›†å‹ä»»åŠ¡

å…³é”®æ–¹æ³•ï¼š

def parse_artifact_sources(self, artifact: str) -> Dict[str, List[str]]:
    """è§£æ <!-- sources: msg_xxx, msg_yyy --> æ ‡è®°"""
    pattern = r'(#{1,6}\s+[^\n]+?)\s*<!--\s*sources:\s*([^>]+?)\s*-->'
    # è¿”å› {"## åˆ—è¡¨æ¨å¯¼å¼": ["msg_001", "msg_002"], ...}

def find_section_by_keyword(self, artifact: str, keyword: str) -> Optional[Tuple[str, List[str]]]:
    """æ ¹æ®å…³é”®è¯æŸ¥æ‰¾åŒ¹é…çš„ç« èŠ‚"""
    # 1. è·å–æ‰€æœ‰ç« èŠ‚
    # 2. åœ¨æ ‡é¢˜å’Œå†…å®¹ä¸­æœç´¢å…³é”®è¯
    # 3. è¿”å› (ç« èŠ‚æ ‡é¢˜, [æ¶ˆæ¯IDåˆ—è¡¨])

æ­£åˆ™è¡¨è¾¾å¼è¯¦è§£ï¼š

pattern = r'(#{1,6}\s+[^\n]+?)\s*<!--\s*sources:\s*([^>]+?)\s*-->'

# (#{1,6}\s+[^\n]+?)  â†’ æ•è·ç»„1ï¼š1-6ä¸ª#å· + ç©ºæ ¼ + æ ‡é¢˜æ–‡å­—
# \s*                 â†’ å¯é€‰ç©ºç™½
# <!--\s*sources:\s*  â†’ æ³¨é‡Šå¼€å§‹ + sources:
# ([^>]+?)            â†’ æ•è·ç»„2ï¼šæ¶ˆæ¯IDåˆ—è¡¨ï¼ˆéè´ªå©ªï¼‰
# \s*-->              â†’ æ³¨é‡Šç»“æŸ

ğŸ“ backend/app/utils/embedding.pyï¼ˆå‘é‡åµŒå…¥å·¥å…· - é¢„ç•™ï¼‰
è¿™æ˜¯ä¸ºæœªæ¥çš„è¯­ä¹‰æ£€ç´¢åŠŸèƒ½é¢„ç•™çš„ä»£ç ï¼š

async def get_cloudflare_embedding(text: str) -> List[float]:
    """
    ä½¿ç”¨ Cloudflare Workers AI ç”Ÿæˆ 768 ç»´å‘é‡
    ç›®å‰æœªä½¿ç”¨ï¼Œé¢„ç•™ç»™ BigQuery å†·è®°å¿†çš„è¯­ä¹‰æ£€ç´¢
    """

def cosine_similarity(vec1: List[float], vec2: List[float]) -> float:
    """
    è®¡ç®—ä½™å¼¦ç›¸ä¼¼åº¦
    å…¬å¼ï¼šcos(Î¸) = (AÂ·B) / (||A|| Ã— ||B||)
    """
    dot_product = np.dot(v1, v2)
    norm_v1 = np.linalg.norm(v1)
    norm_v2 = np.linalg.norm(v2)
    return dot_product / (norm_v1 * norm_v2)

ğŸ“ frontend/ï¼ˆå‰ç«¯æ§åˆ¶å°ï¼‰
è¿™æ˜¯ä¸€ä¸ªè½»é‡çº§çš„ API è°ƒè¯•é¢æ¿ï¼š

index.html ç»“æ„ï¼š

<main class="app">
  <header class="hero">           <!-- æ ‡é¢˜åŒº + å¥åº·æ£€æŸ¥ -->
  <section class="grid">
    <section class="card">å¯¹è¯</section>      <!-- å‘é€æ¶ˆæ¯ -->
    <section class="card">ä¼šè¯</section>      <!-- è·å–ä¼šè¯æ¶ˆæ¯ -->
    <section class="card">ä¸»é¢˜</section>      <!-- æŸ¥çœ‹ä¸»é¢˜/Artifact -->
  </section>
  <section class="card output">è¾“å‡º</section> <!-- JSON ç»“æœå±•ç¤º -->
</main>

app.js å…³é”®æ¨¡å¼ï¼š

// 1. DOM å…ƒç´ ç¼“å­˜
const ui = {
  baseUrl: byId("baseUrl"),
  sendBtn: byId("sendBtn"),
  // ...
};

// 2. çŠ¶æ€ç®¡ç†
const state = {
  lastJson: null,
};

// 3. é€šç”¨è¯·æ±‚å‡½æ•°
const request = async (path, options = {}) => {
  const url = `${normalizeBase()}${path}`;
  const response = await fetch(url, init);
  // ç»Ÿä¸€å¤„ç†å“åº”å’Œé”™è¯¯
};

// 4. æŒ‰é’®é˜²æŠ– + åŠ è½½çŠ¶æ€
const withBusy = async (button, fn) => {
  button.disabled = true;
  button.textContent = "å¤„ç†ä¸­...";
  try {
    return await fn();
  } finally {
    button.disabled = false;
    button.textContent = originalText;
  }
};

ğŸ“ tests/ï¼ˆæµ‹è¯•å¥—ä»¶ï¼‰
æµ‹è¯•ç±»å‹ï¼š

æ–‡ä»¶	ç±»å‹	æµ‹è¯•å†…å®¹
test_integration.py	ç«¯åˆ°ç«¯	å®Œæ•´çš„å½’æ¡£+ä¸Šä¸‹æ–‡æµç¨‹
test_artifact.py	å•å…ƒ	Artifact è§£æã€ç« èŠ‚æå–
test_archive.py	é›†æˆ	å½’æ¡£è§¦å‘å’Œæ‰§è¡Œ
test_context_loop.py	å•å…ƒ	NEED_CONTEXT è§£æ
æµ‹è¯•ç¤ºä¾‹è§£è¯»ï¼š

@pytest.mark.asyncio  # æ ‡è®°ä¸ºå¼‚æ­¥æµ‹è¯•
async def test_archive_and_context_flow(self, setup_services):
    # ä¸´æ—¶ä¿®æ”¹é…ç½®ï¼ˆé™ä½é˜ˆå€¼æ–¹ä¾¿æµ‹è¯•ï¼‰
    settings.archive_threshold = 4
    settings.active_window_size = 2
    
    try:
        # æ·»åŠ 4æ¡æ¶ˆæ¯è§¦å‘å½’æ¡£
        for i in range(4):
            await services["firestore"].add_message(...)
        
        # éªŒè¯å½’æ¡£è¢«è§¦å‘
        should_archive = await services["archive"].check_should_archive(...)
        assert should_archive is True
        
        # æ‰§è¡Œå½’æ¡£
        thread_id = await services["archive"].execute_archive(...)
        assert thread_id is not None
    finally:
        # æ¢å¤åŸå§‹é…ç½®
        settings.archive_threshold = original_threshold

å››ã€æ•°æ®æµå›¾
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          å®Œæ•´æ•°æ®æµ                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç”¨æˆ·è¾“å…¥æ¶ˆæ¯
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  POST /api/chat â”‚
â”‚   (chat.py:38)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
    â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”
    â–¼         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ–°ä¼šè¯  â”‚ â”‚    ç°æœ‰ä¼šè¯         â”‚
â”‚ åˆ›å»º    â”‚ â”‚    è·å–            â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
             â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  ä¿å­˜ç”¨æˆ·æ¶ˆæ¯       â”‚
    â”‚  (firestore:73)    â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  æ£€æŸ¥å½’æ¡£æ¡ä»¶       â”‚     æ¶ˆæ¯æ•° >= 40?
    â”‚  (archive:18)      â”‚ â”€â”€â”€â”€â”€â”€ å¦ â”€â”€â”€â”€â”€â”€â”€â”
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
              â”‚ æ˜¯                           â”‚
              â–¼                              â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
    â”‚  æ‰§è¡Œå½’æ¡£           â”‚                  â”‚
    â”‚  1. LLM åˆ†ææ¶ˆæ¯    â”‚                  â”‚
    â”‚  2. ç”Ÿæˆ Artifact   â”‚                  â”‚
    â”‚  3. åˆ›å»º/åˆå¹¶ä¸»é¢˜    â”‚                  â”‚
    â”‚  4. æ ‡è®°æ¶ˆæ¯å½’æ¡£     â”‚                  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚      ä¸Šä¸‹æ–‡å¾ªç¯            â”‚
              â”‚   (context_loop:23)        â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚  æ„å»ºä¸Šä¸‹æ–‡                 â”‚
              â”‚  1. ç³»ç»Ÿæç¤ºè¯              â”‚
              â”‚  2. æ‰€æœ‰ Artifact           â”‚
              â”‚  3. é¢å¤–å†å²æ¶ˆæ¯            â”‚
              â”‚  4. æ´»è·ƒçª—å£æ¶ˆæ¯            â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚   è°ƒç”¨ Gemini API          â”‚
              â”‚   ç”Ÿæˆå›å¤                  â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â–¼
                    æœ‰ [NEED_CONTEXT]?
                   /                \
                 æ˜¯                  å¦
                 â–¼                    â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ è§£æå…³é”®è¯           â”‚   â”‚   è¿”å›å›å¤    â”‚
    â”‚ æœç´¢ Artifact        â”‚   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚ åŠ è½½æºæ¶ˆæ¯           â”‚          â”‚
    â”‚ é‡æ–°æ„å»ºä¸Šä¸‹æ–‡       â”‚          â”‚
    â”‚ å†æ¬¡ç”Ÿæˆå›å¤         â”‚          â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
               â”‚ (æœ€å¤šé‡è¯•3æ¬¡)         â”‚
               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚  ä¿å­˜åŠ©æ‰‹æ¶ˆæ¯              â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚  è¿”å› ChatResponse         â”‚
              â”‚  - session_id              â”‚
              â”‚  - response                â”‚
              â”‚  - archived                â”‚
              â”‚  - archive_topic           â”‚
              â”‚  - context_loads           â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

äº”ã€Python åˆå­¦è€…çŸ¥è¯†ç‚¹æ€»ç»“
1. ç±»å‹æ³¨è§£
def add(a: int, b: int) -> int:    # å‚æ•°ç±»å‹å’Œè¿”å›ç±»å‹
    return a + b

name: str = "hello"                 # å˜é‡ç±»å‹
names: List[str] = ["a", "b"]       # åˆ—è¡¨å…ƒç´ ç±»å‹
data: Dict[str, int] = {"a": 1}     # å­—å…¸é”®å€¼ç±»å‹
result: Optional[str] = None        # å¯é€‰ç±»å‹ï¼ˆå¯ä»¥æ˜¯ str æˆ– Noneï¼‰

2. å¼‚æ­¥ç¼–ç¨‹ (async/await)
async def fetch_data():           # async å®šä¹‰å¼‚æ­¥å‡½æ•°
    result = await some_api()     # await ç­‰å¾…å¼‚æ­¥æ“ä½œå®Œæˆ
    return result

3. Pydantic æ•°æ®éªŒè¯
class User(BaseModel):
    name: str
    age: int = 18                  # é»˜è®¤å€¼
    email: Optional[str] = None
    
user = User(name="å¼ ä¸‰")           # è‡ªåŠ¨éªŒè¯ + ç±»å‹è½¬æ¢

4. è£…é¥°å™¨
@router.post("/chat")              # å°†å‡½æ•°æ³¨å†Œä¸º POST /chat è·¯ç”±
async def chat(request: ChatRequest):
    pass

@pytest.mark.asyncio               # æ ‡è®°ä¸ºå¼‚æ­¥æµ‹è¯•
async def test_something():
    pass

5. ä¸Šä¸‹æ–‡ç®¡ç†å™¨
async with httpx.AsyncClient() as client:  # è‡ªåŠ¨ç®¡ç†èµ„æº
    response = await client.post(url, ...)
# é€€å‡ºæ—¶è‡ªåŠ¨å…³é—­è¿æ¥

6. åˆ—è¡¨æ¨å¯¼å¼
# åŸºæœ¬å½¢å¼
squares = [x**2 for x in range(10)]

# å¸¦æ¡ä»¶
evens = [x for x in range(10) if x % 2 == 0]

# é¡¹ç›®ä¸­çš„ä¾‹å­ (firestore_service.py:126)
active = [msg for msg in messages if not msg.is_archived and not msg.is_excluded]

7. å­—å…¸æ¨å¯¼å¼
# é¡¹ç›®ä¸­çš„ä¾‹å­ (artifact_service.py:27-33)
sources_map = {
    title: [msg_id.strip() for msg_id in sources_str.split(',')]
    for title, sources_str in matches
}

å…­ã€é¡¹ç›®äº®ç‚¹ä¸è®¾è®¡æ€æƒ³
1. æ»‘åŠ¨çª—å£å½’æ¡£
é¿å…ä¸Šä¸‹æ–‡æ— é™å¢é•¿
ä¿ç•™æœ€æ–°å¯¹è¯çš„å®Œæ•´æ€§
è‡ªåŠ¨ç§¯ç´¯çŸ¥è¯†æ–‡æ¡£
2. ä¸»é¢˜åˆå¹¶æœºåˆ¶
å…ˆç²¾ç¡®åŒ¹é…æ ‡é¢˜
å†ä½¿ç”¨ LLM è¯­ä¹‰åˆ¤æ–­
é¿å…çŸ¥è¯†ç¢ç‰‡åŒ–
3. æŒ‰éœ€å›æº¯ (NEED_CONTEXT)
LLM è‡ªä¸»å†³å®šä½•æ—¶éœ€è¦æ›´å¤šä¿¡æ¯
å‡å°‘ä¸å¿…è¦çš„ä¸Šä¸‹æ–‡åŠ è½½
ä¿æŒå“åº”æ•ˆç‡
4. æºæ¶ˆæ¯è¿½æº¯
Artifact ä¸­è®°å½• <!-- sources: msg_xxx -->
æ”¯æŒä»æ€»ç»“å›æº¯åˆ°åŸå§‹å¯¹è¯
ä¿è¯ä¿¡æ¯å¯éªŒè¯