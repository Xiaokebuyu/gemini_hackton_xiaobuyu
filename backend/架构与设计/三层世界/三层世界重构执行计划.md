# 三层世界重构 — 执行计划（总览）

> 创建时间：2026-02-20
> 状态：阶段 1 ✅ 完成，阶段 2 ✅ 完成，阶段 3 ✅ 完成，阶段 4 待启动
> 前置文档：[架构现状盘点与重构方向.md](./架构现状盘点与重构方向.md)
> 原则：每个阶段结束后系统可正常运行，不断不停

---

## 阶段总览

| 阶段 | 名称 | 目标 | 状态 | 文档 |
|------|------|------|------|------|
| 1 | 地基修补（治屎山） | 收拢散写、合并冗余、加固持久化 | ✅ 完成 | [阶段1-地基修补.md](./阶段1-地基修补.md) |
| 2 | 底层引擎独立化 | `app/world/` 纯机械边界，零 LLM | ✅ 完成 | [阶段2-底层引擎独立化.md](./阶段2-底层引擎独立化.md) |
| 3 | World API 中层建立 | SessionRuntime 升级为中层 API，操作收编 | ✅ 完成 | [阶段3-World-API中层建立.md](./阶段3-World-API中层建立.md) |
| 4 | 上层 Agent 改造 | 沉浸式接口 + 回合系统 + 新功能 | ⏸️ 待启动 | [阶段4-上层Agent改造.md](./阶段4-上层Agent改造.md) |

---

## 阶段依赖关系

```
阶段 1（地基修补）        ✅
  └──→ 阶段 2（底层引擎独立化）  ✅
         └──→ 阶段 3（World API 中层）  ✅
                └──→ 阶段 4（上层 Agent 改造）  ← 当前
```

严格线性依赖：每个阶段的产出是下一阶段的前置。

---

## 全局架构决策

以下决策在阶段 3 调查阶段确认，贯穿阶段 3+4：

| 编号 | 决策 | 归属 |
|------|------|------|
| D1 | 运行时全内存，Firestore 仅存档 | 阶段 3 |
| D2 | 复用 SessionRuntime 就地升级为中层 | 阶段 3 |
| D3 | 两套接口（机械直调 + 沉浸式） | 阶段 3 定义 / 阶段 4 实现沉浸式 |
| D4 | 数据模型 B：WorldGraph + 侧子系统 | 阶段 3 架构 / 后续实现 |
| D5 | 沉浸式接口：LLM 以角色视角行动 | 阶段 4 |
| D6 | 角色工具注册：按 role+traits 过滤 | 阶段 4 |
| D7 | 情感量化：预定义档位 | 阶段 4 |
| D8 | SceneBus 成员模型：接触制 | 阶段 4 |
| D9 | 回合时间系统：每轮 ≈10 分钟 | 阶段 4 |
| D10 | 商店+好感度联动定价 | 阶段 4（或后续） |
| D11 | 私聊接入 Pipeline | 阶段 4 |

---

## 变更日志

| 日期 | 操作 |
|------|------|
| 2026-02-20 | 创建总览 + 四阶段独立文档 |
| 2026-02-20 | 阶段 1 进展：1.5 ✅ → 1.1 ✅ → 1.2 ✅ → 1.3 ✅ → 1.4 ✅，下一步 1.6 |
| 2026-02-20 | **阶段 1 完成**：1.6 重复代码合并 ✅ + 1.7 错误处理统一 ✅（合并执行）。全部 7 个子任务完成，下一步 → 阶段 2 |
| 2026-02-20 | **阶段 2 完成**：两次执行（P1+2.1+2.2 LLM 边界清理 + 2.3+2.4 数据一致性）。`app/world/` 零 LLM 依赖 |
| 2026-02-20 | **阶段 3 调查完成**：四路审计（三套接口 / 私聊系统 / 模块依赖 / 权限现状）+ 架构设计讨论，确认 11 个全局决策（D1-D11），重写阶段 3+4 文档 |
